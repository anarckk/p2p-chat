const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/keyExchangeStore-BQPnJgqy.js","assets/index-C7JC_cEt.js","assets/index-CH9t_CQJ.css"])))=>i.map(i=>d[i]);
import{K as _e,r as x,q as oe,_ as be}from"./index-C7JC_cEt.js";import{i as Q,a as R,u as O,P as Ce,g as re,$ as ae}from"./PeerHttpUtil-CqeeV06i.js";import{n as Re}from"./networkLogDB-bSBVLm5N.js";import{cryptoManager as ce}from"./cryptoManager-BXa9bEtX.js";import{c as h}from"./logger-CUkP4sI-.js";const T="p2p_messages_",J="p2p_contacts",se="p2p_pending_messages",F="message_content_migrated_to_indexeddb",M=_e("chat",()=>{const e=x(new Map),o=x(new Map),n=x(new Map),s=x(null);async function a(c,u,y){const g=`msg-content-${c}`;await Q.set("messages",{id:g,messageId:c,type:u,content:y})}async function i(c){const u=`msg-content-${c}`;return(await Q.get("messages",u))?.content||null}async function r(){if(!localStorage.getItem(F))try{console.log("[ChatStore] 开始检查消息数据迁移...");const u=localStorage.getItem(J);if(!u){localStorage.setItem(F,"true");return}const y=JSON.parse(u),g=Object.keys(y);let S=0;for(const U of g){const te=localStorage.getItem(T+U);if(!te)continue;const ne=JSON.parse(te);let V=0;for(const q of ne)if(q.type==="image"||q.type==="file"||q.type==="video"){const H=q.content;H&&H.length>1e3&&(await a(q.id,q.type,H),q.content=`msg-content-${q.id}`,V++)}V>0&&(localStorage.setItem(T+U,JSON.stringify(ne)),S+=V)}localStorage.setItem(F,"true"),console.log(`[ChatStore] 消息数据迁移完成！迁移了 ${S} 条大型消息内容`)}catch(u){console.error("[ChatStore] 消息数据迁移失败:",u)}}const t=oe(()=>s.value?e.value.get(s.value)||[]:[]),d=oe(()=>Array.from(o.value.values()).sort((c,u)=>c.online!==u.online?c.online?-1:1:u.lastSeen-c.lastSeen));async function f(){await r();const c=localStorage.getItem("p2p_current_chat");if(c)try{s.value=c}catch(g){console.error("[ChatStore] Failed to load current chat:",g)}const u=localStorage.getItem(J);if(u)try{const g=JSON.parse(u);o.value=new Map(Object.entries(g));for(const[S]of o.value)await D(S)}catch(g){console.error("[ChatStore] Failed to load contacts:",g)}const y=localStorage.getItem(se);if(y)try{const g=JSON.parse(y);n.value=new Map(Object.entries(g))}catch(g){console.error("[ChatStore] Failed to load pending messages:",g)}}function l(){const c=Object.fromEntries(o.value);localStorage.setItem(J,JSON.stringify(c))}function w(){const c=Object.fromEntries(n.value);localStorage.setItem(se,JSON.stringify(c))}async function m(c){const u=e.value.get(c)||[],y=[];for(const g of u)if(g.type==="image"||g.type==="file"||g.type==="video"){const S=g.content;S.startsWith("msg-content-")?y.push(g):S&&S.length>1e3?(await a(g.id,g.type,S),y.push({...g,content:`msg-content-${g.id}`})):y.push(g)}else y.push(g);localStorage.setItem(T+c,JSON.stringify(y))}async function D(c){const u=localStorage.getItem(T+c);if(u)try{const y=JSON.parse(u),g=[];for(const S of y)if((S.type==="image"||S.type==="file"||S.type==="video")&&typeof S.content=="string"&&S.content.startsWith("msg-content-")){const U=await i(S.id);g.push({...S,content:U||S.content})}else g.push(S);return e.value.set(c,g),g}catch(y){console.error("[ChatStore] Failed to load messages:",y)}return[]}function v(c){const u=o.value.get(c.peerId);u?o.value.set(c.peerId,{...u,...c}):o.value.set(c.peerId,c),l()}function P(c){return o.value.get(c)}function C(c,u){const y=o.value.get(c);y&&(y.online=u,y.lastSeen=Date.now(),l())}async function k(c,u){e.value.has(c)||e.value.set(c,[]),e.value.get(c).push(u),await m(c);const y=o.value.get(c);if(y&&u.from===c){const g=e.value.get(c);g&&g.length>0&&(y.lastSeen=u.timestamp),l()}}async function I(c,u,y){const g=e.value.get(c);if(g){const S=g.find(U=>U.id===u);S&&(S.status=y,y==="delivered"&&(S.deliveredAt=Date.now()),await m(c))}}function b(c){for(const u of e.value.values()){const y=u.find(g=>g.id===c);if(y)return y}return null}function L(c){n.value.set(c.id,c),w()}function K(c){n.value.delete(c),w()}function me(c){const u=n.value.get(c);return u?(u.retryCount++,w(),!(u.maxRetries!==void 0&&u.retryCount>u.maxRetries)):!1}function Pe(c){return Array.from(n.value.values()).filter(u=>u.to===c)}function ee(c){const u=Array.from(n.value.entries()).filter(([,y])=>y.to===c);return u.forEach(([y])=>n.value.delete(y)),w(),u.map(([,y])=>y)}async function he(c,u=c){o.value.has(c)||v({peerId:c,username:u,avatar:null,online:!1,lastSeen:Date.now(),unreadCount:0,chatVersion:0}),await D(c)}async function we(c){o.value.delete(c),e.value.delete(c);const u=localStorage.getItem(T+c);if(u)try{const y=JSON.parse(u);for(const g of y)(g.type==="image"||g.type==="file"||g.type==="video")&&await Q.delete("messages",`msg-content-${g.id}`)}catch(y){console.error("[ChatStore] Failed to clean up IndexedDB messages:",y)}localStorage.removeItem(T+c),l(),ee(c),s.value===c&&(s.value=null)}function De(c){if(s.value=c,c){localStorage.setItem("p2p_current_chat",c);const u=o.value.get(c);u&&(u.unreadCount=0,l())}else localStorage.removeItem("p2p_current_chat")}function Se(c){const u=o.value.get(c);u&&s.value!==c&&(u.unreadCount++,l())}function Ie(){return Array.from(o.value.values()).reduce((c,u)=>c+u.unreadCount,0)}return{messages:e,contacts:o,pendingMessages:n,currentChatPeerId:s,currentMessages:t,sortedContacts:d,loadFromStorage:f,loadMessages:D,addOrUpdateContact:v,getContact:P,setContactOnline:C,addMessage:k,updateMessageStatus:I,getMessageById:b,addPendingMessage:L,removePendingMessage:K,incrementRetryCount:me,getPendingMessagesForPeer:Pe,clearPendingMessagesForPeer:ee,createChat:he,deleteChat:we,setCurrentChat:De,incrementUnread:Se,getTotalUnread:Ie}});let _=null;function G(e){_=e}let ie=null;function N(e){ie=e}const p={message:null,discoveryResponse:null,discoveryNotification:null,discoveryNotificationRequest:null,usernameQuery:null,usernameResponse:null,onlineCheckQuery:null,onlineCheckRequest:null,onlineCheckResponse:null,userInfoQuery:null,userInfoResponse:null,userInfoUpdate:null,relayMessage:null,relayResponse:null,networkAccelerationStatus:null,deviceListRequest:null,deviceListResponse:null},j=new Set;let W=null,le=!1;function ue(e){W=e}function de(e){le=e}const E=x(!1),B=x(!1);async function A(e){const o=_,n=R(),s=M();if(!o)return null;h.sync.requestInfo({to:e});try{const a=await o.queryUserInfo(e);if(a){console.log("[Peer] Got user info for "+e+": "+JSON.stringify({username:a.username,version:a.version}));const i=n.getDevice(e);n.addOrUpdateDevice({peerId:e,username:a.username,avatar:a.avatar,lastHeartbeat:Date.now(),firstDiscovered:i?.firstDiscovered||Date.now(),userInfoVersion:a.version});const r=s.getContact(e);return r&&s.addOrUpdateContact({...r,username:a.username,avatar:a.avatar,lastSeen:Date.now()}),a}}catch(a){console.error("[Peer] Request user info error:",a)}return null}async function ke(e){const o=_,n=R();if(!o)return[];try{h.discovery.add({peerId:e});const s=await o.queryDiscoveredDevices(e);return s.length>0&&n.addDevices(s),s}catch(s){return console.error("[Peer] Query discovered devices error:",s),[]}}function Oe(){const e=_;return e?e.getDiscoveredDevices():[]}function qe(){return R().allDevices}function Ee(e){const o=_,n=R();o&&(o.addDiscoveredDevice(e),n.addOrUpdateDevice(e))}async function Me(e){const o=_,n=O();if(!o){console.warn("[Peer] sendDiscoveryNotification: peerInstance is null");return}try{console.log("[Peer] Sending discovery notification to:",e,"username:",n.userInfo.username),h.discovery.notify({to:e,username:n.userInfo.username}),await o.sendDiscoveryNotification(e,n.userInfo.username||"",n.userInfo.avatar,n.userInfo.version||0),console.log("[Peer] Discovery notification sent successfully to:",e)}catch(s){console.error("[Peer] Send discovery notification error:",s)}}async function Ue(e){const o=_;if(!o)return console.warn("[Peer] queryUsername: peerInstance is null"),null;try{console.log("[Peer] Querying username for:",e),h.discovery.query({from:e});const n=await o.queryUsername(e);return console.log("[Peer] Query username result:",n),n}catch(n){return console.error("[Peer] Query username error: "+String(n)),null}}async function Te(e,o=5e3){const n=_,s=O();if(!n)return!1;try{h.heartbeat.check({to:e,version:s.userInfo.version});const a=await n.checkOnline(e,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version,o);return a!==null&&a.isOnline?(h.heartbeat.online({from:e}),!0):(a!==null&&!a.isOnline&&h.heartbeat.offline({peerId:e}),a!==null&&a.isOnline)}catch(a){return console.error("[Peer] Check online error: "+String(a)),h.heartbeat.offline({peerId:e}),!1}}async function $(e){const o=_,n=R();if(!o)return[];h.deviceDiscovery.requestSent({to:e});try{const s=await o.requestDeviceList(e);return s.length>0&&n.addDevices(s),s}catch(s){return console.error("[Peer] Request device list error:",s),[]}}async function xe(){const e=_,o=R();if(!e)return;const n=o.allDevices;console.log("[Peer] Requesting device lists from "+n.length+" devices");const s=n.map(a=>$(a.peerId));await Promise.allSettled(s)}async function Ne(){const e=_,o=O(),n=R();if(!e)return;const s=n.allDevices,{username:a,avatar:i,version:r}=o.userInfo;console.log("[Peer] Broadcasting user info update to",s.length,"devices:",{username:a,version:r});const t=s.map(d=>d.isOnline?e.sendUserInfoUpdate(d.peerId,a,i,r).catch(f=>{console.warn("[Peer] Failed to send user info update to",d.peerId,f)}):Promise.resolve());await Promise.allSettled(t),console.log("[Peer] User info update broadcast completed")}async function fe(e,o){const n=R(),s=n.getDevice(e);if(s)if(s.publicKey&&s.publicKey!==o){console.warn("[Peer] Public key changed for peer:",e,"- This may indicate a man-in-the-middle attack!");const{useKeyExchangeStore:a}=await be(async()=>{const{useKeyExchangeStore:t}=await import("./keyExchangeStore-BQPnJgqy.js");return{useKeyExchangeStore:t}},__vite__mapDeps([0,1,2]));await a().showKeyChangeDialog(e,s.username||e,s.publicKey,o)?(console.log("[Peer] User trusted new public key for:",e),s.publicKey=o,s.keyExchangeStatus="verified"):(console.log("[Peer] User rejected new public key for:",e),s.keyExchangeStatus="compromised"),await n.addOrUpdateDevice(s),console.log("[Peer] Public key decision saved for peer:",e,"status:",s.keyExchangeStatus)}else s.publicKey||(console.log("[Peer] First time receiving public key from:",e),s.publicKey=o,s.keyExchangeStatus="exchanged",await n.addOrUpdateDevice(s));else await n.addOrUpdateDevice({peerId:e,username:"",avatar:null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0,publicKey:o,keyExchangeStatus:"exchanged"})}async function ve(e){const o=_,n=R();if(!o)return console.warn("[Peer] exchangePublicKey: peerInstance is null"),!1;try{if(!ce)return console.error("[Peer] CryptoManager not initialized"),!1;const s=n.getDevice(e);s&&(s.keyExchangeStatus="pending",n.addOrUpdateDevice(s)),console.log("[Peer] Initiating key exchange with:",e),h.info("Key exchange initiated with "+e.substring(0,8)+"...");const a=await o.exchangePublicKey(e);if(a&&a.publicKey){fe(e,a.publicKey);const i=n.getDevice(e);return i&&(i.keyExchangeStatus="exchanged",i.lastHeartbeat=Date.now(),n.addOrUpdateDevice(i)),console.log("[Peer] Key exchange completed with:",e),h.info("Key exchange completed with "+e.substring(0,8)+"..."),!0}return!1}catch(s){console.error("[Peer] Key exchange error:",s);const a=n.getDevice(e);return a&&(a.keyExchangeStatus="none",n.addOrUpdateDevice(a)),!1}}function ge(e,o){console.log("[Peer] Received key exchange request from:",e),h.info("Key exchange request from "+e.substring(0,8)+"..."),fe(e,o)}function Be(e){const o=M(),n=R(),s=O();p.discoveryResponse=(r,t)=>{if(r.type==="discovery_response"){if(r.devices){const{devices:d}=r;h.discovery.found({peerId:t}),d?.forEach(f=>{e?.addDiscoveredDevice(f)})}else if(r.username){const{username:d,avatar:f}=r;console.log("[Peer] Received discovery response from:",t,"username:",d);const l=n.getDevice(t),w={peerId:t,username:d,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:l?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(w),n.addOrUpdateDevice(w);let m=!1;try{const D=window;D._events&&D._events["discovery-devices-updated"]&&(m=!0)}catch{m=!0}m?window.dispatchEvent(new CustomEvent("discovery-devices-updated")):(window.__pendingDiscoveryUpdate=!0,console.log("[Peer] Discovery update event queued for later processing"))}}},e.onProtocol("discovery_response",p.discoveryResponse);const a=(r,t,d)=>{const f=d?"discovery_notification_request":"discovery_notification";console.log("[Peer] discoveryNotificationHandler called:",{type:r.type,from:t,protocolType:f});const{fromUsername:l,fromAvatar:w,profileVersion:m}=r;h.discovery.notified({from:t,username:l}),console.log("[Peer] Received discovery notification from:",t,"username:",l,"profileVersion:",m,"protocol:",f);const D=n.getDevice(t),v=!D||D.userInfoVersion===void 0||D.userInfoVersion<m,P={peerId:t,username:l,avatar:w,lastHeartbeat:Date.now(),firstDiscovered:D?.firstDiscovered||Date.now(),isOnline:!0,userInfoVersion:m};console.log("[Peer] Adding device to store:",P),e?.addDiscoveredDevice(P),n.addOrUpdateDevice(P);let C=!1;try{const b=window;b._events&&b._events["discovery-devices-updated"]&&(C=!0)}catch{C=!0}C?window.dispatchEvent(new CustomEvent("discovery-devices-updated")):(window.__pendingDiscoveryUpdate=!0,console.log("[Peer] Discovery update event queued for later processing")),o.getContact(t)||(o.createChat(t,l),o.addOrUpdateContact({peerId:t,username:l,avatar:w,online:!0,lastSeen:Date.now(),unreadCount:0,chatVersion:0}));const k=s.userInfo.username||"",I=s.userInfo.avatar;console.log("[Peer] Sending discovery response to:",t,"username:",k,"avatar:",I),e?.sendDiscoveryResponse(t,k,I),v&&D!==void 0&&(console.log("[Peer] Profile version mismatch, requesting latest user info from:",t),A(t)),$(t).then(b=>{b.length>0&&console.log("[Peer] Discovered "+b.length+" devices from "+t)}).catch(b=>{console.error("[Peer] Request device list error after discovery notification:",b)}),ve(t).then(b=>{b?console.log("[Peer] Key exchange completed with:",t):console.warn("[Peer] Key exchange failed with:",t)}).catch(b=>{console.error("[Peer] Key exchange error after discovery notification:",b)})};p.discoveryNotification=(r,t)=>{r.type==="discovery_notification"&&a(r,t,!1)},e.onProtocol("discovery_notification",p.discoveryNotification),p.discoveryNotificationRequest=(r,t)=>{r.type==="discovery_notification_request"&&a(r,t,!0)},e.onProtocol("discovery_notification_request",p.discoveryNotificationRequest),p.usernameQuery=(r,t)=>{r.type==="username_query"&&(h.discovery.query({from:t}),e?.respondUsernameQuery(t,s.userInfo.username||"",s.userInfo.avatar))},e.onProtocol("username_query",p.usernameQuery),p.usernameResponse=(r,t)=>{if(r.type==="username_response"){const{username:d,avatar:f}=r;h.discovery.response({to:t,username:d});const l=o.getContact(t);l&&o.addOrUpdateContact({...l,username:d,avatar:f});const w=n.getDevice(t),m={peerId:t,username:d,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:w?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(m),n.addOrUpdateDevice(m)}},e.onProtocol("username_response",p.usernameResponse);const i=(r,t,d)=>{const f=d?"online_check_request":"online_check_query";console.log("[Peer] onlineCheckRequestHandler called:",{type:r.type,from:t,protocolType:f});let l;d?l=r.payload?.userInfoVersion:l=r.userInfoVersion;const m=n.getDevice(t)?.userInfoVersion||0;h.heartbeat.response({to:t,version:s.userInfo.version}),e?.respondOnlineCheck(t,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version),l!==void 0&&l!==m&&(h.sync.versionMismatch({peerId:t,stored:m,theirs:l}),h.sync.requestInfo({to:t}),A(t))};return p.onlineCheckQuery=(r,t)=>{r.type==="online_check_query"&&i(r,t,!1)},e.onProtocol("online_check_query",p.onlineCheckQuery),p.onlineCheckRequest=(r,t)=>{r.type==="online_check_request"&&i(r,t,!0)},e.onProtocol("online_check_request",p.onlineCheckRequest),p.onlineCheckResponse=(r,t)=>{if(r.type==="online_check_response"){const{isOnline:d,username:f,avatar:l,userInfoVersion:w}=r,m=n.getDevice(t),D=m?.userInfoVersion||0;n.addOrUpdateDevice({peerId:t,username:f,avatar:l,lastHeartbeat:Date.now(),firstDiscovered:m?.firstDiscovered||Date.now(),userInfoVersion:w});const v=o.getContact(t);v&&o.addOrUpdateContact({...v,username:f,avatar:l,online:d,lastSeen:Date.now()}),w!==void 0&&w!==D&&(h.sync.versionMismatch({peerId:t,stored:D,theirs:w}),A(t))}},e.onProtocol("online_check_response",p.onlineCheckResponse),p.userInfoQuery=(r,t)=>{r.type==="user_info_query"&&(h.sync.respondInfo({to:t,version:s.userInfo.version}),e?.respondUserInfo(t,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version))},p.userInfoResponse=(r,t)=>{if(r.type==="user_info_response"){const{username:d,avatar:f,version:l}=r;h.sync.updateInfo({peerId:t,username:d,version:l});const w=n.getDevice(t);n.addOrUpdateDevice({peerId:t,username:d,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:w?.firstDiscovered||Date.now(),userInfoVersion:l});const m=o.getContact(t);m&&o.addOrUpdateContact({...m,username:d,avatar:f,lastSeen:Date.now()})}},e.onProtocol("user_info_query",p.userInfoQuery),e.onProtocol("user_info_response",p.userInfoResponse),p.userInfoUpdate=(r,t)=>{if(r.type==="user_info_update"){const{username:d,avatar:f,version:l}=r;console.log("[Peer] Received user info update from:",t,"username:",d,"version:",l);const w=n.getDevice(t);if(w&&(!w.userInfoVersion||l>w.userInfoVersion)){n.addOrUpdateDevice({...w,username:d,avatar:f,userInfoVersion:l,lastHeartbeat:Date.now()});const m=o.getContact(t);m&&o.addOrUpdateContact({peerId:t,username:d,avatar:f,online:!0,lastSeen:Date.now(),unreadCount:m.unreadCount||0,chatVersion:m.chatVersion||0});let D=!1;try{const v=window;v._events&&v._events["discovery-devices-updated"]&&(D=!0)}catch{D=!0}D?window.dispatchEvent(new CustomEvent("discovery-devices-updated")):(window.__pendingDiscoveryUpdate=!0,console.log("[Peer] Discovery update event queued for later processing")),console.log("[Peer] User info updated for device:",t)}}},e.onProtocol("user_info_update",p.userInfoUpdate),p.networkAccelerationStatus=(r,t)=>{if(r.type==="network_acceleration_status"){const{enabled:d}=r;console.log("[Peer] Network acceleration status from "+t+": "+d),h.networkAcceleration.statusSync({from:t,enabled:d});const f=n.getDevice(t);f&&n.addOrUpdateDevice({...f,networkAccelerationEnabled:d})}},e.onProtocol("network_acceleration_status",p.networkAccelerationStatus),p.deviceListResponse=r=>{if(r.type==="device_list_response"){const{devices:t}=r;if(h.deviceDiscovery.responseReceived({deviceCount:t?.length||0}),t&&t.length>0){const d=[];t.forEach(f=>{!n.getDevice(f.peerId)&&!j.has(f.peerId)&&d.push(f),e?.addDiscoveredDevice(f)}),n.addDevices(t),d.forEach(f=>{j.add(f.peerId),h.deviceDiscovery.newDevice({peerId:f.peerId,username:f.username}),$(f.peerId).then(l=>{l.length>0&&console.log("[Peer] Discovered "+l.length+" more devices from "+f.peerId)}).catch(l=>{console.error("[Peer] Recursive device list request error:",l)}).finally(()=>{j.delete(f.peerId)})})}}},e.onProtocol("device_list_response",p.deviceListResponse),p.deviceListRequest=(r,t)=>{if(r.type==="device_list_request"){h.deviceDiscovery.requestReceived({from:t});const d=n.allDevices;e?.sendDeviceListResponse(t,d)}},e.onProtocol("device_list_request",p.deviceListRequest),e}function Ae(e){const{from:o,data:n}=e;if(n&&typeof n=="object"&&"id"in n&&"type"in n){$e(o,n);return}}async function $e(e,o){const n=M(),s=R(),{id:a,type:i}=o;h.message.received({from:e,msgType:i,messageId:a});const r=JSON.stringify({id:a,from:e,to:o.to,type:i,timestamp:o.timestamp});console.log("[Peer] Handling chat message:",r.substring(0,200));const t=n.getContact(e);n.setContactOnline(e,!0),await s.updateDeviceOnlineStatus(e,!0),console.log("[Peer] Contact online: "+e),t?(n.incrementUnread(e),console.log("[Peer] Incremented unread for "+e)):n.addOrUpdateContact({peerId:e,username:e,avatar:null,online:!0,lastSeen:Date.now(),unreadCount:1,chatVersion:0}),n.addMessage(e,o),console.log("[Peer] Message saved to store: "+o.id),await Le(e)}async function Le(e){const o=M(),n=o.getPendingMessagesForPeer(e);if(n.length!==0){console.log("[Peer] Retrying "+n.length+" pending messages for "+e);for(const s of n)await X(e,s.id,s.content,s.type)?o.removePendingMessage(s.id):o.incrementRetryCount(s.id)||(o.removePendingMessage(s.id),o.updateMessageStatus(e,s.id,"failed"))}}async function X(e,o,n,s="text"){const a=_;if(!a)return console.error("[Peer] Peer instance not initialized"),!1;console.log("[Peer] Sending chat message: peerId="+e+", msgId="+o+", type="+s);try{const i=O(),r={id:o,from:i.myPeerId||"",to:e,content:n,timestamp:Date.now(),status:"sending",type:s},t=await a.sendMessage(e,r);return console.log("[Peer] Send result: msgId="+o+", sent="+t),t&&M().updateMessageStatus(e,o,"sending"),t}catch(i){return console.error("[Peer] Send error: "+String(i)),!1}}function pe(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}async function Ke(e,o,n="text"){const s=O(),a=M();if(!E.value||!_)throw console.error("[Peer] Peer not connected, cannot send message"),new Error("Peer not connected");const i=pe();h.message.send({to:e,msgType:n,messageId:i});const r={id:i,from:s.myPeerId||"",to:e,content:o,timestamp:Date.now(),status:"sending",type:n};a.addMessage(e,r),console.log("[Peer] Message added to local store: "+r.id);const t=await X(e,i,o,n);return console.log("[Peer] Send result: messageId="+i+", success="+t),t?a.updateMessageStatus(e,i,"sending"):(a.addPendingMessage({id:i,to:e,content:o,timestamp:Date.now(),retryCount:0,type:n}),a.updateMessageStatus(e,i,"failed")),i}function Ve(){return e=>{Ae(e)}}function Z(){W!==null&&(clearTimeout(W),ue(null),console.log("[Peer] Auto-reconnect stopped")),de(!1)}function z(e){le||(de(!0),console.log("[Peer] Starting auto-reconnect in 10 seconds..."),ue(window.setTimeout(async()=>{console.log("[Peer] Attempting to reconnect...");try{await e(),console.log("[Peer] Reconnected successfully"),Z()}catch(o){console.error("[Peer] Reconnect failed:",o),z(e)}},1e4)))}function Y(e){return new Promise((o,n)=>{const s=R(),a=performance.now();console.log("[Peer-Performance] ===== Peer 初始化开始 ====="),console.log("[Peer-Performance] Timestamp:",Date.now());const i=(v,P)=>{const C=performance.now(),k=Math.round(C-a);console.log(`[Peer-Performance] [${v}] +${k}ms ${P}`)};i("start","开始初始化 Peer");const r=_;r&&(i("destroy-old","销毁旧的 peerInstance"),r.destroy(),G(null));let t=e.userInfo.peerId;if(t)i("reuse-peerid",`复用已存储的 PeerId: ${t}`);else{i("generate-peerid","生成新的 PeerId");const v=Date.now().toString(36),P=Math.random().toString(36).substring(2,11);t=`peer_${v}_${P}`}console.log("[Peer] Initializing with PeerId:",t,"at",new Date().toISOString());const d={debug:2};i("before-peer-http-util","准备创建 PeerHttpUtil");const f=performance.now(),l=new Ce(t,d);G(l),i("after-peer-http-util",`PeerHttpUtil 创建完成 (耗时 ${Math.round(performance.now()-f)}ms)`),e.loadNetworkLogging()&&(i("network-logging","启用网络日志"),l.setNetworkLogger(!0,async v=>{try{await Re.addLog(v)}catch(P){console.error("[Peer] Failed to save network log:",P)}}),console.log("[Peer] Network logging enabled"));let m=!1;const D=setTimeout(()=>{m||(m=!0,console.error("[Peer] Connection timeout"),i("timeout","连接超时 (30秒)"),E.value=!1,n(new Error("Peer connection timeout")))},3e4);i("before-register-protocols","准备注册协议处理器"),Be(l),i("after-register-protocols","协议处理器注册完成"),i("before-register-message","准备注册消息处理器"),l.on("message",Ve()),i("after-register-message","消息处理器注册完成"),i("before-set-userinfo-provider","准备设置用户信息提供器"),l.setUserInfoProvider({getUsername:()=>e.userInfo.username||"",getAvatar:()=>e.userInfo.avatar,getVersion:()=>e.userInfo.version||0}),i("after-set-userinfo-provider","用户信息提供器设置完成"),i("before-set-publickey-provider","准备设置公钥提供器"),l.setPublicKeyProvider({getPublicKey:()=>{try{return ce.getPublicKey()}catch(v){return console.error("[Peer] Failed to get public key:",v),""}},onPublicKeyReceived:(v,P)=>{console.log("[Peer] Received public key from:",v),ge(v,P)}}),i("after-set-publickey-provider","公钥提供器设置完成"),l.setOnlineChecker(v=>s.getDevice(v)?.isOnline??!1),i("after-set-online-checker","在线检查器设置完成"),l.on("open",v=>{if(!m){const P=performance.now();m=!0,clearTimeout(D),E.value=!0,e.setPeerId(v);const C=Math.round(P-a);console.log("[Peer] Connected with ID:",v),i("connected",`Peer 连接成功! 总耗时: ${C}ms`),console.log("[Peer-Performance] ===== Peer 初始化完成 ====="),Z(),o(l)}}),l.on("disconnected",()=>{console.warn("[Peer] Disconnected from Peer Server"),E.value=!1,z(Y.bind(null,e))}),l.on("close",()=>{console.warn("[Peer] Peer connection closed"),E.value=!1,z(Y.bind(null,e))}),l.on("error",v=>{console.error("[Peer] PeerJS error:",v),!m&&(v?.type==="peer-unavailable"||v?.type==="network"||v?.type==="server-error"||v?.type==="socket-error"||v?.type==="socket-closed")&&(m=!0,clearTimeout(D),E.value=!1,n(new Error(`Peer connection failed: ${v?.type||"unknown error"}`))),v?.type==="peer-unavailable"&&console.log("[Peer] Target peer unavailable:",v)})})}async function He(){const e="UNIVERSE-BOOTSTRAP-PEER-ID-001",o=R(),n=O();console.log("[Peer] Trying to become universe bootstrap with ID:",e),h.universeBootstrap.connecting();const s=performance.now();console.log("[Bootstrap-Performance] ===== 尝试成为宇宙启动者 =====");const a=(r,t)=>{const d=performance.now(),f=Math.round(d-s);console.log(`[Bootstrap-Performance] [${r}] +${f}ms ${t}`)};a("start","开始尝试成为宇宙启动者");const i=Math.floor(Math.random()*1e3);return i>0&&(console.log("[Peer] Adding random delay before bootstrap attempt:",i,"ms"),a("random-delay",`添加随机延迟 ${i}ms 避免竞争`),await new Promise(r=>setTimeout(r,i))),new Promise(r=>{let t=globalThis.__bootstrapPeerInstance;if(t){console.log("[Peer] Already is bootstrap"),a("already-bootstrap","已经是启动者"),r(!0);return}const d=setTimeout(()=>{h.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! Keeping connection..."),a("success","成为宇宙启动者成功 (3秒超时未被触发)"),B.value=!0,r(!0)},3e3);try{a("before-create-peer","准备创建 Bootstrap Peer");const f=performance.now(),l=re(),w=l.host||"PeerJS Cloud (default)",m=l.port,D=l.path,v=m?`${w}:${m}${D}`:`${w}${D}`;console.log("[Peer-Bootstrap] Connecting to Peer Server:",v),t=new ae(e,l),globalThis.__bootstrapPeerInstance=t,N(t),a("after-create-peer",`Bootstrap Peer 创建完成 (耗时 ${Math.round(performance.now()-f)}ms)`),t.on("open",P=>{const C=performance.now();clearTimeout(d),h.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! ID:",P),a("connected",`成为宇宙启动者成功! 连接耗时: ${Math.round(C-s)}ms`),B.value=!0,t.on("connection",k=>{k.on("data",I=>{if(I&&I.type==="device_list_request"){if(console.log("[Peer-Bootstrap] Received device list request from:",I.from,"realPeerId:",I.realPeerId,"username:",I.username),h.deviceDiscovery.requestReceived({from:I.from}),I.realPeerId&&I.realPeerId!==n.myPeerId){const K={peerId:I.realPeerId,username:I.username||I.realPeerId,avatar:I.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0};o.addOrUpdateDevice(K),console.log("[Peer-Bootstrap] Added requester to device list:",I.realPeerId,"username:",I.username)}const b=o.allDevices,L={type:"device_list_response",from:e,to:I.from,timestamp:Date.now(),devices:b,isBootstrap:!0,realPeerId:n.myPeerId,username:n.userInfo.username,avatar:n.userInfo.avatar};k.send(L),h.deviceDiscovery.responseSent({to:I.from,deviceCount:b.length}),console.log("[Peer-Bootstrap] Sent device list with",b.length,"devices")}})}),console.log("[Peer-Bootstrap] Listening for device list requests..."),r(!0)}),t.on("error",P=>{if(!t)return;const C=performance.now();clearTimeout(d),h.universeBootstrap.failed({error:P?.type}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Bootstrap already exists, requesting device list..."),a("error",`Bootstrap 已存在，连接失败 (耗时 ${Math.round(C-s)}ms)`),B.value=!1,t&&(t.destroy(),t=null,globalThis.__bootstrapPeerInstance=null,N(null)),ye(e).then(()=>{r(!1)}).catch(()=>{r(!1)})}),t.on("disconnected",()=>{console.warn("[Peer-Bootstrap] Disconnected from server")}),t.on("close",()=>{console.log("[Peer-Bootstrap] Connection closed"),t=null,globalThis.__bootstrapPeerInstance=null,N(null),B.value=!1})}catch(f){clearTimeout(d),console.error("[Peer] Bootstrap error:",f),t=null,globalThis.__bootstrapPeerInstance=null,N(null),r(!1)}})}async function ye(e){const o=R(),n=O();return h.universeBootstrap.requestList({to:e}),new Promise(s=>{let a=null,i=null,r=null,t=null;const d=()=>{i&&(i.close(),i=null),a&&(a.destroy(),a=null),r!==null&&(clearTimeout(r),r=null),t!==null&&(clearInterval(t),t=null)};r=window.setTimeout(()=>{console.warn("[Peer] Request bootstrap device list timeout"),d(),s()},1e4);try{const f=re(),l=f.host||"PeerJS Cloud (default)",w=f.port,m=f.path,D=w?`${l}:${w}${m}`:`${l}${m}`;console.log("[Peer-Bootstrap-Request] Connecting to Peer Server:",D),a=new ae(f),a.on("open",v=>{console.log("[Peer] Temp peer connected with ID:",v),i=a.connect(e),i.on("open",()=>{console.log("[Peer] Connected to bootstrap, waiting for myPeerId...");const P=5e3,C=Date.now();t=window.setInterval(()=>{if(n.myPeerId){clearInterval(t),t=null,console.log("[Peer] myPeerId is ready:",n.myPeerId);const k={type:"device_list_request",from:v,to:e,timestamp:Date.now(),realPeerId:n.myPeerId,username:n.userInfo.username,avatar:n.userInfo.avatar};console.log("[Peer] Sending device list request with realPeerId:",n.myPeerId),i.send(k)}else if(Date.now()-C>P){clearInterval(t),t=null,console.warn("[Peer] Timeout waiting for myPeerId, sending request without it...");const k={type:"device_list_request",from:v,to:e,timestamp:Date.now(),realPeerId:null,username:null,avatar:null};i.send(k)}},100)}),i.on("data",P=>{if(P&&P.type==="device_list_response"){if(console.log("[Peer] Received device list from bootstrap:",P.devices?.length||0,"devices"),h.universeBootstrap.responseList({deviceCount:P.devices?.length||0}),P.devices&&P.devices.length>0&&o.addDevices(P.devices),P.isBootstrap&&P.realPeerId){console.log("[Peer] Bootstrap device has real PeerID:",P.realPeerId);const C={peerId:P.realPeerId,username:P.username||"宇宙启动者",avatar:P.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0,isBootstrap:!0,realPeerId:e};o.addOrUpdateDevice(C)}d(),s()}}),i.on("error",P=>{console.error("[Peer] Bootstrap connection error:",P),d(),s()}),i.on("close",()=>{d(),s()})}),a.on("error",v=>{console.error("[Peer] Temp peer error:",v),d(),s()})}catch(f){console.error("[Peer] Request bootstrap device list error:",f),d(),s()}})}function Qe(e){const o=_;o&&(o.setNetworkAccelerationEnabled(e),e?h.networkAcceleration.enabled():h.networkAcceleration.disabled())}function Je(){return _?.getNetworkAccelerationEnabled()||!1}async function Fe(){const e=_;if(!e)return;const n=R().allDevices;e.getNetworkAccelerationEnabled();const s=n.map(a=>a.isOnline?e.sendNetworkAccelerationStatus(a.peerId).catch(()=>{}):Promise.resolve());await Promise.allSettled(s)}function Xe(){M();const e=O(),o=R();function n(){return Y(e)}function s(){Z();const a=_;a&&(a.destroy(),G(null),p.message=null,p.discoveryResponse=null,p.discoveryNotification=null,p.usernameQuery=null,p.usernameResponse=null,p.onlineCheckQuery=null,p.onlineCheckResponse=null,p.userInfoQuery=null,p.userInfoResponse=null,p.userInfoUpdate=null,p.relayMessage=null,p.relayResponse=null,p.networkAccelerationStatus=null,p.deviceListRequest=null,p.deviceListResponse=null,E.value=!1);const i=ie;i&&(i.destroy(),N(null),console.log("[Peer] Bootstrap connection destroyed"))}return{isConnected:E,isBootstrap:B,init:n,destroy:s,sendChatMessage:X,sendMessageWithRetry:Ke,generateMessageId:pe,queryDiscoveredDevices:ke,getDiscoveredDevices:Oe,getStoredDevices:qe,addDiscoveredDevice:Ee,sendDiscoveryNotification:Me,queryUsername:Ue,checkOnline:Te,requestUserInfo:A,tryBecomeBootstrap:He,requestBootstrapDeviceList:ye,setNetworkAccelerationEnabled:Qe,getNetworkAccelerationEnabled:Je,broadcastNetworkAccelerationStatus:Fe,requestDeviceList:$,requestAllDeviceLists:xe,broadcastUserInfoUpdate:Ne,exchangePublicKey:ve,handleKeyExchangeRequest:ge,deviceStore:o}}export{M as a,Xe as u};
