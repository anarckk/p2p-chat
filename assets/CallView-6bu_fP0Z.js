import{c as B}from"./logger-CUkP4sI-.js";import{c as s,I as y,d as F,a as H,k as C,g as f,i as g,t as P,n as W,j as k,w as v,b as m,r as u,S as w,q as _,e as E,f as c}from"./index-C7JC_cEt.js";import{V as G}from"./VideoCameraOutlined-BABRp49-.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";var Q={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M682 455V311l-76 76v68c-.1 50.7-42 92.1-94 92a95.8 95.8 0 01-52-15l-54 55c29.1 22.4 65.9 36 106 36 93.8 0 170-75.1 170-168z"}},{tag:"path",attrs:{d:"M833 446h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254-63 0-120.7-23-165-61l-54 54a334.01 334.01 0 00179 81v102H326c-13.9 0-24.9 14.3-25 32v36c.1 4.4 2.9 8 6 8h408c3.2 0 6-3.6 6-8v-36c0-17.7-11-32-25-32H547V782c165.3-17.9 294-157.9 294-328 0-4.4-3.6-8-8-8zm13.1-377.7l-43.5-41.9a8 8 0 00-11.2.1l-129 129C634.3 101.2 577 64 511 64c-93.9 0-170 75.3-170 168v224c0 6.7.4 13.3 1.2 19.8l-68 68A252.33 252.33 0 01258 454c-.2-4.4-3.8-8-8-8h-60c-4.4 0-8 3.6-8 8 0 53 12.5 103 34.6 147.4l-137 137a8.03 8.03 0 000 11.3l42.7 42.7c3.1 3.1 8.2 3.1 11.3 0L846.2 79.8l.1-.1c3.1-3.2 3-8.3-.2-11.4zM417 401V232c0-50.6 41.9-92 94-92 46 0 84.1 32.3 92.3 74.7L417 401z"}}]},name:"audio-muted",theme:"outlined"};function A(l){for(var e=1;e<arguments.length;e++){var a=arguments[e]!=null?Object(arguments[e]):{},t=Object.keys(a);typeof Object.getOwnPropertySymbols=="function"&&(t=t.concat(Object.getOwnPropertySymbols(a).filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable}))),t.forEach(function(n){X(l,n,a[n])})}return l}function X(l,e,a){return e in l?Object.defineProperty(l,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):l[e]=a,l}var R=function(e,a){var t=A({},e,a.attrs);return s(y,A({},t,{icon:Q}),null)};R.displayName="AudioMutedOutlined";R.inheritAttrs=!1;var Y={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M842 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254S258 594.3 258 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 168.7 126.6 307.9 290 327.6V884H326.7c-13.7 0-24.7 14.3-24.7 32v36c0 4.4 2.8 8 6.2 8h407.6c3.4 0 6.2-3.6 6.2-8v-36c0-17.7-11-32-24.7-32H548V782.1c165.3-18 294-158 294-328.1zM512 624c93.9 0 170-75.2 170-168V232c0-92.8-76.1-168-170-168s-170 75.2-170 168v224c0 92.8 76.1 168 170 168zm-94-392c0-50.6 41.9-92 94-92s94 41.4 94 92v224c0 50.6-41.9 92-94 92s-94-41.4-94-92V232z"}}]},name:"audio",theme:"outlined"};function j(l){for(var e=1;e<arguments.length;e++){var a=arguments[e]!=null?Object(arguments[e]):{},t=Object.keys(a);typeof Object.getOwnPropertySymbols=="function"&&(t=t.concat(Object.getOwnPropertySymbols(a).filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable}))),t.forEach(function(n){Z(l,n,a[n])})}return l}function Z(l,e,a){return e in l?Object.defineProperty(l,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):l[e]=a,l}var M=function(e,a){var t=j({},e,a.attrs);return s(y,j({},t,{icon:Y}),null)};M.displayName="AudioOutlined";M.inheritAttrs=!1;var U={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M877.1 238.7L770.6 132.3c-13-13-30.4-20.3-48.8-20.3s-35.8 7.2-48.8 20.3L558.3 246.8c-13 13-20.3 30.5-20.3 48.9 0 18.5 7.2 35.8 20.3 48.9l89.6 89.7a405.46 405.46 0 01-86.4 127.3c-36.7 36.9-79.6 66-127.2 86.6l-89.6-89.7c-13-13-30.4-20.3-48.8-20.3a68.2 68.2 0 00-48.8 20.3L132.3 673c-13 13-20.3 30.5-20.3 48.9 0 18.5 7.2 35.8 20.3 48.9l106.4 106.4c22.2 22.2 52.8 34.9 84.2 34.9 6.5 0 12.8-.5 19.2-1.6 132.4-21.8 263.8-92.3 369.9-198.3C818 606 888.4 474.6 910.4 342.1c6.3-37.6-6.3-76.3-33.3-103.4zm-37.6 91.5c-19.5 117.9-82.9 235.5-178.4 331s-213 158.9-330.9 178.4c-14.8 2.5-30-2.5-40.8-13.2L184.9 721.9 295.7 611l119.8 120 .9.9 21.6-8a481.29 481.29 0 00285.7-285.8l8-21.6-120.8-120.7 110.8-110.9 104.5 104.5c10.8 10.8 15.8 26 13.3 40.8z"}}]},name:"phone",theme:"outlined"};function L(l){for(var e=1;e<arguments.length;e++){var a=arguments[e]!=null?Object(arguments[e]):{},t=Object.keys(a);typeof Object.getOwnPropertySymbols=="function"&&(t=t.concat(Object.getOwnPropertySymbols(a).filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable}))),t.forEach(function(n){K(l,n,a[n])})}return l}function K(l,e,a){return e in l?Object.defineProperty(l,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):l[e]=a,l}var S=function(e,a){var t=L({},e,a.attrs);return s(y,L({},t,{icon:U}),null)};S.displayName="PhoneOutlined";S.inheritAttrs=!1;var ee={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M368 724H252V608c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v116H72c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h116v116c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V788h116c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8z"}},{tag:"path",attrs:{d:"M912 302.3L784 376V224c0-35.3-28.7-64-64-64H128c-35.3 0-64 28.7-64 64v352h72V232h576v560H448v72h272c35.3 0 64-28.7 64-64V648l128 73.7c21.3 12.3 48-3.1 48-27.6V330c0-24.6-26.7-40-48-27.7zM888 625l-104-59.8V458.9L888 399v226z"}},{tag:"path",attrs:{d:"M320 360c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H208c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h112z"}}]},name:"video-camera-add",theme:"outlined"};function T(l){for(var e=1;e<arguments.length;e++){var a=arguments[e]!=null?Object(arguments[e]):{},t=Object.keys(a);typeof Object.getOwnPropertySymbols=="function"&&(t=t.concat(Object.getOwnPropertySymbols(a).filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable}))),t.forEach(function(n){ae(l,n,a[n])})}return l}function ae(l,e,a){return e in l?Object.defineProperty(l,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):l[e]=a,l}var I=function(e,a){var t=T({},e,a.attrs);return s(y,T({},t,{icon:ee}),null)};I.displayName="VideoCameraAddOutlined";I.inheritAttrs=!1;class te{peerConnection=null;dataChannel=null;localStream=null;remoteStream=null;currentPeerId=null;currentCallType="audio";callState="idle";configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};pendingIceCandidates=[];currentRequestId=null;async initiateCall(e,a,t){if(console.log("[CallManager] Initiating call:",{peerId:e,callType:a}),B.info(`Initiating ${a} call to ${e.substring(0,8)}...`),this.callState!=="idle")throw new Error("Already in a call");this.currentPeerId=e,this.currentCallType=a,this.callState="calling",this.pendingIceCandidates=[];try{a==="data_channel"?await this.initiateDataChannelCall(e,t):await this.initiateMediaStreamCall(e,a,t)}catch(n){throw console.error("[CallManager] Failed to initiate call:",n),this.cleanup(),this.callState="idle",n}}async initiateMediaStreamCall(e,a,t){this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:a==="video"}),this.onLocalStream&&this.onLocalStream(this.localStream),this.peerConnection=new RTCPeerConnection(this.configuration),this.peerConnection.onicecandidate=o=>{o.candidate&&(console.log("[CallManager] ICE candidate generated:",o.candidate),this.handleIceCandidate(o.candidate,e,t))},this.peerConnection.onconnectionstatechange=()=>{console.log("[CallManager] Connection state:",this.peerConnection?.connectionState),this.peerConnection?.connectionState==="disconnected"&&(console.warn("[CallManager] Connection disconnected"),this.hangup())},this.peerConnection.ontrack=o=>{console.log("[CallManager] Received remote track:",o.track.kind);const r=o.streams[0];r&&(this.remoteStream=r,this.onRemoteStream&&this.onRemoteStream(r))},this.localStream.getTracks().forEach(o=>{this.peerConnection.addTrack(o,this.localStream)});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),console.log("[CallManager] Local description set");try{const r=await t.getRRManager().sendRequest(e,"call_request",{callType:a,offer:n},3e4);if(r?.accepted&&r?.answer)console.log("[CallManager] Call accepted"),await this.handleAnswer(r.answer);else throw new Error("Call rejected")}catch(o){throw console.error("[CallManager] Failed to send call request:",o),this.cleanup(),o}}async initiateDataChannelCall(e,a){console.log("[CallManager] Initiating data channel call"),this.peerConnection=new RTCPeerConnection(this.configuration),this.dataChannel=this.peerConnection.createDataChannel("voice-call",{ordered:!1}),this.setupDataChannel(),this.peerConnection.onicecandidate=n=>{n.candidate&&(console.log("[CallManager] ICE candidate generated:",n.candidate),this.handleIceCandidate(n.candidate,e,a))};const t=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(t);try{const o=await a.getRRManager().sendRequest(e,"call_request",{callType:"data_channel",offer:t},3e4);if(o?.accepted&&o?.answer)await this.handleAnswer(o.answer);else throw new Error("Call rejected")}catch(n){throw console.error("[CallManager] Failed to send data channel call request:",n),this.cleanup(),n}}async answerCall(e,a,t,n){if(console.log("[CallManager] Answering call:",{peerId:e,callType:t}),this.callState!=="idle")throw new Error("Already in a call");this.currentPeerId=e,this.currentCallType=t,this.callState="incall",this.pendingIceCandidates=[];try{t==="data_channel"?await this.answerDataChannelCall(e,a,n):await this.answerMediaStreamCall(e,a,t,n)}catch(o){throw console.error("[CallManager] Failed to answer call:",o),this.cleanup(),this.callState="idle",o}}async answerMediaStreamCall(e,a,t,n){this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:t==="video"}),this.onLocalStream&&this.onLocalStream(this.localStream),this.peerConnection=new RTCPeerConnection(this.configuration),this.peerConnection.onicecandidate=r=>{r.candidate&&(console.log("[CallManager] ICE candidate generated:",r.candidate),this.handleIceCandidate(r.candidate,e,n))},this.peerConnection.onconnectionstatechange=()=>{console.log("[CallManager] Connection state:",this.peerConnection?.connectionState),this.peerConnection?.connectionState==="disconnected"&&(console.warn("[CallManager] Connection disconnected"),this.hangup())},this.peerConnection.ontrack=r=>{console.log("[CallManager] Received remote track:",r.track.kind);const d=r.streams[0];d&&(this.remoteStream=d,this.onRemoteStream&&this.onRemoteStream(d))},this.localStream.getTracks().forEach(r=>{this.peerConnection.addTrack(r,this.localStream)}),await this.peerConnection.setRemoteDescription(new RTCSessionDescription(a)),console.log("[CallManager] Remote description set");const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),console.log("[CallManager] Local description set");try{await n.getRRManager().sendRequest(e,"call_response",{accepted:!0,answer:o})}catch(r){throw console.error("[CallManager] Failed to send answer:",r),this.cleanup(),r}}async answerDataChannelCall(e,a,t){console.log("[CallManager] Answering data channel call"),this.peerConnection=new RTCPeerConnection(this.configuration),this.peerConnection.ondatachannel=o=>{console.log("[CallManager] Data channel received"),this.dataChannel=o.channel,this.setupDataChannel()},this.peerConnection.onicecandidate=o=>{o.candidate&&(console.log("[CallManager] ICE candidate generated:",o.candidate),this.handleIceCandidate(o.candidate,e,t))},await this.peerConnection.setRemoteDescription(new RTCSessionDescription(a));const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n);try{await t.getRRManager().sendRequest(e,"call_response",{accepted:!0,answer:n})}catch(o){throw console.error("[CallManager] Failed to send data channel answer:",o),this.cleanup(),o}}async handleAnswer(e){if(!this.peerConnection)throw new Error("No active peer connection");if(await this.peerConnection.setRemoteDescription(new RTCSessionDescription(e)),console.log("[CallManager] Remote description set"),this.callState="incall",this.onIceCandidate&&this.currentPeerId){for(const a of this.pendingIceCandidates)this.onIceCandidate({candidate:a,peerId:this.currentPeerId});this.pendingIceCandidates=[]}}handleIceCandidate(e,a,t){(this.callState==="calling"||this.callState==="incall")&&(this.onIceCandidate?this.onIceCandidate({candidate:e,peerId:a}):this.pendingIceCandidates.push(e))}async addIceCandidate(e){if(!this.peerConnection){console.warn("[CallManager] No peer connection to add ICE candidate");return}if(this.peerConnection.remoteDescription===null){console.log("[CallManager] Waiting for remote description before adding ICE candidate"),this.pendingIceCandidates.push(e);return}try{await this.peerConnection.addIceCandidate(new RTCIceCandidate(e)),console.log("[CallManager] ICE candidate added successfully")}catch(a){console.error("[CallManager] Error adding ICE candidate:",a)}}setupDataChannel(){this.dataChannel&&(this.dataChannel.onopen=()=>{console.log("[CallManager] Data channel opened"),this.onDataChannelOpen&&this.onDataChannelOpen()},this.dataChannel.onmessage=e=>{console.log("[CallManager] Data channel message:",e.data),this.onDataChannelMessage&&this.onDataChannelMessage(e.data)},this.dataChannel.onclose=()=>{console.log("[CallManager] Data channel closed")})}sendDataChannelData(e){this.dataChannel&&this.dataChannel.readyState==="open"?typeof e=="string"?this.dataChannel.send(e):this.dataChannel.send(e):console.warn("[CallManager] Data channel not ready")}async hangup(){console.log("[CallManager] Hanging up"),this.cleanup(),this.callState="ended",this.onCallEnded&&this.onCallEnded(),setTimeout(()=>{this.callState="idle"},100)}async rejectCall(e,a){console.log("[CallManager] Rejecting call from:",e);try{await a.getRRManager().sendRequest(e,"call_response",{accepted:!1})}catch(t){console.error("[CallManager] Failed to send rejection:",t)}}toggleMute(){if(!this.localStream)return!1;const e=this.localStream.getAudioTracks()[0];return e?(e.enabled=!e.enabled,!e.enabled):!1}toggleVideo(){if(!this.localStream)return!1;const e=this.localStream.getVideoTracks()[0];return e?(e.enabled=!e.enabled,!e.enabled):!1}cleanup(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.remoteStream=null,this.currentPeerId=null,this.currentCallType="audio",this.pendingIceCandidates=[],this.currentRequestId=null}getLocalStream(){return this.localStream}getRemoteStream(){return this.remoteStream}isInCall(){return this.callState==="incall"}getCallState(){return this.callState}getCurrentPeerId(){return this.currentPeerId}getCurrentCallType(){return this.currentCallType}onRemoteStream;onLocalStream;onCallEnded;onIceCandidate;onDataChannelOpen;onDataChannelMessage;onIncomingCall}const h=new te,ne={class:"call-container"},le={key:0,class:"call-active"},oe={key:1,class:"audio-call-placeholder"},re={class:"audio-icon"},ie={class:"audio-info"},ce={class:"peer-id"},se={class:"call-status"},de={class:"call-controls"},ue={key:1,class:"call-idle"},he=F({__name:"CallView",setup(l){const e=u(!1),a=u(!1),t=u(!1),n=u("idle"),o=u("audio"),r=u(null),d=u(),p=u();h.onRemoteStream=i=>{console.log("[CallView] Remote stream received"),d.value&&(d.value.srcObject=i),e.value=!0,n.value="incall"},h.onLocalStream=i=>{console.log("[CallView] Local stream received"),p.value&&(p.value.srcObject=i)},h.onCallEnded=()=>{console.log("[CallView] Call ended"),e.value=!1,n.value="ended",r.value=null,d.value&&(d.value.srcObject=null),p.value&&(p.value.srcObject=null),setTimeout(()=>{n.value="idle",a.value=!1,t.value=!1},100)},h.onIncomingCall=i=>{console.log("[CallView] Incoming call:",i),r.value=i.peerId,o.value=i.callType},h.onIceCandidate=i=>{console.log("[CallView] ICE candidate:",i)};function z(){const i=h.toggleMute();a.value=i,w.info(i?"麦克风已关闭":"麦克风已开启")}function q(){const i=h.toggleVideo();t.value=i,w.info(i?"摄像头已关闭":"摄像头已开启")}async function V(){try{await h.hangup(),w.info("通话已结束")}catch(i){console.error("[CallView] Error hanging up:",i),w.error("挂断失败")}}H(()=>{e.value&&V()});const b=_(()=>o.value==="video"),$=_(()=>b.value&&e.value),x=_(()=>{switch(n.value){case"calling":return"正在呼叫...";case"incall":return"通话中";case"ended":return"通话已结束";default:return"没有进行中的通话"}});return(i,D)=>{const O=E("a-button"),N=E("a-empty");return c(),C("div",ne,[e.value?(c(),C("div",le,[b.value?(c(),C("video",{key:0,ref_key:"remoteVideoRef",ref:d,autoplay:"",playsinline:"",class:"remote-video","aria-label":"Remote video"},null,512)):(c(),C("div",oe,[f("div",re,[s(g(M))]),f("div",ie,[D[0]||(D[0]=f("p",null,"语音通话中",-1)),f("p",ce,P(r.value),1)])])),$.value?(c(),C("video",{key:2,ref_key:"localVideoRef",ref:p,autoplay:"",muted:"",playsinline:"",class:W(["local-video",{"video-off":t.value}]),"aria-label":"Local video"},null,2)):k("",!0),f("div",se,P(x.value),1),f("div",de,[s(O,{type:a.value?"primary":"default",shape:"circle",size:"large",onClick:z,"aria-label":a.value?"Unmute microphone":"Mute microphone",class:"control-button"},{icon:v(()=>[a.value?(c(),m(g(R),{key:0})):(c(),m(g(M),{key:1}))]),_:1},8,["type","aria-label"]),b.value?(c(),m(O,{key:0,type:t.value?"primary":"default",shape:"circle",size:"large",onClick:q,"aria-label":t.value?"Turn on camera":"Turn off camera",class:"control-button"},{icon:v(()=>[t.value?(c(),m(g(I),{key:0})):(c(),m(g(G),{key:1}))]),_:1},8,["type","aria-label"])):k("",!0),s(O,{type:"primary",danger:"",shape:"circle",size:"large",onClick:V,"aria-label":"Hang up",class:"control-button hangup-button"},{icon:v(()=>[s(g(S))]),_:1})])])):(c(),C("div",ue,[s(N,{description:"没有进行中的通话"},{default:v(()=>[s(g(S),{style:{"font-size":"64px",color:"#ccc"}})]),_:1})]))])}}}),me=J(he,[["__scopeId","data-v-5068c9a2"]]);export{me as default};
