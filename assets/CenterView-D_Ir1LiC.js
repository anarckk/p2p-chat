import{u as Ie,b as Ce,c as be,a as we}from"./index-C-8vRXzh.js";import{c as s,I as ne,d as De,o as Oe,v as Z,k,w as n,e as p,f as m,h as u,t as D,i as v,a as C,g as x,P as Pe,n as K,j as w,q as ee,R as ke,r as S,s as H}from"./index-Dh8JxQg4.js";import{_ as xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./PeerHttpUtil-D_AN6ldI.js";import"./networkLogDB-BlD6FS5Z.js";var Se={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M168 504.2c1-43.7 10-86.1 26.9-126 17.3-41 42.1-77.7 73.7-109.4S337 212.3 378 195c42.4-17.9 87.4-27 133.9-27s91.5 9.1 133.8 27A341.5 341.5 0 01755 268.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.7 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c0-6.7-7.7-10.5-12.9-6.3l-56.4 44.1C765.8 155.1 646.2 92 511.8 92 282.7 92 96.3 275.6 92 503.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8zm756 7.8h-60c-4.4 0-7.9 3.5-8 7.8-1 43.7-10 86.1-26.9 126-17.3 41-42.1 77.8-73.7 109.4A342.45 342.45 0 01512.1 856a342.24 342.24 0 01-243.2-100.8c-9.9-9.9-19.2-20.4-27.8-31.4l60.2-47a8 8 0 00-3-14.1l-175.7-43c-5-1.2-9.9 2.6-9.9 7.7l-.7 181c0 6.7 7.7 10.5 12.9 6.3l56.4-44.1C258.2 868.9 377.8 932 512.2 932c229.2 0 415.5-183.7 419.8-411.8a8 8 0 00-8-8.2z"}}]},name:"sync",theme:"outlined"};function te(d){for(var r=1;r<arguments.length;r++){var l=arguments[r]!=null?Object(arguments[r]):{},i=Object.keys(l);typeof Object.getOwnPropertySymbols=="function"&&(i=i.concat(Object.getOwnPropertySymbols(l).filter(function(y){return Object.getOwnPropertyDescriptor(l,y).enumerable}))),i.forEach(function(y){Me(d,y,l[y])})}return d}function Me(d,r,l){return r in d?Object.defineProperty(d,r,{value:l,enumerable:!0,configurable:!0,writable:!0}):d[r]=l,d}var V=function(r,l){var i=te({},r,l.attrs);return s(ne,te({},i,{icon:Se}),null)};V.displayName="SyncOutlined";V.inheritAttrs=!1;var $e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M824.2 699.9a301.55 301.55 0 00-86.4-60.4C783.1 602.8 812 546.8 812 484c0-110.8-92.4-201.7-203.2-200-109.1 1.7-197 90.6-197 200 0 62.8 29 118.8 74.2 155.5a300.95 300.95 0 00-86.4 60.4C345 754.6 314 826.8 312 903.8a8 8 0 008 8.2h56c4.3 0 7.9-3.4 8-7.7 1.9-58 25.4-112.3 66.7-153.5A226.62 226.62 0 01612 684c60.9 0 118.2 23.7 161.3 66.8C814.5 792 838 846.3 840 904.3c.1 4.3 3.7 7.7 8 7.7h56a8 8 0 008-8.2c-2-77-33-149.2-87.8-203.9zM612 612c-34.2 0-66.4-13.3-90.5-37.5a126.86 126.86 0 01-37.5-91.8c.3-32.8 13.4-64.5 36.3-88 24-24.6 56.1-38.3 90.4-38.7 33.9-.3 66.8 12.9 91 36.6 24.8 24.3 38.4 56.8 38.4 91.4 0 34.2-13.3 66.3-37.5 90.5A127.3 127.3 0 01612 612zM361.5 510.4c-.9-8.7-1.4-17.5-1.4-26.4 0-15.9 1.5-31.4 4.3-46.5.7-3.6-1.2-7.3-4.5-8.8-13.6-6.1-26.1-14.5-36.9-25.1a127.54 127.54 0 01-38.7-95.4c.9-32.1 13.8-62.6 36.3-85.6 24.7-25.3 57.9-39.1 93.2-38.7 31.9.3 62.7 12.6 86 34.4 7.9 7.4 14.7 15.6 20.4 24.4 2 3.1 5.9 4.4 9.3 3.2 17.6-6.1 36.2-10.4 55.3-12.4 5.6-.6 8.8-6.6 6.3-11.6-32.5-64.3-98.9-108.7-175.7-109.9-110.9-1.7-203.3 89.2-203.3 199.9 0 62.8 28.9 118.8 74.2 155.5-31.8 14.7-61.1 35-86.5 60.4-54.8 54.7-85.8 126.9-87.8 204a8 8 0 008 8.2h56.1c4.3 0 7.9-3.4 8-7.7 1.9-58 25.4-112.3 66.7-153.5 29.4-29.4 65.4-49.8 104.7-59.7 3.9-1 6.5-4.7 6-8.7z"}}]},name:"team",theme:"outlined"};function re(d){for(var r=1;r<arguments.length;r++){var l=arguments[r]!=null?Object(arguments[r]):{},i=Object.keys(l);typeof Object.getOwnPropertySymbols=="function"&&(i=i.concat(Object.getOwnPropertySymbols(l).filter(function(y){return Object.getOwnPropertyDescriptor(l,y).enumerable}))),i.forEach(function(y){ze(d,y,l[y])})}return d}function ze(d,r,l){return r in d?Object.defineProperty(d,r,{value:l,enumerable:!0,configurable:!0,writable:!0}):d[r]=l,d}var F=function(r,l){var i=re({},r,l.attrs);return s(ne,re({},i,{icon:$e}),null)};F.displayName="TeamOutlined";F.inheritAttrs=!1;const Te={class:"center-container"},qe={class:"query-section"},Ue={key:0,class:"empty-state"},Ee={key:1,class:"refresh-duration"},Re=De({__name:"CenterView",setup(d){const r=Ie(),l=Ce(),i=be(),y=we(),{isConnected:q,isBootstrap:ae,queryDiscoveredDevices:oe,addDiscoveredDevice:Q,sendDiscoveryNotification:G,queryUsername:se,checkOnline:J,requestAllDeviceLists:le,requestDeviceList:ce,tryBecomeBootstrap:ie}=y,_=S(""),L=S(!1),U=S(!1),E=S(""),W=S("info"),R=S(new Map);function N(t){return R.value.get(t)||{refreshing:!1,duration:null,error:!1}}const M=H(()=>i.allDevices),$=H(()=>r.userInfo.username?{peerId:r.myPeerId||"connecting...",username:r.userInfo.username||r.myPeerId||"Unknown",avatar:r.userInfo.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0}:null),X=H(()=>{const t=[...M.value];if($.value){const e=$.value.peerId,o=t.findIndex(a=>a.peerId===e);o>=0?t[o]={...t[o],username:$.value.username,avatar:$.value.avatar,lastHeartbeat:Date.now()}:t.push($.value)}return t.sort((e,o)=>o.lastHeartbeat-e.lastHeartbeat)});function ue(t){return l.getContact(t)!==void 0}Oe(async()=>{await r.loadUserInfo(),console.log("[Center] User info loaded:",{username:r.userInfo.username,avatarLength:r.userInfo.avatar?.length||0,myPeerId:r.myPeerId});const t=performance.now();console.log("[Center-Performance] ===== 组件开始挂载 ====="),console.log("[Center-Performance] Timestamp:",Date.now());const e=(I,O)=>{const B=performance.now(),j=Math.round(B-t);console.log(`[Center-Performance] [${I}] +${j}ms ${O}`),window.__performanceLogs||(window.__performanceLogs=[]),window.__performanceLogs.push({timestamp:Date.now(),phase:I,duration:j,message:O})};e("start","组件开始挂载"),e("before-bootstrap","准备成为宇宙启动者");const o=performance.now();ie(),e("after-bootstrap",`成为宇宙启动者调用完成 (耗时 ${Math.round(performance.now()-o)}ms)`),e("before-load-devices","准备加载设备列表");const a=performance.now();await i.loadDevices(),e("after-load-devices",`设备列表加载完成 (耗时 ${Math.round(performance.now()-a)}ms)`),e("before-load-chat","准备加载聊天数据");const f=performance.now();l.loadFromStorage(),e("after-load-chat",`聊天数据加载完成 (耗时 ${Math.round(performance.now()-f)}ms)`),e("before-heartbeat","准备启动心跳定时器");const h=r.loadDeviceCheckInterval(),b=r.loadDeviceCheckTimeout()*1e3;i.startHeartbeatTimer(async I=>{if(!q.value)return!1;try{return await J(I.peerId,b)}catch(O){return console.error("[Center] Heartbeat check error:",O),!1}},h),e("after-heartbeat","心跳定时器启动完成");const z=()=>{console.log("[Center] Discovery devices updated, refreshing..."),i.updateOnlineStatus(),i.allDevices.forEach(I=>{l.getContact(I.peerId)&&l.setContactOnline(I.peerId,I.isOnline??!1)})};window.addEventListener("discovery-devices-updated",z),e("event-listeners","事件监听器注册完成"),Z(()=>{window.removeEventListener("discovery-devices-updated",z)}),e("complete","组件挂载完成");const T=Math.round(performance.now()-t);console.log("[Center-Performance] ===== 组件挂载完成 ====="),console.log("[Center-Performance] 总耗时:",T,"ms")}),Z(()=>{});function g(t,e="info"){E.value=t,W.value=e}function A(){E.value=""}async function Y(){if(A(),!_.value.trim()){g("请输入要查询的 Peer ID","warning");return}L.value=!0;try{const t=await oe(_.value.trim());t.length>0?g(`从 ${_.value} 发现了 ${t.length} 个设备`,"success"):g("未发现任何设备","info"),_.value=""}catch(t){console.error("[Center] Query error:",t),g("查询失败","error")}finally{L.value=!1}}async function de(){if(A(),!_.value.trim()){g("请输入要添加的 Peer ID","warning");return}const t=_.value.trim();if(M.value.find(a=>a.peerId===t)){g("该设备已存在","info"),console.log("[Center] Device already exists, but sending discovery notification anyway:",t);try{await G(t),console.log("[Center] Discovery notification sent to existing device:",t)}catch(a){console.error("[Center] Error sending discovery notification:",a)}_.value="";return}console.log("[Center] Adding device manually:",t);const o={peerId:t,username:t,avatar:null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0};Q(o),console.log("[Center] Device added to store:",o),console.log("[Center] Sending discovery notification to:",t);try{await G(t),console.log("[Center] Discovery notification sent to:",t)}catch(a){console.error("[Center] Error sending discovery notification:",a)}g(`已添加设备 ${t}`,"success"),_.value="",ce(t).then(a=>{a.length>0&&console.log("[Center] Discovered "+a.length+" devices from "+t)}).catch(a=>{console.error("[Center] Request device list error:",a)}),console.log("[Center] About to query username for:",t),se(t).then(a=>{a?(console.log("[Center] Received user info:",a),o.username=a.username,o.avatar=a.avatar,Q({...o}),i.addOrUpdateDevice({...o})):(console.warn("[Center] Failed to get user info for:",t),i.addOrUpdateDevice({...o}))}).catch(a=>{console.error("[Center] Error querying username:",a)})}function fe(t){l.createChat(t.peerId,t.username),g(`已添加 ${t.username} 到聊天列表`,"success")}function pe(t){A(),navigator.clipboard.writeText(t),g("已复制到剪贴板","success")}async function ve(){A(),console.log("[Center] Refresh discovery started"),U.value=!0;try{q.value||console.warn("[Center] Not connected to Peer Server"),r.myPeerId||console.warn("[Center] User info not set");const t=M.value.filter(o=>o.peerId!==r.myPeerId);t.forEach(o=>{R.value.set(o.peerId,{refreshing:!0,duration:null,error:!1})});try{await le()}catch(o){console.error("[Center] Request device lists error:",o)}U.value=!1;const e=t.map(async o=>{const a=Date.now(),f=o.peerId;try{const h=await J(f),b=Date.now()-a;return i.updateDeviceOnlineStatus(f,h),l.getContact(f)&&l.setContactOnline(f,h),R.value.set(f,{refreshing:!1,duration:b,error:!1}),console.log("[Center] Device "+f+" checked: online="+h+", duration="+b+"ms"),{peerId:f,isOnline:h,duration:b}}catch(h){return console.warn("[Center] Check online failed for "+f+":",h),R.value.set(f,{refreshing:!1,duration:null,error:!0}),{peerId:f,isOnline:!1,duration:null}}});Promise.allSettled(e).then(o=>{const a=o.filter(f=>f.status==="fulfilled"&&f.value.isOnline).length;console.log("[Center] Refresh completed: "+M.value.length+" devices, "+a+" online"),g(`已刷新，当前发现 ${M.value.length} 个设备，其中 ${a} 个在线`,"success")})}catch(t){console.error("[Center] Refresh error:",t),g("刷新失败","error"),U.value=!1}}return(t,e)=>{const o=p("a-descriptions-item"),a=p("a-typography-text"),f=p("a-badge"),h=p("a-descriptions"),b=p("a-card"),z=p("a-col"),T=p("a-button"),I=p("a-input"),O=p("a-input-group"),B=p("a-typography-paragraph"),j=p("a-empty"),me=p("a-avatar"),P=p("a-tag"),ye=p("a-card-meta"),ge=p("a-list-item"),_e=p("a-list"),he=p("a-row");return m(),k("div",Te,[s(he,{gutter:[16,16]},{default:n(()=>[s(z,{xs:24,md:8},{default:n(()=>[s(b,{title:"我的信息",bordered:!1},{default:n(()=>[s(h,{column:1},{default:n(()=>[s(o,{label:"用户名"},{default:n(()=>[u(D(v(r).userInfo.username||"未设置"),1)]),_:1}),s(o,{label:"我的 Peer ID"},{default:n(()=>[v(r).myPeerId?(m(),C(a,{key:0,copyable:"","copy-text":v(r).myPeerId,onCopy:e[0]||(e[0]=c=>pe(v(r).myPeerId))},{default:n(()=>[u(D(v(r).myPeerId),1)]),_:1},8,["copy-text"])):(m(),C(a,{key:1,type:"secondary"},{default:n(()=>[...e[2]||(e[2]=[u("连接中...",-1)])]),_:1}))]),_:1}),s(o,{label:"连接状态"},{default:n(()=>[s(f,{status:v(q)?"processing":"error",text:v(q)?"已连接":"未连接"},null,8,["status","text"])]),_:1})]),_:1})]),_:1})]),_:1}),s(z,{xs:24,md:16},{default:n(()=>[s(b,{title:"发现中心",bordered:!1},{extra:n(()=>[s(T,{size:"small",loading:U.value,onClick:ve,"aria-label":"refresh-discovery"},{icon:n(()=>[s(v(ke))]),default:n(()=>[e[3]||(e[3]=u(" 刷新 ",-1))]),_:1},8,["loading"])]),default:n(()=>[x("div",qe,[s(O,{compact:""},{default:n(()=>[s(I,{value:_.value,"onUpdate:value":e[1]||(e[1]=c=>_.value=c),placeholder:"输入对方 Peer ID 进行查询或添加",style:{width:"calc(100% - 130px)"},onPressEnter:Y},null,8,["value"]),s(T,{type:"primary",onClick:Y,loading:L.value,"aria-label":"query-devices-button"},{default:n(()=>[...e[4]||(e[4]=[u(" 查询 ",-1)])]),_:1},8,["loading"]),s(T,{onClick:de,"aria-label":"add-device"},{icon:n(()=>[s(v(Pe))]),default:n(()=>[e[5]||(e[5]=u(" 添加 ",-1))]),_:1})]),_:1}),E.value?(m(),k("div",{key:0,class:K(["inline-message",`inline-message-${W.value}`])},D(E.value),3)):w("",!0)]),X.value.length===0?(m(),k("div",Ue,[s(j,{description:"暂无在线设备"},{image:n(()=>[s(v(F),{style:{"font-size":"64px",color:"#ccc"}})]),default:n(()=>[s(B,{type:"secondary"},{default:n(()=>[...e[6]||(e[6]=[x("p",null,"去中心化发现中心使用说明：",-1)])]),_:1}),s(B,{type:"secondary",style:{"font-size":"12px"}},{default:n(()=>[...e[7]||(e[7]=[u(' 1. 输入已知设备的 Peer ID 点击"查询"，向该设备询问它已发现的设备',-1),x("br",null,null,-1),u(' 2. 输入新的 Peer ID 点击"添加"，直接将该设备添加到发现列表',-1),x("br",null,null,-1),u(" 3. 每个节点都是发现中心，可以互相询问已发现的设备",-1),x("br",null,null,-1),u(" 4. 设备列表会自动保存，刷新页面后依然保留",-1),x("br",null,null,-1),u(" 5. 超过3天未在线的设备会自动删除 ",-1)])]),_:1})]),_:1})])):(m(),C(_e,{key:1,"data-source":X.value,grid:{gutter:16,xs:1,sm:2,md:2}},{renderItem:n(({item:c})=>[s(ge,null,{default:n(()=>[s(b,{hoverable:"",size:"small",class:K(["device-card",{"is-me":c.peerId===v(r).myPeerId||c.peerId==="connecting...","is-offline":!c.isOnline}]),onClick:Ae=>c.peerId!==v(r).myPeerId&&c.peerId!=="connecting..."&&fe(c)},{actions:n(()=>[s(f,{status:c.isOnline?"processing":"default",text:c.isOnline?"在线":"离线"},null,8,["status","text"])]),default:n(()=>[s(ye,null,{avatar:n(()=>[s(me,{src:c.avatar||void 0,size:48},{default:n(()=>[u(D(c.username.charAt(0).toUpperCase()),1)]),_:2},1032,["src"])]),title:n(()=>[u(D(c.username)+" ",1),c.peerId===v(r).myPeerId?(m(),C(P,{key:0,color:"blue",size:"small"},{default:n(()=>[...e[8]||(e[8]=[u("我",-1)])]),_:1})):w("",!0),c.peerId===v(r).myPeerId&&v(ae)?(m(),C(P,{key:1,color:"purple",size:"small"},{default:n(()=>[...e[9]||(e[9]=[u("宇宙启动者",-1)])]),_:1})):w("",!0),c.peerId!==v(r).myPeerId&&c.peerId!=="connecting..."?(m(),k(ee,{key:2},[c.isBootstrap?(m(),C(P,{key:0,color:"purple",size:"small"},{default:n(()=>[...e[10]||(e[10]=[u("宇宙启动者",-1)])]),_:1})):w("",!0),ue(c.peerId)?(m(),C(P,{key:1,color:"green",size:"small"},{default:n(()=>[...e[11]||(e[11]=[u("聊天中",-1)])]),_:1})):w("",!0),c.isOnline?(m(),C(P,{key:2,color:"success",size:"small"},{default:n(()=>[...e[12]||(e[12]=[u("在线",-1)])]),_:1})):(m(),C(P,{key:3,color:"default",size:"small"},{default:n(()=>[...e[13]||(e[13]=[u("离线",-1)])]),_:1})),c.isOnline?(m(),k(ee,{key:4},[N(c.peerId).refreshing?(m(),C(v(V),{key:0,spin:"",style:{color:"#1890ff","margin-left":"4px"}})):N(c.peerId).duration!==null?(m(),k("span",Ee,D(N(c.peerId).duration)+"ms",1)):w("",!0)],64)):w("",!0)],64)):w("",!0)]),description:n(()=>[s(a,{type:"secondary",style:{"font-size":"12px"}},{default:n(()=>[u(D(c.peerId),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["class","onClick"])]),_:2},1024)]),_:1},8,["data-source"]))]),_:1})]),_:1})]),_:1})])}}}),Ve=xe(Re,[["__scopeId","data-v-3534fa8b"]]);export{Ve as default};
