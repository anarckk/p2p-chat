import{c as N}from"./logger-CUkP4sI-.js";import{c as d,I as _,d as B,a as F,k as C,g as f,i as g,t as D,n as H,j as k,w as v,b as m,r as h,Q as w,s as b,e as P,f as c}from"./index-BIiVSCif.js";import{V as Q}from"./VideoCameraOutlined-Q8oxBAPt.js";import{P as E}from"./PhoneOutlined-DBF9JMui.js";import{_ as W}from"./_plugin-vue_export-helper-DlAUqK2U.js";var G={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M682 455V311l-76 76v68c-.1 50.7-42 92.1-94 92a95.8 95.8 0 01-52-15l-54 55c29.1 22.4 65.9 36 106 36 93.8 0 170-75.1 170-168z"}},{tag:"path",attrs:{d:"M833 446h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254-63 0-120.7-23-165-61l-54 54a334.01 334.01 0 00179 81v102H326c-13.9 0-24.9 14.3-25 32v36c.1 4.4 2.9 8 6 8h408c3.2 0 6-3.6 6-8v-36c0-17.7-11-32-25-32H547V782c165.3-17.9 294-157.9 294-328 0-4.4-3.6-8-8-8zm13.1-377.7l-43.5-41.9a8 8 0 00-11.2.1l-129 129C634.3 101.2 577 64 511 64c-93.9 0-170 75.3-170 168v224c0 6.7.4 13.3 1.2 19.8l-68 68A252.33 252.33 0 01258 454c-.2-4.4-3.8-8-8-8h-60c-4.4 0-8 3.6-8 8 0 53 12.5 103 34.6 147.4l-137 137a8.03 8.03 0 000 11.3l42.7 42.7c3.1 3.1 8.2 3.1 11.3 0L846.2 79.8l.1-.1c3.1-3.2 3-8.3-.2-11.4zM417 401V232c0-50.6 41.9-92 94-92 46 0 84.1 32.3 92.3 74.7L417 401z"}}]},name:"audio-muted",theme:"outlined"};function A(o){for(var e=1;e<arguments.length;e++){var a=arguments[e]!=null?Object(arguments[e]):{},t=Object.keys(a);typeof Object.getOwnPropertySymbols=="function"&&(t=t.concat(Object.getOwnPropertySymbols(a).filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable}))),t.forEach(function(n){J(o,n,a[n])})}return o}function J(o,e,a){return e in o?Object.defineProperty(o,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):o[e]=a,o}var O=function(e,a){var t=A({},e,a.attrs);return d(_,A({},t,{icon:G}),null)};O.displayName="AudioMutedOutlined";O.inheritAttrs=!1;var X={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M842 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254S258 594.3 258 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 168.7 126.6 307.9 290 327.6V884H326.7c-13.7 0-24.7 14.3-24.7 32v36c0 4.4 2.8 8 6.2 8h407.6c3.4 0 6.2-3.6 6.2-8v-36c0-17.7-11-32-24.7-32H548V782.1c165.3-18 294-158 294-328.1zM512 624c93.9 0 170-75.2 170-168V232c0-92.8-76.1-168-170-168s-170 75.2-170 168v224c0 92.8 76.1 168 170 168zm-94-392c0-50.6 41.9-92 94-92s94 41.4 94 92v224c0 50.6-41.9 92-94 92s-94-41.4-94-92V232z"}}]},name:"audio",theme:"outlined"};function T(o){for(var e=1;e<arguments.length;e++){var a=arguments[e]!=null?Object(arguments[e]):{},t=Object.keys(a);typeof Object.getOwnPropertySymbols=="function"&&(t=t.concat(Object.getOwnPropertySymbols(a).filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable}))),t.forEach(function(n){Y(o,n,a[n])})}return o}function Y(o,e,a){return e in o?Object.defineProperty(o,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):o[e]=a,o}var M=function(e,a){var t=T({},e,a.attrs);return d(_,T({},t,{icon:X}),null)};M.displayName="AudioOutlined";M.inheritAttrs=!1;var Z={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M368 724H252V608c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v116H72c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h116v116c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V788h116c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8z"}},{tag:"path",attrs:{d:"M912 302.3L784 376V224c0-35.3-28.7-64-64-64H128c-35.3 0-64 28.7-64 64v352h72V232h576v560H448v72h272c35.3 0 64-28.7 64-64V648l128 73.7c21.3 12.3 48-3.1 48-27.6V330c0-24.6-26.7-40-48-27.7zM888 625l-104-59.8V458.9L888 399v226z"}},{tag:"path",attrs:{d:"M320 360c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H208c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h112z"}}]},name:"video-camera-add",theme:"outlined"};function j(o){for(var e=1;e<arguments.length;e++){var a=arguments[e]!=null?Object(arguments[e]):{},t=Object.keys(a);typeof Object.getOwnPropertySymbols=="function"&&(t=t.concat(Object.getOwnPropertySymbols(a).filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable}))),t.forEach(function(n){U(o,n,a[n])})}return o}function U(o,e,a){return e in o?Object.defineProperty(o,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):o[e]=a,o}var R=function(e,a){var t=j({},e,a.attrs);return d(_,j({},t,{icon:Z}),null)};R.displayName="VideoCameraAddOutlined";R.inheritAttrs=!1;class K{peerConnection=null;dataChannel=null;localStream=null;remoteStream=null;currentPeerId=null;currentCallType="audio";callState="idle";configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};pendingIceCandidates=[];currentRequestId=null;async initiateCall(e,a,t){if(console.log("[CallManager] Initiating call:",{peerId:e,callType:a}),N.info(`Initiating ${a} call to ${e.substring(0,8)}...`),this.callState!=="idle")throw new Error("Already in a call");this.currentPeerId=e,this.currentCallType=a,this.callState="calling",this.pendingIceCandidates=[];try{a==="data_channel"?await this.initiateDataChannelCall(e,t):await this.initiateMediaStreamCall(e,a,t)}catch(n){throw console.error("[CallManager] Failed to initiate call:",n),this.cleanup(),this.callState="idle",n}}async initiateMediaStreamCall(e,a,t){this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:a==="video"}),this.onLocalStream&&this.onLocalStream(this.localStream),this.peerConnection=new RTCPeerConnection(this.configuration),this.peerConnection.onicecandidate=l=>{l.candidate&&(console.log("[CallManager] ICE candidate generated:",l.candidate),this.handleIceCandidate(l.candidate,e,t))},this.peerConnection.onconnectionstatechange=()=>{console.log("[CallManager] Connection state:",this.peerConnection?.connectionState),this.peerConnection?.connectionState==="disconnected"&&(console.warn("[CallManager] Connection disconnected"),this.hangup())},this.peerConnection.ontrack=l=>{console.log("[CallManager] Received remote track:",l.track.kind);const i=l.streams[0];i&&(this.remoteStream=i,this.onRemoteStream&&this.onRemoteStream(i))},this.localStream.getTracks().forEach(l=>{this.peerConnection.addTrack(l,this.localStream)});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),console.log("[CallManager] Local description set");try{const i=await t.getRRManager().sendRequest(e,"call_request",{callType:a,offer:n},3e4);if(i?.accepted&&i?.answer)console.log("[CallManager] Call accepted"),await this.handleAnswer(i.answer);else throw new Error("Call rejected")}catch(l){throw console.error("[CallManager] Failed to send call request:",l),this.cleanup(),l}}async initiateDataChannelCall(e,a){console.log("[CallManager] Initiating data channel call"),this.peerConnection=new RTCPeerConnection(this.configuration),this.dataChannel=this.peerConnection.createDataChannel("voice-call",{ordered:!1}),this.setupDataChannel(),this.peerConnection.onicecandidate=n=>{n.candidate&&(console.log("[CallManager] ICE candidate generated:",n.candidate),this.handleIceCandidate(n.candidate,e,a))};const t=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(t);try{const l=await a.getRRManager().sendRequest(e,"call_request",{callType:"data_channel",offer:t},3e4);if(l?.accepted&&l?.answer)await this.handleAnswer(l.answer);else throw new Error("Call rejected")}catch(n){throw console.error("[CallManager] Failed to send data channel call request:",n),this.cleanup(),n}}async answerCall(e,a,t,n){if(console.log("[CallManager] Answering call:",{peerId:e,callType:t}),this.callState!=="idle")throw new Error("Already in a call");this.currentPeerId=e,this.currentCallType=t,this.callState="incall",this.pendingIceCandidates=[];try{t==="data_channel"?await this.answerDataChannelCall(e,a,n):await this.answerMediaStreamCall(e,a,t,n)}catch(l){throw console.error("[CallManager] Failed to answer call:",l),this.cleanup(),this.callState="idle",l}}async answerMediaStreamCall(e,a,t,n){this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:t==="video"}),this.onLocalStream&&this.onLocalStream(this.localStream),this.peerConnection=new RTCPeerConnection(this.configuration),this.peerConnection.onicecandidate=i=>{i.candidate&&(console.log("[CallManager] ICE candidate generated:",i.candidate),this.handleIceCandidate(i.candidate,e,n))},this.peerConnection.onconnectionstatechange=()=>{console.log("[CallManager] Connection state:",this.peerConnection?.connectionState),this.peerConnection?.connectionState==="disconnected"&&(console.warn("[CallManager] Connection disconnected"),this.hangup())},this.peerConnection.ontrack=i=>{console.log("[CallManager] Received remote track:",i.track.kind);const s=i.streams[0];s&&(this.remoteStream=s,this.onRemoteStream&&this.onRemoteStream(s))},this.localStream.getTracks().forEach(i=>{this.peerConnection.addTrack(i,this.localStream)}),await this.peerConnection.setRemoteDescription(new RTCSessionDescription(a)),console.log("[CallManager] Remote description set");const l=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(l),console.log("[CallManager] Local description set");try{await n.getRRManager().sendRequest(e,"call_response",{accepted:!0,answer:l})}catch(i){throw console.error("[CallManager] Failed to send answer:",i),this.cleanup(),i}}async answerDataChannelCall(e,a,t){console.log("[CallManager] Answering data channel call"),this.peerConnection=new RTCPeerConnection(this.configuration),this.peerConnection.ondatachannel=l=>{console.log("[CallManager] Data channel received"),this.dataChannel=l.channel,this.setupDataChannel()},this.peerConnection.onicecandidate=l=>{l.candidate&&(console.log("[CallManager] ICE candidate generated:",l.candidate),this.handleIceCandidate(l.candidate,e,t))},await this.peerConnection.setRemoteDescription(new RTCSessionDescription(a));const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n);try{await t.getRRManager().sendRequest(e,"call_response",{accepted:!0,answer:n})}catch(l){throw console.error("[CallManager] Failed to send data channel answer:",l),this.cleanup(),l}}async handleAnswer(e){if(!this.peerConnection)throw new Error("No active peer connection");if(await this.peerConnection.setRemoteDescription(new RTCSessionDescription(e)),console.log("[CallManager] Remote description set"),this.callState="incall",this.onIceCandidate&&this.currentPeerId){for(const a of this.pendingIceCandidates)this.onIceCandidate({candidate:a,peerId:this.currentPeerId});this.pendingIceCandidates=[]}}handleIceCandidate(e,a,t){(this.callState==="calling"||this.callState==="incall")&&(this.onIceCandidate?this.onIceCandidate({candidate:e,peerId:a}):this.pendingIceCandidates.push(e))}async addIceCandidate(e){if(!this.peerConnection){console.warn("[CallManager] No peer connection to add ICE candidate");return}if(this.peerConnection.remoteDescription===null){console.log("[CallManager] Waiting for remote description before adding ICE candidate"),this.pendingIceCandidates.push(e);return}try{await this.peerConnection.addIceCandidate(new RTCIceCandidate(e)),console.log("[CallManager] ICE candidate added successfully")}catch(a){console.error("[CallManager] Error adding ICE candidate:",a)}}setupDataChannel(){this.dataChannel&&(this.dataChannel.onopen=()=>{console.log("[CallManager] Data channel opened"),this.onDataChannelOpen&&this.onDataChannelOpen()},this.dataChannel.onmessage=e=>{console.log("[CallManager] Data channel message:",e.data),this.onDataChannelMessage&&this.onDataChannelMessage(e.data)},this.dataChannel.onclose=()=>{console.log("[CallManager] Data channel closed")})}sendDataChannelData(e){this.dataChannel&&this.dataChannel.readyState==="open"?typeof e=="string"?this.dataChannel.send(e):this.dataChannel.send(e):console.warn("[CallManager] Data channel not ready")}async hangup(){console.log("[CallManager] Hanging up"),this.cleanup(),this.callState="ended",this.onCallEnded&&this.onCallEnded(),setTimeout(()=>{this.callState="idle"},100)}async rejectCall(e,a){console.log("[CallManager] Rejecting call from:",e);try{await a.getRRManager().sendRequest(e,"call_response",{accepted:!1})}catch(t){console.error("[CallManager] Failed to send rejection:",t)}}toggleMute(){if(!this.localStream)return!1;const e=this.localStream.getAudioTracks()[0];return e?(e.enabled=!e.enabled,!e.enabled):!1}toggleVideo(){if(!this.localStream)return!1;const e=this.localStream.getVideoTracks()[0];return e?(e.enabled=!e.enabled,!e.enabled):!1}cleanup(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.remoteStream=null,this.currentPeerId=null,this.currentCallType="audio",this.pendingIceCandidates=[],this.currentRequestId=null}getLocalStream(){return this.localStream}getRemoteStream(){return this.remoteStream}isInCall(){return this.callState==="incall"}getCallState(){return this.callState}getCurrentPeerId(){return this.currentPeerId}getCurrentCallType(){return this.currentCallType}onRemoteStream;onLocalStream;onCallEnded;onIceCandidate;onDataChannelOpen;onDataChannelMessage;onIncomingCall}const u=new K,ee={class:"call-container"},ae={key:0,class:"call-active"},te={key:1,class:"audio-call-placeholder"},ne={class:"audio-icon"},le={class:"audio-info"},oe={class:"peer-id"},ie={class:"call-status"},re={class:"call-controls"},ce={key:1,class:"call-idle"},se=B({__name:"CallView",setup(o){const e=h(!1),a=h(!1),t=h(!1),n=h("idle"),l=h("audio"),i=h(null),s=h(),p=h();u.onRemoteStream=r=>{console.log("[CallView] Remote stream received"),s.value&&(s.value.srcObject=r),e.value=!0,n.value="incall"},u.onLocalStream=r=>{console.log("[CallView] Local stream received"),p.value&&(p.value.srcObject=r)},u.onCallEnded=()=>{console.log("[CallView] Call ended"),e.value=!1,n.value="ended",i.value=null,s.value&&(s.value.srcObject=null),p.value&&(p.value.srcObject=null),setTimeout(()=>{n.value="idle",a.value=!1,t.value=!1},100)},u.onIncomingCall=r=>{console.log("[CallView] Incoming call:",r),i.value=r.peerId,l.value=r.callType},u.onIceCandidate=r=>{console.log("[CallView] ICE candidate:",r)};function L(){const r=u.toggleMute();a.value=r,w.info(r?"麦克风已关闭":"麦克风已开启")}function z(){const r=u.toggleVideo();t.value=r,w.info(r?"摄像头已关闭":"摄像头已开启")}async function I(){try{await u.hangup(),w.info("通话已结束")}catch(r){console.error("[CallView] Error hanging up:",r),w.error("挂断失败")}}F(()=>{e.value&&I()});const S=b(()=>l.value==="video"),q=b(()=>S.value&&e.value),x=b(()=>{switch(n.value){case"calling":return"正在呼叫...";case"incall":return"通话中";case"ended":return"通话已结束";default:return"没有进行中的通话"}});return(r,V)=>{const y=P("a-button"),$=P("a-empty");return c(),C("div",ee,[e.value?(c(),C("div",ae,[S.value?(c(),C("video",{key:0,ref_key:"remoteVideoRef",ref:s,autoplay:"",playsinline:"",class:"remote-video","aria-label":"Remote video"},null,512)):(c(),C("div",te,[f("div",ne,[d(g(M))]),f("div",le,[V[0]||(V[0]=f("p",null,"语音通话中",-1)),f("p",oe,D(i.value),1)])])),q.value?(c(),C("video",{key:2,ref_key:"localVideoRef",ref:p,autoplay:"",muted:"",playsinline:"",class:H(["local-video",{"video-off":t.value}]),"aria-label":"Local video"},null,2)):k("",!0),f("div",ie,D(x.value),1),f("div",re,[d(y,{type:a.value?"primary":"default",shape:"circle",size:"large",onClick:L,"aria-label":a.value?"Unmute microphone":"Mute microphone",class:"control-button"},{icon:v(()=>[a.value?(c(),m(g(O),{key:0})):(c(),m(g(M),{key:1}))]),_:1},8,["type","aria-label"]),S.value?(c(),m(y,{key:0,type:t.value?"primary":"default",shape:"circle",size:"large",onClick:z,"aria-label":t.value?"Turn on camera":"Turn off camera",class:"control-button"},{icon:v(()=>[t.value?(c(),m(g(R),{key:0})):(c(),m(g(Q),{key:1}))]),_:1},8,["type","aria-label"])):k("",!0),d(y,{type:"primary",danger:"",shape:"circle",size:"large",onClick:I,"aria-label":"Hang up",class:"control-button hangup-button"},{icon:v(()=>[d(g(E))]),_:1})])])):(c(),C("div",ce,[d($,{description:"没有进行中的通话"},{default:v(()=>[d(g(E),{style:{"font-size":"64px",color:"#ccc"}})]),_:1})]))])}}}),fe=W(se,[["__scopeId","data-v-5068c9a2"]]);export{fe as default};
