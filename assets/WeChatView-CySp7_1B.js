import{u as Pe,b as ze,c as Ie,a as xe}from"./index-Iins0OtH.js";import{f as Se,M as ne}from"./fileHelper-QisBlk73.js";import{c as s,I as E,d as ke,o as Me,a as Le,x as ae,k as h,w as m,g as u,i as d,t as y,j as z,q as R,m as se,n as k,b as M,r as b,s as re,e as g,f as p,h as L,P as ie,L as De,D as je,y as oe,z as le,p as $e,C as Ve,E as Ue,A as Be,B as v}from"./index-BJRbWrZn.js";import{_ as Ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./PeerHttpUtil-CtNkY1zz.js";import"./networkLogDB-BlD6FS5Z.js";var We={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M456 231a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0z"}}]},name:"more",theme:"outlined"};function ce(i){for(var n=1;n<arguments.length;n++){var e=arguments[n]!=null?Object(arguments[n]):{},l=Object.keys(e);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(e).filter(function(f){return Object.getOwnPropertyDescriptor(e,f).enumerable}))),l.forEach(function(f){Fe(i,f,e[f])})}return i}function Fe(i,n,e){return n in i?Object.defineProperty(i,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[n]=e,i}var H=function(n,e){var l=ce({},n,e.attrs);return s(E,ce({},l,{icon:We}),null)};H.displayName="MoreOutlined";H.inheritAttrs=!1;var Te={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 632H136v-39.9l138.5-164.3 150.1 178L658.1 489 888 761.6V792zm0-129.8L664.2 396.8c-3.2-3.8-9-3.8-12.2 0L424.6 666.4l-144-170.7c-3.2-3.8-9-3.8-12.2 0L136 652.7V232h752v430.2zM304 456a88 88 0 100-176 88 88 0 000 176zm0-116c15.5 0 28 12.5 28 28s-12.5 28-28 28-28-12.5-28-28 12.5-28 28-28z"}}]},name:"picture",theme:"outlined"};function ue(i){for(var n=1;n<arguments.length;n++){var e=arguments[n]!=null?Object(arguments[n]):{},l=Object.keys(e);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(e).filter(function(f){return Object.getOwnPropertyDescriptor(e,f).enumerable}))),l.forEach(function(f){Ae(i,f,e[f])})}return i}function Ae(i,n,e){return n in i?Object.defineProperty(i,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[n]=e,i}var q=function(n,e){var l=ue({},n,e.attrs);return s(E,ue({},l,{icon:Te}),null)};q.displayName="PictureOutlined";q.inheritAttrs=!1;var Ne={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M931.4 498.9L94.9 79.5c-3.4-1.7-7.3-2.1-11-1.2a15.99 15.99 0 00-11.7 19.3l86.2 352.2c1.3 5.3 5.2 9.6 10.4 11.3l147.7 50.7-147.6 50.7c-5.2 1.8-9.1 6-10.3 11.3L72.2 926.5c-.9 3.7-.5 7.6 1.2 10.9 3.9 7.9 13.5 11.1 21.5 7.2l836.5-417c3.1-1.5 5.6-4.1 7.2-7.1 3.9-8 .7-17.6-7.2-21.6zM170.8 826.3l50.3-205.6 295.2-101.3c2.3-.8 4.2-2.6 5-5 1.4-4.2-.8-8.7-5-10.2L221.1 403 171 198.2l628 314.9-628.2 313.2z"}}]},name:"send",theme:"outlined"};function de(i){for(var n=1;n<arguments.length;n++){var e=arguments[n]!=null?Object(arguments[n]):{},l=Object.keys(e);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(e).filter(function(f){return Object.getOwnPropertyDescriptor(e,f).enumerable}))),l.forEach(function(f){Re(i,f,e[f])})}return i}function Re(i,n,e){return n in i?Object.defineProperty(i,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[n]=e,i}var G=function(n,e){var l=de({},n,e.attrs);return s(E,de({},l,{icon:Ne}),null)};G.displayName="SendOutlined";G.inheritAttrs=!1;var He={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M912 302.3L784 376V224c0-35.3-28.7-64-64-64H128c-35.3 0-64 28.7-64 64v576c0 35.3 28.7 64 64 64h592c35.3 0 64-28.7 64-64V648l128 73.7c21.3 12.3 48-3.1 48-27.6V330c0-24.6-26.7-40-48-27.7zM712 792H136V232h576v560zm176-167l-104-59.8V458.9L888 399v226zM208 360h112c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H208c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8z"}}]},name:"video-camera",theme:"outlined"};function me(i){for(var n=1;n<arguments.length;n++){var e=arguments[n]!=null?Object(arguments[n]):{},l=Object.keys(e);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(e).filter(function(f){return Object.getOwnPropertyDescriptor(e,f).enumerable}))),l.forEach(function(f){qe(i,f,e[f])})}return i}function qe(i,n,e){return n in i?Object.defineProperty(i,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[n]=e,i}var J=function(n,e){var l=me({},n,e.attrs);return s(E,me({},l,{icon:He}),null)};J.displayName="VideoCameraOutlined";J.inheritAttrs=!1;const Ge={class:"wechat-container"},Je={class:"wechat-layout"},Qe={key:0,class:"contacts-panel"},Xe={class:"contacts-header"},Ye={class:"user-info"},Ze={class:"username"},Ke={class:"header-actions"},et={class:"contacts-list"},tt={key:0,class:"empty-contacts"},nt=["onClick"],at={class:"contact-info"},st={class:"contact-top"},rt={class:"contact-name"},it={class:"contact-time"},ot={class:"contact-bottom"},lt={class:"contact-peer-id"},ct={class:"chat-header"},ut={class:"chat-header-left"},dt={class:"chat-title"},mt={class:"chat-name"},ft={class:"chat-status"},pt={key:0,class:"empty-messages"},vt={key:1,class:"messages-list"},ht={class:"message-content"},gt={class:"message-meta"},_t={class:"message-time"},yt={class:"input-area"},Ct={class:"input-toolbar"},bt={class:"input-row"},Ot={key:1,class:"no-chat-selected"},wt=ke({__name:"WeChatView",setup(i){const n=Pe(),e=ze(),l=Ie(),f=xe(),{sendMessageWithRetry:Q}=f,D=b(!1),x=b(""),j=b(""),$=b(null),S=b(!1),V=b(null),U=b(""),X=b("info"),O=re(()=>{if(!e.currentChatPeerId)return null;const a=e.getContact(e.currentChatPeerId);if(!a)return null;const t=l.getDevice(e.currentChatPeerId);return{...a,online:t?t.isOnline:a.online,lastSeen:t?t.lastHeartbeat:a.lastSeen}}),Y=re(()=>e.sortedContacts.map(t=>{const r=l.getDevice(t.peerId);return r?{...t,online:r.isOnline??!1,lastSeen:r.lastHeartbeat,username:r.username,avatar:r.avatar}:t}).sort((t,r)=>t.online!==r.online?t.online?-1:1:r.lastSeen-t.lastSeen));Me(()=>{e.loadFromStorage(),l.loadDevices(),W(),window.addEventListener("resize",W)}),Le(()=>{window.removeEventListener("resize",W)});function W(){S.value=window.innerWidth<768}ae(()=>e.currentChatPeerId,a=>{a&&(e.loadMessages(a),Z())}),ae(()=>e.currentMessages.length,()=>{le(()=>Z())});function Z(){$.value&&($.value.scrollTop=$.value.scrollHeight)}function fe(a){e.setCurrentChat(a)}function pe(){e.setCurrentChat(null)}function w(a,t="info"){U.value=a,X.value=t}function K(){U.value=""}async function ve(){const a=j.value.trim();if(K(),!a){w("请输入对方 Peer ID","warning");return}if(a===n.myPeerId){w("不能与自己聊天","warning");return}const t=a;console.log("[WeChat] Creating chat with peerId:",a,"username:",t),await e.createChat(a,t),e.setCurrentChat(a),D.value=!1,j.value="",w("已创建聊天","success"),console.log("[WeChat] Chat created successfully")}function he(){if(!e.currentChatPeerId)return;const t=O.value?.username||e.currentChatPeerId;e.deleteChat(e.currentChatPeerId),w(`已删除与 ${t} 的聊天`,"success")}async function ee(){const a=x.value.trim();if(!a||!e.currentChatPeerId)return;console.log("[WeChat] Sending text message:",{to:e.currentChatPeerId,content:a});const t=await Q(e.currentChatPeerId,a,"text");console.log("[WeChat] Message sent with ID:",t),x.value="",await le(),console.log("[WeChat] Current messages count:",e.currentMessages.length)}function B(a){V.value&&a&&V.value.setAttribute("accept",a),V.value?.click()}async function ge(a){const t=a.target,r=t.files?.[0];if(!(!r||!e.currentChatPeerId)){if(K(),r.size>50*1024*1024){w("文件大小不能超过 50MB","warning");return}try{const c=await Se(r);let _,P;if(r.type.startsWith("image/"))try{const I=await _e(r);_={name:r.name,size:r.size,width:I.width,height:I.height,data:c},P="image"}catch(I){console.warn("[Chat] Failed to load image dimensions, treating as file:",I),_={name:r.name,size:r.size,type:r.type,data:c},P="file"}else r.type.startsWith("video/")?(_={name:r.name,size:r.size,data:c},P="video"):(_={name:r.name,size:r.size,type:r.type,data:c},P="file");await Q(e.currentChatPeerId,_,P),w("文件发送成功","success")}catch(c){console.error("[Chat] File send error:",c),w("文件发送失败","error")}t&&(t.value="")}}function _e(a){return new Promise((t,r)=>{const c=new Image,_=URL.createObjectURL(a);c.onload=()=>{URL.revokeObjectURL(_),t({width:c.width,height:c.height})},c.onerror=()=>{URL.revokeObjectURL(_),r(new Error("Failed to load image"))},c.src=_})}function ye(a){const t=a.content;if(typeof t=="string")return;const r=document.createElement("a");r.href=t.data,r.download=t.name,r.click()}function F(a){return a<1024?a+" B":a<1024*1024?(a/1024).toFixed(1)+" KB":(a/(1024*1024)).toFixed(1)+" MB"}function te(a){const t=new Date(a),r=new Date;return t.toDateString()===r.toDateString()?t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):t.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function Ce(a){const{content:t,type:r}=a;if(typeof t=="string")return v("div",{class:"message-text"},t);switch(r){case"image":{const c=t;return v("div",{class:"message-image"},[v("img",{src:c.data,alt:c.name,style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"8px"}}),v("div",{class:"file-info"},[v("span",{class:"file-name"},c.name),v("span",{class:"file-size"},F(c.size))])])}case"video":{const c=t;return v("div",{class:"message-video"},[v("video",{src:c.data,controls:!0,style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"8px"}}),v("div",{class:"file-info"},[v("span",{class:"file-name"},c.name),v("span",{class:"file-size"},F(c.size))])])}case"file":{const c=t;return v("div",{class:"message-file"},[v(oe,{style:{fontSize:"48px",color:"#1890ff"}}),v("div",{class:"file-details"},[v("div",{class:"file-name"},c.name),v("div",{class:"file-size"},F(c.size))]),v("a",{class:"download-link",onClick:()=>ye(a)},"下载")])}default:return v("div",{class:"message-text"},"[不支持的消息类型]")}}return(a,t)=>{const r=g("a-input"),c=g("a-form-item"),_=g("a-typography-text"),P=g("a-form"),I=g("a-modal"),T=g("a-avatar"),C=g("a-button"),A=g("a-empty"),N=g("a-badge"),be=g("a-menu-item"),Oe=g("a-menu"),we=g("a-dropdown");return p(),h("div",Ge,[s(I,{open:D.value,"onUpdate:open":t[1]||(t[1]=o=>D.value=o),title:"新增聊天","ok-text":"创建",onOk:ve},{default:m(()=>[s(P,{layout:"vertical"},{default:m(()=>[s(c,{label:"对方 Peer ID"},{default:m(()=>[s(r,{value:j.value,"onUpdate:value":t[0]||(t[0]=o=>j.value=o),placeholder:"请输入对方的 Peer ID"},null,8,["value"])]),_:1}),s(_,{type:"secondary"},{default:m(()=>[...t[8]||(t[8]=[L(" 提示：在发现中心可以查看和复制其他设备的 Peer ID ",-1)])]),_:1}),U.value?(p(),h("div",{key:0,class:k(["inline-message",`inline-message-${X.value}`])},y(U.value),3)):z("",!0)]),_:1})]),_:1},8,["open"]),u("div",Je,[!S.value||!d(e).currentChatPeerId?(p(),h("div",Qe,[u("div",Xe,[u("div",Ye,[s(T,{src:d(n).userInfo.avatar||void 0,size:40},{default:m(()=>[L(y(d(n).userInfo.username?.charAt(0).toUpperCase()||"U"),1)]),_:1},8,["src"]),u("span",Ze,y(d(n).userInfo.username),1)]),u("div",Ke,[s(C,{type:"text",size:"small","aria-label":"plus",onClick:t[2]||(t[2]=o=>D.value=!0)},{icon:m(()=>[s(d(ie))]),_:1})])]),u("div",et,[Y.value.length===0?(p(),h("div",tt,[s(A,{description:"暂无聊天"},{description:m(()=>[...t[9]||(t[9]=[u("span",{style:{color:"#999"}},"点击 + 号添加聊天，或在发现中心查看可用设备",-1)])]),_:1})])):z("",!0),(p(!0),h(R,null,se(Y.value,o=>(p(),h("div",{key:o.peerId,class:k(["contact-item",{active:d(e).currentChatPeerId===o.peerId}]),onClick:Pt=>fe(o.peerId)},[s(N,{count:o.unreadCount,offset:[-4,4]},{default:m(()=>[s(T,{src:o.avatar||void 0,size:48},{default:m(()=>[L(y(o.username.charAt(0).toUpperCase()),1)]),_:2},1032,["src"])]),_:2},1032,["count"]),u("div",at,[u("div",st,[u("span",rt,y(o.username),1),u("span",it,y(te(o.lastSeen)),1)]),u("div",ot,[u("span",lt,y(o.peerId.slice(0,8))+"..."+y(o.peerId.slice(-4)),1),s(N,{status:o.online?"processing":"default",text:o.online?"在线":"离线"},null,8,["status","text"])])])],10,nt))),128))])])):z("",!0),!S.value||d(e).currentChatPeerId?(p(),h("div",{key:1,class:k(["chat-panel",{"mobile-show":S.value&&d(e).currentChatPeerId}])},[O.value?(p(),h(R,{key:0},[u("div",ct,[u("div",ut,[S.value?(p(),M(C,{key:0,type:"text",onClick:pe,class:"back-button"},{icon:m(()=>[s(d(De))]),_:1})):z("",!0),s(T,{src:O.value.avatar||void 0,size:36},{default:m(()=>[L(y(O.value.username.charAt(0).toUpperCase()),1)]),_:1},8,["src"]),u("div",dt,[u("div",mt,y(O.value.username),1),u("div",ft,[s(N,{status:O.value.online?"processing":"default",text:O.value.online?"在线":"离线"},null,8,["status","text"])])])]),s(we,null,{overlay:m(()=>[s(Oe,null,{default:m(()=>[s(be,{onClick:he,style:{color:"#ff4d4f"}},{default:m(()=>[s(d(je)),t[10]||(t[10]=L(" 删除聊天 ",-1))]),_:1})]),_:1})]),default:m(()=>[s(C,{type:"text",size:"small","aria-label":"more"},{icon:m(()=>[s(d(H))]),_:1})]),_:1})]),u("div",{ref_key:"messagesContainer",ref:$,class:"messages-area"},[d(e).currentMessages.length===0?(p(),h("div",pt,[s(A,{description:"开始聊天吧"},{default:m(()=>[s(d(ne),{style:{"font-size":"48px",color:"#ddd"}})]),_:1})])):(p(),h("div",vt,[(p(!0),h(R,null,se(d(e).currentMessages,o=>(p(),h("div",{key:o.id,class:k(["message-item",{"is-self":o.from===d(n).myPeerId}])},[u("div",ht,[(p(),M($e(Ce(o))))]),u("div",gt,[o.from===d(n).myPeerId?(p(),h("span",{key:0,class:k(["message-status",`message-status-${o.status}`])},[o.status==="delivered"?(p(),M(d(Ve),{key:0})):o.status==="failed"?(p(),M(d(Ue),{key:1})):o.status==="sending"?(p(),M(d(Be),{key:2})):z("",!0)],2)):z("",!0),u("span",_t,y(te(o.timestamp)),1)])],2))),128))]))],512),u("div",yt,[u("div",Ct,[s(C,{type:"text",size:"small","aria-label":"upload-file",onClick:t[3]||(t[3]=o=>B())},{icon:m(()=>[s(d(ie))]),_:1}),s(C,{type:"text",size:"small","aria-label":"upload-image",onClick:t[4]||(t[4]=o=>B("image/*"))},{icon:m(()=>[s(d(q))]),_:1}),s(C,{type:"text",size:"small","aria-label":"upload-file",onClick:t[5]||(t[5]=o=>B())},{icon:m(()=>[s(d(oe))]),_:1}),s(C,{type:"text",size:"small","aria-label":"upload-video",onClick:t[6]||(t[6]=o=>B("video/*"))},{icon:m(()=>[s(d(J))]),_:1}),u("input",{ref_key:"fileInputRef",ref:V,type:"file","data-testid":"file-input",style:{display:"none"},onChange:ge},null,544)]),u("div",bt,[s(r,{value:x.value,"onUpdate:value":t[7]||(t[7]=o=>x.value=o),placeholder:"输入消息...",size:"large",onPressEnter:ee},{suffix:m(()=>[s(C,{type:"primary",disabled:!x.value.trim(),onClick:ee,"aria-label":"send"},{icon:m(()=>[s(d(G))]),_:1},8,["disabled"])]),_:1},8,["value"])])])],64)):(p(),h("div",Ot,[s(A,{description:"选择一个联系人开始聊天"},{image:m(()=>[s(d(ne),{style:{"font-size":"64px",color:"#ccc"}})]),_:1})]))],2)):z("",!0)])])}}}),Lt=Ee(wt,[["__scopeId","data-v-55ba447c"]]);export{Lt as default};
