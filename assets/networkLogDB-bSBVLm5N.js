class i{static instance;db=null;DB_NAME="P2PNetworkLogDB";DB_VERSION=1;STORE_NAME="network_logs";constructor(){}static getInstance(){return i.instance||(i.instance=new i),i.instance}async init(){return new Promise((e,t)=>{const s=indexedDB.open(this.DB_NAME,this.DB_VERSION);s.onerror=()=>{t(new Error("Failed to open IndexedDB"))},s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=r=>{const n=r.target.result;if(!n.objectStoreNames.contains(this.STORE_NAME)){const o=n.createObjectStore(this.STORE_NAME,{keyPath:"id",autoIncrement:!0});o.createIndex("timestamp","timestamp",{unique:!1}),o.createIndex("direction","direction",{unique:!1}),o.createIndex("peerId","peerId",{unique:!1}),o.createIndex("businessType","businessType",{unique:!1})}}})}async addLog(e){return this.db||await this.init(),new Promise((t,s)=>{const o=this.db.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME).add(e);o.onsuccess=()=>{t(o.result)},o.onerror=()=>{s(new Error("Failed to add log"))}})}async getLogs(e=1,t=20){return this.db||await this.init(),new Promise((s,r)=>{const o=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME),b=o.index("timestamp"),a=[],u=o.count();u.onsuccess=()=>{const d=u.result,l=b.openCursor(null,"prev");let E=(e-1)*t,h=0;l.onsuccess=w=>{const c=w.target.result;if(c){if(E>0){E--,c.continue();return}h<t?(a.push(c.value),h++,c.continue()):s({data:a,total:d,page:e,pageSize:t})}else s({data:a,total:d,page:e,pageSize:t})},l.onerror=()=>{r(new Error("Failed to query logs"))}},u.onerror=()=>{r(new Error("Failed to count logs"))}})}async clearAllLogs(){return this.db||await this.init(),new Promise((e,t)=>{const n=this.db.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME).clear();n.onsuccess=()=>{e()},n.onerror=()=>{t(new Error("Failed to clear logs"))}})}async getTotalCount(){return this.db||await this.init(),new Promise((e,t)=>{const n=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).count();n.onsuccess=()=>{e(n.result)},n.onerror=()=>{t(new Error("Failed to count logs"))}})}}const S=i.getInstance();export{S as n};
