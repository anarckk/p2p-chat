const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/keyExchangeStore-Bj6DK5Uu.js","assets/index-BIiVSCif.js","assets/index-CH9t_CQJ.css"])))=>i.map(i=>d[i]);
import{K as _e,r as T,s as ne,_ as be}from"./index-BIiVSCif.js";import{i as H,a as b,u as k,P as Ce,g as se,$ as re}from"./PeerHttpUtil-m59UYI9_.js";import{n as Re}from"./networkLogDB-BlD6FS5Z.js";import{cryptoManager as ae}from"./cryptoManager-B5C1ax7v.js";import{c as P}from"./logger-CUkP4sI-.js";const U="p2p_messages_",Q="p2p_contacts",oe="p2p_pending_messages",J="message_content_migrated_to_indexeddb",E=_e("chat",()=>{const e=T(new Map),o=T(new Map),n=T(new Map),s=T(null);async function c(a,u,p){const g=`msg-content-${a}`;await H.set("messages",{id:g,messageId:a,type:u,content:p})}async function i(a){const u=`msg-content-${a}`;return(await H.get("messages",u))?.content||null}async function r(){if(!localStorage.getItem(J))try{console.log("[ChatStore] 开始检查消息数据迁移...");const u=localStorage.getItem(Q);if(!u){localStorage.setItem(J,"true");return}const p=JSON.parse(u),g=Object.keys(p);let S=0;for(const M of g){const ee=localStorage.getItem(U+M);if(!ee)continue;const te=JSON.parse(ee);let L=0;for(const O of te)if(O.type==="image"||O.type==="file"||O.type==="video"){const V=O.content;V&&V.length>1e3&&(await c(O.id,O.type,V),O.content=`msg-content-${O.id}`,L++)}L>0&&(localStorage.setItem(U+M,JSON.stringify(te)),S+=L)}localStorage.setItem(J,"true"),console.log(`[ChatStore] 消息数据迁移完成！迁移了 ${S} 条大型消息内容`)}catch(u){console.error("[ChatStore] 消息数据迁移失败:",u)}}const t=ne(()=>s.value?e.value.get(s.value)||[]:[]),d=ne(()=>Array.from(o.value.values()).sort((a,u)=>a.online!==u.online?a.online?-1:1:u.lastSeen-a.lastSeen));async function f(){await r();const a=localStorage.getItem("p2p_current_chat");if(a)try{s.value=a}catch(g){console.error("[ChatStore] Failed to load current chat:",g)}const u=localStorage.getItem(Q);if(u)try{const g=JSON.parse(u);o.value=new Map(Object.entries(g));for(const[S]of o.value)await I(S)}catch(g){console.error("[ChatStore] Failed to load contacts:",g)}const p=localStorage.getItem(oe);if(p)try{const g=JSON.parse(p);n.value=new Map(Object.entries(g))}catch(g){console.error("[ChatStore] Failed to load pending messages:",g)}}function l(){const a=Object.fromEntries(o.value);localStorage.setItem(Q,JSON.stringify(a))}function w(){const a=Object.fromEntries(n.value);localStorage.setItem(oe,JSON.stringify(a))}async function h(a){const u=e.value.get(a)||[],p=[];for(const g of u)if(g.type==="image"||g.type==="file"||g.type==="video"){const S=g.content;S.startsWith("msg-content-")?p.push(g):S&&S.length>1e3?(await c(g.id,g.type,S),p.push({...g,content:`msg-content-${g.id}`})):p.push(g)}else p.push(g);localStorage.setItem(U+a,JSON.stringify(p))}async function I(a){const u=localStorage.getItem(U+a);if(u)try{const p=JSON.parse(u),g=[];for(const S of p)if((S.type==="image"||S.type==="file"||S.type==="video")&&typeof S.content=="string"&&S.content.startsWith("msg-content-")){const M=await i(S.id);g.push({...S,content:M||S.content})}else g.push(S);return e.value.set(a,g),g}catch(p){console.error("[ChatStore] Failed to load messages:",p)}return[]}function v(a){const u=o.value.get(a.peerId);u?o.value.set(a.peerId,{...u,...a}):o.value.set(a.peerId,a),l()}function m(a){return o.value.get(a)}function C(a,u){const p=o.value.get(a);p&&(p.online=u,p.lastSeen=Date.now(),l())}async function D(a,u){e.value.has(a)||e.value.set(a,[]),e.value.get(a).push(u),await h(a);const p=o.value.get(a);if(p&&u.from===a){const g=e.value.get(a);g&&g.length>0&&(p.lastSeen=u.timestamp),l()}}async function R(a,u,p){const g=e.value.get(a);if(g){const S=g.find(M=>M.id===u);S&&(S.status=p,p==="delivered"&&(S.deliveredAt=Date.now()),await h(a))}}function $(a){for(const u of e.value.values()){const p=u.find(g=>g.id===a);if(p)return p}return null}function K(a){n.value.set(a.id,a),w()}function ye(a){n.value.delete(a),w()}function me(a){const u=n.value.get(a);return u?(u.retryCount++,w(),!(u.maxRetries!==void 0&&u.retryCount>u.maxRetries)):!1}function Pe(a){return Array.from(n.value.values()).filter(u=>u.to===a)}function Z(a){const u=Array.from(n.value.entries()).filter(([,p])=>p.to===a);return u.forEach(([p])=>n.value.delete(p)),w(),u.map(([,p])=>p)}async function he(a,u=a){o.value.has(a)||v({peerId:a,username:u,avatar:null,online:!1,lastSeen:Date.now(),unreadCount:0,chatVersion:0}),await I(a);const p=e.value.get(a);if(!p||p.length===0){const g={id:`system-${a}-${Date.now()}`,from:a,to:"system",content:"",timestamp:Date.now(),status:"delivered",type:"system"};await D(a,g)}}async function we(a){o.value.delete(a),e.value.delete(a);const u=localStorage.getItem(U+a);if(u)try{const p=JSON.parse(u);for(const g of p)(g.type==="image"||g.type==="file"||g.type==="video")&&await H.delete("messages",`msg-content-${g.id}`)}catch(p){console.error("[ChatStore] Failed to clean up IndexedDB messages:",p)}localStorage.removeItem(U+a),l(),Z(a),s.value===a&&(s.value=null)}function De(a){if(s.value=a,a){localStorage.setItem("p2p_current_chat",a);const u=o.value.get(a);u&&(u.unreadCount=0,l())}else localStorage.removeItem("p2p_current_chat")}function Se(a){const u=o.value.get(a);u&&s.value!==a&&(u.unreadCount++,l())}function Ie(){return Array.from(o.value.values()).reduce((a,u)=>a+u.unreadCount,0)}return{messages:e,contacts:o,pendingMessages:n,currentChatPeerId:s,currentMessages:t,sortedContacts:d,loadFromStorage:f,loadMessages:I,addOrUpdateContact:v,getContact:m,setContactOnline:C,addMessage:D,updateMessageStatus:R,getMessageById:$,addPendingMessage:K,removePendingMessage:ye,incrementRetryCount:me,getPendingMessagesForPeer:Pe,clearPendingMessagesForPeer:Z,createChat:he,deleteChat:we,setCurrentChat:De,incrementUnread:Se,getTotalUnread:Ie}});let _=null;function j(e){_=e}let ce=null;function x(e){ce=e}const y={message:null,discoveryResponse:null,discoveryNotification:null,discoveryNotificationRequest:null,usernameQuery:null,usernameResponse:null,onlineCheckQuery:null,onlineCheckRequest:null,onlineCheckResponse:null,userInfoQuery:null,userInfoResponse:null,userInfoUpdate:null,relayMessage:null,relayResponse:null,networkAccelerationStatus:null,deviceListRequest:null,deviceListResponse:null},F=new Set;let G=null,ie=!1;function le(e){G=e}function ue(e){ie=e}const q=T(!1),N=T(!1);async function B(e){const o=_,n=b(),s=E();if(!o)return null;P.sync.requestInfo({to:e});try{const c=await o.queryUserInfo(e);if(c){console.log("[Peer] Got user info for "+e+": "+JSON.stringify({username:c.username,version:c.version}));const i=n.getDevice(e);n.addOrUpdateDevice({peerId:e,username:c.username,avatar:c.avatar,lastHeartbeat:Date.now(),firstDiscovered:i?.firstDiscovered||Date.now(),userInfoVersion:c.version});const r=s.getContact(e);return r&&s.addOrUpdateContact({...r,username:c.username,avatar:c.avatar,lastSeen:Date.now()}),c}}catch(c){console.error("[Peer] Request user info error:",c)}return null}async function ke(e){const o=_,n=b();if(!o)return[];try{P.discovery.add({peerId:e});const s=await o.queryDiscoveredDevices(e);return s.length>0&&n.addDevices(s),s}catch(s){return console.error("[Peer] Query discovered devices error:",s),[]}}function Oe(){const e=_;return e?e.getDiscoveredDevices():[]}function qe(){return b().allDevices}function Ee(e){const o=_,n=b();o&&(o.addDiscoveredDevice(e),n.addOrUpdateDevice(e))}async function Me(e){const o=_,n=k();if(!o){console.warn("[Peer] sendDiscoveryNotification: peerInstance is null");return}try{console.log("[Peer] Sending discovery notification to:",e,"username:",n.userInfo.username),P.discovery.notify({to:e,username:n.userInfo.username}),await o.sendDiscoveryNotification(e,n.userInfo.username||"",n.userInfo.avatar,n.userInfo.version||0),console.log("[Peer] Discovery notification sent successfully to:",e)}catch(s){console.error("[Peer] Send discovery notification error:",s)}}async function Ue(e){const o=_;if(!o)return console.warn("[Peer] queryUsername: peerInstance is null"),null;try{console.log("[Peer] Querying username for:",e),P.discovery.query({from:e});const n=await o.queryUsername(e);return console.log("[Peer] Query username result:",n),n}catch(n){return console.error("[Peer] Query username error: "+String(n)),null}}async function Te(e,o=5e3){const n=_,s=k();if(!n)return!1;try{P.heartbeat.check({to:e,version:s.userInfo.version});const c=await n.checkOnline(e,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version,o);return c!==null&&c.isOnline?(P.heartbeat.online({from:e}),!0):(c!==null&&!c.isOnline&&P.heartbeat.offline({peerId:e}),c!==null&&c.isOnline)}catch(c){return console.error("[Peer] Check online error: "+String(c)),P.heartbeat.offline({peerId:e}),!1}}async function A(e){const o=_,n=b();if(!o)return[];P.deviceDiscovery.requestSent({to:e});try{const s=await o.requestDeviceList(e);return s.length>0&&n.addDevices(s),s}catch(s){return console.error("[Peer] Request device list error:",s),[]}}async function xe(){const e=_,o=b();if(!e)return;const n=o.allDevices;console.log("[Peer] Requesting device lists from "+n.length+" devices");const s=n.map(c=>A(c.peerId));await Promise.allSettled(s)}async function Ne(){const e=_,o=k(),n=b();if(!e)return;const s=n.allDevices,{username:c,avatar:i,version:r}=o.userInfo;console.log("[Peer] Broadcasting user info update to",s.length,"devices:",{username:c,version:r});const t=s.map(d=>d.isOnline?e.sendUserInfoUpdate(d.peerId,c,i,r).catch(f=>{console.warn("[Peer] Failed to send user info update to",d.peerId,f)}):Promise.resolve());await Promise.allSettled(t),console.log("[Peer] User info update broadcast completed")}async function de(e,o){const n=b(),s=n.getDevice(e);if(s)if(s.publicKey&&s.publicKey!==o){console.warn("[Peer] Public key changed for peer:",e,"- This may indicate a man-in-the-middle attack!");const{useKeyExchangeStore:c}=await be(async()=>{const{useKeyExchangeStore:t}=await import("./keyExchangeStore-Bj6DK5Uu.js");return{useKeyExchangeStore:t}},__vite__mapDeps([0,1,2]));await c().showKeyChangeDialog(e,s.username||e,s.publicKey,o)?(console.log("[Peer] User trusted new public key for:",e),s.publicKey=o,s.keyExchangeStatus="verified"):(console.log("[Peer] User rejected new public key for:",e),s.keyExchangeStatus="compromised"),await n.addOrUpdateDevice(s),console.log("[Peer] Public key decision saved for peer:",e,"status:",s.keyExchangeStatus)}else s.publicKey||(console.log("[Peer] First time receiving public key from:",e),s.publicKey=o,s.keyExchangeStatus="exchanged",await n.addOrUpdateDevice(s));else await n.addOrUpdateDevice({peerId:e,username:"",avatar:null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0,publicKey:o,keyExchangeStatus:"exchanged"})}async function fe(e){const o=_,n=b();if(!o)return console.warn("[Peer] exchangePublicKey: peerInstance is null"),!1;try{if(!ae)return console.error("[Peer] CryptoManager not initialized"),!1;const s=n.getDevice(e);s&&(s.keyExchangeStatus="pending",n.addOrUpdateDevice(s)),console.log("[Peer] Initiating key exchange with:",e),P.info("Key exchange initiated with "+e.substring(0,8)+"...");const c=await o.exchangePublicKey(e);if(c&&c.publicKey){de(e,c.publicKey);const i=n.getDevice(e);return i&&(i.keyExchangeStatus="exchanged",i.lastHeartbeat=Date.now(),n.addOrUpdateDevice(i)),console.log("[Peer] Key exchange completed with:",e),P.info("Key exchange completed with "+e.substring(0,8)+"..."),!0}return!1}catch(s){console.error("[Peer] Key exchange error:",s);const c=n.getDevice(e);return c&&(c.keyExchangeStatus="none",n.addOrUpdateDevice(c)),!1}}function ge(e,o){console.log("[Peer] Received key exchange request from:",e),P.info("Key exchange request from "+e.substring(0,8)+"..."),de(e,o)}function Be(e){const o=E(),n=b(),s=k();y.discoveryResponse=(r,t)=>{if(r.type==="discovery_response"){if(r.devices){const{devices:d}=r;P.discovery.found({peerId:t}),d?.forEach(f=>{e?.addDiscoveredDevice(f)})}else if(r.username){const{username:d,avatar:f}=r;console.log("[Peer] Received discovery response from:",t,"username:",d);const l=n.getDevice(t),w={peerId:t,username:d,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:l?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(w),n.addOrUpdateDevice(w),window.dispatchEvent(new CustomEvent("discovery-devices-updated"))}}},e.onProtocol("discovery_response",y.discoveryResponse);const c=(r,t,d)=>{const f=d?"discovery_notification_request":"discovery_notification";console.log("[Peer] discoveryNotificationHandler called:",{type:r.type,from:t,protocolType:f});const{fromUsername:l,fromAvatar:w,profileVersion:h}=r;P.discovery.notified({from:t,username:l}),console.log("[Peer] Received discovery notification from:",t,"username:",l,"profileVersion:",h,"protocol:",f);const I=n.getDevice(t),v=!I||I.userInfoVersion===void 0||I.userInfoVersion<h,m={peerId:t,username:l,avatar:w,lastHeartbeat:Date.now(),firstDiscovered:I?.firstDiscovered||Date.now(),isOnline:!0,userInfoVersion:h};console.log("[Peer] Adding device to store:",m),e?.addDiscoveredDevice(m),n.addOrUpdateDevice(m),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),o.getContact(t)||(o.createChat(t,l),o.addOrUpdateContact({peerId:t,username:l,avatar:w,online:!0,lastSeen:Date.now(),unreadCount:0,chatVersion:0}));const C=s.userInfo.username||"",D=s.userInfo.avatar;console.log("[Peer] Sending discovery response to:",t,"username:",C,"avatar:",D),e?.sendDiscoveryResponse(t,C,D),v&&I!==void 0&&(console.log("[Peer] Profile version mismatch, requesting latest user info from:",t),B(t)),A(t).then(R=>{R.length>0&&console.log("[Peer] Discovered "+R.length+" devices from "+t)}).catch(R=>{console.error("[Peer] Request device list error after discovery notification:",R)}),fe(t).then(R=>{R?console.log("[Peer] Key exchange completed with:",t):console.warn("[Peer] Key exchange failed with:",t)}).catch(R=>{console.error("[Peer] Key exchange error after discovery notification:",R)})};y.discoveryNotification=(r,t)=>{r.type==="discovery_notification"&&c(r,t,!1)},e.onProtocol("discovery_notification",y.discoveryNotification),y.discoveryNotificationRequest=(r,t)=>{r.type==="discovery_notification_request"&&c(r,t,!0)},e.onProtocol("discovery_notification_request",y.discoveryNotificationRequest),y.usernameQuery=(r,t)=>{r.type==="username_query"&&(P.discovery.query({from:t}),e?.respondUsernameQuery(t,s.userInfo.username||"",s.userInfo.avatar))},e.onProtocol("username_query",y.usernameQuery),y.usernameResponse=(r,t)=>{if(r.type==="username_response"){const{username:d,avatar:f}=r;P.discovery.response({to:t,username:d});const l=o.getContact(t);l&&o.addOrUpdateContact({...l,username:d,avatar:f});const w=n.getDevice(t),h={peerId:t,username:d,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:w?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(h),n.addOrUpdateDevice(h)}},e.onProtocol("username_response",y.usernameResponse);const i=(r,t,d)=>{const f=d?"online_check_request":"online_check_query";console.log("[Peer] onlineCheckRequestHandler called:",{type:r.type,from:t,protocolType:f});let l;d?l=r.payload?.userInfoVersion:l=r.userInfoVersion;const h=n.getDevice(t)?.userInfoVersion||0;P.heartbeat.response({to:t,version:s.userInfo.version}),e?.respondOnlineCheck(t,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version),l!==void 0&&l!==h&&(P.sync.versionMismatch({peerId:t,stored:h,theirs:l}),P.sync.requestInfo({to:t}),B(t))};return y.onlineCheckQuery=(r,t)=>{r.type==="online_check_query"&&i(r,t,!1)},e.onProtocol("online_check_query",y.onlineCheckQuery),y.onlineCheckRequest=(r,t)=>{r.type==="online_check_request"&&i(r,t,!0)},e.onProtocol("online_check_request",y.onlineCheckRequest),y.onlineCheckResponse=(r,t)=>{if(r.type==="online_check_response"){const{isOnline:d,username:f,avatar:l,userInfoVersion:w}=r,h=n.getDevice(t),I=h?.userInfoVersion||0;n.addOrUpdateDevice({peerId:t,username:f,avatar:l,lastHeartbeat:Date.now(),firstDiscovered:h?.firstDiscovered||Date.now(),userInfoVersion:w});const v=o.getContact(t);v&&o.addOrUpdateContact({...v,username:f,avatar:l,online:d,lastSeen:Date.now()}),w!==void 0&&w!==I&&(P.sync.versionMismatch({peerId:t,stored:I,theirs:w}),B(t))}},e.onProtocol("online_check_response",y.onlineCheckResponse),y.userInfoQuery=(r,t)=>{r.type==="user_info_query"&&(P.sync.respondInfo({to:t,version:s.userInfo.version}),e?.respondUserInfo(t,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version))},y.userInfoResponse=(r,t)=>{if(r.type==="user_info_response"){const{username:d,avatar:f,version:l}=r;P.sync.updateInfo({peerId:t,username:d,version:l});const w=n.getDevice(t);n.addOrUpdateDevice({peerId:t,username:d,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:w?.firstDiscovered||Date.now(),userInfoVersion:l});const h=o.getContact(t);h&&o.addOrUpdateContact({...h,username:d,avatar:f,lastSeen:Date.now()})}},e.onProtocol("user_info_query",y.userInfoQuery),e.onProtocol("user_info_response",y.userInfoResponse),y.userInfoUpdate=(r,t)=>{if(r.type==="user_info_update"){const{username:d,avatar:f,version:l}=r;console.log("[Peer] Received user info update from:",t,"username:",d,"version:",l);const w=n.getDevice(t);if(w&&(!w.userInfoVersion||l>w.userInfoVersion)){n.addOrUpdateDevice({...w,username:d,avatar:f,userInfoVersion:l,lastHeartbeat:Date.now()});const h=o.getContact(t);h&&o.addOrUpdateContact({peerId:t,username:d,avatar:f,online:!0,lastSeen:Date.now(),unreadCount:h.unreadCount||0,chatVersion:h.chatVersion||0}),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),console.log("[Peer] User info updated for device:",t)}}},e.onProtocol("user_info_update",y.userInfoUpdate),y.networkAccelerationStatus=(r,t)=>{if(r.type==="network_acceleration_status"){const{enabled:d}=r;console.log("[Peer] Network acceleration status from "+t+": "+d),P.networkAcceleration.statusSync({from:t,enabled:d});const f=n.getDevice(t);f&&n.addOrUpdateDevice({...f,networkAccelerationEnabled:d})}},e.onProtocol("network_acceleration_status",y.networkAccelerationStatus),y.deviceListResponse=r=>{if(r.type==="device_list_response"){const{devices:t}=r;if(P.deviceDiscovery.responseReceived({deviceCount:t?.length||0}),t&&t.length>0){const d=[];t.forEach(f=>{!n.getDevice(f.peerId)&&!F.has(f.peerId)&&d.push(f),e?.addDiscoveredDevice(f)}),n.addDevices(t),d.forEach(f=>{F.add(f.peerId),P.deviceDiscovery.newDevice({peerId:f.peerId,username:f.username}),A(f.peerId).then(l=>{l.length>0&&console.log("[Peer] Discovered "+l.length+" more devices from "+f.peerId)}).catch(l=>{console.error("[Peer] Recursive device list request error:",l)}).finally(()=>{F.delete(f.peerId)})})}}},e.onProtocol("device_list_response",y.deviceListResponse),y.deviceListRequest=(r,t)=>{if(r.type==="device_list_request"){P.deviceDiscovery.requestReceived({from:t});const d=n.allDevices;e?.sendDeviceListResponse(t,d)}},e.onProtocol("device_list_request",y.deviceListRequest),e}function Ae(e){const{from:o,data:n}=e;if(n&&typeof n=="object"&&"id"in n&&"type"in n){$e(o,n);return}}async function $e(e,o){const n=E(),s=b(),{id:c,type:i}=o;P.message.received({from:e,msgType:i,messageId:c});const r=JSON.stringify({id:c,from:e,to:o.to,type:i,timestamp:o.timestamp});console.log("[Peer] Handling chat message:",r.substring(0,200));const t=n.getContact(e);n.setContactOnline(e,!0),await s.updateDeviceOnlineStatus(e,!0),console.log("[Peer] Contact online: "+e),t?(n.incrementUnread(e),console.log("[Peer] Incremented unread for "+e)):n.addOrUpdateContact({peerId:e,username:e,avatar:null,online:!0,lastSeen:Date.now(),unreadCount:1,chatVersion:0}),n.addMessage(e,o),console.log("[Peer] Message saved to store: "+o.id),await Ke(e)}async function Ke(e){const o=E(),n=o.getPendingMessagesForPeer(e);if(n.length!==0){console.log("[Peer] Retrying "+n.length+" pending messages for "+e);for(const s of n)await Y(e,s.id,s.content,s.type)?o.removePendingMessage(s.id):o.incrementRetryCount(s.id)||(o.removePendingMessage(s.id),o.updateMessageStatus(e,s.id,"failed"))}}async function Y(e,o,n,s="text"){const c=_;if(!c)return console.error("[Peer] Peer instance not initialized"),!1;console.log("[Peer] Sending chat message: peerId="+e+", msgId="+o+", type="+s);try{const i=k(),r={id:o,from:i.myPeerId||"",to:e,content:n,timestamp:Date.now(),status:"sending",type:s},t=await c.sendMessage(e,r);return console.log("[Peer] Send result: msgId="+o+", sent="+t),t&&E().updateMessageStatus(e,o,"sending"),t}catch(i){return console.error("[Peer] Send error: "+String(i)),!1}}function ve(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}async function Le(e,o,n="text"){const s=k(),c=E();if(!q.value||!_)throw console.error("[Peer] Peer not connected, cannot send message"),new Error("Peer not connected");const i=ve();P.message.send({to:e,msgType:n,messageId:i});const r={id:i,from:s.myPeerId||"",to:e,content:o,timestamp:Date.now(),status:"sending",type:n};c.addMessage(e,r),console.log("[Peer] Message added to local store: "+r.id);const t=await Y(e,i,o,n);return console.log("[Peer] Send result: messageId="+i+", success="+t),t?c.updateMessageStatus(e,i,"sending"):(c.addPendingMessage({id:i,to:e,content:o,timestamp:Date.now(),retryCount:0,type:n}),c.updateMessageStatus(e,i,"failed")),i}function Ve(){return e=>{Ae(e)}}function X(){G!==null&&(clearTimeout(G),le(null),console.log("[Peer] Auto-reconnect stopped")),ue(!1)}function W(e){ie||(ue(!0),console.log("[Peer] Starting auto-reconnect in 10 seconds..."),le(window.setTimeout(async()=>{console.log("[Peer] Attempting to reconnect...");try{await e(),console.log("[Peer] Reconnected successfully"),X()}catch(o){console.error("[Peer] Reconnect failed:",o),W(e)}},1e4)))}function z(e){return new Promise((o,n)=>{const s=b(),c=performance.now();console.log("[Peer-Performance] ===== Peer 初始化开始 ====="),console.log("[Peer-Performance] Timestamp:",Date.now());const i=(v,m)=>{const C=performance.now(),D=Math.round(C-c);console.log(`[Peer-Performance] [${v}] +${D}ms ${m}`)};i("start","开始初始化 Peer");const r=_;r&&(i("destroy-old","销毁旧的 peerInstance"),r.destroy(),j(null));let t=e.userInfo.peerId;if(t)i("reuse-peerid",`复用已存储的 PeerId: ${t}`);else{i("generate-peerid","生成新的 PeerId");const v=Date.now().toString(36),m=Math.random().toString(36).substring(2,11);t=`peer_${v}_${m}`}console.log("[Peer] Initializing with PeerId:",t,"at",new Date().toISOString());const d={debug:2};i("before-peer-http-util","准备创建 PeerHttpUtil");const f=performance.now(),l=new Ce(t,d);j(l),i("after-peer-http-util",`PeerHttpUtil 创建完成 (耗时 ${Math.round(performance.now()-f)}ms)`),e.loadNetworkLogging()&&(i("network-logging","启用网络日志"),l.setNetworkLogger(!0,async v=>{try{await Re.addLog(v)}catch(m){console.error("[Peer] Failed to save network log:",m)}}),console.log("[Peer] Network logging enabled"));let h=!1;const I=setTimeout(()=>{h||(h=!0,console.error("[Peer] Connection timeout"),i("timeout","连接超时 (30秒)"),q.value=!1,n(new Error("Peer connection timeout")))},3e4);i("before-register-protocols","准备注册协议处理器"),Be(l),i("after-register-protocols","协议处理器注册完成"),i("before-register-message","准备注册消息处理器"),l.on("message",Ve()),i("after-register-message","消息处理器注册完成"),i("before-set-userinfo-provider","准备设置用户信息提供器"),l.setUserInfoProvider({getUsername:()=>e.userInfo.username||"",getAvatar:()=>e.userInfo.avatar,getVersion:()=>e.userInfo.version||0}),i("after-set-userinfo-provider","用户信息提供器设置完成"),i("before-set-publickey-provider","准备设置公钥提供器"),l.setPublicKeyProvider({getPublicKey:()=>{try{return ae.getPublicKey()}catch(v){return console.error("[Peer] Failed to get public key:",v),""}},onPublicKeyReceived:(v,m)=>{console.log("[Peer] Received public key from:",v),ge(v,m)}}),i("after-set-publickey-provider","公钥提供器设置完成"),l.setOnlineChecker(v=>s.getDevice(v)?.isOnline??!1),i("after-set-online-checker","在线检查器设置完成"),l.on("open",v=>{if(!h){const m=performance.now();h=!0,clearTimeout(I),q.value=!0,e.setPeerId(v);const C=Math.round(m-c);console.log("[Peer] Connected with ID:",v),i("connected",`Peer 连接成功! 总耗时: ${C}ms`),console.log("[Peer-Performance] ===== Peer 初始化完成 ====="),X(),o(l)}}),l.on("disconnected",()=>{console.warn("[Peer] Disconnected from Peer Server"),q.value=!1,W(z.bind(null,e))}),l.on("close",()=>{console.warn("[Peer] Peer connection closed"),q.value=!1,W(z.bind(null,e))}),l.on("error",v=>{console.error("[Peer] PeerJS error:",v),!h&&(v?.type==="peer-unavailable"||v?.type==="network"||v?.type==="server-error"||v?.type==="socket-error"||v?.type==="socket-closed")&&(h=!0,clearTimeout(I),q.value=!1,n(new Error(`Peer connection failed: ${v?.type||"unknown error"}`))),v?.type==="peer-unavailable"&&console.log("[Peer] Target peer unavailable:",v)})})}async function He(){const e="UNIVERSE-BOOTSTRAP-PEER-ID-001",o=b(),n=k();console.log("[Peer] Trying to become universe bootstrap with ID:",e),P.universeBootstrap.connecting();const s=performance.now();console.log("[Bootstrap-Performance] ===== 尝试成为宇宙启动者 =====");const c=(i,r)=>{const t=performance.now(),d=Math.round(t-s);console.log(`[Bootstrap-Performance] [${i}] +${d}ms ${r}`)};return c("start","开始尝试成为宇宙启动者"),new Promise(i=>{let r=globalThis.__bootstrapPeerInstance;if(r){console.log("[Peer] Already is bootstrap"),c("already-bootstrap","已经是启动者"),i(!0);return}const t=setTimeout(()=>{P.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! Keeping connection..."),c("success","成为宇宙启动者成功 (3秒超时未被触发)"),N.value=!0,i(!0)},3e3);try{c("before-create-peer","准备创建 Bootstrap Peer");const d=performance.now(),f=se(),l=f.host||"PeerJS Cloud (default)",w=f.port,h=f.path,I=w?`${l}:${w}${h}`:`${l}${h}`;console.log("[Peer-Bootstrap] Connecting to Peer Server:",I),r=new re(e,f),globalThis.__bootstrapPeerInstance=r,x(r),c("after-create-peer",`Bootstrap Peer 创建完成 (耗时 ${Math.round(performance.now()-d)}ms)`),r.on("open",v=>{const m=performance.now();clearTimeout(t),P.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! ID:",v),c("connected",`成为宇宙启动者成功! 连接耗时: ${Math.round(m-s)}ms`),N.value=!0,r.on("connection",C=>{C.on("data",D=>{if(D&&D.type==="device_list_request"){if(console.log("[Peer-Bootstrap] Received device list request from:",D.from,"realPeerId:",D.realPeerId,"username:",D.username),P.deviceDiscovery.requestReceived({from:D.from}),D.realPeerId&&D.realPeerId!==n.myPeerId){const K={peerId:D.realPeerId,username:D.username||D.realPeerId,avatar:D.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0};o.addOrUpdateDevice(K),console.log("[Peer-Bootstrap] Added requester to device list:",D.realPeerId,"username:",D.username)}const R=o.allDevices,$={type:"device_list_response",from:e,to:D.from,timestamp:Date.now(),devices:R,isBootstrap:!0,realPeerId:n.myPeerId,username:n.userInfo.username,avatar:n.userInfo.avatar};C.send($),P.deviceDiscovery.responseSent({to:D.from,deviceCount:R.length}),console.log("[Peer-Bootstrap] Sent device list with",R.length,"devices")}})}),console.log("[Peer-Bootstrap] Listening for device list requests..."),i(!0)}),r.on("error",v=>{if(!r)return;const m=performance.now();clearTimeout(t),P.universeBootstrap.failed({error:v?.type}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Bootstrap already exists, requesting device list..."),c("error",`Bootstrap 已存在，连接失败 (耗时 ${Math.round(m-s)}ms)`),N.value=!1,r&&(r.destroy(),r=null,globalThis.__bootstrapPeerInstance=null,x(null)),pe(e).then(()=>{i(!1)}).catch(()=>{i(!1)})}),r.on("disconnected",()=>{console.warn("[Peer-Bootstrap] Disconnected from server")}),r.on("close",()=>{console.log("[Peer-Bootstrap] Connection closed"),r=null,globalThis.__bootstrapPeerInstance=null,x(null),N.value=!1})}catch(d){clearTimeout(t),console.error("[Peer] Bootstrap error:",d),r=null,globalThis.__bootstrapPeerInstance=null,x(null),i(!1)}})}async function pe(e){const o=b(),n=k();return P.universeBootstrap.requestList({to:e}),new Promise(s=>{let c=null,i=null,r=null,t=null;const d=()=>{i&&(i.close(),i=null),c&&(c.destroy(),c=null),r!==null&&(clearTimeout(r),r=null),t!==null&&(clearInterval(t),t=null)};r=window.setTimeout(()=>{console.warn("[Peer] Request bootstrap device list timeout"),d(),s()},1e4);try{const f=se(),l=f.host||"PeerJS Cloud (default)",w=f.port,h=f.path,I=w?`${l}:${w}${h}`:`${l}${h}`;console.log("[Peer-Bootstrap-Request] Connecting to Peer Server:",I),c=new re(f),c.on("open",v=>{console.log("[Peer] Temp peer connected with ID:",v),i=c.connect(e),i.on("open",()=>{console.log("[Peer] Connected to bootstrap, waiting for myPeerId...");const m=5e3,C=Date.now();t=window.setInterval(()=>{if(n.myPeerId){clearInterval(t),t=null,console.log("[Peer] myPeerId is ready:",n.myPeerId);const D={type:"device_list_request",from:v,to:e,timestamp:Date.now(),realPeerId:n.myPeerId,username:n.userInfo.username,avatar:n.userInfo.avatar};console.log("[Peer] Sending device list request with realPeerId:",n.myPeerId),i.send(D)}else if(Date.now()-C>m){clearInterval(t),t=null,console.warn("[Peer] Timeout waiting for myPeerId, sending request without it...");const D={type:"device_list_request",from:v,to:e,timestamp:Date.now(),realPeerId:null,username:null,avatar:null};i.send(D)}},100)}),i.on("data",m=>{if(m&&m.type==="device_list_response"){if(console.log("[Peer] Received device list from bootstrap:",m.devices?.length||0,"devices"),P.universeBootstrap.responseList({deviceCount:m.devices?.length||0}),m.devices&&m.devices.length>0&&o.addDevices(m.devices),m.isBootstrap&&m.realPeerId){console.log("[Peer] Bootstrap device has real PeerID:",m.realPeerId);const C={peerId:m.realPeerId,username:m.username||"宇宙启动者",avatar:m.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0,isBootstrap:!0,realPeerId:e};o.addOrUpdateDevice(C)}d(),s()}}),i.on("error",m=>{console.error("[Peer] Bootstrap connection error:",m),d(),s()}),i.on("close",()=>{d(),s()})}),c.on("error",v=>{console.error("[Peer] Temp peer error:",v),d(),s()})}catch(f){console.error("[Peer] Request bootstrap device list error:",f),d(),s()}})}function Qe(e){const o=_;o&&(o.setNetworkAccelerationEnabled(e),e?P.networkAcceleration.enabled():P.networkAcceleration.disabled())}function Je(){return _?.getNetworkAccelerationEnabled()||!1}async function Fe(){const e=_;if(!e)return;const n=b().allDevices;e.getNetworkAccelerationEnabled();const s=n.map(c=>c.isOnline?e.sendNetworkAccelerationStatus(c.peerId).catch(()=>{}):Promise.resolve());await Promise.allSettled(s)}function Xe(){E();const e=k(),o=b();function n(){return z(e)}function s(){X();const c=_;c&&(c.destroy(),j(null),y.message=null,y.discoveryResponse=null,y.discoveryNotification=null,y.usernameQuery=null,y.usernameResponse=null,y.onlineCheckQuery=null,y.onlineCheckResponse=null,y.userInfoQuery=null,y.userInfoResponse=null,y.userInfoUpdate=null,y.relayMessage=null,y.relayResponse=null,y.networkAccelerationStatus=null,y.deviceListRequest=null,y.deviceListResponse=null,q.value=!1);const i=ce;i&&(i.destroy(),x(null),console.log("[Peer] Bootstrap connection destroyed"))}return{isConnected:q,isBootstrap:N,init:n,destroy:s,sendChatMessage:Y,sendMessageWithRetry:Le,generateMessageId:ve,queryDiscoveredDevices:ke,getDiscoveredDevices:Oe,getStoredDevices:qe,addDiscoveredDevice:Ee,sendDiscoveryNotification:Me,queryUsername:Ue,checkOnline:Te,requestUserInfo:B,tryBecomeBootstrap:He,requestBootstrapDeviceList:pe,setNetworkAccelerationEnabled:Qe,getNetworkAccelerationEnabled:Je,broadcastNetworkAccelerationStatus:Fe,requestDeviceList:A,requestAllDeviceLists:xe,broadcastUserInfoUpdate:Ne,exchangePublicKey:fe,handleKeyExchangeRequest:ge,deviceStore:o}}export{E as a,Xe as u};
