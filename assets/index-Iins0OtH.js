import{H as Ie,J as ce,r as B,s as Y,_ as Q,K as we}from"./index-BJRbWrZn.js";import{c as _,P as Ne,g as Ee,$ as Re}from"./PeerHttpUtil-CtNkY1zz.js";import{n as Ae}from"./networkLogDB-BlD6FS5Z.js";class $e{db=null;DB_NAME="p2p-chat";DB_VERSION=1;async init(){if(!this.db)return new Promise((n,r)=>{const a=indexedDB.open(this.DB_NAME,this.DB_VERSION);a.onerror=()=>{console.error("[IndexedDB] Failed to open database:",a.error),r(a.error)},a.onsuccess=()=>{this.db=a.result,console.log("[IndexedDB] Database opened successfully"),n()},a.onupgradeneeded=i=>{const l=i.target.result;if(l.objectStoreNames.contains("avatars")||l.createObjectStore("avatars",{keyPath:"id"}).createIndex("peerId","peerId",{unique:!1}),!l.objectStoreNames.contains("messages")){const s=l.createObjectStore("messages",{keyPath:"id"});s.createIndex("toPeerId","toPeerId",{unique:!1}),s.createIndex("timestamp","timestamp",{unique:!1})}l.objectStoreNames.contains("devices")||l.createObjectStore("devices",{keyPath:"peerId"}).createIndex("username","username",{unique:!1}),console.log("[IndexedDB] Object stores created")}})}async ensureInitialized(){this.db||await this.init()}async set(n,r){return await this.ensureInitialized(),new Promise((a,i)=>{const o=this.db.transaction([n],"readwrite").objectStore(n).put(r);o.onsuccess=()=>{console.log(`[IndexedDB] Data saved to ${n}:`,r.id||r.peerId||r.toPeerId),a()},o.onerror=()=>{console.error(`[IndexedDB] Failed to save to ${n}:`,o.error),i(o.error)}})}async get(n,r){return await this.ensureInitialized(),new Promise((a,i)=>{const o=this.db.transaction([n],"readonly").objectStore(n).get(r);o.onsuccess=()=>{a(o.result)},o.onerror=()=>{console.error(`[IndexedDB] Failed to get from ${n}:`,o.error),i(o.error)}})}async getAll(n){return await this.ensureInitialized(),new Promise((r,a)=>{const s=this.db.transaction([n],"readonly").objectStore(n).getAll();s.onsuccess=()=>{r(s.result)},s.onerror=()=>{console.error(`[IndexedDB] Failed to get all from ${n}:`,s.error),a(s.error)}})}async delete(n,r){return await this.ensureInitialized(),new Promise((a,i)=>{const o=this.db.transaction([n],"readwrite").objectStore(n).delete(r);o.onsuccess=()=>{console.log(`[IndexedDB] Data deleted from ${n}:`,r),a()},o.onerror=()=>{console.error(`[IndexedDB] Failed to delete from ${n}:`,o.error),i(o.error)}})}async clearStore(n){return await this.ensureInitialized(),new Promise((r,a)=>{const s=this.db.transaction([n],"readwrite").objectStore(n).clear();s.onsuccess=()=>{console.log(`[IndexedDB] Store ${n} cleared`),r()},s.onerror=()=>{console.error(`[IndexedDB] Failed to clear ${n}:`,s.error),a(s.error)}})}close(){this.db&&(this.db.close(),this.db=null,console.log("[IndexedDB] Database closed"))}}const U=new $e,G="p2p_user_info",W="p2p_user_info_meta",De="p2p_network_acceleration",Pe="p2p_network_logging",_e="p2p_device_check_interval",be="p2p_device_check_timeout",ie="user_avatar_migrated_to_indexeddb",x="my-avatar",L=Ie("user",()=>{const e=B({username:"",avatar:null,peerId:null,version:0}),n=B(!1),r=B(!1),a=B(!1),i=B(20),l=B(5),s=B(null),o=B(null),v=B(!1),f=Y(()=>e.value.peerId);async function u(){await D();let t=localStorage.getItem(W);const c=localStorage.getItem("user_info");if(!t&&c&&(t=c,console.log('[UserStore] Loading from old key "user_info"')),t)try{const d=JSON.parse(t);e.value={username:d.username||"",avatar:null,peerId:d.peerId||null,version:d.version||0},n.value=!!d.username;const P=await U.get("avatars",x);if(P&&P.avatar)e.value.avatar=P.avatar;else{const A=localStorage.getItem(G);if(A)try{const $=JSON.parse(A);$.avatar&&(e.value.avatar=$.avatar,console.log("[UserStore] Loaded avatar from fallback (old localStorage key)"),await U.set("avatars",{id:x,peerId:x,avatar:$.avatar}),console.log("[UserStore] Migrated avatar to IndexedDB"))}catch($){console.error("[UserStore] Failed to load avatar from fallback:",$)}}}catch(d){console.error("[UserStore] Failed to load user info:",d)}const g=n.value;return g&&await N(),g}async function D(){if(!localStorage.getItem(ie))try{const c=localStorage.getItem(G);if(!c){localStorage.setItem(ie,"true");return}const g=JSON.parse(c);console.log("[UserStore] 开始迁移用户数据到混合存储...");const{avatar:d,...P}=g;localStorage.setItem(W,JSON.stringify(P)),d&&(await U.set("avatars",{id:x,peerId:x,avatar:d}),console.log("[UserStore] 用户头像已移至 IndexedDB")),localStorage.removeItem(G),localStorage.setItem(ie,"true"),console.log("[UserStore] 用户数据迁移完成！")}catch(c){console.error("[UserStore] 迁移失败:",c)}}async function w(t){const c=t.username!==void 0&&t.username!==e.value.username,g=t.avatar!==void 0&&t.avatar!==e.value.avatar&&!((t.avatar===null||t.avatar===void 0)&&e.value.avatar===null),d=c||g,{avatar:P,peerId:A,...$}=t;e.value={...e.value,...$,...A!=null?{peerId:A}:{}},d&&(e.value.version+=1),P!==void 0&&(e.value.avatar=P,P?await U.set("avatars",{id:x,peerId:x,avatar:P}):await U.delete("avatars",x));const{avatar:se,...z}=e.value;localStorage.setItem(W,JSON.stringify(z)),localStorage.setItem(G,JSON.stringify(e.value)),t.username&&(n.value=!0)}async function C(t){e.value.peerId=t;const{avatar:c,...g}=e.value;localStorage.setItem(W,JSON.stringify(g)),localStorage.setItem(G,JSON.stringify(e.value))}async function I(){e.value={username:"",avatar:null,peerId:null,version:0},n.value=!1,localStorage.removeItem(W),await U.delete("avatars",x)}function S(){const t=localStorage.getItem(De);return t!==null&&(r.value=t==="true"),r.value}function R(t){r.value=t,localStorage.setItem(De,String(t))}function O(){const t=localStorage.getItem(Pe);return t!==null&&(a.value=t==="true"),a.value}function T(t){a.value=t,localStorage.setItem(Pe,String(t))}function m(){const t=localStorage.getItem(_e);if(t!==null){const c=Number.parseInt(t,10);!Number.isNaN(c)&&c>=5&&c<=600&&(i.value=c)}return i.value}function p(t){const c=Math.max(5,Math.min(600,t));i.value=c,localStorage.setItem(_e,String(c))}function y(){const t=localStorage.getItem(be);if(t!==null){const c=Number.parseInt(t,10);!Number.isNaN(c)&&c>=3&&c<=30&&(l.value=c)}return l.value}function b(t){const c=Math.max(3,Math.min(30,t));l.value=c,localStorage.setItem(be,String(c))}async function N(){try{const{cryptoManager:t}=await Q(async()=>{const{cryptoManager:c}=await import("./cryptoManager-B5C1ax7v.js");return{cryptoManager:c}},[]);await t.init(),s.value=t.getPublicKey(),o.value=t.getPrivateKey(),v.value=!0,console.log("[UserStore] Crypto keys initialized")}catch(t){throw console.error("[UserStore] Failed to initialize crypto keys:",t),t}}async function E(){try{const{cryptoManager:t}=await Q(async()=>{const{cryptoManager:c}=await import("./cryptoManager-B5C1ax7v.js");return{cryptoManager:c}},[]);await t.regenerate(),s.value=t.getPublicKey(),o.value=t.getPrivateKey(),console.log("[UserStore] Crypto keys regenerated")}catch(t){throw console.error("[UserStore] Failed to regenerate crypto keys:",t),t}}async function M(t){try{const{cryptoManager:c}=await Q(async()=>{const{cryptoManager:g}=await import("./cryptoManager-B5C1ax7v.js");return{cryptoManager:g}},[]);return await c.sign(t)}catch(c){throw console.error("[UserStore] Sign failed:",c),c}}async function K(t,c,g){try{const{cryptoManager:d}=await Q(async()=>{const{cryptoManager:P}=await import("./cryptoManager-B5C1ax7v.js");return{cryptoManager:P}},[]);return await d.verify(t,c,g)}catch(d){return console.error("[UserStore] Verify failed:",d),!1}}function oe(){if(!s.value)throw new Error("Public key not initialized. Call initCryptoKeys() first.");return s.value}function ne(){if(!o.value)throw new Error("Private key not initialized. Call initCryptoKeys() first.");return o.value}async function re(){try{const{cryptoManager:t}=await Q(async()=>{const{cryptoManager:c}=await import("./cryptoManager-B5C1ax7v.js");return{cryptoManager:c}},[]);await t.close(),s.value=null,o.value=null,v.value=!1,console.log("[UserStore] Crypto keys cleared")}catch(t){console.error("[UserStore] Failed to clear crypto keys:",t)}}return{userInfo:e,isSetup:n,myPeerId:f,loadUserInfo:u,saveUserInfo:w,setPeerId:C,clearUserInfo:I,networkAccelerationEnabled:r,loadNetworkAcceleration:S,setNetworkAcceleration:R,networkLoggingEnabled:a,loadNetworkLogging:O,setNetworkLogging:T,deviceCheckInterval:i,loadDeviceCheckInterval:m,setDeviceCheckInterval:p,deviceCheckTimeout:l,loadDeviceCheckTimeout:y,setDeviceCheckTimeout:b,myPublicKey:ce(s),myPrivateKey:ce(o),isCryptoInitialized:ce(v),initCryptoKeys:N,regenerateCryptoKeys:E,signData:M,verifySignature:K,getMyPublicKey:oe,getMyPrivateKey:ne,clearCryptoKeys:re}}),F="p2p_messages_",le="p2p_contacts",Oe="p2p_pending_messages",ue="message_content_migrated_to_indexeddb",J=Ie("chat",()=>{const e=B(new Map),n=B(new Map),r=B(new Map),a=B(null);async function i(t,c,g){const d=`msg-content-${t}`;await U.set("messages",{id:d,messageId:t,type:c,content:g})}async function l(t){const c=`msg-content-${t}`;return(await U.get("messages",c))?.content||null}async function s(){if(!localStorage.getItem(ue))try{console.log("[ChatStore] 开始检查消息数据迁移...");const c=localStorage.getItem(le);if(!c){localStorage.setItem(ue,"true");return}const g=JSON.parse(c),d=Object.keys(g);let P=0;for(const A of d){const $=localStorage.getItem(F+A);if(!$)continue;const se=JSON.parse($);let z=0;for(const V of se)if(V.type==="image"||V.type==="file"||V.type==="video"){const ae=V.content;ae&&ae.length>1e3&&(await i(V.id,V.type,ae),V.content=`msg-content-${V.id}`,z++)}z>0&&(localStorage.setItem(F+A,JSON.stringify(se)),P+=z)}localStorage.setItem(ue,"true"),console.log(`[ChatStore] 消息数据迁移完成！迁移了 ${P} 条大型消息内容`)}catch(c){console.error("[ChatStore] 消息数据迁移失败:",c)}}const o=Y(()=>a.value?e.value.get(a.value)||[]:[]),v=Y(()=>Array.from(n.value.values()).sort((t,c)=>t.online!==c.online?t.online?-1:1:c.lastSeen-t.lastSeen));async function f(){await s();const t=localStorage.getItem("p2p_current_chat");if(t)try{a.value=t}catch(d){console.error("[ChatStore] Failed to load current chat:",d)}const c=localStorage.getItem(le);if(c)try{const d=JSON.parse(c);n.value=new Map(Object.entries(d));for(const[P]of n.value)await C(P)}catch(d){console.error("[ChatStore] Failed to load contacts:",d)}const g=localStorage.getItem(Oe);if(g)try{const d=JSON.parse(g);r.value=new Map(Object.entries(d))}catch(d){console.error("[ChatStore] Failed to load pending messages:",d)}}function u(){const t=Object.fromEntries(n.value);localStorage.setItem(le,JSON.stringify(t))}function D(){const t=Object.fromEntries(r.value);localStorage.setItem(Oe,JSON.stringify(t))}async function w(t){const c=e.value.get(t)||[],g=[];for(const d of c)if(d.type==="image"||d.type==="file"||d.type==="video"){const P=d.content;P.startsWith("msg-content-")?g.push(d):P&&P.length>1e3?(await i(d.id,d.type,P),g.push({...d,content:`msg-content-${d.id}`})):g.push(d)}else g.push(d);localStorage.setItem(F+t,JSON.stringify(g))}async function C(t){const c=localStorage.getItem(F+t);if(c)try{const g=JSON.parse(c),d=[];for(const P of g)if((P.type==="image"||P.type==="file"||P.type==="video")&&typeof P.content=="string"&&P.content.startsWith("msg-content-")){const A=await l(P.id);d.push({...P,content:A||P.content})}else d.push(P);return e.value.set(t,d),d}catch(g){console.error("[ChatStore] Failed to load messages:",g)}return[]}function I(t){const c=n.value.get(t.peerId);c?n.value.set(t.peerId,{...c,...t}):n.value.set(t.peerId,t),u()}function S(t){return n.value.get(t)}function R(t,c){const g=n.value.get(t);g&&(g.online=c,g.lastSeen=Date.now(),u())}async function O(t,c){e.value.has(t)||e.value.set(t,[]),e.value.get(t).push(c),await w(t);const g=n.value.get(t);if(g&&c.from===t){const d=e.value.get(t);d&&d.length>0&&(g.lastSeen=c.timestamp),u()}}async function T(t,c,g){const d=e.value.get(t);if(d){const P=d.find(A=>A.id===c);P&&(P.status=g,g==="delivered"&&(P.deliveredAt=Date.now()),await w(t))}}function m(t){for(const c of e.value.values()){const g=c.find(d=>d.id===t);if(g)return g}return null}function p(t){r.value.set(t.id,t),D()}function y(t){r.value.delete(t),D()}function b(t){const c=r.value.get(t);return c?(c.retryCount++,D(),!(c.maxRetries!==void 0&&c.retryCount>c.maxRetries)):!1}function N(t){return Array.from(r.value.values()).filter(c=>c.to===t)}function E(t){const c=Array.from(r.value.entries()).filter(([,g])=>g.to===t);return c.forEach(([g])=>r.value.delete(g)),D(),c.map(([,g])=>g)}async function M(t,c=t){n.value.has(t)||I({peerId:t,username:c,avatar:null,online:!1,lastSeen:Date.now(),unreadCount:0,chatVersion:0}),await C(t);const g=e.value.get(t);if(!g||g.length===0){const d={id:`system-${t}-${Date.now()}`,from:t,to:"system",content:"",timestamp:Date.now(),status:"delivered",type:"system"};await O(t,d)}}async function K(t){n.value.delete(t),e.value.delete(t);const c=localStorage.getItem(F+t);if(c)try{const g=JSON.parse(c);for(const d of g)(d.type==="image"||d.type==="file"||d.type==="video")&&await U.delete("messages",`msg-content-${d.id}`)}catch(g){console.error("[ChatStore] Failed to clean up IndexedDB messages:",g)}localStorage.removeItem(F+t),u(),E(t),a.value===t&&(a.value=null)}function oe(t){if(a.value=t,t){localStorage.setItem("p2p_current_chat",t);const c=n.value.get(t);c&&(c.unreadCount=0,u())}else localStorage.removeItem("p2p_current_chat")}function ne(t){const c=n.value.get(t);c&&a.value!==t&&(c.unreadCount++,u())}function re(){return Array.from(n.value.values()).reduce((t,c)=>t+c.unreadCount,0)}return{messages:e,contacts:n,pendingMessages:r,currentChatPeerId:a,currentMessages:o,sortedContacts:v,loadFromStorage:f,loadMessages:C,addOrUpdateContact:I,getContact:S,setContactOnline:R,addMessage:O,updateMessageStatus:T,getMessageById:m,addPendingMessage:p,removePendingMessage:y,incrementRetryCount:b,getPendingMessagesForPeer:N,clearPendingMessagesForPeer:E,createChat:M,deleteChat:K,setCurrentChat:oe,incrementUnread:ne,getTotalUnread:re}}),Ce="discovered_devices",de="discovered_devices_meta",ve="avatar_migrated_to_indexeddb",j=600*1e3,xe=3,Le=xe*24*60*60*1e3,q=Ie("device",()=>{const e=B(new Map);let n=null;async function r(){try{await a();const m=localStorage.getItem(de);if(m){const p=JSON.parse(m),y=Object.values(p),b=await U.getAll("avatars"),N=new Map(b.map(M=>[M.peerId,M.avatar])),E=Date.now();e.value=new Map(y.map(M=>[M.peerId,{...M,avatar:N.get(M.peerId)||null,isOnline:E-M.lastHeartbeat<j}])),e.value.forEach((M,K)=>{console.log("[DeviceStore] Loaded device: "+K+" isBootstrap="+M.isBootstrap+" realPeerId="+M.realPeerId)}),console.log(`[DeviceStore] Loaded ${e.value.size} devices from storage (${N.size} avatars from IndexedDB)`),await S()}}catch(m){console.error("[DeviceStore] Failed to load devices:",m)}}async function a(){if(!localStorage.getItem(ve))try{const p=localStorage.getItem(Ce);if(!p){localStorage.setItem(ve,"true");return}const y=Object.values(JSON.parse(p));console.log(`[DeviceStore] 开始迁移 ${y.length} 个设备到混合存储...`);const b={},N=[];for(const E of y){const{avatar:M,...K}=E;b[E.peerId]=K,M&&(await U.set("avatars",{id:E.peerId,peerId:E.peerId,avatar:M}),N.push({peerId:E.peerId,avatar:M}))}localStorage.setItem(de,JSON.stringify(b)),localStorage.removeItem(Ce),localStorage.setItem(ve,"true"),console.log(`[DeviceStore] 迁移完成！${N.length} 个头像已移至 IndexedDB`)}catch(p){console.error("[DeviceStore] 迁移失败:",p)}}async function i(){try{const m={};for(const[p,y]of e.value){const{avatar:b,isBootstrap:N,...E}=y;m[p]=E,b?await U.set("avatars",{id:p,peerId:p,avatar:b}):await U.delete("avatars",p)}localStorage.setItem(de,JSON.stringify(m))}catch(m){console.error("[DeviceStore] Failed to save devices:",m)}}const l=Y(()=>Array.from(e.value.values())),s=Y(()=>{const m=Date.now();return l.value.filter(p=>m-p.lastHeartbeat<j)}),o=Y(()=>{const m=Date.now();return l.value.filter(p=>m-p.lastHeartbeat>=j)});async function v(m){const p=e.value.get(m.peerId),y=Date.now();p?(p.username=m.username,p.avatar=m.avatar,p.lastHeartbeat=m.lastHeartbeat,p.isOnline=y-m.lastHeartbeat<j,p.isOnline?("isBootstrap"in m&&(p.isBootstrap=m.isBootstrap),"realPeerId"in m&&(p.realPeerId=m.realPeerId)):(p.isBootstrap=!1,p.realPeerId=void 0)):e.value.set(m.peerId,{...m,firstDiscovered:m.firstDiscovered||y,isOnline:!0}),await i()}function f(m){return e.value.get(m)}async function u(m){const p=e.value.get(m);p&&(p.lastHeartbeat=Date.now(),p.isOnline=!0,await i())}async function D(m,p){const y=e.value.get(m);if(y){const b=y.isBootstrap;y.isOnline=p,p?y.lastHeartbeat=Date.now():(y.isBootstrap&&console.log("[DeviceStore] 设备离线，清除启动者标签: "+m+" (wasBootstrap: "+b+")"),y.isBootstrap=!1,y.realPeerId=void 0),await i(),we(e),console.log("[DeviceStore] updateDeviceOnlineStatus: "+m+" isOnline="+p+" (wasBootstrap: "+b+", isBootstrap: "+y.isBootstrap+")")}else console.warn("[DeviceStore] updateDeviceOnlineStatus: device not found: "+m)}async function w(m){const p=Date.now();m.forEach(y=>{const b=e.value.get(y.peerId);b?(b.lastHeartbeat=Math.max(b.lastHeartbeat,y.lastHeartbeat),b.isOnline=p-b.lastHeartbeat<j,y.username&&(b.username=y.username),y.avatar!==void 0&&(b.avatar=y.avatar),"isBootstrap"in y&&(b.isBootstrap=y.isBootstrap),"realPeerId"in y&&(b.realPeerId=y.realPeerId)):e.value.set(y.peerId,{...y,firstDiscovered:p,isOnline:!0})}),await i()}async function C(m){return e.value.delete(m)?(await U.delete("avatars",m),await i(),!0):!1}async function I(){const m=Date.now(),p=[];e.value.forEach((y,b)=>{m-y.lastHeartbeat>Le&&p.push(b)});for(const y of p)e.value.delete(y),await U.delete("avatars",y),console.log(`[DeviceStore] Removed expired device: ${y}`);return p.length>0&&await i(),p.length}async function S(){const m=Date.now();e.value.forEach(p=>{p.isOnline=m-p.lastHeartbeat<j}),await i(),we(e)}function R(m,p=20){n===null&&(I().catch(y=>console.error("[DeviceStore] Initial cleanup failed:",y)),n=window.setInterval(async()=>{console.log("[DeviceStore] Running heartbeat check...");const y=[];e.value.forEach(b=>{y.push(b)});for(const b of y)try{if(await m(b))await u(b.peerId);else{const E=e.value.get(b.peerId);E&&(E.isOnline=!1)}}catch{const E=e.value.get(b.peerId);E&&(E.isOnline=!1)}await S(),await I()},p*1e3),console.log("[DeviceStore] Heartbeat timer started (interval: "+p+"s)"))}function O(){n!==null&&(clearInterval(n),n=null,console.log("[DeviceStore] Heartbeat timer stopped"))}async function T(){e.value.clear(),await U.clearStore("avatars"),await i()}return{devices:e,allDevices:l,onlineDevices:s,offlineDevices:o,loadDevices:r,addOrUpdateDevice:v,getDevice:f,updateHeartbeat:u,updateDeviceOnlineStatus:D,addDevices:w,removeDevice:C,cleanupExpiredDevices:I,updateOnlineStatus:S,startHeartbeatTimer:R,stopHeartbeatTimer:O,clearAll:T}});let k=null;function ge(e){k=e}let Me=null;function X(e){Me=e}const h={message:null,discoveryResponse:null,discoveryNotification:null,discoveryNotificationRequest:null,usernameQuery:null,usernameResponse:null,onlineCheckQuery:null,onlineCheckRequest:null,onlineCheckResponse:null,userInfoQuery:null,userInfoResponse:null,userInfoUpdate:null,relayMessage:null,relayResponse:null,networkAccelerationStatus:null,deviceListRequest:null,deviceListResponse:null},fe=new Set;let pe=null,ke=!1;function Be(e){pe=e}function Ue(e){ke=e}const H=B(!1),Z=B(!1);async function ee(e){const n=k,r=q(),a=J();if(!n)return null;_.sync.requestInfo({to:e});try{const i=await n.queryUserInfo(e);if(i){console.log("[Peer] Got user info for "+e+": "+JSON.stringify({username:i.username,version:i.version}));const l=r.getDevice(e);r.addOrUpdateDevice({peerId:e,username:i.username,avatar:i.avatar,lastHeartbeat:Date.now(),firstDiscovered:l?.firstDiscovered||Date.now(),userInfoVersion:i.version});const s=a.getContact(e);return s&&a.addOrUpdateContact({...s,username:i.username,avatar:i.avatar,lastSeen:Date.now()}),i}}catch(i){console.error("[Peer] Request user info error:",i)}return null}async function Ve(e){const n=k,r=q();if(!n)return[];try{_.discovery.add({peerId:e});const a=await n.queryDiscoveredDevices(e);return a.length>0&&r.addDevices(a),a}catch(a){return console.error("[Peer] Query discovered devices error:",a),[]}}function He(){const e=k;return e?e.getDiscoveredDevices():[]}function Ke(){return q().allDevices}function Je(e){const n=k,r=q();n&&(n.addDiscoveredDevice(e),r.addOrUpdateDevice(e))}async function Fe(e){const n=k,r=L();if(!n){console.warn("[Peer] sendDiscoveryNotification: peerInstance is null");return}try{console.log("[Peer] Sending discovery notification to:",e,"username:",r.userInfo.username),_.discovery.notify({to:e,username:r.userInfo.username}),await n.sendDiscoveryNotification(e,r.userInfo.username||"",r.userInfo.avatar,r.userInfo.version||0),console.log("[Peer] Discovery notification sent successfully to:",e)}catch(a){console.error("[Peer] Send discovery notification error:",a)}}async function je(e){const n=k;if(!n)return console.warn("[Peer] queryUsername: peerInstance is null"),null;try{console.log("[Peer] Querying username for:",e),_.discovery.query({from:e});const r=await n.queryUsername(e);return console.log("[Peer] Query username result:",r),r}catch(r){return console.error("[Peer] Query username error: "+String(r)),null}}async function Ye(e,n=5e3){const r=k,a=L();if(!r)return!1;try{_.heartbeat.check({to:e,version:a.userInfo.version});const i=await r.checkOnline(e,a.userInfo.username||"",a.userInfo.avatar,a.userInfo.version,n);return i!==null&&i.isOnline?(_.heartbeat.online({from:e}),!0):(i!==null&&!i.isOnline&&_.heartbeat.offline({peerId:e}),i!==null&&i.isOnline)}catch(i){return console.error("[Peer] Check online error: "+String(i)),_.heartbeat.offline({peerId:e}),!1}}async function te(e){const n=k,r=q();if(!n)return[];_.deviceDiscovery.requestSent({to:e});try{const a=await n.requestDeviceList(e);return a.length>0&&r.addDevices(a),a}catch(a){return console.error("[Peer] Request device list error:",a),[]}}async function ze(){const e=k,n=q();if(!e)return;const r=n.allDevices;console.log("[Peer] Requesting device lists from "+r.length+" devices");const a=r.map(i=>te(i.peerId));await Promise.allSettled(a)}async function Qe(){const e=k,n=L(),r=q();if(!e)return;const a=r.allDevices,{username:i,avatar:l,version:s}=n.userInfo;console.log("[Peer] Broadcasting user info update to",a.length,"devices:",{username:i,version:s});const o=a.map(v=>v.isOnline?e.sendUserInfoUpdate(v.peerId,i,l,s).catch(f=>{console.warn("[Peer] Failed to send user info update to",v.peerId,f)}):Promise.resolve());await Promise.allSettled(o),console.log("[Peer] User info update broadcast completed")}function Ge(e){const n=J(),r=q(),a=L();h.discoveryResponse=(s,o)=>{if(s.type==="discovery_response"){if(s.devices){const{devices:v}=s;_.discovery.found({peerId:o}),v?.forEach(f=>{e?.addDiscoveredDevice(f)})}else if(s.username){const{username:v,avatar:f}=s;console.log("[Peer] Received discovery response from:",o,"username:",v);const u=r.getDevice(o),D={peerId:o,username:v,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:u?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(D),r.addOrUpdateDevice(D),window.dispatchEvent(new CustomEvent("discovery-devices-updated"))}}},e.onProtocol("discovery_response",h.discoveryResponse);const i=(s,o,v)=>{const f=v?"discovery_notification_request":"discovery_notification";console.log("[Peer] discoveryNotificationHandler called:",{type:s.type,from:o,protocolType:f});const{fromUsername:u,fromAvatar:D,profileVersion:w}=s;_.discovery.notified({from:o,username:u}),console.log("[Peer] Received discovery notification from:",o,"username:",u,"profileVersion:",w,"protocol:",f);const C=r.getDevice(o),I=!C||C.userInfoVersion===void 0||C.userInfoVersion<w,S={peerId:o,username:u,avatar:D,lastHeartbeat:Date.now(),firstDiscovered:C?.firstDiscovered||Date.now(),isOnline:!0,userInfoVersion:w};console.log("[Peer] Adding device to store:",S),e?.addDiscoveredDevice(S),r.addOrUpdateDevice(S),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),n.getContact(o)||(n.createChat(o,u),n.addOrUpdateContact({peerId:o,username:u,avatar:D,online:!0,lastSeen:Date.now(),unreadCount:0,chatVersion:0}));const R=a.userInfo.username||"",O=a.userInfo.avatar;console.log("[Peer] Sending discovery response to:",o,"username:",R,"avatar:",O),e?.sendDiscoveryResponse(o,R,O),I&&C!==void 0&&(console.log("[Peer] Profile version mismatch, requesting latest user info from:",o),ee(o)),te(o).then(T=>{T.length>0&&console.log("[Peer] Discovered "+T.length+" devices from "+o)}).catch(T=>{console.error("[Peer] Request device list error after discovery notification:",T)})};h.discoveryNotification=(s,o)=>{s.type==="discovery_notification"&&i(s,o,!1)},e.onProtocol("discovery_notification",h.discoveryNotification),h.discoveryNotificationRequest=(s,o)=>{s.type==="discovery_notification_request"&&i(s,o,!0)},e.onProtocol("discovery_notification_request",h.discoveryNotificationRequest),h.usernameQuery=(s,o)=>{s.type==="username_query"&&(_.discovery.query({from:o}),e?.respondUsernameQuery(o,a.userInfo.username||"",a.userInfo.avatar))},e.onProtocol("username_query",h.usernameQuery),h.usernameResponse=(s,o)=>{if(s.type==="username_response"){const{username:v,avatar:f}=s;_.discovery.response({to:o,username:v});const u=n.getContact(o);u&&n.addOrUpdateContact({...u,username:v,avatar:f});const D=r.getDevice(o),w={peerId:o,username:v,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:D?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(w),r.addOrUpdateDevice(w)}},e.onProtocol("username_response",h.usernameResponse);const l=(s,o,v)=>{const f=v?"online_check_request":"online_check_query";console.log("[Peer] onlineCheckRequestHandler called:",{type:s.type,from:o,protocolType:f});let u;v?u=s.payload?.userInfoVersion:u=s.userInfoVersion;const w=r.getDevice(o)?.userInfoVersion||0;_.heartbeat.response({to:o,version:a.userInfo.version}),e?.respondOnlineCheck(o,a.userInfo.username||"",a.userInfo.avatar,a.userInfo.version),u!==void 0&&u!==w&&(_.sync.versionMismatch({peerId:o,stored:w,theirs:u}),_.sync.requestInfo({to:o}),ee(o))};return h.onlineCheckQuery=(s,o)=>{s.type==="online_check_query"&&l(s,o,!1)},e.onProtocol("online_check_query",h.onlineCheckQuery),h.onlineCheckRequest=(s,o)=>{s.type==="online_check_request"&&l(s,o,!0)},e.onProtocol("online_check_request",h.onlineCheckRequest),h.onlineCheckResponse=(s,o)=>{if(s.type==="online_check_response"){const{isOnline:v,username:f,avatar:u,userInfoVersion:D}=s,w=r.getDevice(o),C=w?.userInfoVersion||0;r.addOrUpdateDevice({peerId:o,username:f,avatar:u,lastHeartbeat:Date.now(),firstDiscovered:w?.firstDiscovered||Date.now(),userInfoVersion:D});const I=n.getContact(o);I&&n.addOrUpdateContact({...I,username:f,avatar:u,online:v,lastSeen:Date.now()}),D!==void 0&&D!==C&&(_.sync.versionMismatch({peerId:o,stored:C,theirs:D}),ee(o))}},e.onProtocol("online_check_response",h.onlineCheckResponse),h.userInfoQuery=(s,o)=>{s.type==="user_info_query"&&(_.sync.respondInfo({to:o,version:a.userInfo.version}),e?.respondUserInfo(o,a.userInfo.username||"",a.userInfo.avatar,a.userInfo.version))},h.userInfoResponse=(s,o)=>{if(s.type==="user_info_response"){const{username:v,avatar:f,version:u}=s;_.sync.updateInfo({peerId:o,username:v,version:u});const D=r.getDevice(o);r.addOrUpdateDevice({peerId:o,username:v,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:D?.firstDiscovered||Date.now(),userInfoVersion:u});const w=n.getContact(o);w&&n.addOrUpdateContact({...w,username:v,avatar:f,lastSeen:Date.now()})}},e.onProtocol("user_info_query",h.userInfoQuery),e.onProtocol("user_info_response",h.userInfoResponse),h.userInfoUpdate=(s,o)=>{if(s.type==="user_info_update"){const{username:v,avatar:f,version:u}=s;console.log("[Peer] Received user info update from:",o,"username:",v,"version:",u);const D=r.getDevice(o);if(D&&(!D.userInfoVersion||u>D.userInfoVersion)){r.addOrUpdateDevice({...D,username:v,avatar:f,userInfoVersion:u,lastHeartbeat:Date.now()});const w=n.getContact(o);w&&n.addOrUpdateContact({peerId:o,username:v,avatar:f,online:!0,lastSeen:Date.now(),unreadCount:w.unreadCount||0,chatVersion:w.chatVersion||0}),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),console.log("[Peer] User info updated for device:",o)}}},e.onProtocol("user_info_update",h.userInfoUpdate),h.networkAccelerationStatus=(s,o)=>{if(s.type==="network_acceleration_status"){const{enabled:v}=s;console.log("[Peer] Network acceleration status from "+o+": "+v),_.networkAcceleration.statusSync({from:o,enabled:v});const f=r.getDevice(o);f&&r.addOrUpdateDevice({...f,networkAccelerationEnabled:v})}},e.onProtocol("network_acceleration_status",h.networkAccelerationStatus),h.deviceListResponse=s=>{if(s.type==="device_list_response"){const{devices:o}=s;if(_.deviceDiscovery.responseReceived({deviceCount:o?.length||0}),o&&o.length>0){const v=[];o.forEach(f=>{!r.getDevice(f.peerId)&&!fe.has(f.peerId)&&v.push(f),e?.addDiscoveredDevice(f)}),r.addDevices(o),v.forEach(f=>{fe.add(f.peerId),_.deviceDiscovery.newDevice({peerId:f.peerId,username:f.username}),te(f.peerId).then(u=>{u.length>0&&console.log("[Peer] Discovered "+u.length+" more devices from "+f.peerId)}).catch(u=>{console.error("[Peer] Recursive device list request error:",u)}).finally(()=>{fe.delete(f.peerId)})})}}},e.onProtocol("device_list_response",h.deviceListResponse),h.deviceListRequest=(s,o)=>{if(s.type==="device_list_request"){_.deviceDiscovery.requestReceived({from:o});const v=r.allDevices;e?.sendDeviceListResponse(o,v)}},e.onProtocol("device_list_request",h.deviceListRequest),e}function We(e){const{from:n,data:r}=e;if(r&&typeof r=="object"&&"id"in r&&"type"in r){Xe(n,r);return}}async function Xe(e,n){const r=J(),a=q(),{id:i,type:l}=n;_.message.received({from:e,msgType:l,messageId:i});const s=JSON.stringify({id:i,from:e,to:n.to,type:l,timestamp:n.timestamp});console.log("[Peer] Handling chat message:",s.substring(0,200));const o=r.getContact(e);r.setContactOnline(e,!0),await a.updateDeviceOnlineStatus(e,!0),console.log("[Peer] Contact online: "+e),o?(r.incrementUnread(e),console.log("[Peer] Incremented unread for "+e)):r.addOrUpdateContact({peerId:e,username:e,avatar:null,online:!0,lastSeen:Date.now(),unreadCount:1,chatVersion:0}),r.addMessage(e,n),console.log("[Peer] Message saved to store: "+n.id),await Ze(e)}async function Ze(e){const n=J(),r=n.getPendingMessagesForPeer(e);if(r.length!==0){console.log("[Peer] Retrying "+r.length+" pending messages for "+e);for(const a of r)await he(e,a.id,a.content,a.type)?n.removePendingMessage(a.id):n.incrementRetryCount(a.id)||(n.removePendingMessage(a.id),n.updateMessageStatus(e,a.id,"failed"))}}async function he(e,n,r,a="text"){const i=k;if(!i)return console.error("[Peer] Peer instance not initialized"),!1;console.log("[Peer] Sending chat message: peerId="+e+", msgId="+n+", type="+a);try{const l=L(),s={id:n,from:l.myPeerId||"",to:e,content:r,timestamp:Date.now(),status:"sending",type:a},o=await i.sendMessage(e,s);return console.log("[Peer] Send result: msgId="+n+", sent="+o),o&&J().updateMessageStatus(e,n,"sending"),o}catch(l){return console.error("[Peer] Send error: "+String(l)),!1}}function Te(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}async function et(e,n,r="text"){const a=L(),i=J();if(!H.value||!k)throw console.error("[Peer] Peer not connected, cannot send message"),new Error("Peer not connected");const l=Te();_.message.send({to:e,msgType:r,messageId:l});const s={id:l,from:a.myPeerId||"",to:e,content:n,timestamp:Date.now(),status:"sending",type:r};i.addMessage(e,s),console.log("[Peer] Message added to local store: "+s.id);const o=await he(e,l,n,r);return console.log("[Peer] Send result: messageId="+l+", success="+o),o?i.updateMessageStatus(e,l,"sending"):(i.addPendingMessage({id:l,to:e,content:n,timestamp:Date.now(),retryCount:0,type:r}),i.updateMessageStatus(e,l,"failed")),l}function tt(){return e=>{We(e)}}function Se(){pe!==null&&(clearTimeout(pe),Be(null),console.log("[Peer] Auto-reconnect stopped")),Ue(!1)}function me(e){ke||(Ue(!0),console.log("[Peer] Starting auto-reconnect in 10 seconds..."),Be(window.setTimeout(async()=>{console.log("[Peer] Attempting to reconnect...");try{await e(),console.log("[Peer] Reconnected successfully"),Se()}catch(n){console.error("[Peer] Reconnect failed:",n),me(e)}},1e4)))}function ye(e){return new Promise((n,r)=>{const a=q(),i=performance.now();console.log("[Peer-Performance] ===== Peer 初始化开始 ====="),console.log("[Peer-Performance] Timestamp:",Date.now());const l=(I,S)=>{const R=performance.now(),O=Math.round(R-i);console.log(`[Peer-Performance] [${I}] +${O}ms ${S}`)};l("start","开始初始化 Peer");const s=k;s&&(l("destroy-old","销毁旧的 peerInstance"),s.destroy(),ge(null));let o=e.userInfo.peerId;if(o)l("reuse-peerid",`复用已存储的 PeerId: ${o}`);else{l("generate-peerid","生成新的 PeerId");const I=Date.now().toString(36),S=Math.random().toString(36).substring(2,11);o=`peer_${I}_${S}`}console.log("[Peer] Initializing with PeerId:",o,"at",new Date().toISOString());const v={debug:2};l("before-peer-http-util","准备创建 PeerHttpUtil");const f=performance.now(),u=new Ne(o,v);ge(u),l("after-peer-http-util",`PeerHttpUtil 创建完成 (耗时 ${Math.round(performance.now()-f)}ms)`),e.loadNetworkLogging()&&(l("network-logging","启用网络日志"),u.setNetworkLogger(!0,async I=>{try{await Ae.addLog(I)}catch(S){console.error("[Peer] Failed to save network log:",S)}}),console.log("[Peer] Network logging enabled"));let w=!1;const C=setTimeout(()=>{w||(w=!0,console.error("[Peer] Connection timeout"),l("timeout","连接超时 (30秒)"),H.value=!1,r(new Error("Peer connection timeout")))},3e4);l("before-register-protocols","准备注册协议处理器"),Ge(u),l("after-register-protocols","协议处理器注册完成"),l("before-register-message","准备注册消息处理器"),u.on("message",tt()),l("after-register-message","消息处理器注册完成"),l("before-set-userinfo-provider","准备设置用户信息提供器"),u.setUserInfoProvider({getUsername:()=>e.userInfo.username||"",getAvatar:()=>e.userInfo.avatar,getVersion:()=>e.userInfo.version||0}),l("after-set-userinfo-provider","用户信息提供器设置完成"),u.setOnlineChecker(I=>a.getDevice(I)?.isOnline??!1),l("after-set-online-checker","在线检查器设置完成"),u.on("open",I=>{if(!w){const S=performance.now();w=!0,clearTimeout(C),H.value=!0,e.setPeerId(I);const R=Math.round(S-i);console.log("[Peer] Connected with ID:",I),l("connected",`Peer 连接成功! 总耗时: ${R}ms`),console.log("[Peer-Performance] ===== Peer 初始化完成 ====="),Se(),n(u)}}),u.on("disconnected",()=>{console.warn("[Peer] Disconnected from Peer Server"),H.value=!1,me(ye.bind(null,e))}),u.on("close",()=>{console.warn("[Peer] Peer connection closed"),H.value=!1,me(ye.bind(null,e))}),u.on("error",I=>{console.error("[Peer] PeerJS error:",I),!w&&(I?.type==="peer-unavailable"||I?.type==="network"||I?.type==="server-error"||I?.type==="socket-error"||I?.type==="socket-closed")&&(w=!0,clearTimeout(C),H.value=!1,r(new Error(`Peer connection failed: ${I?.type||"unknown error"}`))),I?.type==="peer-unavailable"&&console.log("[Peer] Target peer unavailable:",I)})})}async function ot(){const e="UNIVERSE-BOOTSTRAP-PEER-ID-001",n=q(),r=L();console.log("[Peer] Trying to become universe bootstrap with ID:",e),_.universeBootstrap.connecting();const a=performance.now();console.log("[Bootstrap-Performance] ===== 尝试成为宇宙启动者 =====");const i=(l,s)=>{const o=performance.now(),v=Math.round(o-a);console.log(`[Bootstrap-Performance] [${l}] +${v}ms ${s}`)};return i("start","开始尝试成为宇宙启动者"),new Promise(l=>{let s=globalThis.__bootstrapPeerInstance;if(s){console.log("[Peer] Already is bootstrap"),i("already-bootstrap","已经是启动者"),l(!0);return}const o=setTimeout(()=>{_.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! Keeping connection..."),i("success","成为宇宙启动者成功 (3秒超时未被触发)"),Z.value=!0,l(!0)},3e3);try{i("before-create-peer","准备创建 Bootstrap Peer");const v=performance.now(),f=Ee(),u=f.host||"PeerJS Cloud (default)",D=f.port,w=f.path,C=D?`${u}:${D}${w}`:`${u}${w}`;console.log("[Peer-Bootstrap] Connecting to Peer Server:",C),s=new Re(e,f),globalThis.__bootstrapPeerInstance=s,X(s),i("after-create-peer",`Bootstrap Peer 创建完成 (耗时 ${Math.round(performance.now()-v)}ms)`),s.on("open",I=>{const S=performance.now();clearTimeout(o),_.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! ID:",I),i("connected",`成为宇宙启动者成功! 连接耗时: ${Math.round(S-a)}ms`),Z.value=!0,s.on("connection",R=>{R.on("data",O=>{if(O&&O.type==="device_list_request"){if(console.log("[Peer-Bootstrap] Received device list request from:",O.from,"realPeerId:",O.realPeerId,"username:",O.username),_.deviceDiscovery.requestReceived({from:O.from}),O.realPeerId&&O.realPeerId!==r.myPeerId){const p={peerId:O.realPeerId,username:O.username||O.realPeerId,avatar:O.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0};n.addOrUpdateDevice(p),console.log("[Peer-Bootstrap] Added requester to device list:",O.realPeerId,"username:",O.username)}const T=n.allDevices,m={type:"device_list_response",from:e,to:O.from,timestamp:Date.now(),devices:T,isBootstrap:!0,realPeerId:r.myPeerId,username:r.userInfo.username,avatar:r.userInfo.avatar};R.send(m),_.deviceDiscovery.responseSent({to:O.from,deviceCount:T.length}),console.log("[Peer-Bootstrap] Sent device list with",T.length,"devices")}})}),console.log("[Peer-Bootstrap] Listening for device list requests..."),l(!0)}),s.on("error",I=>{if(!s)return;const S=performance.now();clearTimeout(o),_.universeBootstrap.failed({error:I?.type}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Bootstrap already exists, requesting device list..."),i("error",`Bootstrap 已存在，连接失败 (耗时 ${Math.round(S-a)}ms)`),Z.value=!1,s&&(s.destroy(),s=null,globalThis.__bootstrapPeerInstance=null,X(null)),qe(e).then(()=>{l(!1)}).catch(()=>{l(!1)})}),s.on("disconnected",()=>{console.warn("[Peer-Bootstrap] Disconnected from server")}),s.on("close",()=>{console.log("[Peer-Bootstrap] Connection closed"),s=null,globalThis.__bootstrapPeerInstance=null,X(null),Z.value=!1})}catch(v){clearTimeout(o),console.error("[Peer] Bootstrap error:",v),s=null,globalThis.__bootstrapPeerInstance=null,X(null),l(!1)}})}async function qe(e){const n=q(),r=L();return _.universeBootstrap.requestList({to:e}),new Promise(a=>{let i=null,l=null,s=null,o=null;const v=()=>{l&&(l.close(),l=null),i&&(i.destroy(),i=null),s!==null&&(clearTimeout(s),s=null),o!==null&&(clearInterval(o),o=null)};s=window.setTimeout(()=>{console.warn("[Peer] Request bootstrap device list timeout"),v(),a()},1e4);try{const f=Ee(),u=f.host||"PeerJS Cloud (default)",D=f.port,w=f.path,C=D?`${u}:${D}${w}`:`${u}${w}`;console.log("[Peer-Bootstrap-Request] Connecting to Peer Server:",C),i=new Re(f),i.on("open",I=>{console.log("[Peer] Temp peer connected with ID:",I),l=i.connect(e),l.on("open",()=>{console.log("[Peer] Connected to bootstrap, waiting for myPeerId...");const S=5e3,R=Date.now();o=window.setInterval(()=>{if(r.myPeerId){clearInterval(o),o=null,console.log("[Peer] myPeerId is ready:",r.myPeerId);const O={type:"device_list_request",from:I,to:e,timestamp:Date.now(),realPeerId:r.myPeerId,username:r.userInfo.username,avatar:r.userInfo.avatar};console.log("[Peer] Sending device list request with realPeerId:",r.myPeerId),l.send(O)}else if(Date.now()-R>S){clearInterval(o),o=null,console.warn("[Peer] Timeout waiting for myPeerId, sending request without it...");const O={type:"device_list_request",from:I,to:e,timestamp:Date.now(),realPeerId:null,username:null,avatar:null};l.send(O)}},100)}),l.on("data",S=>{if(S&&S.type==="device_list_response"){if(console.log("[Peer] Received device list from bootstrap:",S.devices?.length||0,"devices"),_.universeBootstrap.responseList({deviceCount:S.devices?.length||0}),S.devices&&S.devices.length>0&&n.addDevices(S.devices),S.isBootstrap&&S.realPeerId){console.log("[Peer] Bootstrap device has real PeerID:",S.realPeerId);const R={peerId:S.realPeerId,username:S.username||"宇宙启动者",avatar:S.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0,isBootstrap:!0,realPeerId:e};n.addOrUpdateDevice(R)}v(),a()}}),l.on("error",S=>{console.error("[Peer] Bootstrap connection error:",S),v(),a()}),l.on("close",()=>{v(),a()})}),i.on("error",I=>{console.error("[Peer] Temp peer error:",I),v(),a()})}catch(f){console.error("[Peer] Request bootstrap device list error:",f),v(),a()}})}function nt(e){const n=k;n&&(n.setNetworkAccelerationEnabled(e),e?_.networkAcceleration.enabled():_.networkAcceleration.disabled())}function rt(){return k?.getNetworkAccelerationEnabled()||!1}async function st(){const e=k;if(!e)return;const r=q().allDevices;e.getNetworkAccelerationEnabled();const a=r.map(i=>i.isOnline?e.sendNetworkAccelerationStatus(i.peerId).catch(()=>{}):Promise.resolve());await Promise.allSettled(a)}function lt(){J();const e=L(),n=q();function r(){return ye(e)}function a(){Se();const i=k;i&&(i.destroy(),ge(null),h.message=null,h.discoveryResponse=null,h.discoveryNotification=null,h.usernameQuery=null,h.usernameResponse=null,h.onlineCheckQuery=null,h.onlineCheckResponse=null,h.userInfoQuery=null,h.userInfoResponse=null,h.userInfoUpdate=null,h.relayMessage=null,h.relayResponse=null,h.networkAccelerationStatus=null,h.deviceListRequest=null,h.deviceListResponse=null,H.value=!1);const l=Me;l&&(l.destroy(),X(null),console.log("[Peer] Bootstrap connection destroyed"))}return{isConnected:H,isBootstrap:Z,init:r,destroy:a,sendChatMessage:he,sendMessageWithRetry:et,generateMessageId:Te,queryDiscoveredDevices:Ve,getDiscoveredDevices:He,getStoredDevices:Ke,addDiscoveredDevice:Je,sendDiscoveryNotification:Fe,queryUsername:je,checkOnline:Ye,requestUserInfo:ee,tryBecomeBootstrap:ot,requestBootstrapDeviceList:qe,setNetworkAccelerationEnabled:nt,getNetworkAccelerationEnabled:rt,broadcastNetworkAccelerationStatus:st,requestDeviceList:te,requestAllDeviceLists:ze,broadcastUserInfoUpdate:Qe,deviceStore:n}}export{lt as a,J as b,q as c,L as u};
