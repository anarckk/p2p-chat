import{u as Ie,a as Pe}from"./PeerHttpUtil-BdqDL09T.js";import{a as ze,u as xe}from"./index-C_bmiR2O.js";import{f as ke,M as ne}from"./fileHelper-D6eTRPHu.js";import{c as s,I as A,d as Se,o as Me,a as De,z as ae,k as h,w as d,g as c,i as u,t as y,j as b,F as V,m as se,n as S,b as M,r as O,q as re,e as g,f,h as D,P as ie,L as Le,D as $e,A as oe,x as le,p as je,B as Ue,E as Be,G as Fe,H as p}from"./index-Dh4fjBfC.js";import{V as We}from"./VideoCameraOutlined-CMVACf46.js";import{_ as Ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./logger-CUkP4sI-.js";import"./networkLogDB-bSBVLm5N.js";import"./cryptoManager-BXa9bEtX.js";var Te={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M456 231a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0z"}}]},name:"more",theme:"outlined"};function ce(o){for(var a=1;a<arguments.length;a++){var t=arguments[a]!=null?Object(arguments[a]):{},m=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(m=m.concat(Object.getOwnPropertySymbols(t).filter(function(v){return Object.getOwnPropertyDescriptor(t,v).enumerable}))),m.forEach(function(v){Ne(o,v,t[v])})}return o}function Ne(o,a,t){return a in o?Object.defineProperty(o,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[a]=t,o}var H=function(a,t){var m=ce({},a,t.attrs);return s(A,ce({},m,{icon:Te}),null)};H.displayName="MoreOutlined";H.inheritAttrs=!1;var Re={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 632H136v-39.9l138.5-164.3 150.1 178L658.1 489 888 761.6V792zm0-129.8L664.2 396.8c-3.2-3.8-9-3.8-12.2 0L424.6 666.4l-144-170.7c-3.2-3.8-9-3.8-12.2 0L136 652.7V232h752v430.2zM304 456a88 88 0 100-176 88 88 0 000 176zm0-116c15.5 0 28 12.5 28 28s-12.5 28-28 28-28-12.5-28-28 12.5-28 28-28z"}}]},name:"picture",theme:"outlined"};function ue(o){for(var a=1;a<arguments.length;a++){var t=arguments[a]!=null?Object(arguments[a]):{},m=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(m=m.concat(Object.getOwnPropertySymbols(t).filter(function(v){return Object.getOwnPropertyDescriptor(t,v).enumerable}))),m.forEach(function(v){Ve(o,v,t[v])})}return o}function Ve(o,a,t){return a in o?Object.defineProperty(o,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[a]=t,o}var q=function(a,t){var m=ue({},a,t.attrs);return s(A,ue({},m,{icon:Re}),null)};q.displayName="PictureOutlined";q.inheritAttrs=!1;var Ae={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M931.4 498.9L94.9 79.5c-3.4-1.7-7.3-2.1-11-1.2a15.99 15.99 0 00-11.7 19.3l86.2 352.2c1.3 5.3 5.2 9.6 10.4 11.3l147.7 50.7-147.6 50.7c-5.2 1.8-9.1 6-10.3 11.3L72.2 926.5c-.9 3.7-.5 7.6 1.2 10.9 3.9 7.9 13.5 11.1 21.5 7.2l836.5-417c3.1-1.5 5.6-4.1 7.2-7.1 3.9-8 .7-17.6-7.2-21.6zM170.8 826.3l50.3-205.6 295.2-101.3c2.3-.8 4.2-2.6 5-5 1.4-4.2-.8-8.7-5-10.2L221.1 403 171 198.2l628 314.9-628.2 313.2z"}}]},name:"send",theme:"outlined"};function de(o){for(var a=1;a<arguments.length;a++){var t=arguments[a]!=null?Object(arguments[a]):{},m=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(m=m.concat(Object.getOwnPropertySymbols(t).filter(function(v){return Object.getOwnPropertyDescriptor(t,v).enumerable}))),m.forEach(function(v){He(o,v,t[v])})}return o}function He(o,a,t){return a in o?Object.defineProperty(o,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[a]=t,o}var G=function(a,t){var m=de({},a,t.attrs);return s(A,de({},m,{icon:Ae}),null)};G.displayName="SendOutlined";G.inheritAttrs=!1;const qe={class:"wechat-container"},Ge={class:"wechat-layout"},Je={key:0,class:"contacts-panel"},Qe={class:"contacts-header"},Xe={class:"user-info"},Ye={class:"username"},Ze={class:"header-actions"},Ke={class:"contacts-list"},et={key:0,class:"empty-contacts"},tt=["onClick"],nt={class:"contact-info"},at={class:"contact-top"},st={class:"contact-name"},rt={class:"contact-time"},it={class:"contact-bottom"},ot={key:0,class:"contact-peer-id"},lt={class:"chat-header"},ct={class:"chat-header-left"},ut={class:"chat-title"},dt={class:"chat-name"},mt={class:"chat-status"},ft={key:0,class:"empty-messages"},pt={key:1,class:"messages-list"},vt={class:"message-content"},ht={class:"message-meta"},gt={class:"message-time"},_t={class:"input-area"},yt={class:"input-toolbar"},Ct={class:"input-row"},bt={key:1,class:"no-chat-selected"},Ot=Se({__name:"WeChatView",setup(o){const a=Ie(),t=ze(),m=Pe(),v=xe(),{sendMessageWithRetry:J}=v,L=O(!1),x=O(""),$=O(""),j=O(null),k=O(!1),U=O(null),B=O(""),Q=O("info"),w=re(()=>{if(!t.currentChatPeerId)return null;const n=t.getContact(t.currentChatPeerId);if(!n)return null;const e=m.getDevice(t.currentChatPeerId);return{...n,online:e?e.isOnline:n.online,lastSeen:e?e.lastHeartbeat:n.lastSeen}}),X=re(()=>t.sortedContacts.map(e=>{const r=m.getDevice(e.peerId);return r?{...e,online:r.isOnline??!1,lastSeen:r.lastHeartbeat,username:r.username,avatar:r.avatar}:e}).sort((e,r)=>e.online!==r.online?e.online?-1:1:r.lastSeen-e.lastSeen));Me(()=>{t.loadFromStorage(),m.loadDevices(),W(),window.addEventListener("resize",W)}),De(()=>{window.removeEventListener("resize",W)});function W(){k.value=window.innerWidth<768}ae(()=>t.currentChatPeerId,n=>{n&&(t.loadMessages(n),Y())}),ae(()=>t.currentMessages.length,()=>{le(()=>Y())});function Y(){j.value&&(j.value.scrollTop=j.value.scrollHeight)}function me(n){t.setCurrentChat(n)}function fe(){t.setCurrentChat(null)}function I(n,e="info"){B.value=n,Q.value=e}function Z(){B.value=""}async function pe(){const n=$.value.trim();if(Z(),!n){I("请输入对方 Peer ID","warning");return}if(n===a.myPeerId){I("不能与自己聊天","warning");return}const e=n;console.log("[WeChat] Creating chat with peerId:",n,"username:",e),await t.createChat(n,e),t.setCurrentChat(n),L.value=!1,$.value="",I("已创建聊天","success"),console.log("[WeChat] Chat created successfully")}function ve(){if(!t.currentChatPeerId)return;const e=w.value?.username||t.currentChatPeerId;t.deleteChat(t.currentChatPeerId),I(`已删除与 ${e} 的聊天`,"success")}async function K(){const n=x.value.trim();if(!n||!t.currentChatPeerId)return;console.log("[WeChat] Sending text message:",{to:t.currentChatPeerId,content:n});const e=await J(t.currentChatPeerId,n,"text");console.log("[WeChat] Message sent with ID:",e),x.value="",await le(),console.log("[WeChat] Current messages count:",t.currentMessages.length)}function F(n){U.value&&n&&U.value.setAttribute("accept",n),U.value?.click()}async function he(n){const e=n.target,r=e.files?.[0];if(!(!r||!t.currentChatPeerId)){if(Z(),r.size>50*1024*1024){I("文件大小不能超过 50MB","warning");return}try{const l=await ke(r);let _,P;if(r.type.startsWith("image/"))try{const z=await ge(r);_={name:r.name,size:r.size,width:z.width,height:z.height,data:l},P="image"}catch(z){console.warn("[Chat] Failed to load image dimensions, treating as file:",z),_={name:r.name,size:r.size,type:r.type,data:l},P="file"}else r.type.startsWith("video/")?(_={name:r.name,size:r.size,data:l},P="video"):(_={name:r.name,size:r.size,type:r.type,data:l},P="file");await J(t.currentChatPeerId,_,P),I("文件发送成功","success")}catch(l){console.error("[Chat] File send error:",l),I("文件发送失败","error")}e&&(e.value="")}}function ge(n){return new Promise((e,r)=>{const l=new Image,_=URL.createObjectURL(n);l.onload=()=>{URL.revokeObjectURL(_),e({width:l.width,height:l.height})},l.onerror=()=>{URL.revokeObjectURL(_),r(new Error("Failed to load image"))},l.src=_})}function _e(n){const e=n.content;if(typeof e=="string")return;const r=document.createElement("a");r.href=e.data,r.download=e.name,r.click()}function E(n){return n<1024?n+" B":n<1024*1024?(n/1024).toFixed(1)+" KB":(n/(1024*1024)).toFixed(1)+" MB"}function ee(n){const e=new Date(n),r=new Date;return e.toDateString()===r.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function ye(n){return n.username&&n.username!==n.peerId?n.username:n.peerId}function te(n){return n.username&&n.username!==n.peerId?`${n.peerId.slice(0,8)}...${n.peerId.slice(-4)}`:""}function Ce(n){const{content:e,type:r}=n;if(typeof e=="string")return p("div",{class:"message-text"},e);switch(r){case"image":{const l=e;return p("div",{class:"message-image"},[p("img",{src:l.data,alt:l.name,style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"8px"}}),p("div",{class:"file-info"},[p("span",{class:"file-name"},l.name),p("span",{class:"file-size"},E(l.size))])])}case"video":{const l=e;return p("div",{class:"message-video"},[p("video",{src:l.data,controls:!0,style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"8px"}}),p("div",{class:"file-info"},[p("span",{class:"file-name"},l.name),p("span",{class:"file-size"},E(l.size))])])}case"file":{const l=e;return p("div",{class:"message-file"},[p(oe,{style:{fontSize:"48px",color:"#1890ff"}}),p("div",{class:"file-details"},[p("div",{class:"file-name"},l.name),p("div",{class:"file-size"},E(l.size))]),p("a",{class:"download-link",onClick:()=>_e(n)},"下载")])}default:return p("div",{class:"message-text"},"[不支持的消息类型]")}}return(n,e)=>{const r=g("a-input"),l=g("a-form-item"),_=g("a-typography-text"),P=g("a-form"),z=g("a-modal"),T=g("a-avatar"),C=g("a-button"),N=g("a-empty"),R=g("a-badge"),be=g("a-menu-item"),Oe=g("a-menu"),we=g("a-dropdown");return f(),h("div",qe,[s(z,{open:L.value,"onUpdate:open":e[1]||(e[1]=i=>L.value=i),title:"新增聊天","ok-text":"创建",onOk:pe},{default:d(()=>[s(P,{layout:"vertical"},{default:d(()=>[s(l,{label:"对方 Peer ID"},{default:d(()=>[s(r,{value:$.value,"onUpdate:value":e[0]||(e[0]=i=>$.value=i),placeholder:"请输入对方的 Peer ID"},null,8,["value"])]),_:1}),s(_,{type:"secondary"},{default:d(()=>[...e[8]||(e[8]=[D(" 提示：在发现中心可以查看和复制其他设备的 Peer ID ",-1)])]),_:1}),B.value?(f(),h("div",{key:0,class:S(["inline-message",`inline-message-${Q.value}`])},y(B.value),3)):b("",!0)]),_:1})]),_:1},8,["open"]),c("div",Ge,[!k.value||!u(t).currentChatPeerId?(f(),h("div",Je,[c("div",Qe,[c("div",Xe,[s(T,{src:u(a).userInfo.avatar||void 0,size:40},{default:d(()=>[D(y(u(a).userInfo.username?.charAt(0).toUpperCase()||"U"),1)]),_:1},8,["src"]),c("span",Ye,y(u(a).userInfo.username),1)]),c("div",Ze,[s(C,{type:"text",size:"small","aria-label":"plus",onClick:e[2]||(e[2]=i=>L.value=!0)},{icon:d(()=>[s(u(ie))]),_:1})])]),c("div",Ke,[X.value.length===0?(f(),h("div",et,[s(N,{description:"暂无聊天"},{description:d(()=>[...e[9]||(e[9]=[c("span",{style:{color:"#999"}},"点击 + 号添加聊天，或在发现中心查看可用设备",-1)])]),_:1})])):b("",!0),(f(!0),h(V,null,se(X.value,i=>(f(),h("div",{key:i.peerId,class:S(["contact-item",{active:u(t).currentChatPeerId===i.peerId}]),onClick:wt=>me(i.peerId)},[s(R,{count:i.unreadCount,offset:[-4,4]},{default:d(()=>[s(T,{src:i.avatar||void 0,size:48},{default:d(()=>[D(y(i.username.charAt(0).toUpperCase()),1)]),_:2},1032,["src"])]),_:2},1032,["count"]),c("div",nt,[c("div",at,[c("span",st,y(ye(i)),1),c("span",rt,y(ee(i.lastSeen)),1)]),c("div",it,[te(i)?(f(),h("span",ot,y(te(i)),1)):b("",!0),s(R,{status:i.online?"processing":"default",text:i.online?"在线":"离线"},null,8,["status","text"])])])],10,tt))),128))])])):b("",!0),!k.value||u(t).currentChatPeerId?(f(),h("div",{key:1,class:S(["chat-panel",{"mobile-show":k.value&&u(t).currentChatPeerId}])},[w.value?(f(),h(V,{key:0},[c("div",lt,[c("div",ct,[k.value?(f(),M(C,{key:0,type:"text",onClick:fe,class:"back-button"},{icon:d(()=>[s(u(Le))]),_:1})):b("",!0),s(T,{src:w.value.avatar||void 0,size:36},{default:d(()=>[D(y(w.value.username.charAt(0).toUpperCase()),1)]),_:1},8,["src"]),c("div",ut,[c("div",dt,y(w.value.username),1),c("div",mt,[s(R,{status:w.value.online?"processing":"default",text:w.value.online?"在线":"离线"},null,8,["status","text"])])])]),s(we,null,{overlay:d(()=>[s(Oe,null,{default:d(()=>[s(be,{onClick:ve,style:{color:"#ff4d4f"}},{default:d(()=>[s(u($e)),e[10]||(e[10]=D(" 删除聊天 ",-1))]),_:1})]),_:1})]),default:d(()=>[s(C,{type:"text",size:"small","aria-label":"more"},{icon:d(()=>[s(u(H))]),_:1})]),_:1})]),c("div",{ref_key:"messagesContainer",ref:j,class:"messages-area"},[u(t).currentMessages.length===0?(f(),h("div",ft,[s(N,{description:"开始聊天吧"},{default:d(()=>[s(u(ne),{style:{"font-size":"48px",color:"#ddd"}})]),_:1})])):(f(),h("div",pt,[(f(!0),h(V,null,se(u(t).currentMessages,i=>(f(),h("div",{key:i.id,class:S(["message-item",{"is-self":i.from===u(a).myPeerId}])},[c("div",vt,[(f(),M(je(Ce(i))))]),c("div",ht,[i.from===u(a).myPeerId?(f(),h("span",{key:0,class:S(["message-status",`message-status-${i.status}`])},[i.status==="delivered"?(f(),M(u(Ue),{key:0})):i.status==="failed"?(f(),M(u(Be),{key:1})):i.status==="sending"?(f(),M(u(Fe),{key:2})):b("",!0)],2)):b("",!0),c("span",gt,y(ee(i.timestamp)),1)])],2))),128))]))],512),c("div",_t,[c("div",yt,[s(C,{type:"text",size:"small","aria-label":"upload-file",onClick:e[3]||(e[3]=i=>F())},{icon:d(()=>[s(u(ie))]),_:1}),s(C,{type:"text",size:"small","aria-label":"upload-image",onClick:e[4]||(e[4]=i=>F("image/*"))},{icon:d(()=>[s(u(q))]),_:1}),s(C,{type:"text",size:"small","aria-label":"upload-file",onClick:e[5]||(e[5]=i=>F())},{icon:d(()=>[s(u(oe))]),_:1}),s(C,{type:"text",size:"small","aria-label":"upload-video",onClick:e[6]||(e[6]=i=>F("video/*"))},{icon:d(()=>[s(u(We))]),_:1}),c("input",{ref_key:"fileInputRef",ref:U,type:"file","data-testid":"file-input",style:{display:"none"},onChange:he},null,544)]),c("div",Ct,[s(r,{value:x.value,"onUpdate:value":e[7]||(e[7]=i=>x.value=i),placeholder:"输入消息...",size:"large",onPressEnter:K},{suffix:d(()=>[s(C,{type:"primary",disabled:!x.value.trim(),onClick:K,"aria-label":"send"},{icon:d(()=>[s(u(G))]),_:1},8,["disabled"])]),_:1},8,["value"])])])],64)):(f(),h("div",bt,[s(N,{description:"选择一个联系人开始聊天"},{image:d(()=>[s(u(ne),{style:{"font-size":"64px",color:"#ccc"}})]),_:1})]))],2)):b("",!0)])])}}}),$t=Ee(Ot,[["__scopeId","data-v-bb23337d"]]);export{$t as default};
