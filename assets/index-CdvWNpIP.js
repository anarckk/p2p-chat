import{G as de,r as N,s as j,H as me}from"./index-B_j7crxL.js";import{c as S,P as Ae,g as we,$ as Pe}from"./PeerHttpUtil-DRi0vkli.js";import{n as ke}from"./networkLogDB-BlD6FS5Z.js";class Te{db=null;DB_NAME="p2p-chat";DB_VERSION=1;async init(){if(!this.db)return new Promise((o,r)=>{const s=indexedDB.open(this.DB_NAME,this.DB_VERSION);s.onerror=()=>{console.error("[IndexedDB] Failed to open database:",s.error),r(s.error)},s.onsuccess=()=>{this.db=s.result,console.log("[IndexedDB] Database opened successfully"),o()},s.onupgradeneeded=n=>{const t=n.target.result;if(t.objectStoreNames.contains("avatars")||t.createObjectStore("avatars",{keyPath:"id"}).createIndex("peerId","peerId",{unique:!1}),!t.objectStoreNames.contains("messages")){const a=t.createObjectStore("messages",{keyPath:"id"});a.createIndex("toPeerId","toPeerId",{unique:!1}),a.createIndex("timestamp","timestamp",{unique:!1})}t.objectStoreNames.contains("devices")||t.createObjectStore("devices",{keyPath:"peerId"}).createIndex("username","username",{unique:!1}),console.log("[IndexedDB] Object stores created")}})}async ensureInitialized(){this.db||await this.init()}async set(o,r){return await this.ensureInitialized(),new Promise((s,n)=>{const c=this.db.transaction([o],"readwrite").objectStore(o).put(r);c.onsuccess=()=>{console.log(`[IndexedDB] Data saved to ${o}:`,r.id||r.peerId||r.toPeerId),s()},c.onerror=()=>{console.error(`[IndexedDB] Failed to save to ${o}:`,c.error),n(c.error)}})}async get(o,r){return await this.ensureInitialized(),new Promise((s,n)=>{const c=this.db.transaction([o],"readonly").objectStore(o).get(r);c.onsuccess=()=>{s(c.result)},c.onerror=()=>{console.error(`[IndexedDB] Failed to get from ${o}:`,c.error),n(c.error)}})}async getAll(o){return await this.ensureInitialized(),new Promise((r,s)=>{const a=this.db.transaction([o],"readonly").objectStore(o).getAll();a.onsuccess=()=>{r(a.result)},a.onerror=()=>{console.error(`[IndexedDB] Failed to get all from ${o}:`,a.error),s(a.error)}})}async delete(o,r){return await this.ensureInitialized(),new Promise((s,n)=>{const c=this.db.transaction([o],"readwrite").objectStore(o).delete(r);c.onsuccess=()=>{console.log(`[IndexedDB] Data deleted from ${o}:`,r),s()},c.onerror=()=>{console.error(`[IndexedDB] Failed to delete from ${o}:`,c.error),n(c.error)}})}async clearStore(o){return await this.ensureInitialized(),new Promise((r,s)=>{const a=this.db.transaction([o],"readwrite").objectStore(o).clear();a.onsuccess=()=>{console.log(`[IndexedDB] Store ${o} cleared`),r()},a.onerror=()=>{console.error(`[IndexedDB] Failed to clear ${o}:`,a.error),s(a.error)}})}close(){this.db&&(this.db.close(),this.db=null,console.log("[IndexedDB] Database closed"))}}const A=new Te,K="p2p_user_info",Q="p2p_user_info_meta",ye="p2p_network_acceleration",Ie="p2p_network_logging",te="user_avatar_migrated_to_indexeddb",q="my-avatar",H=de("user",()=>{const e=N({username:"",avatar:null,peerId:null,version:0}),o=N(!1),r=N(!1),s=N(!1),n=j(()=>e.value.peerId);async function t(){await a();const l=localStorage.getItem(Q);if(l)try{const m=JSON.parse(l);e.value={username:m.username||"",avatar:null,peerId:m.peerId||null,version:m.version||0},o.value=!!m.username;const O=await A.get("avatars",q);if(O&&O.avatar)e.value.avatar=O.avatar;else{const P=localStorage.getItem(K);if(P)try{const R=JSON.parse(P);R.avatar&&(e.value.avatar=R.avatar,console.log("[UserStore] Loaded avatar from fallback (old localStorage key)"),await A.set("avatars",{id:q,peerId:q,avatar:R.avatar}),console.log("[UserStore] Migrated avatar to IndexedDB"))}catch(R){console.error("[UserStore] Failed to load avatar from fallback:",R)}}}catch(m){console.error("[UserStore] Failed to load user info:",m)}return o.value}async function a(){if(!localStorage.getItem(te))try{const m=localStorage.getItem(K);if(!m){localStorage.setItem(te,"true");return}const O=JSON.parse(m);console.log("[UserStore] 开始迁移用户数据到混合存储...");const{avatar:P,...R}=O;localStorage.setItem(Q,JSON.stringify(R)),P&&(await A.set("avatars",{id:q,peerId:q,avatar:P}),console.log("[UserStore] 用户头像已移至 IndexedDB")),localStorage.removeItem(K),localStorage.setItem(te,"true"),console.log("[UserStore] 用户数据迁移完成！")}catch(m){console.error("[UserStore] 迁移失败:",m)}}async function c(l){const m=l.username!==void 0&&l.username!==e.value.username,O=l.avatar!==void 0&&l.avatar!==e.value.avatar&&!((l.avatar===null||l.avatar===void 0)&&e.value.avatar===null),P=m||O,{avatar:R,peerId:v,...u}=l;e.value={...e.value,...u,...v!=null?{peerId:v}:{}},P&&(e.value.version+=1),R!==void 0&&(e.value.avatar=R,R?await A.set("avatars",{id:q,peerId:q,avatar:R}):await A.delete("avatars",q));const{avatar:y,..._}=e.value;localStorage.setItem(Q,JSON.stringify(_)),localStorage.setItem(K,JSON.stringify(e.value)),l.username&&(o.value=!0)}async function f(l){e.value.peerId=l;const{avatar:m,...O}=e.value;localStorage.setItem(Q,JSON.stringify(O)),localStorage.setItem(K,JSON.stringify(e.value))}async function g(){e.value={username:"",avatar:null,peerId:null,version:0},o.value=!1,localStorage.removeItem(Q),await A.delete("avatars",q)}function D(){const l=localStorage.getItem(ye);return l!==null&&(r.value=l==="true"),r.value}function b(l){r.value=l,localStorage.setItem(ye,String(l))}function C(){const l=localStorage.getItem(Ie);return l!==null&&(s.value=l==="true"),s.value}function w(l){s.value=l,localStorage.setItem(Ie,String(l))}return{userInfo:e,isSetup:o,myPeerId:n,loadUserInfo:t,saveUserInfo:c,setPeerId:f,clearUserInfo:g,networkAccelerationEnabled:r,loadNetworkAcceleration:D,setNetworkAcceleration:b,networkLoggingEnabled:s,loadNetworkLogging:C,setNetworkLogging:w}}),J="p2p_messages_",oe="p2p_contacts",Se="p2p_pending_messages",ne="message_content_migrated_to_indexeddb",L=de("chat",()=>{const e=N(new Map),o=N(new Map),r=N(new Map),s=N(null);async function n(i,d,p){const I=`msg-content-${i}`;await A.set("messages",{id:I,messageId:i,type:d,content:p})}async function t(i){const d=`msg-content-${i}`;return(await A.get("messages",d))?.content||null}async function a(){if(!localStorage.getItem(ne))try{console.log("[ChatStore] 开始检查消息数据迁移...");const d=localStorage.getItem(oe);if(!d){localStorage.setItem(ne,"true");return}const p=JSON.parse(d),I=Object.keys(p);let E=0;for(const V of I){const ge=localStorage.getItem(J+V);if(!ge)continue;const pe=JSON.parse(ge);let Z=0;for(const $ of pe)if($.type==="image"||$.type==="file"||$.type==="video"){const ee=$.content;ee&&ee.length>1e3&&(await n($.id,$.type,ee),$.content=`msg-content-${$.id}`,Z++)}Z>0&&(localStorage.setItem(J+V,JSON.stringify(pe)),E+=Z)}localStorage.setItem(ne,"true"),console.log(`[ChatStore] 消息数据迁移完成！迁移了 ${E} 条大型消息内容`)}catch(d){console.error("[ChatStore] 消息数据迁移失败:",d)}}const c=j(()=>s.value?e.value.get(s.value)||[]:[]),f=j(()=>Array.from(o.value.values()).sort((i,d)=>i.online!==d.online?i.online?-1:1:d.lastSeen-i.lastSeen));async function g(){await a();const i=localStorage.getItem(oe);if(i)try{const p=JSON.parse(i);o.value=new Map(Object.entries(p));for(const[I]of o.value)await w(I)}catch(p){console.error("[ChatStore] Failed to load contacts:",p)}const d=localStorage.getItem(Se);if(d)try{const p=JSON.parse(d);r.value=new Map(Object.entries(p))}catch(p){console.error("[ChatStore] Failed to load pending messages:",p)}}function D(){const i=Object.fromEntries(o.value);localStorage.setItem(oe,JSON.stringify(i))}function b(){const i=Object.fromEntries(r.value);localStorage.setItem(Se,JSON.stringify(i))}async function C(i){const d=e.value.get(i)||[],p=[];for(const I of d)if(I.type==="image"||I.type==="file"||I.type==="video"){const E=I.content;E.startsWith("msg-content-")?p.push(I):E&&E.length>1e3?(await n(I.id,I.type,E),p.push({...I,content:`msg-content-${I.id}`})):p.push(I)}else p.push(I);localStorage.setItem(J+i,JSON.stringify(p))}async function w(i){const d=localStorage.getItem(J+i);if(d)try{const p=JSON.parse(d),I=[];for(const E of p)if((E.type==="image"||E.type==="file"||E.type==="video")&&typeof E.content=="string"&&E.content.startsWith("msg-content-")){const V=await t(E.id);I.push({...E,content:V||E.content})}else I.push(E);return e.value.set(i,I),I}catch(p){console.error("[ChatStore] Failed to load messages:",p)}return[]}function l(i){const d=o.value.get(i.peerId);d?o.value.set(i.peerId,{...d,...i}):o.value.set(i.peerId,i),D()}function m(i){return o.value.get(i)}function O(i,d){const p=o.value.get(i);p&&(p.online=d,p.lastSeen=Date.now(),D())}async function P(i,d){e.value.has(i)||e.value.set(i,[]),e.value.get(i).push(d),await C(i);const p=o.value.get(i);if(p&&d.from===i){const I=e.value.get(i);I&&I.length>0&&(p.lastSeen=d.timestamp),D()}}async function R(i,d,p){const I=e.value.get(i);if(I){const E=I.find(V=>V.id===d);E&&(E.status=p,p==="delivered"&&(E.deliveredAt=Date.now()),await C(i))}}function v(i){for(const d of e.value.values()){const p=d.find(I=>I.id===i);if(p)return p}return null}function u(i){r.value.set(i.id,i),b()}function y(i){r.value.delete(i),b()}function _(i){const d=r.value.get(i);return d?(d.retryCount++,b(),!(d.maxRetries!==void 0&&d.retryCount>d.maxRetries)):!1}function k(i){return Array.from(r.value.values()).filter(d=>d.to===i)}function U(i){const d=Array.from(r.value.entries()).filter(([,p])=>p.to===i);return d.forEach(([p])=>r.value.delete(p)),b(),d.map(([,p])=>p)}async function M(i,d=i){o.value.has(i)||l({peerId:i,username:d,avatar:null,online:!1,lastSeen:Date.now(),unreadCount:0,chatVersion:0}),await w(i);const p=e.value.get(i);if(!p||p.length===0){const I={id:`system-${i}-${Date.now()}`,from:i,to:"system",content:"",timestamp:Date.now(),status:"delivered",type:"system"};await P(i,I)}}async function Y(i){o.value.delete(i),e.value.delete(i);const d=localStorage.getItem(J+i);if(d)try{const p=JSON.parse(d);for(const I of p)(I.type==="image"||I.type==="file"||I.type==="video")&&await A.delete("messages",`msg-content-${I.id}`)}catch(p){console.error("[ChatStore] Failed to clean up IndexedDB messages:",p)}localStorage.removeItem(J+i),D(),U(i),s.value===i&&(s.value=null)}function Re(i){if(s.value=i,i){const d=o.value.get(i);d&&(d.unreadCount=0,D())}}function Be(i){const d=o.value.get(i);d&&s.value!==i&&(d.unreadCount++,D())}function Me(){return Array.from(o.value.values()).reduce((i,d)=>i+d.unreadCount,0)}return{messages:e,contacts:o,pendingMessages:r,currentChatPeerId:s,currentMessages:c,sortedContacts:f,loadFromStorage:g,loadMessages:w,addOrUpdateContact:l,getContact:m,setContactOnline:O,addMessage:P,updateMessageStatus:R,getMessageById:v,addPendingMessage:u,removePendingMessage:y,incrementRetryCount:_,getPendingMessagesForPeer:k,clearPendingMessagesForPeer:U,createChat:M,deleteChat:Y,setCurrentChat:Re,incrementUnread:Be,getTotalUnread:Me}}),De="discovered_devices",re="discovered_devices_meta",se="avatar_migrated_to_indexeddb",F=600*1e3,Ue=3,Ne=Ue*24*60*60*1e3,T=de("device",()=>{const e=N(new Map);let o=null;async function r(){try{await s();const v=localStorage.getItem(re);if(v){const u=JSON.parse(v),y=Object.values(u),_=await A.getAll("avatars"),k=new Map(_.map(M=>[M.peerId,M.avatar])),U=Date.now();e.value=new Map(y.map(M=>[M.peerId,{...M,avatar:k.get(M.peerId)||null,isOnline:U-M.lastHeartbeat<F}])),e.value.forEach((M,Y)=>{console.log("[DeviceStore] Loaded device: "+Y+" isBootstrap="+M.isBootstrap+" realPeerId="+M.realPeerId)}),console.log(`[DeviceStore] Loaded ${e.value.size} devices from storage (${k.size} avatars from IndexedDB)`),await m()}}catch(v){console.error("[DeviceStore] Failed to load devices:",v)}}async function s(){if(!localStorage.getItem(se))try{const u=localStorage.getItem(De);if(!u){localStorage.setItem(se,"true");return}const y=Object.values(JSON.parse(u));console.log(`[DeviceStore] 开始迁移 ${y.length} 个设备到混合存储...`);const _={},k=[];for(const U of y){const{avatar:M,...Y}=U;_[U.peerId]=Y,M&&(await A.set("avatars",{id:U.peerId,peerId:U.peerId,avatar:M}),k.push({peerId:U.peerId,avatar:M}))}localStorage.setItem(re,JSON.stringify(_)),localStorage.removeItem(De),localStorage.setItem(se,"true"),console.log(`[DeviceStore] 迁移完成！${k.length} 个头像已移至 IndexedDB`)}catch(u){console.error("[DeviceStore] 迁移失败:",u)}}async function n(){try{const v={};for(const[u,y]of e.value){const{avatar:_,isBootstrap:k,...U}=y;v[u]=U,_?await A.set("avatars",{id:u,peerId:u,avatar:_}):await A.delete("avatars",u)}localStorage.setItem(re,JSON.stringify(v))}catch(v){console.error("[DeviceStore] Failed to save devices:",v)}}const t=j(()=>Array.from(e.value.values())),a=j(()=>{const v=Date.now();return t.value.filter(u=>v-u.lastHeartbeat<F)}),c=j(()=>{const v=Date.now();return t.value.filter(u=>v-u.lastHeartbeat>=F)});async function f(v){const u=e.value.get(v.peerId),y=Date.now();u?(u.username=v.username,u.avatar=v.avatar,u.lastHeartbeat=v.lastHeartbeat,u.isOnline=y-v.lastHeartbeat<F,u.isOnline?("isBootstrap"in v&&(u.isBootstrap=v.isBootstrap),"realPeerId"in v&&(u.realPeerId=v.realPeerId)):(u.isBootstrap=!1,u.realPeerId=void 0)):e.value.set(v.peerId,{...v,firstDiscovered:v.firstDiscovered||y,isOnline:!0}),await n()}function g(v){return e.value.get(v)}async function D(v){const u=e.value.get(v);u&&(u.lastHeartbeat=Date.now(),u.isOnline=!0,await n())}async function b(v,u){const y=e.value.get(v);if(y){const _=y.isBootstrap;y.isOnline=u,u?y.lastHeartbeat=Date.now():(y.isBootstrap&&console.log("[DeviceStore] 设备离线，清除启动者标签: "+v+" (wasBootstrap: "+_+")"),y.isBootstrap=!1,y.realPeerId=void 0),await n(),me(e),console.log("[DeviceStore] updateDeviceOnlineStatus: "+v+" isOnline="+u+" (wasBootstrap: "+_+", isBootstrap: "+y.isBootstrap+")")}else console.warn("[DeviceStore] updateDeviceOnlineStatus: device not found: "+v)}async function C(v){const u=Date.now();v.forEach(y=>{const _=e.value.get(y.peerId);_?(_.lastHeartbeat=Math.max(_.lastHeartbeat,y.lastHeartbeat),_.isOnline=u-_.lastHeartbeat<F,"isBootstrap"in y&&(_.isBootstrap=y.isBootstrap),"realPeerId"in y&&(_.realPeerId=y.realPeerId)):e.value.set(y.peerId,{...y,firstDiscovered:u,isOnline:!0})}),await n()}async function w(v){return e.value.delete(v)?(await A.delete("avatars",v),await n(),!0):!1}async function l(){const v=Date.now(),u=[];e.value.forEach((y,_)=>{v-y.lastHeartbeat>Ne&&u.push(_)});for(const y of u)e.value.delete(y),await A.delete("avatars",y),console.log(`[DeviceStore] Removed expired device: ${y}`);return u.length>0&&await n(),u.length}async function m(){const v=Date.now();e.value.forEach(u=>{u.isOnline=v-u.lastHeartbeat<F}),await n(),me(e)}function O(v){o===null&&(l().catch(u=>console.error("[DeviceStore] Initial cleanup failed:",u)),o=window.setInterval(async()=>{console.log("[DeviceStore] Running heartbeat check...");const u=[];e.value.forEach(y=>{u.push(y)});for(const y of u)try{if(await v(y))await D(y.peerId);else{const k=e.value.get(y.peerId);k&&(k.isOnline=!1)}}catch{const k=e.value.get(y.peerId);k&&(k.isOnline=!1)}await m(),await l()},600*1e3),console.log("[DeviceStore] Heartbeat timer started"))}function P(){o!==null&&(clearInterval(o),o=null,console.log("[DeviceStore] Heartbeat timer stopped"))}async function R(){e.value.clear(),await A.clearStore("avatars"),await n()}return{devices:e,allDevices:t,onlineDevices:a,offlineDevices:c,loadDevices:r,addOrUpdateDevice:f,getDevice:g,updateHeartbeat:D,updateDeviceOnlineStatus:b,addDevices:C,removeDevice:w,cleanupExpiredDevices:l,updateOnlineStatus:m,startHeartbeatTimer:O,stopHeartbeatTimer:P,clearAll:R}});let B=null;function ce(e){B=e}let he=null;function G(e){he=e}const h={message:null,deliveryAck:null,discoveryResponse:null,discoveryNotification:null,usernameQuery:null,usernameResponse:null,onlineCheckQuery:null,onlineCheckResponse:null,userInfoQuery:null,userInfoResponse:null,userInfoUpdate:null,networkAccelerationStatus:null,deviceListRequest:null,deviceListResponse:null},ae=new Set;let ie=null,be=!1;function _e(e){ie=e}function Oe(e){be=e}const x=N(!1),z=N(!1);async function W(e){const o=B,r=T(),s=L();if(!o)return null;S.sync.requestInfo({to:e});try{const n=await o.queryUserInfo(e);if(n){console.log("[Peer] Got user info for "+e+": "+JSON.stringify({username:n.username,version:n.version}));const t=r.getDevice(e);r.addOrUpdateDevice({peerId:e,username:n.username,avatar:n.avatar,lastHeartbeat:Date.now(),firstDiscovered:t?.firstDiscovered||Date.now(),userInfoVersion:n.version});const a=s.getContact(e);return a&&s.addOrUpdateContact({...a,username:n.username,avatar:n.avatar,lastSeen:Date.now()}),n}}catch(n){console.error("[Peer] Request user info error:",n)}return null}async function qe(e){const o=B,r=T();if(!o)return[];try{S.discovery.add({peerId:e});const s=await o.queryDiscoveredDevices(e);return s.length>0&&r.addDevices(s),s}catch(s){return console.error("[Peer] Query discovered devices error:",s),[]}}function $e(){const e=B;return e?e.getDiscoveredDevices():[]}function xe(){return T().allDevices}function He(e){const o=B,r=T();o&&(o.addDiscoveredDevice(e),r.addOrUpdateDevice(e))}async function Le(e){const o=B,r=H();if(!o){console.warn("[Peer] sendDiscoveryNotification: peerInstance is null");return}try{console.log("[Peer] Sending discovery notification to:",e,"username:",r.userInfo.username),S.discovery.notify({to:e,username:r.userInfo.username}),await o.sendDiscoveryNotification(e,r.userInfo.username||"",r.userInfo.avatar,r.userInfo.version||0),console.log("[Peer] Discovery notification sent successfully to:",e)}catch(s){console.error("[Peer] Send discovery notification error:",s)}}async function Ve(e){const o=B;if(!o)return console.warn("[Peer] queryUsername: peerInstance is null"),null;try{console.log("[Peer] Querying username for:",e),S.discovery.query({from:e});const r=await o.queryUsername(e);return console.log("[Peer] Query username result:",r),r}catch(r){return console.error("[Peer] Query username error: "+String(r)),null}}async function Je(e){const o=B,r=H();if(!o)return!1;try{S.heartbeat.check({to:e,version:r.userInfo.version});const s=await o.checkOnline(e,r.userInfo.username||"",r.userInfo.avatar,r.userInfo.version);return s!==null&&s.isOnline?(S.heartbeat.online({from:e}),!0):(s!==null&&!s.isOnline&&S.heartbeat.offline({peerId:e}),s!==null&&s.isOnline)}catch(s){return console.error("[Peer] Check online error: "+String(s)),S.heartbeat.offline({peerId:e}),!1}}async function X(e){const o=B,r=T();if(!o)return[];S.deviceDiscovery.requestSent({to:e});try{const s=await o.requestDeviceList(e);return s.length>0&&r.addDevices(s),s}catch(s){return console.error("[Peer] Request device list error:",s),[]}}async function Fe(){const e=B,o=T();if(!e)return;const r=o.allDevices;console.log("[Peer] Requesting device lists from "+r.length+" devices");const s=r.map(n=>X(n.peerId));await Promise.allSettled(s)}async function je(){const e=B,o=H(),r=T();if(!e)return;const s=r.allDevices,{username:n,avatar:t,version:a}=o.userInfo;console.log("[Peer] Broadcasting user info update to",s.length,"devices:",{username:n,version:a});const c=s.map(f=>f.isOnline?e.sendUserInfoUpdate(f.peerId,n,t,a).catch(g=>{console.warn("[Peer] Failed to send user info update to",f.peerId,g)}):Promise.resolve());await Promise.allSettled(c),console.log("[Peer] User info update broadcast completed")}function Ye(e){const o=L(),r=T(),s=H();return h.deliveryAck=(n,t)=>{if(n.type==="delivery_ack"){const{messageId:a}=n;S.message.delivered({from:t,messageId:a});const c=o.getMessageById(a);c&&(o.updateMessageStatus(c.to,a,"delivered"),o.removePendingMessage(a))}},e.onProtocol("delivery_ack",h.deliveryAck),h.discoveryResponse=(n,t)=>{if(n.type==="discovery_response"){if(n.devices){const{devices:a}=n;S.discovery.found({peerId:t}),a?.forEach(c=>{e?.addDiscoveredDevice(c)})}else if(n.username){const{username:a,avatar:c}=n;console.log("[Peer] Received discovery response from:",t,"username:",a);const f=r.getDevice(t),g={peerId:t,username:a,avatar:c,lastHeartbeat:Date.now(),firstDiscovered:f?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(g),r.addOrUpdateDevice(g),window.dispatchEvent(new CustomEvent("discovery-devices-updated"))}}},e.onProtocol("discovery_response",h.discoveryResponse),h.discoveryNotification=(n,t)=>{if(console.log("[Peer] discoveryNotificationHandler called:",{type:n.type,from:t}),n.type==="discovery_notification"){const{fromUsername:a,fromAvatar:c,profileVersion:f}=n;S.discovery.notified({from:t,username:a}),console.log("[Peer] Received discovery notification from:",t,"username:",a,"profileVersion:",f);const g=r.getDevice(t),D=!g||g.userInfoVersion===void 0||g.userInfoVersion<f,b={peerId:t,username:a,avatar:c,lastHeartbeat:Date.now(),firstDiscovered:g?.firstDiscovered||Date.now(),isOnline:!0,userInfoVersion:f};console.log("[Peer] Adding device to store:",b),e?.addDiscoveredDevice(b),r.addOrUpdateDevice(b),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),o.getContact(t)||(o.createChat(t,a),o.addOrUpdateContact({peerId:t,username:a,avatar:c,online:!0,lastSeen:Date.now(),unreadCount:0,chatVersion:0}));const C=s.userInfo.username||"",w=s.userInfo.avatar;console.log("[Peer] Sending discovery response to:",t,"username:",C,"avatar:",w),e?.sendDiscoveryResponse(t,C,w),D&&g!==void 0&&(console.log("[Peer] Profile version mismatch, requesting latest user info from:",t),W(t)),X(t).then(l=>{l.length>0&&console.log("[Peer] Discovered "+l.length+" devices from "+t)}).catch(l=>{console.error("[Peer] Request device list error after discovery notification:",l)})}},e.onProtocol("discovery_notification",h.discoveryNotification),h.usernameQuery=(n,t)=>{n.type==="username_query"&&(S.discovery.query({from:t}),e?.respondUsernameQuery(t,s.userInfo.username||"",s.userInfo.avatar))},e.onProtocol("username_query",h.usernameQuery),h.usernameResponse=(n,t)=>{if(n.type==="username_response"){const{username:a,avatar:c}=n;S.discovery.response({to:t,username:a});const f=o.getContact(t);f&&o.addOrUpdateContact({...f,username:a,avatar:c});const g=r.getDevice(t),D={peerId:t,username:a,avatar:c,lastHeartbeat:Date.now(),firstDiscovered:g?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(D),r.addOrUpdateDevice(D)}},e.onProtocol("username_response",h.usernameResponse),h.onlineCheckQuery=(n,t)=>{if(n.type==="online_check_query"){const{userInfoVersion:a}=n,f=r.getDevice(t)?.userInfoVersion||0;S.heartbeat.response({to:t,version:s.userInfo.version}),e?.respondOnlineCheck(t,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version),a!==void 0&&a!==f&&(S.sync.versionMismatch({peerId:t,stored:f,theirs:a}),S.sync.requestInfo({to:t}),W(t))}},e.onProtocol("online_check_query",h.onlineCheckQuery),h.onlineCheckResponse=(n,t)=>{if(n.type==="online_check_response"){const{isOnline:a,username:c,avatar:f,userInfoVersion:g}=n,D=r.getDevice(t),b=D?.userInfoVersion||0;r.addOrUpdateDevice({peerId:t,username:c,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:D?.firstDiscovered||Date.now(),userInfoVersion:g});const C=o.getContact(t);C&&o.addOrUpdateContact({...C,username:c,avatar:f,online:a,lastSeen:Date.now()}),g!==void 0&&g!==b&&(S.sync.versionMismatch({peerId:t,stored:b,theirs:g}),W(t))}},e.onProtocol("online_check_response",h.onlineCheckResponse),h.userInfoQuery=(n,t)=>{n.type==="user_info_query"&&(S.sync.respondInfo({to:t,version:s.userInfo.version}),e?.respondUserInfo(t,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version))},h.userInfoResponse=(n,t)=>{if(n.type==="user_info_response"){const{username:a,avatar:c,version:f}=n;S.sync.updateInfo({peerId:t,username:a,version:f});const g=r.getDevice(t);r.addOrUpdateDevice({peerId:t,username:a,avatar:c,lastHeartbeat:Date.now(),firstDiscovered:g?.firstDiscovered||Date.now(),userInfoVersion:f});const D=o.getContact(t);D&&o.addOrUpdateContact({...D,username:a,avatar:c,lastSeen:Date.now()})}},e.onProtocol("user_info_query",h.userInfoQuery),e.onProtocol("user_info_response",h.userInfoResponse),h.userInfoUpdate=(n,t)=>{if(n.type==="user_info_update"){const{username:a,avatar:c,version:f}=n;console.log("[Peer] Received user info update from:",t,"username:",a,"version:",f);const g=r.getDevice(t);if(g&&(!g.userInfoVersion||f>g.userInfoVersion)){r.addOrUpdateDevice({...g,username:a,avatar:c,userInfoVersion:f,lastHeartbeat:Date.now()});const D=o.getContact(t);D&&o.addOrUpdateContact({peerId:t,username:a,avatar:c,online:!0,lastSeen:Date.now(),unreadCount:D.unreadCount||0,chatVersion:D.chatVersion||0}),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),console.log("[Peer] User info updated for device:",t)}}},e.onProtocol("user_info_update",h.userInfoUpdate),h.networkAccelerationStatus=(n,t)=>{if(n.type==="network_acceleration_status"){const{enabled:a}=n;console.log("[Peer] Network acceleration status from "+t+": "+a),S.networkAcceleration.statusSync({from:t,enabled:a});const c=r.getDevice(t);c&&r.addOrUpdateDevice({...c,networkAccelerationEnabled:a})}},e.onProtocol("network_acceleration_status",h.networkAccelerationStatus),h.deviceListResponse=n=>{if(n.type==="device_list_response"){const{devices:t}=n;if(S.deviceDiscovery.responseReceived({deviceCount:t?.length||0}),t&&t.length>0){const a=[];t.forEach(c=>{!r.getDevice(c.peerId)&&!ae.has(c.peerId)&&a.push(c)}),r.addDevices(t),a.forEach(c=>{ae.add(c.peerId),S.deviceDiscovery.newDevice({peerId:c.peerId,username:c.username}),X(c.peerId).then(f=>{f.length>0&&console.log("[Peer] Discovered "+f.length+" more devices from "+c.peerId)}).catch(f=>{console.error("[Peer] Recursive device list request error:",f)}).finally(()=>{ae.delete(c.peerId)})})}}},e.onProtocol("device_list_response",h.deviceListResponse),h.deviceListRequest=(n,t)=>{if(n.type==="device_list_request"){S.deviceDiscovery.requestReceived({from:t});const a=r.allDevices;e?.sendDeviceListResponse(t,a)}},e.onProtocol("device_list_request",h.deviceListRequest),e}function Ke(e){const{from:o,data:r}=e;if(r&&typeof r=="object"&&"id"in r&&"type"in r){Qe(o,r);return}}async function Qe(e,o){const r=L(),s=T(),{id:n,type:t}=o;S.message.received({from:e,msgType:t,messageId:n});const a=JSON.stringify({id:n,from:e,to:o.to,type:t,timestamp:o.timestamp});console.log("[Peer] Handling chat message:",a.substring(0,200));const c=r.getContact(e);r.setContactOnline(e,!0),await s.updateDeviceOnlineStatus(e,!0),console.log("[Peer] Contact online: "+e),c?(r.incrementUnread(e),console.log("[Peer] Incremented unread for "+e)):r.addOrUpdateContact({peerId:e,username:e,avatar:null,online:!0,lastSeen:Date.now(),unreadCount:1,chatVersion:0}),r.addMessage(e,o),console.log("[Peer] Message saved to store: "+o.id),await Ge(e)}async function Ge(e){const o=L(),r=o.getPendingMessagesForPeer(e);if(r.length!==0){console.log("[Peer] Retrying "+r.length+" pending messages for "+e);for(const s of r)await ve(e,s.id,s.content,s.type)?o.removePendingMessage(s.id):o.incrementRetryCount(s.id)||(o.removePendingMessage(s.id),o.updateMessageStatus(e,s.id,"failed"))}}async function ve(e,o,r,s="text"){const n=B;if(!n)return console.error("[Peer] Peer instance not initialized"),!1;console.log("[Peer] Sending chat message: peerId="+e+", msgId="+o+", type="+s);try{const t=await n.send(e,o,r,s);return console.log("[Peer] Send result: msgId="+t.messageId+", sent="+t.sent+", stage="+t.stage),t.sent&&L().updateMessageStatus(e,o,"sending"),t.sent}catch(t){return console.error("[Peer] Send error: "+String(t)),!1}}function Ce(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}async function ze(e,o,r="text"){const s=H(),n=L();if(!x.value||!B)throw console.error("[Peer] Peer not connected, cannot send message"),new Error("Peer not connected");const t=Ce();S.message.send({to:e,msgType:r,messageId:t});const a={id:t,from:s.myPeerId||"",to:e,content:o,timestamp:Date.now(),status:"sending",type:r};n.addMessage(e,a),console.log("[Peer] Message added to local store: "+a.id);const c=await ve(e,t,o,r);return console.log("[Peer] Send result: messageId="+t+", success="+c),c?n.updateMessageStatus(e,t,"sending"):(n.addPendingMessage({id:t,to:e,content:o,timestamp:Date.now(),retryCount:0,type:r}),n.updateMessageStatus(e,t,"failed")),t}function We(){return e=>{Ke(e)}}function fe(){ie!==null&&(clearTimeout(ie),_e(null),console.log("[Peer] Auto-reconnect stopped")),Oe(!1)}function le(e){be||(Oe(!0),console.log("[Peer] Starting auto-reconnect in 10 seconds..."),_e(window.setTimeout(async()=>{console.log("[Peer] Attempting to reconnect...");try{await e(),console.log("[Peer] Reconnected successfully"),fe()}catch(o){console.error("[Peer] Reconnect failed:",o),le(e)}},1e4)))}function ue(e){return new Promise((o,r)=>{const s=performance.now();console.log("[Peer-Performance] ===== Peer 初始化开始 ====="),console.log("[Peer-Performance] Timestamp:",Date.now());const n=(w,l)=>{const m=performance.now(),O=Math.round(m-s);console.log(`[Peer-Performance] [${w}] +${O}ms ${l}`)};n("start","开始初始化 Peer");const t=B;t&&(n("destroy-old","销毁旧的 peerInstance"),t.destroy(),ce(null));let a=e.userInfo.peerId;if(a)n("reuse-peerid",`复用已存储的 PeerId: ${a}`);else{n("generate-peerid","生成新的 PeerId");const w=Date.now().toString(36),l=Math.random().toString(36).substring(2,11);a=`peer_${w}_${l}`}console.log("[Peer] Initializing with PeerId:",a,"at",new Date().toISOString());const c={debug:2};n("before-peer-http-util","准备创建 PeerHttpUtil");const f=performance.now(),g=new Ae(a,c);ce(g),n("after-peer-http-util",`PeerHttpUtil 创建完成 (耗时 ${Math.round(performance.now()-f)}ms)`),e.loadNetworkLogging()&&(n("network-logging","启用网络日志"),g.setNetworkLogger(!0,async w=>{try{await ke.addLog(w)}catch(l){console.error("[Peer] Failed to save network log:",l)}}),console.log("[Peer] Network logging enabled"));let b=!1;const C=setTimeout(()=>{b||(b=!0,console.error("[Peer] Connection timeout"),n("timeout","连接超时 (30秒)"),x.value=!1,r(new Error("Peer connection timeout")))},3e4);n("before-register-protocols","准备注册协议处理器"),Ye(g),n("after-register-protocols","协议处理器注册完成"),n("before-register-message","准备注册消息处理器"),g.on("message",We()),n("after-register-message","消息处理器注册完成"),g.on("open",w=>{if(!b){const l=performance.now();b=!0,clearTimeout(C),x.value=!0,e.setPeerId(w);const m=Math.round(l-s);console.log("[Peer] Connected with ID:",w),n("connected",`Peer 连接成功! 总耗时: ${m}ms`),console.log("[Peer-Performance] ===== Peer 初始化完成 ====="),fe(),o(g)}}),g.on("disconnected",()=>{console.warn("[Peer] Disconnected from Peer Server"),x.value=!1,le(ue.bind(null,e))}),g.on("close",()=>{console.warn("[Peer] Peer connection closed"),x.value=!1,le(ue.bind(null,e))}),g.on("error",w=>{console.error("[Peer] PeerJS error:",w),!b&&(w?.type==="peer-unavailable"||w?.type==="network"||w?.type==="server-error"||w?.type==="socket-error"||w?.type==="socket-closed")&&(b=!0,clearTimeout(C),x.value=!1,r(new Error(`Peer connection failed: ${w?.type||"unknown error"}`))),w?.type==="peer-unavailable"&&console.log("[Peer] Target peer unavailable:",w)})})}async function Xe(){const e="UNIVERSE-BOOTSTRAP-PEER-ID-001",o=T(),r=H();console.log("[Peer] Trying to become universe bootstrap with ID:",e),S.universeBootstrap.connecting();const s=performance.now();console.log("[Bootstrap-Performance] ===== 尝试成为宇宙启动者 =====");const n=(t,a)=>{const c=performance.now(),f=Math.round(c-s);console.log(`[Bootstrap-Performance] [${t}] +${f}ms ${a}`)};return n("start","开始尝试成为宇宙启动者"),new Promise(t=>{let a=globalThis.__bootstrapPeerInstance;if(a){console.log("[Peer] Already is bootstrap"),n("already-bootstrap","已经是启动者"),t(!0);return}const c=setTimeout(()=>{S.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! Keeping connection..."),n("success","成为宇宙启动者成功 (3秒超时未被触发)"),z.value=!0,t(!0)},3e3);try{n("before-create-peer","准备创建 Bootstrap Peer");const f=performance.now(),g=we(),D=g.host||"PeerJS Cloud (default)",b=g.port,C=g.path,w=b?`${D}:${b}${C}`:`${D}${C}`;console.log("[Peer-Bootstrap] Connecting to Peer Server:",w),a=new Pe(e,g),globalThis.__bootstrapPeerInstance=a,G(a),n("after-create-peer",`Bootstrap Peer 创建完成 (耗时 ${Math.round(performance.now()-f)}ms)`),a.on("open",l=>{const m=performance.now();clearTimeout(c),S.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! ID:",l),n("connected",`成为宇宙启动者成功! 连接耗时: ${Math.round(m-s)}ms`),z.value=!0,a.on("connection",O=>{O.on("data",P=>{if(P&&P.type==="device_list_request"){if(console.log("[Peer-Bootstrap] Received device list request from:",P.from,"realPeerId:",P.realPeerId,"username:",P.username),S.deviceDiscovery.requestReceived({from:P.from}),P.realPeerId&&P.realPeerId!==r.myPeerId){const u={peerId:P.realPeerId,username:P.username||P.realPeerId,avatar:P.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0};o.addOrUpdateDevice(u),console.log("[Peer-Bootstrap] Added requester to device list:",P.realPeerId,"username:",P.username)}const R=o.allDevices,v={type:"device_list_response",from:e,to:P.from,timestamp:Date.now(),devices:R,isBootstrap:!0,realPeerId:r.myPeerId,username:r.userInfo.username,avatar:r.userInfo.avatar};O.send(v),S.deviceDiscovery.responseSent({to:P.from,deviceCount:R.length}),console.log("[Peer-Bootstrap] Sent device list with",R.length,"devices")}})}),console.log("[Peer-Bootstrap] Listening for device list requests..."),t(!0)}),a.on("error",l=>{if(!a)return;const m=performance.now();clearTimeout(c),S.universeBootstrap.failed({error:l?.type}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Bootstrap already exists, requesting device list..."),n("error",`Bootstrap 已存在，连接失败 (耗时 ${Math.round(m-s)}ms)`),z.value=!1,a&&(a.destroy(),a=null,globalThis.__bootstrapPeerInstance=null,G(null)),Ee(e).then(()=>{t(!1)}).catch(()=>{t(!1)})}),a.on("disconnected",()=>{console.warn("[Peer-Bootstrap] Disconnected from server")}),a.on("close",()=>{console.log("[Peer-Bootstrap] Connection closed"),a=null,globalThis.__bootstrapPeerInstance=null,G(null),z.value=!1})}catch(f){clearTimeout(c),console.error("[Peer] Bootstrap error:",f),a=null,globalThis.__bootstrapPeerInstance=null,G(null),t(!1)}})}async function Ee(e){const o=T(),r=H();return S.universeBootstrap.requestList({to:e}),new Promise(s=>{let n=null,t=null,a=null,c=null;const f=()=>{t&&(t.close(),t=null),n&&(n.destroy(),n=null),a!==null&&(clearTimeout(a),a=null),c!==null&&(clearInterval(c),c=null)};a=window.setTimeout(()=>{console.warn("[Peer] Request bootstrap device list timeout"),f(),s()},1e4);try{const g=we(),D=g.host||"PeerJS Cloud (default)",b=g.port,C=g.path,w=b?`${D}:${b}${C}`:`${D}${C}`;console.log("[Peer-Bootstrap-Request] Connecting to Peer Server:",w),n=new Pe(g),n.on("open",l=>{console.log("[Peer] Temp peer connected with ID:",l),t=n.connect(e),t.on("open",()=>{console.log("[Peer] Connected to bootstrap, waiting for myPeerId...");const m=5e3,O=Date.now();c=window.setInterval(()=>{if(r.myPeerId){clearInterval(c),c=null,console.log("[Peer] myPeerId is ready:",r.myPeerId);const P={type:"device_list_request",from:l,to:e,timestamp:Date.now(),realPeerId:r.myPeerId,username:r.userInfo.username,avatar:r.userInfo.avatar};console.log("[Peer] Sending device list request with realPeerId:",r.myPeerId),t.send(P)}else if(Date.now()-O>m){clearInterval(c),c=null,console.warn("[Peer] Timeout waiting for myPeerId, sending request without it...");const P={type:"device_list_request",from:l,to:e,timestamp:Date.now(),realPeerId:null,username:null,avatar:null};t.send(P)}},100)}),t.on("data",m=>{if(m&&m.type==="device_list_response"){if(console.log("[Peer] Received device list from bootstrap:",m.devices?.length||0,"devices"),S.universeBootstrap.responseList({deviceCount:m.devices?.length||0}),m.devices&&m.devices.length>0&&o.addDevices(m.devices),m.isBootstrap&&m.realPeerId){console.log("[Peer] Bootstrap device has real PeerID:",m.realPeerId);const O={peerId:m.realPeerId,username:m.username||"宇宙启动者",avatar:m.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0,isBootstrap:!0,realPeerId:e};o.addOrUpdateDevice(O)}f(),s()}}),t.on("error",m=>{console.error("[Peer] Bootstrap connection error:",m),f(),s()}),t.on("close",()=>{f(),s()})}),n.on("error",l=>{console.error("[Peer] Temp peer error:",l),f(),s()})}catch(g){console.error("[Peer] Request bootstrap device list error:",g),f(),s()}})}function Ze(e){const o=B;o&&(o.setNetworkAccelerationEnabled(e),e?S.networkAcceleration.enabled():S.networkAcceleration.disabled())}function et(){return B?.getNetworkAccelerationEnabled()||!1}async function tt(){const e=B;if(!e)return;const r=T().allDevices;e.getNetworkAccelerationEnabled();const s=r.map(n=>n.isOnline?e.sendNetworkAccelerationStatus(n.peerId).catch(()=>{}):Promise.resolve());await Promise.allSettled(s)}function st(){L();const e=H(),o=T();function r(){return ue(e)}function s(){fe();const n=B;n&&(n.destroy(),ce(null),h.message=null,h.deliveryAck=null,h.discoveryResponse=null,h.discoveryNotification=null,h.onlineCheckQuery=null,h.onlineCheckResponse=null,x.value=!1);const t=he;t&&(t.destroy(),G(null),console.log("[Peer] Bootstrap connection destroyed"))}return{isConnected:x,isBootstrap:z,init:r,destroy:s,sendChatMessage:ve,sendMessageWithRetry:ze,generateMessageId:Ce,queryDiscoveredDevices:qe,getDiscoveredDevices:$e,getStoredDevices:xe,addDiscoveredDevice:He,sendDiscoveryNotification:Le,queryUsername:Ve,checkOnline:Je,requestUserInfo:W,tryBecomeBootstrap:Xe,requestBootstrapDeviceList:Ee,setNetworkAccelerationEnabled:Ze,getNetworkAccelerationEnabled:et,broadcastNetworkAccelerationStatus:tt,requestDeviceList:X,requestAllDeviceLists:Fe,broadcastUserInfoUpdate:je,deviceStore:o}}export{st as a,L as b,T as c,H as u};
