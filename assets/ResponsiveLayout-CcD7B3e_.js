const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PeerHttpUtil-BdqDL09T.js","assets/index-Dh4fjBfC.js","assets/index-CH9t_CQJ.css","assets/logger-CUkP4sI-.js"])))=>i.map(i=>d[i]);
import{c as n,I as q,d as Ce,o as xe,a as Me,r as w,b as E,w as t,u as ze,e as d,f as _,g as p,h as g,t as m,i,P as De,j as A,k as P,n as le,l as Ae,E as se,m as B,p as V,F as W,q as T,_ as re,s as je,v as Ke}from"./index-Dh4fjBfC.js";import{u as $e}from"./PeerHttpUtil-BdqDL09T.js";import{u as Ne}from"./index-C_bmiR2O.js";import{useKeyExchangeStore as Be}from"./keyExchangeStore-lNKC1kW2.js";import{f as Ve,M as We}from"./fileHelper-D6eTRPHu.js";import{R as qe}from"./RadarChartOutlined-DsKbaUax.js";import{_ as Fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./logger-CUkP4sI-.js";import"./networkLogDB-bSBVLm5N.js";import"./cryptoManager-BXa9bEtX.js";var Ge={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"}}]},name:"menu",theme:"outlined"};function ie(r){for(var o=1;o<arguments.length;o++){var s=arguments[o]!=null?Object(arguments[o]):{},l=Object.keys(s);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(s).filter(function(f){return Object.getOwnPropertyDescriptor(s,f).enumerable}))),l.forEach(function(f){He(r,f,s[f])})}return r}function He(r,o,s){return o in r?Object.defineProperty(r,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):r[o]=s,r}var F=function(o,s){var l=ie({},o,s.attrs);return n(q,ie({},l,{icon:Ge}),null)};F.displayName="MenuOutlined";F.inheritAttrs=!1;var Je={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M924.8 625.7l-65.5-56c3.1-19 4.7-38.4 4.7-57.8s-1.6-38.8-4.7-57.8l65.5-56a32.03 32.03 0 009.3-35.2l-.9-2.6a443.74 443.74 0 00-79.7-137.9l-1.8-2.1a32.12 32.12 0 00-35.1-9.5l-81.3 28.9c-30-24.6-63.5-44-99.7-57.6l-15.7-85a32.05 32.05 0 00-25.8-25.7l-2.7-.5c-52.1-9.4-106.9-9.4-159 0l-2.7.5a32.05 32.05 0 00-25.8 25.7l-15.8 85.4a351.86 351.86 0 00-99 57.4l-81.9-29.1a32 32 0 00-35.1 9.5l-1.8 2.1a446.02 446.02 0 00-79.7 137.9l-.9 2.6c-4.5 12.5-.8 26.5 9.3 35.2l66.3 56.6c-3.1 18.8-4.6 38-4.6 57.1 0 19.2 1.5 38.4 4.6 57.1L99 625.5a32.03 32.03 0 00-9.3 35.2l.9 2.6c18.1 50.4 44.9 96.9 79.7 137.9l1.8 2.1a32.12 32.12 0 0035.1 9.5l81.9-29.1c29.8 24.5 63.1 43.9 99 57.4l15.8 85.4a32.05 32.05 0 0025.8 25.7l2.7.5a449.4 449.4 0 00159 0l2.7-.5a32.05 32.05 0 0025.8-25.7l15.7-85a350 350 0 0099.7-57.6l81.3 28.9a32 32 0 0035.1-9.5l1.8-2.1c34.8-41.1 61.6-87.5 79.7-137.9l.9-2.6c4.5-12.3.8-26.3-9.3-35zM788.3 465.9c2.5 15.1 3.8 30.6 3.8 46.1s-1.3 31-3.8 46.1l-6.6 40.1 74.7 63.9a370.03 370.03 0 01-42.6 73.6L721 702.8l-31.4 25.8c-23.9 19.6-50.5 35-79.3 45.8l-38.1 14.3-17.9 97a377.5 377.5 0 01-85 0l-17.9-97.2-37.8-14.5c-28.5-10.8-55-26.2-78.7-45.7l-31.4-25.9-93.4 33.2c-17-22.9-31.2-47.6-42.6-73.6l75.5-64.5-6.5-40c-2.4-14.9-3.7-30.3-3.7-45.5 0-15.3 1.2-30.6 3.7-45.5l6.5-40-75.5-64.5c11.3-26.1 25.6-50.7 42.6-73.6l93.4 33.2 31.4-25.9c23.7-19.5 50.2-34.9 78.7-45.7l37.9-14.3 17.9-97.2c28.1-3.2 56.8-3.2 85 0l17.9 97 38.1 14.3c28.7 10.8 55.4 26.2 79.3 45.8l31.4 25.8 92.8-32.9c17 22.9 31.2 47.6 42.6 73.6L781.8 426l6.5 39.9zM512 326c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm79.2 255.2A111.6 111.6 0 01512 614c-29.9 0-58-11.7-79.2-32.8A111.6 111.6 0 01400 502c0-29.9 11.7-58 32.8-79.2C454 401.6 482.1 390 512 390c29.9 0 58 11.6 79.2 32.8A111.6 111.6 0 01624 502c0 29.9-11.7 58-32.8 79.2z"}}]},name:"setting",theme:"outlined"};function ue(r){for(var o=1;o<arguments.length;o++){var s=arguments[o]!=null?Object(arguments[o]):{},l=Object.keys(s);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(s).filter(function(f){return Object.getOwnPropertyDescriptor(s,f).enumerable}))),l.forEach(function(f){Qe(r,f,s[f])})}return r}function Qe(r,o,s){return o in r?Object.defineProperty(r,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):r[o]=s,r}var G=function(o,s){var l=ue({},o,s.attrs);return n(q,ue({},l,{icon:Je}),null)};G.displayName="SettingOutlined";G.inheritAttrs=!1;var Xe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M464 720a48 48 0 1096 0 48 48 0 10-96 0zm16-304v184c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V416c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8zm475.7 440l-416-720c-6.2-10.7-16.9-16-27.7-16s-21.6 5.3-27.7 16l-416 720C56 877.4 71.4 904 96 904h832c24.6 0 40-26.6 27.7-48zm-783.5-27.9L512 239.9l339.8 588.2H172.2z"}}]},name:"warning",theme:"outlined"};function ce(r){for(var o=1;o<arguments.length;o++){var s=arguments[o]!=null?Object(arguments[o]):{},l=Object.keys(s);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(s).filter(function(f){return Object.getOwnPropertyDescriptor(s,f).enumerable}))),l.forEach(function(f){Ye(r,f,s[f])})}return r}function Ye(r,o,s){return o in r?Object.defineProperty(r,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):r[o]=s,r}var H=function(o,s){var l=ce({},o,s.attrs);return n(q,ce({},l,{icon:Xe}),null)};H.displayName="WarningOutlined";H.inheritAttrs=!1;const Ze={class:"avatar-upload-container"},et={key:0,style:{"text-align":"center",color:"#8c8c8c","font-size":"12px"}},tt={class:"user-card"},at={class:"user-info"},nt={class:"username"},ot={class:"peer-id"},lt={key:1,class:"mobile-wrapper"},st={class:"header-title"},rt={class:"user-card"},it={class:"user-info"},ut={class:"username"},ct={class:"peer-id"},dt={class:"footer-label"},pt=Ce({__name:"ResponsiveLayout",setup(r){const o=ze(),s=je(),l=$e(),{init:f}=Ne(),v=Be(),j=w(!1),C=w(!1);function K(){j.value=window.innerWidth<768}xe(async()=>{console.log("[ResponsiveLayout] onMounted: pathname =",window.location.pathname,", hash =",window.location.hash),console.log("[ResponsiveLayout] localStorage E2E_TEST_MODE =",localStorage.getItem("__E2E_TEST_MODE__")),console.log("[ResponsiveLayout] localStorage E2E_TARGET_ROUTE =",localStorage.getItem("__E2E_TARGET_ROUTE__")),K(),window.addEventListener("resize",K);const a=localStorage.getItem("__E2E_TEST_MODE__"),e=localStorage.getItem("__E2E_TARGET_ROUTE__");if(a==="true"&&e){console.log("[ResponsiveLayout] E2E 测试模式：检测到标记，目标路由 =",e),localStorage.removeItem("__E2E_TEST_MODE__"),localStorage.removeItem("__E2E_TARGET_ROUTE__");const u=await l.loadUserInfo();if(console.log("[ResponsiveLayout] E2E 测试模式：用户信息加载结果 isSetup =",u),!u){console.log("[ResponsiveLayout] E2E 测试模式：用户信息未设置，显示设置弹窗"),R.value=!0;return}const h=e.charAt(0).toUpperCase()+e.slice(1);console.log("[ResponsiveLayout] E2E 测试模式：导航到",h),await o.replace({name:h}),await new Promise(b=>{const U=o.afterEach((N,Y)=>{console.log("[ResponsiveLayout] E2E 测试模式：路由导航完成",N.name),U(),b()});o.currentRoute.value.name===h&&(console.log("[ResponsiveLayout] E2E 测试模式：路由已经是",h),b())});try{await f(),console.log("[ResponsiveLayout] E2E 测试模式：Peer 初始化完成，myPeerId =",l.myPeerId)}catch(b){console.error("[ResponsiveLayout] E2E 测试模式：Peer init failed:",b)}console.log("[ResponsiveLayout] E2E 测试模式：导航完成");return}if(!await l.loadUserInfo())R.value=!0;else try{await f()}catch(u){console.error("Peer init failed:",u)}}),Me(()=>{window.removeEventListener("resize",K)});const de=[{key:"WeChat",label:"聊天",icon:We,route:"/wechat"},{key:"Center",label:"发现中心",icon:qe,route:"/center"},{key:"Settings",label:"设置",icon:G,route:"/settings"},{key:"NetworkLog",label:"网络日志",icon:Ke,route:"/network-log",requiresLogging:!0}],x=T(()=>de.filter(a=>a.requiresLogging?l.loadNetworkLogging():!0)),pe=T(()=>x.value.filter(a=>!a.requiresLogging).slice(0,4));function $(a){o.push(a),C.value=!1}const M=T(()=>s.name),fe=T(()=>x.value.find(e=>e.key===M.value)?.label||"P2P Chat");function J(a){return a?a.length<16?a:`${a.substring(0,8)}...${a.substring(a.length-8)}`:"未知"}const R=w(!1),O=w(""),S=w(!1),k=w(""),L=w([]),z=w(""),Q=w("info"),ve=T(()=>k.value||l.userInfo.avatar||"");function I(a,e="info"){z.value=a,Q.value=e}function me(){z.value=""}async function X(){console.error("=== [ResponsiveLayout] handleUserSetup START ==="),console.error("[ResponsiveLayout] handleUserSetup: Function called, isSubmitting =",S.value),console.error("[ResponsiveLayout] handleUserSetup: usernameInput.value =",O.value);const a=O.value.trim();if(console.error("[ResponsiveLayout] handleUserSetup: Username =",a),me(),!a){console.error("[ResponsiveLayout] handleUserSetup: Username is empty, showing warning"),I("用户名不能为空，请输入用户名","warning");return}if(a.length<2){I("用户名至少需要2个字符","warning");return}if(a.length>20){I("用户名不能超过20个字符","warning");return}S.value=!0;try{await f(),await l.saveUserInfo({username:a,avatar:k.value||null}),await l.initCryptoKeys(),R.value=!1,O.value="",k.value="",L.value=[],I("设置完成","success"),console.log("[ResponsiveLayout] handleUserSetup: Setup completed successfully")}catch(e){console.error("[ResponsiveLayout] handleUserSetup: Error:",e),await l.saveUserInfo({username:O.value.trim(),avatar:k.value||null});try{await l.initCryptoKeys()}catch(y){console.error("Crypto init failed:",y)}R.value=!1,O.value="",k.value="",L.value=[],I("Peer 连接失败，某些功能可能不可用","warning")}finally{S.value=!1}}const D=w(!1),_e=async a=>{if(a.file.status==="uploading"){D.value=!0;return}if(a.file.status==="done"){D.value=!1;return}a.file.status==="removed"&&(k.value="",L.value=[])},ge=async a=>{if(!a.type.startsWith("image/")||!(a.size/1024/1024<2))return!1;try{const u=await Ve(a);k.value=u,L.value=[{uid:"1",name:a.name,status:"done",url:u}]}catch(u){console.error("Avatar processing error:",u)}return!1};async function ye(){const a=v.dialog;console.log("[ResponsiveLayout] User does not trust key change for:",a.peerId);const{useDeviceStore:e}=await re(async()=>{const{useDeviceStore:h}=await import("./PeerHttpUtil-BdqDL09T.js").then(b=>b.d);return{useDeviceStore:h}},__vite__mapDeps([0,1,2,3])),y=e(),u=y.getDevice(a.peerId);u&&(u.keyExchangeStatus="compromised",await y.addOrUpdateDevice(u),console.log("[ResponsiveLayout] Device marked as compromised:",a.peerId)),v.handleNotTrust()}async function be(){const a=v.dialog;console.log("[ResponsiveLayout] User trusts key change for:",a.peerId);const{useDeviceStore:e}=await re(async()=>{const{useDeviceStore:h}=await import("./PeerHttpUtil-BdqDL09T.js").then(b=>b.d);return{useDeviceStore:h}},__vite__mapDeps([0,1,2,3])),y=e(),u=y.getDevice(a.peerId);u&&(u.publicKey=a.newPublicKey,u.keyExchangeStatus="verified",await y.addOrUpdateDevice(u),console.log("[ResponsiveLayout] Device public key updated and marked as verified:",a.peerId)),v.handleTrust()}return(a,e)=>{const y=d("a-avatar"),u=d("a-button"),h=d("a-upload"),b=d("a-typography-text"),U=d("a-form-item"),N=d("a-input"),Y=d("a-form"),Z=d("a-modal"),he=d("a-alert"),ee=d("a-descriptions-item"),we=d("a-descriptions"),Ee=d("a-card"),te=d("a-space"),ae=d("a-menu-item"),ne=d("a-menu"),Oe=d("a-layout-sider"),Se=d("a-layout-header"),ke=d("a-drawer"),Re=d("router-view"),Le=d("a-layout-content"),Pe=d("a-col"),Ie=d("a-row"),Ue=d("a-layout-footer"),Te=d("a-layout");return _(),E(Te,{class:"responsive-layout"},{default:t(()=>[n(Z,{open:R.value,"onUpdate:open":e[1]||(e[1]=c=>R.value=c),title:"设置用户信息",footer:null,closable:!1,"mask-closable":!1},{default:t(()=>[n(Y,{layout:"vertical"},{default:t(()=>[n(U,{label:"头像"},{default:t(()=>[p("div",Ze,[n(y,{src:ve.value,size:80},{default:t(()=>[g(m(O.value.charAt(0).toUpperCase()||"U"),1)]),_:1},8,["src"]),n(h,{"file-list":L.value,"before-upload":ge,onChange:_e,"max-count":1,"list-type":"picture",accept:"image/*",disabled:D.value||S.value},{default:t(()=>[L.value.length===0?(_(),E(u,{key:0,loading:D.value,disabled:S.value,"aria-label":"upload-avatar"},{icon:t(()=>[n(i(De))]),default:t(()=>[e[5]||(e[5]=g(" 上传头像 ",-1))]),_:1},8,["loading","disabled"])):A("",!0)]),_:1},8,["file-list","disabled"]),n(b,{type:"secondary",style:{"font-size":"12px"}},{default:t(()=>[...e[6]||(e[6]=[g(" 支持 jpg、png 格式，不超过 2MB ",-1)])]),_:1}),z.value?(_(),P("div",{key:0,class:le(["inline-message",`inline-message-${Q.value}`])},m(z.value),3)):A("",!0)])]),_:1}),n(U,{label:"用户名",required:""},{default:t(()=>[n(N,{value:O.value,"onUpdate:value":e[0]||(e[0]=c=>O.value=c),placeholder:"请输入用户名（2-20个字符）",maxlength:20,disabled:S.value,onKeyup:Ae(X,["enter"])},null,8,["value","disabled"])]),_:1}),n(U,null,{default:t(()=>[n(u,{type:"primary",block:"",loading:S.value,disabled:S.value,onClick:X,"aria-label":"complete-user-setup"},{default:t(()=>[...e[7]||(e[7]=[g(" 完成 ",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},8,["open"]),n(Z,{open:i(v).dialog.visible,"onUpdate:open":e[2]||(e[2]=c=>i(v).dialog.visible=c),title:"安全警告",closable:!1,"mask-closable":!1,width:"600px",footer:null},{icon:t(()=>[n(i(se),{style:{color:"#faad14","font-size":"24px"}})]),default:t(()=>[n(te,{direction:"vertical",size:16,style:{width:"100%"}},{default:t(()=>[n(he,{type:"warning","show-icon":"",message:"检测到公钥变更"},{description:t(()=>[p("div",null,[e[8]||(e[8]=g("设备 ",-1)),p("strong",null,m(i(v).dialog.username),1),g(" ("+m(i(v).truncateKey(i(v).dialog.peerId))+") 的公钥已发生变化。",1)]),e[9]||(e[9]=p("div",{style:{"margin-top":"8px"}},"这可能意味着：",-1)),e[10]||(e[10]=p("ul",{style:{margin:"8px 0","padding-left":"20px"}},[p("li",null,"对方重新生成了密钥对（例如更换设备）"),p("li",null,"存在中间人攻击，有人正在冒充对方")],-1)),e[11]||(e[11]=p("div",null,"请通过其他渠道确认对方身份后再决定是否信任。",-1))]),_:1}),n(Ee,{size:"small",title:"公钥对比"},{default:t(()=>[n(we,{column:1,size:"small"},{default:t(()=>[n(ee,{label:"旧公钥"},{default:t(()=>[n(b,{code:"",copyable:"","copy-text":i(v).dialog.oldPublicKey},{default:t(()=>[g(m(i(v).truncateKey(i(v).dialog.oldPublicKey)),1)]),_:1},8,["copy-text"])]),_:1}),n(ee,{label:"新公钥"},{default:t(()=>[n(b,{code:"",copyable:"","copy-text":i(v).dialog.newPublicKey},{default:t(()=>[g(m(i(v).truncateKey(i(v).dialog.newPublicKey)),1)]),_:1},8,["copy-text"])]),_:1})]),_:1})]),_:1}),n(te,{style:{width:"100%","justify-content":"flex-end"}},{default:t(()=>[n(u,{onClick:ye,"aria-label":"not-trust-key-change"},{icon:t(()=>[n(i(H))]),default:t(()=>[e[12]||(e[12]=g(" 不信任（移除设备） ",-1))]),_:1}),n(u,{type:"primary",danger:"",onClick:be,"aria-label":"trust-key-change"},{icon:t(()=>[n(i(se))]),default:t(()=>[e[13]||(e[13]=g(" 信任（更新公钥） ",-1))]),_:1})]),_:1}),i(v).pendingChanges.size>0?(_(),P("div",et," 还有 "+m(i(v).pendingChanges.size)+" 个设备的公钥变更待处理 ",1)):A("",!0)]),_:1})]),_:1},8,["open"]),j.value?(_(),P("div",lt,[n(Se,{class:"mobile-header"},{default:t(()=>[p("div",st,m(fe.value),1),n(u,{type:"text",onClick:e[3]||(e[3]=c=>C.value=!0),"aria-label":"open-menu"},{icon:t(()=>[n(i(F))]),_:1})]),_:1}),n(ke,{open:C.value,"onUpdate:open":e[4]||(e[4]=c=>C.value=c),placement:"left",closable:!1,class:"mobile-drawer"},{default:t(()=>[e[15]||(e[15]=p("div",{class:"logo-section"},[p("div",{class:"logo"},"P2P 聊天")],-1)),n(ne,{selectedKeys:[M.value],mode:"inline",theme:"dark"},{default:t(()=>[(_(!0),P(W,null,B(x.value,c=>(_(),E(ae,{key:c.key,onClick:oe=>$(c.route)},{icon:t(()=>[(_(),E(V(c.icon)))]),default:t(()=>[g(" "+m(c.label),1)]),_:2},1032,["onClick"]))),128))]),_:1},8,["selectedKeys"]),p("div",rt,[n(y,{size:48,src:i(l).userInfo.avatar},{default:t(()=>[g(m(i(l).userInfo.username?.charAt(0)),1)]),_:1},8,["src"]),p("div",it,[p("div",ut,m(i(l).userInfo.username),1),p("div",ct,m(J(i(l).myPeerId)),1)])])]),_:1},8,["open"])])):(_(),E(Oe,{key:0,width:"240",class:"pc-sider"},{default:t(()=>[e[14]||(e[14]=p("div",{class:"logo-section"},[p("div",{class:"logo"},"P2P 聊天")],-1)),n(ne,{selectedKeys:[M.value],mode:"inline",theme:"dark",class:"side-menu"},{default:t(()=>[(_(!0),P(W,null,B(x.value,c=>(_(),E(ae,{key:c.key,onClick:oe=>$(c.route)},{icon:t(()=>[(_(),E(V(c.icon)))]),default:t(()=>[g(" "+m(c.label),1)]),_:2},1032,["onClick"]))),128))]),_:1},8,["selectedKeys"]),p("div",tt,[n(y,{size:48,src:i(l).userInfo.avatar},{default:t(()=>[g(m(i(l).userInfo.username?.charAt(0)),1)]),_:1},8,["src"]),p("div",at,[p("div",nt,m(i(l).userInfo.username),1),p("div",ot,m(J(i(l).myPeerId)),1)])])]),_:1})),n(Le,{class:"main-content"},{default:t(()=>[n(Re)]),_:1}),j.value?(_(),E(Ue,{key:2,class:"mobile-footer"},{default:t(()=>[n(Ie,{type:"flex",justify:"space-around"},{default:t(()=>[(_(!0),P(W,null,B(pe.value,c=>(_(),E(Pe,{key:c.key,span:6,class:le(["footer-item",{active:M.value===c.key}]),onClick:oe=>$(c.route)},{default:t(()=>[(_(),E(V(c.icon),{class:"footer-icon"})),p("span",dt,m(c.label),1)]),_:2},1032,["class","onClick"]))),128))]),_:1})]),_:1})):A("",!0)]),_:1})}}}),Ot=Fe(pt,[["__scopeId","data-v-47b1118c"]]);export{Ot as default};
