import{G as de,r as B,s as j,H as me}from"./index-Bhcth52k.js";import{c as I,P as ke,g as we,$ as Pe}from"./PeerHttpUtil-CauAybgU.js";import{n as Te}from"./networkLogDB-BlD6FS5Z.js";class Ue{db=null;DB_NAME="p2p-chat";DB_VERSION=1;async init(){if(!this.db)return new Promise((n,r)=>{const s=indexedDB.open(this.DB_NAME,this.DB_VERSION);s.onerror=()=>{console.error("[IndexedDB] Failed to open database:",s.error),r(s.error)},s.onsuccess=()=>{this.db=s.result,console.log("[IndexedDB] Database opened successfully"),n()},s.onupgradeneeded=o=>{const t=o.target.result;if(t.objectStoreNames.contains("avatars")||t.createObjectStore("avatars",{keyPath:"id"}).createIndex("peerId","peerId",{unique:!1}),!t.objectStoreNames.contains("messages")){const a=t.createObjectStore("messages",{keyPath:"id"});a.createIndex("toPeerId","toPeerId",{unique:!1}),a.createIndex("timestamp","timestamp",{unique:!1})}t.objectStoreNames.contains("devices")||t.createObjectStore("devices",{keyPath:"peerId"}).createIndex("username","username",{unique:!1}),console.log("[IndexedDB] Object stores created")}})}async ensureInitialized(){this.db||await this.init()}async set(n,r){return await this.ensureInitialized(),new Promise((s,o)=>{const i=this.db.transaction([n],"readwrite").objectStore(n).put(r);i.onsuccess=()=>{console.log(`[IndexedDB] Data saved to ${n}:`,r.id||r.peerId||r.toPeerId),s()},i.onerror=()=>{console.error(`[IndexedDB] Failed to save to ${n}:`,i.error),o(i.error)}})}async get(n,r){return await this.ensureInitialized(),new Promise((s,o)=>{const i=this.db.transaction([n],"readonly").objectStore(n).get(r);i.onsuccess=()=>{s(i.result)},i.onerror=()=>{console.error(`[IndexedDB] Failed to get from ${n}:`,i.error),o(i.error)}})}async getAll(n){return await this.ensureInitialized(),new Promise((r,s)=>{const a=this.db.transaction([n],"readonly").objectStore(n).getAll();a.onsuccess=()=>{r(a.result)},a.onerror=()=>{console.error(`[IndexedDB] Failed to get all from ${n}:`,a.error),s(a.error)}})}async delete(n,r){return await this.ensureInitialized(),new Promise((s,o)=>{const i=this.db.transaction([n],"readwrite").objectStore(n).delete(r);i.onsuccess=()=>{console.log(`[IndexedDB] Data deleted from ${n}:`,r),s()},i.onerror=()=>{console.error(`[IndexedDB] Failed to delete from ${n}:`,i.error),o(i.error)}})}async clearStore(n){return await this.ensureInitialized(),new Promise((r,s)=>{const a=this.db.transaction([n],"readwrite").objectStore(n).clear();a.onsuccess=()=>{console.log(`[IndexedDB] Store ${n} cleared`),r()},a.onerror=()=>{console.error(`[IndexedDB] Failed to clear ${n}:`,a.error),s(a.error)}})}close(){this.db&&(this.db.close(),this.db=null,console.log("[IndexedDB] Database closed"))}}const A=new Ue,Y="p2p_user_info",K="p2p_user_info_meta",ye="p2p_network_acceleration",Ie="p2p_network_logging",te="user_avatar_migrated_to_indexeddb",q="my-avatar",H=de("user",()=>{const e=B({username:"",avatar:null,peerId:null,version:0}),n=B(!1),r=B(!1),s=B(!1),o=j(()=>e.value.peerId);async function t(){await a();const l=localStorage.getItem(K);if(l)try{const m=JSON.parse(l);e.value={username:m.username||"",avatar:null,peerId:m.peerId||null,version:m.version||0},n.value=!!m.username;const _=await A.get("avatars",q);if(_&&_.avatar)e.value.avatar=_.avatar;else{const P=localStorage.getItem(Y);if(P)try{const R=JSON.parse(P);R.avatar&&(e.value.avatar=R.avatar,console.log("[UserStore] Loaded avatar from fallback (old localStorage key)"),await A.set("avatars",{id:q,peerId:q,avatar:R.avatar}),console.log("[UserStore] Migrated avatar to IndexedDB"))}catch(R){console.error("[UserStore] Failed to load avatar from fallback:",R)}}}catch(m){console.error("[UserStore] Failed to load user info:",m)}return n.value}async function a(){if(!localStorage.getItem(te))try{const m=localStorage.getItem(Y);if(!m){localStorage.setItem(te,"true");return}const _=JSON.parse(m);console.log("[UserStore] 开始迁移用户数据到混合存储...");const{avatar:P,...R}=_;localStorage.setItem(K,JSON.stringify(R)),P&&(await A.set("avatars",{id:q,peerId:q,avatar:P}),console.log("[UserStore] 用户头像已移至 IndexedDB")),localStorage.removeItem(Y),localStorage.setItem(te,"true"),console.log("[UserStore] 用户数据迁移完成！")}catch(m){console.error("[UserStore] 迁移失败:",m)}}async function i(l){const m=l.username!==void 0&&l.username!==e.value.username,_=l.avatar!==void 0&&l.avatar!==e.value.avatar&&!((l.avatar===null||l.avatar===void 0)&&e.value.avatar===null),P=m||_,{avatar:R,peerId:g,...f}=l;e.value={...e.value,...f,...g!=null?{peerId:g}:{}},P&&(e.value.version+=1),R!==void 0&&(e.value.avatar=R,R?await A.set("avatars",{id:q,peerId:q,avatar:R}):await A.delete("avatars",q));const{avatar:S,...C}=e.value;localStorage.setItem(K,JSON.stringify(C)),localStorage.setItem(Y,JSON.stringify(e.value)),l.username&&(n.value=!0)}async function d(l){e.value.peerId=l;const{avatar:m,..._}=e.value;localStorage.setItem(K,JSON.stringify(_)),localStorage.setItem(Y,JSON.stringify(e.value))}async function v(){e.value={username:"",avatar:null,peerId:null,version:0},n.value=!1,localStorage.removeItem(K),await A.delete("avatars",q)}function D(){const l=localStorage.getItem(ye);return l!==null&&(r.value=l==="true"),r.value}function b(l){r.value=l,localStorage.setItem(ye,String(l))}function O(){const l=localStorage.getItem(Ie);return l!==null&&(s.value=l==="true"),s.value}function w(l){s.value=l,localStorage.setItem(Ie,String(l))}return{userInfo:e,isSetup:n,myPeerId:o,loadUserInfo:t,saveUserInfo:i,setPeerId:d,clearUserInfo:v,networkAccelerationEnabled:r,loadNetworkAcceleration:D,setNetworkAcceleration:b,networkLoggingEnabled:s,loadNetworkLogging:O,setNetworkLogging:w}}),J="p2p_messages_",ne="p2p_contacts",Se="p2p_pending_messages",oe="message_content_migrated_to_indexeddb",L=de("chat",()=>{const e=B(new Map),n=B(new Map),r=B(new Map),s=B(null);async function o(c,u,p){const y=`msg-content-${c}`;await A.set("messages",{id:y,messageId:c,type:u,content:p})}async function t(c){const u=`msg-content-${c}`;return(await A.get("messages",u))?.content||null}async function a(){if(!localStorage.getItem(oe))try{console.log("[ChatStore] 开始检查消息数据迁移...");const u=localStorage.getItem(ne);if(!u){localStorage.setItem(oe,"true");return}const p=JSON.parse(u),y=Object.keys(p);let E=0;for(const V of y){const ge=localStorage.getItem(J+V);if(!ge)continue;const pe=JSON.parse(ge);let Z=0;for(const $ of pe)if($.type==="image"||$.type==="file"||$.type==="video"){const ee=$.content;ee&&ee.length>1e3&&(await o($.id,$.type,ee),$.content=`msg-content-${$.id}`,Z++)}Z>0&&(localStorage.setItem(J+V,JSON.stringify(pe)),E+=Z)}localStorage.setItem(oe,"true"),console.log(`[ChatStore] 消息数据迁移完成！迁移了 ${E} 条大型消息内容`)}catch(u){console.error("[ChatStore] 消息数据迁移失败:",u)}}const i=j(()=>s.value?e.value.get(s.value)||[]:[]),d=j(()=>Array.from(n.value.values()).sort((c,u)=>c.online!==u.online?c.online?-1:1:u.lastSeen-c.lastSeen));async function v(){await a();const c=localStorage.getItem(ne);if(c)try{const p=JSON.parse(c);n.value=new Map(Object.entries(p));for(const[y]of n.value)await w(y)}catch(p){console.error("[ChatStore] Failed to load contacts:",p)}const u=localStorage.getItem(Se);if(u)try{const p=JSON.parse(u);r.value=new Map(Object.entries(p))}catch(p){console.error("[ChatStore] Failed to load pending messages:",p)}}function D(){const c=Object.fromEntries(n.value);localStorage.setItem(ne,JSON.stringify(c))}function b(){const c=Object.fromEntries(r.value);localStorage.setItem(Se,JSON.stringify(c))}async function O(c){const u=e.value.get(c)||[],p=[];for(const y of u)if(y.type==="image"||y.type==="file"||y.type==="video"){const E=y.content;E.startsWith("msg-content-")?p.push(y):E&&E.length>1e3?(await o(y.id,y.type,E),p.push({...y,content:`msg-content-${y.id}`})):p.push(y)}else p.push(y);localStorage.setItem(J+c,JSON.stringify(p))}async function w(c){const u=localStorage.getItem(J+c);if(u)try{const p=JSON.parse(u),y=[];for(const E of p)if((E.type==="image"||E.type==="file"||E.type==="video")&&typeof E.content=="string"&&E.content.startsWith("msg-content-")){const V=await t(E.id);y.push({...E,content:V||E.content})}else y.push(E);return e.value.set(c,y),y}catch(p){console.error("[ChatStore] Failed to load messages:",p)}return[]}function l(c){const u=n.value.get(c.peerId);u?n.value.set(c.peerId,{...u,...c}):n.value.set(c.peerId,c),D()}function m(c){return n.value.get(c)}function _(c,u){const p=n.value.get(c);p&&(p.online=u,p.lastSeen=Date.now(),D())}async function P(c,u){e.value.has(c)||e.value.set(c,[]),e.value.get(c).push(u),await O(c);const p=n.value.get(c);if(p&&u.from===c){const y=e.value.get(c);y&&y.length>0&&(p.lastSeen=u.timestamp),D()}}async function R(c,u,p){const y=e.value.get(c);if(y){const E=y.find(V=>V.id===u);E&&(E.status=p,p==="delivered"&&(E.deliveredAt=Date.now()),await O(c))}}function g(c){for(const u of e.value.values()){const p=u.find(y=>y.id===c);if(p)return p}return null}function f(c){r.value.set(c.id,c),b()}function S(c){r.value.delete(c),b()}function C(c){const u=r.value.get(c);return u?(u.retryCount++,b(),!(u.maxRetries!==void 0&&u.retryCount>u.maxRetries)):!1}function k(c){return Array.from(r.value.values()).filter(u=>u.to===c)}function N(c){const u=Array.from(r.value.entries()).filter(([,p])=>p.to===c);return u.forEach(([p])=>r.value.delete(p)),b(),u.map(([,p])=>p)}async function T(c,u=c){n.value.has(c)||l({peerId:c,username:u,avatar:null,online:!1,lastSeen:Date.now(),unreadCount:0,chatVersion:0}),await w(c);const p=e.value.get(c);if(!p||p.length===0){const y={id:`system-${c}-${Date.now()}`,from:c,to:"system",content:"",timestamp:Date.now(),status:"delivered",type:"system"};await P(c,y)}}async function X(c){n.value.delete(c),e.value.delete(c);const u=localStorage.getItem(J+c);if(u)try{const p=JSON.parse(u);for(const y of p)(y.type==="image"||y.type==="file"||y.type==="video")&&await A.delete("messages",`msg-content-${y.id}`)}catch(p){console.error("[ChatStore] Failed to clean up IndexedDB messages:",p)}localStorage.removeItem(J+c),D(),N(c),s.value===c&&(s.value=null)}function Re(c){if(s.value=c,c){const u=n.value.get(c);u&&(u.unreadCount=0,D())}}function Me(c){const u=n.value.get(c);u&&s.value!==c&&(u.unreadCount++,D())}function Ae(){return Array.from(n.value.values()).reduce((c,u)=>c+u.unreadCount,0)}return{messages:e,contacts:n,pendingMessages:r,currentChatPeerId:s,currentMessages:i,sortedContacts:d,loadFromStorage:v,loadMessages:w,addOrUpdateContact:l,getContact:m,setContactOnline:_,addMessage:P,updateMessageStatus:R,getMessageById:g,addPendingMessage:f,removePendingMessage:S,incrementRetryCount:C,getPendingMessagesForPeer:k,clearPendingMessagesForPeer:N,createChat:T,deleteChat:X,setCurrentChat:Re,incrementUnread:Me,getTotalUnread:Ae}}),De="discovered_devices",re="discovered_devices_meta",se="avatar_migrated_to_indexeddb",F=600*1e3,Be=3,Ne=Be*24*60*60*1e3,U=de("device",()=>{const e=B(new Map);let n=null;async function r(){try{await s();const g=localStorage.getItem(re);if(g){const f=JSON.parse(g),S=Object.values(f),C=await A.getAll("avatars"),k=new Map(C.map(T=>[T.peerId,T.avatar])),N=Date.now();e.value=new Map(S.map(T=>[T.peerId,{...T,avatar:k.get(T.peerId)||null,isOnline:N-T.lastHeartbeat<F}])),console.log(`[DeviceStore] Loaded ${e.value.size} devices from storage (${k.size} avatars from IndexedDB)`),await m()}}catch(g){console.error("[DeviceStore] Failed to load devices:",g)}}async function s(){if(!localStorage.getItem(se))try{const f=localStorage.getItem(De);if(!f){localStorage.setItem(se,"true");return}const S=Object.values(JSON.parse(f));console.log(`[DeviceStore] 开始迁移 ${S.length} 个设备到混合存储...`);const C={},k=[];for(const N of S){const{avatar:T,...X}=N;C[N.peerId]=X,T&&(await A.set("avatars",{id:N.peerId,peerId:N.peerId,avatar:T}),k.push({peerId:N.peerId,avatar:T}))}localStorage.setItem(re,JSON.stringify(C)),localStorage.removeItem(De),localStorage.setItem(se,"true"),console.log(`[DeviceStore] 迁移完成！${k.length} 个头像已移至 IndexedDB`)}catch(f){console.error("[DeviceStore] 迁移失败:",f)}}async function o(){try{const g={};for(const[f,S]of e.value){const{avatar:C,...k}=S;g[f]=k,C?await A.set("avatars",{id:f,peerId:f,avatar:C}):await A.delete("avatars",f)}localStorage.setItem(re,JSON.stringify(g))}catch(g){console.error("[DeviceStore] Failed to save devices:",g)}}const t=j(()=>Array.from(e.value.values())),a=j(()=>{const g=Date.now();return t.value.filter(f=>g-f.lastHeartbeat<F)}),i=j(()=>{const g=Date.now();return t.value.filter(f=>g-f.lastHeartbeat>=F)});async function d(g){const f=e.value.get(g.peerId),S=Date.now();f?(f.username=g.username,f.avatar=g.avatar,f.lastHeartbeat=g.lastHeartbeat,f.isOnline=S-g.lastHeartbeat<F):e.value.set(g.peerId,{...g,firstDiscovered:g.firstDiscovered||S,isOnline:!0}),await o()}function v(g){return e.value.get(g)}async function D(g){const f=e.value.get(g);f&&(f.lastHeartbeat=Date.now(),f.isOnline=!0,await o())}async function b(g,f){const S=e.value.get(g);S&&(S.isOnline=f,f&&(S.lastHeartbeat=Date.now()),await o(),me(e))}async function O(g){const f=Date.now();g.forEach(S=>{const C=e.value.get(S.peerId);C?(C.lastHeartbeat=Math.max(C.lastHeartbeat,S.lastHeartbeat),C.isOnline=f-C.lastHeartbeat<F):e.value.set(S.peerId,{...S,firstDiscovered:f,isOnline:!0})}),await o()}async function w(g){return e.value.delete(g)?(await A.delete("avatars",g),await o(),!0):!1}async function l(){const g=Date.now(),f=[];e.value.forEach((S,C)=>{g-S.lastHeartbeat>Ne&&f.push(C)});for(const S of f)e.value.delete(S),await A.delete("avatars",S),console.log(`[DeviceStore] Removed expired device: ${S}`);return f.length>0&&await o(),f.length}async function m(){const g=Date.now();e.value.forEach(f=>{f.isOnline=g-f.lastHeartbeat<F}),await o(),me(e)}function _(g){n===null&&(l().catch(f=>console.error("[DeviceStore] Initial cleanup failed:",f)),n=window.setInterval(async()=>{console.log("[DeviceStore] Running heartbeat check...");const f=[];e.value.forEach(S=>{f.push(S)});for(const S of f)try{if(await g(S))await D(S.peerId);else{const k=e.value.get(S.peerId);k&&(k.isOnline=!1)}}catch{const k=e.value.get(S.peerId);k&&(k.isOnline=!1)}await m(),await l()},600*1e3),console.log("[DeviceStore] Heartbeat timer started"))}function P(){n!==null&&(clearInterval(n),n=null,console.log("[DeviceStore] Heartbeat timer stopped"))}async function R(){e.value.clear(),await A.clearStore("avatars"),await o()}return{devices:e,allDevices:t,onlineDevices:a,offlineDevices:i,loadDevices:r,addOrUpdateDevice:d,getDevice:v,updateHeartbeat:D,updateDeviceOnlineStatus:b,addDevices:O,removeDevice:w,cleanupExpiredDevices:l,updateOnlineStatus:m,startHeartbeatTimer:_,stopHeartbeatTimer:P,clearAll:R}});let M=null;function ce(e){M=e}let he=null;function Q(e){he=e}const h={message:null,deliveryAck:null,discoveryResponse:null,discoveryNotification:null,usernameQuery:null,usernameResponse:null,onlineCheckQuery:null,onlineCheckResponse:null,userInfoQuery:null,userInfoResponse:null,userInfoUpdate:null,networkAccelerationStatus:null,deviceListRequest:null,deviceListResponse:null},ae=new Set;let ie=null,be=!1;function _e(e){ie=e}function Oe(e){be=e}const x=B(!1),G=B(!1);async function z(e){const n=M,r=U(),s=L();if(!n)return null;I.sync.requestInfo({to:e});try{const o=await n.queryUserInfo(e);if(o){console.log("[Peer] Got user info for "+e+": "+JSON.stringify({username:o.username,version:o.version}));const t=r.getDevice(e);r.addOrUpdateDevice({peerId:e,username:o.username,avatar:o.avatar,lastHeartbeat:Date.now(),firstDiscovered:t?.firstDiscovered||Date.now(),userInfoVersion:o.version});const a=s.getContact(e);return a&&s.addOrUpdateContact({...a,username:o.username,avatar:o.avatar,lastSeen:Date.now()}),o}}catch(o){console.error("[Peer] Request user info error:",o)}return null}async function qe(e){const n=M,r=U();if(!n)return[];try{I.discovery.add({peerId:e});const s=await n.queryDiscoveredDevices(e);return s.length>0&&r.addDevices(s),s}catch(s){return console.error("[Peer] Query discovered devices error:",s),[]}}function $e(){const e=M;return e?e.getDiscoveredDevices():[]}function xe(){return U().allDevices}function He(e){const n=M,r=U();n&&(n.addDiscoveredDevice(e),r.addOrUpdateDevice(e))}async function Le(e){const n=M,r=H();if(!n){console.warn("[Peer] sendDiscoveryNotification: peerInstance is null");return}try{console.log("[Peer] Sending discovery notification to:",e,"username:",r.userInfo.username),I.discovery.notify({to:e,username:r.userInfo.username}),await n.sendDiscoveryNotification(e,r.userInfo.username||"",r.userInfo.avatar,r.userInfo.version||0),console.log("[Peer] Discovery notification sent successfully to:",e)}catch(s){console.error("[Peer] Send discovery notification error:",s)}}async function Ve(e){const n=M;if(!n)return console.warn("[Peer] queryUsername: peerInstance is null"),null;try{console.log("[Peer] Querying username for:",e),I.discovery.query({from:e});const r=await n.queryUsername(e);return console.log("[Peer] Query username result:",r),r}catch(r){return console.error("[Peer] Query username error: "+String(r)),null}}async function Je(e){const n=M,r=H();if(!n)return!1;try{I.heartbeat.check({to:e,version:r.userInfo.version});const s=await n.checkOnline(e,r.userInfo.username||"",r.userInfo.avatar,r.userInfo.version);return s!==null&&s.isOnline?(I.heartbeat.online({from:e}),!0):(s!==null&&!s.isOnline&&I.heartbeat.offline({peerId:e}),s!==null&&s.isOnline)}catch(s){return console.error("[Peer] Check online error: "+String(s)),I.heartbeat.offline({peerId:e}),!1}}async function W(e){const n=M,r=U();if(!n)return[];I.deviceDiscovery.requestSent({to:e});try{const s=await n.requestDeviceList(e);return s.length>0&&r.addDevices(s),s}catch(s){return console.error("[Peer] Request device list error:",s),[]}}async function Fe(){const e=M,n=U();if(!e)return;const r=n.allDevices;console.log("[Peer] Requesting device lists from "+r.length+" devices");const s=r.map(o=>W(o.peerId));await Promise.allSettled(s)}async function je(){const e=M,n=H(),r=U();if(!e)return;const s=r.allDevices,{username:o,avatar:t,version:a}=n.userInfo;console.log("[Peer] Broadcasting user info update to",s.length,"devices:",{username:o,version:a});const i=s.map(d=>d.isOnline?e.sendUserInfoUpdate(d.peerId,o,t,a).catch(v=>{console.warn("[Peer] Failed to send user info update to",d.peerId,v)}):Promise.resolve());await Promise.allSettled(i),console.log("[Peer] User info update broadcast completed")}function Ye(e){const n=L(),r=U(),s=H();return h.deliveryAck=(o,t)=>{if(o.type==="delivery_ack"){const{messageId:a}=o;I.message.delivered({from:t,messageId:a});const i=n.getMessageById(a);i&&(n.updateMessageStatus(i.to,a,"delivered"),n.removePendingMessage(a))}},e.onProtocol("delivery_ack",h.deliveryAck),h.discoveryResponse=(o,t)=>{if(o.type==="discovery_response"){if(o.devices){const{devices:a}=o;I.discovery.found({peerId:t}),a?.forEach(i=>{e?.addDiscoveredDevice(i)})}else if(o.username){const{username:a,avatar:i}=o;console.log("[Peer] Received discovery response from:",t,"username:",a);const d=r.getDevice(t),v={peerId:t,username:a,avatar:i,lastHeartbeat:Date.now(),firstDiscovered:d?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(v),r.addOrUpdateDevice(v),window.dispatchEvent(new CustomEvent("discovery-devices-updated"))}}},e.onProtocol("discovery_response",h.discoveryResponse),h.discoveryNotification=(o,t)=>{if(console.log("[Peer] discoveryNotificationHandler called:",{type:o.type,from:t}),o.type==="discovery_notification"){const{fromUsername:a,fromAvatar:i,profileVersion:d}=o;I.discovery.notified({from:t,username:a}),console.log("[Peer] Received discovery notification from:",t,"username:",a,"profileVersion:",d);const v=r.getDevice(t),D=!v||v.userInfoVersion===void 0||v.userInfoVersion<d,b={peerId:t,username:a,avatar:i,lastHeartbeat:Date.now(),firstDiscovered:v?.firstDiscovered||Date.now(),isOnline:!0,userInfoVersion:d};console.log("[Peer] Adding device to store:",b),e?.addDiscoveredDevice(b),r.addOrUpdateDevice(b),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),n.getContact(t)||(n.createChat(t,a),n.addOrUpdateContact({peerId:t,username:a,avatar:i,online:!0,lastSeen:Date.now(),unreadCount:0,chatVersion:0}));const O=s.userInfo.username||"",w=s.userInfo.avatar;console.log("[Peer] Sending discovery response to:",t,"username:",O,"avatar:",w),e?.sendDiscoveryResponse(t,O,w),D&&v!==void 0&&(console.log("[Peer] Profile version mismatch, requesting latest user info from:",t),z(t)),W(t).then(l=>{l.length>0&&console.log("[Peer] Discovered "+l.length+" devices from "+t)}).catch(l=>{console.error("[Peer] Request device list error after discovery notification:",l)})}},e.onProtocol("discovery_notification",h.discoveryNotification),h.usernameQuery=(o,t)=>{o.type==="username_query"&&(I.discovery.query({from:t}),e?.respondUsernameQuery(t,s.userInfo.username||"",s.userInfo.avatar))},e.onProtocol("username_query",h.usernameQuery),h.usernameResponse=(o,t)=>{if(o.type==="username_response"){const{username:a,avatar:i}=o;I.discovery.response({to:t,username:a});const d=n.getContact(t);d&&n.addOrUpdateContact({...d,username:a,avatar:i});const v=r.getDevice(t),D={peerId:t,username:a,avatar:i,lastHeartbeat:Date.now(),firstDiscovered:v?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(D),r.addOrUpdateDevice(D)}},e.onProtocol("username_response",h.usernameResponse),h.onlineCheckQuery=(o,t)=>{if(o.type==="online_check_query"){const{userInfoVersion:a}=o,d=r.getDevice(t)?.userInfoVersion||0;I.heartbeat.response({to:t,version:s.userInfo.version}),e?.respondOnlineCheck(t,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version),a!==void 0&&a!==d&&(I.sync.versionMismatch({peerId:t,stored:d,theirs:a}),I.sync.requestInfo({to:t}),z(t))}},e.onProtocol("online_check_query",h.onlineCheckQuery),h.onlineCheckResponse=(o,t)=>{if(o.type==="online_check_response"){const{isOnline:a,username:i,avatar:d,userInfoVersion:v}=o,D=r.getDevice(t),b=D?.userInfoVersion||0;r.addOrUpdateDevice({peerId:t,username:i,avatar:d,lastHeartbeat:Date.now(),firstDiscovered:D?.firstDiscovered||Date.now(),userInfoVersion:v});const O=n.getContact(t);O&&n.addOrUpdateContact({...O,username:i,avatar:d,online:a,lastSeen:Date.now()}),v!==void 0&&v!==b&&(I.sync.versionMismatch({peerId:t,stored:b,theirs:v}),z(t))}},e.onProtocol("online_check_response",h.onlineCheckResponse),h.userInfoQuery=(o,t)=>{o.type==="user_info_query"&&(I.sync.respondInfo({to:t,version:s.userInfo.version}),e?.respondUserInfo(t,s.userInfo.username||"",s.userInfo.avatar,s.userInfo.version))},h.userInfoResponse=(o,t)=>{if(o.type==="user_info_response"){const{username:a,avatar:i,version:d}=o;I.sync.updateInfo({peerId:t,username:a,version:d});const v=r.getDevice(t);r.addOrUpdateDevice({peerId:t,username:a,avatar:i,lastHeartbeat:Date.now(),firstDiscovered:v?.firstDiscovered||Date.now(),userInfoVersion:d});const D=n.getContact(t);D&&n.addOrUpdateContact({...D,username:a,avatar:i,lastSeen:Date.now()})}},e.onProtocol("user_info_query",h.userInfoQuery),e.onProtocol("user_info_response",h.userInfoResponse),h.userInfoUpdate=(o,t)=>{if(o.type==="user_info_update"){const{username:a,avatar:i,version:d}=o;console.log("[Peer] Received user info update from:",t,"username:",a,"version:",d);const v=r.getDevice(t);if(v&&(!v.userInfoVersion||d>v.userInfoVersion)){r.addOrUpdateDevice({...v,username:a,avatar:i,userInfoVersion:d,lastHeartbeat:Date.now()});const D=n.getContact(t);D&&n.addOrUpdateContact({peerId:t,username:a,avatar:i,online:!0,lastSeen:Date.now(),unreadCount:D.unreadCount||0,chatVersion:D.chatVersion||0}),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),console.log("[Peer] User info updated for device:",t)}}},e.onProtocol("user_info_update",h.userInfoUpdate),h.networkAccelerationStatus=(o,t)=>{if(o.type==="network_acceleration_status"){const{enabled:a}=o;console.log("[Peer] Network acceleration status from "+t+": "+a),I.networkAcceleration.statusSync({from:t,enabled:a});const i=r.getDevice(t);i&&r.addOrUpdateDevice({...i,networkAccelerationEnabled:a})}},e.onProtocol("network_acceleration_status",h.networkAccelerationStatus),h.deviceListResponse=o=>{if(o.type==="device_list_response"){const{devices:t}=o;if(I.deviceDiscovery.responseReceived({deviceCount:t?.length||0}),t&&t.length>0){const a=[];t.forEach(i=>{!r.getDevice(i.peerId)&&!ae.has(i.peerId)&&a.push(i)}),r.addDevices(t),a.forEach(i=>{ae.add(i.peerId),I.deviceDiscovery.newDevice({peerId:i.peerId,username:i.username}),W(i.peerId).then(d=>{d.length>0&&console.log("[Peer] Discovered "+d.length+" more devices from "+i.peerId)}).catch(d=>{console.error("[Peer] Recursive device list request error:",d)}).finally(()=>{ae.delete(i.peerId)})})}}},e.onProtocol("device_list_response",h.deviceListResponse),h.deviceListRequest=(o,t)=>{if(o.type==="device_list_request"){I.deviceDiscovery.requestReceived({from:t});const a=r.allDevices;e?.sendDeviceListResponse(t,a)}},e.onProtocol("device_list_request",h.deviceListRequest),e}function Ke(e){const{from:n,data:r}=e;if(r&&typeof r=="object"&&"id"in r&&"type"in r){Qe(n,r);return}}async function Qe(e,n){const r=L(),{id:s,type:o}=n;I.message.received({from:e,msgType:o,messageId:s});const t=JSON.stringify({id:s,from:e,to:n.to,type:o,timestamp:n.timestamp});console.log("[Peer] Handling chat message:",t.substring(0,200));const a=r.getContact(e);r.setContactOnline(e,!0),console.log("[Peer] Contact online: "+e),a?(r.incrementUnread(e),console.log("[Peer] Incremented unread for "+e)):r.addOrUpdateContact({peerId:e,username:e,avatar:null,online:!0,lastSeen:Date.now(),unreadCount:1,chatVersion:0}),r.addMessage(e,n),console.log("[Peer] Message saved to store: "+n.id),await Ge(e)}async function Ge(e){const n=L(),r=n.getPendingMessagesForPeer(e);if(r.length!==0){console.log("[Peer] Retrying "+r.length+" pending messages for "+e);for(const s of r)await ve(e,s.id,s.content,s.type)?n.removePendingMessage(s.id):n.incrementRetryCount(s.id)||(n.removePendingMessage(s.id),n.updateMessageStatus(e,s.id,"failed"))}}async function ve(e,n,r,s="text"){const o=M;if(!o)return console.error("[Peer] Peer instance not initialized"),!1;console.log("[Peer] Sending chat message: peerId="+e+", msgId="+n+", type="+s);try{const t=await o.send(e,n,r,s);return console.log("[Peer] Send result: msgId="+t.messageId+", sent="+t.sent+", stage="+t.stage),t.sent&&L().updateMessageStatus(e,n,"sending"),t.sent}catch(t){return console.error("[Peer] Send error: "+String(t)),!1}}function Ce(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}async function ze(e,n,r="text"){const s=H(),o=L();if(!x.value||!M)throw console.error("[Peer] Peer not connected, cannot send message"),new Error("Peer not connected");const t=Ce();I.message.send({to:e,msgType:r,messageId:t});const a={id:t,from:s.myPeerId||"",to:e,content:n,timestamp:Date.now(),status:"sending",type:r};o.addMessage(e,a),console.log("[Peer] Message added to local store: "+a.id);const i=await ve(e,t,n,r);return console.log("[Peer] Send result: messageId="+t+", success="+i),i?o.updateMessageStatus(e,t,"sending"):(o.addPendingMessage({id:t,to:e,content:n,timestamp:Date.now(),retryCount:0,type:r}),o.updateMessageStatus(e,t,"failed")),t}function We(){return e=>{Ke(e)}}function fe(){ie!==null&&(clearTimeout(ie),_e(null),console.log("[Peer] Auto-reconnect stopped")),Oe(!1)}function le(e){be||(Oe(!0),console.log("[Peer] Starting auto-reconnect in 10 seconds..."),_e(window.setTimeout(async()=>{console.log("[Peer] Attempting to reconnect...");try{await e(),console.log("[Peer] Reconnected successfully"),fe()}catch(n){console.error("[Peer] Reconnect failed:",n),le(e)}},1e4)))}function ue(e){return new Promise((n,r)=>{const s=performance.now();console.log("[Peer-Performance] ===== Peer 初始化开始 ====="),console.log("[Peer-Performance] Timestamp:",Date.now());const o=(w,l)=>{const m=performance.now(),_=Math.round(m-s);console.log(`[Peer-Performance] [${w}] +${_}ms ${l}`)};o("start","开始初始化 Peer");const t=M;t&&(o("destroy-old","销毁旧的 peerInstance"),t.destroy(),ce(null));let a=e.userInfo.peerId;if(a)o("reuse-peerid",`复用已存储的 PeerId: ${a}`);else{o("generate-peerid","生成新的 PeerId");const w=Date.now().toString(36),l=Math.random().toString(36).substring(2,11);a=`peer_${w}_${l}`}console.log("[Peer] Initializing with PeerId:",a,"at",new Date().toISOString());const i={debug:2};o("before-peer-http-util","准备创建 PeerHttpUtil");const d=performance.now(),v=new ke(a,i);ce(v),o("after-peer-http-util",`PeerHttpUtil 创建完成 (耗时 ${Math.round(performance.now()-d)}ms)`),e.loadNetworkLogging()&&(o("network-logging","启用网络日志"),v.setNetworkLogger(!0,async w=>{try{await Te.addLog(w)}catch(l){console.error("[Peer] Failed to save network log:",l)}}),console.log("[Peer] Network logging enabled"));let b=!1;const O=setTimeout(()=>{b||(b=!0,console.error("[Peer] Connection timeout"),o("timeout","连接超时 (30秒)"),x.value=!1,r(new Error("Peer connection timeout")))},3e4);o("before-register-protocols","准备注册协议处理器"),Ye(v),o("after-register-protocols","协议处理器注册完成"),o("before-register-message","准备注册消息处理器"),v.on("message",We()),o("after-register-message","消息处理器注册完成"),v.on("open",w=>{if(!b){const l=performance.now();b=!0,clearTimeout(O),x.value=!0,e.setPeerId(w);const m=Math.round(l-s);console.log("[Peer] Connected with ID:",w),o("connected",`Peer 连接成功! 总耗时: ${m}ms`),console.log("[Peer-Performance] ===== Peer 初始化完成 ====="),fe(),n(v)}}),v.on("disconnected",()=>{console.warn("[Peer] Disconnected from Peer Server"),x.value=!1,le(ue.bind(null,e))}),v.on("close",()=>{console.warn("[Peer] Peer connection closed"),x.value=!1,le(ue.bind(null,e))}),v.on("error",w=>{console.error("[Peer] PeerJS error:",w),!b&&(w?.type==="peer-unavailable"||w?.type==="network"||w?.type==="server-error"||w?.type==="socket-error"||w?.type==="socket-closed")&&(b=!0,clearTimeout(O),x.value=!1,r(new Error(`Peer connection failed: ${w?.type||"unknown error"}`))),w?.type==="peer-unavailable"&&console.log("[Peer] Target peer unavailable:",w)})})}async function Xe(){const e="UNIVERSE-BOOTSTRAP-PEER-ID-001",n=U(),r=H();console.log("[Peer] Trying to become universe bootstrap with ID:",e),I.universeBootstrap.connecting();const s=performance.now();console.log("[Bootstrap-Performance] ===== 尝试成为宇宙启动者 =====");const o=(t,a)=>{const i=performance.now(),d=Math.round(i-s);console.log(`[Bootstrap-Performance] [${t}] +${d}ms ${a}`)};return o("start","开始尝试成为宇宙启动者"),new Promise(t=>{let a=globalThis.__bootstrapPeerInstance;if(a){console.log("[Peer] Already is bootstrap"),o("already-bootstrap","已经是启动者"),t(!0);return}const i=setTimeout(()=>{I.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! Keeping connection..."),o("success","成为宇宙启动者成功 (3秒超时未被触发)"),G.value=!0,t(!0)},3e3);try{o("before-create-peer","准备创建 Bootstrap Peer");const d=performance.now(),v=we(),D=v.host||"PeerJS Cloud (default)",b=v.port,O=v.path,w=b?`${D}:${b}${O}`:`${D}${O}`;console.log("[Peer-Bootstrap] Connecting to Peer Server:",w),a=new Pe(e,v),globalThis.__bootstrapPeerInstance=a,Q(a),o("after-create-peer",`Bootstrap Peer 创建完成 (耗时 ${Math.round(performance.now()-d)}ms)`),a.on("open",l=>{const m=performance.now();clearTimeout(i),I.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! ID:",l),o("connected",`成为宇宙启动者成功! 连接耗时: ${Math.round(m-s)}ms`),G.value=!0,a.on("connection",_=>{_.on("data",P=>{if(P&&P.type==="device_list_request"){if(console.log("[Peer-Bootstrap] Received device list request from:",P.from,"realPeerId:",P.realPeerId,"username:",P.username),I.deviceDiscovery.requestReceived({from:P.from}),P.realPeerId&&P.realPeerId!==r.myPeerId){const f={peerId:P.realPeerId,username:P.username||P.realPeerId,avatar:P.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0};n.addOrUpdateDevice(f),console.log("[Peer-Bootstrap] Added requester to device list:",P.realPeerId,"username:",P.username)}const R=n.allDevices,g={type:"device_list_response",from:e,to:P.from,timestamp:Date.now(),devices:R,isBootstrap:!0,realPeerId:r.myPeerId,username:r.userInfo.username,avatar:r.userInfo.avatar};_.send(g),I.deviceDiscovery.responseSent({to:P.from,deviceCount:R.length}),console.log("[Peer-Bootstrap] Sent device list with",R.length,"devices")}})}),console.log("[Peer-Bootstrap] Listening for device list requests..."),t(!0)}),a.on("error",l=>{if(!a)return;const m=performance.now();clearTimeout(i),I.universeBootstrap.failed({error:l?.type}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Bootstrap already exists, requesting device list..."),o("error",`Bootstrap 已存在，连接失败 (耗时 ${Math.round(m-s)}ms)`),G.value=!1,a&&(a.destroy(),a=null,globalThis.__bootstrapPeerInstance=null,Q(null)),Ee(e).then(()=>{t(!1)}).catch(()=>{t(!1)})}),a.on("disconnected",()=>{console.warn("[Peer-Bootstrap] Disconnected from server")}),a.on("close",()=>{console.log("[Peer-Bootstrap] Connection closed"),a=null,globalThis.__bootstrapPeerInstance=null,Q(null),G.value=!1})}catch(d){clearTimeout(i),console.error("[Peer] Bootstrap error:",d),a=null,globalThis.__bootstrapPeerInstance=null,Q(null),t(!1)}})}async function Ee(e){const n=U(),r=H();return I.universeBootstrap.requestList({to:e}),new Promise(s=>{let o=null,t=null,a=null,i=null;const d=()=>{t&&(t.close(),t=null),o&&(o.destroy(),o=null),a!==null&&(clearTimeout(a),a=null),i!==null&&(clearInterval(i),i=null)};a=window.setTimeout(()=>{console.warn("[Peer] Request bootstrap device list timeout"),d(),s()},1e4);try{const v=we(),D=v.host||"PeerJS Cloud (default)",b=v.port,O=v.path,w=b?`${D}:${b}${O}`:`${D}${O}`;console.log("[Peer-Bootstrap-Request] Connecting to Peer Server:",w),o=new Pe(v),o.on("open",l=>{console.log("[Peer] Temp peer connected with ID:",l),t=o.connect(e),t.on("open",()=>{console.log("[Peer] Connected to bootstrap, waiting for myPeerId...");const m=5e3,_=Date.now();i=window.setInterval(()=>{if(r.myPeerId){clearInterval(i),i=null,console.log("[Peer] myPeerId is ready:",r.myPeerId);const P={type:"device_list_request",from:l,to:e,timestamp:Date.now(),realPeerId:r.myPeerId,username:r.userInfo.username,avatar:r.userInfo.avatar};console.log("[Peer] Sending device list request with realPeerId:",r.myPeerId),t.send(P)}else if(Date.now()-_>m){clearInterval(i),i=null,console.warn("[Peer] Timeout waiting for myPeerId, sending request without it...");const P={type:"device_list_request",from:l,to:e,timestamp:Date.now(),realPeerId:null,username:null,avatar:null};t.send(P)}},100)}),t.on("data",m=>{if(m&&m.type==="device_list_response"){if(console.log("[Peer] Received device list from bootstrap:",m.devices?.length||0,"devices"),I.universeBootstrap.responseList({deviceCount:m.devices?.length||0}),m.devices&&m.devices.length>0&&n.addDevices(m.devices),m.isBootstrap&&m.realPeerId){console.log("[Peer] Bootstrap device has real PeerID:",m.realPeerId);const _={peerId:m.realPeerId,username:m.username||"宇宙启动者",avatar:m.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0,isBootstrap:!0,realPeerId:e};n.addOrUpdateDevice(_)}d(),s()}}),t.on("error",m=>{console.error("[Peer] Bootstrap connection error:",m),d(),s()}),t.on("close",()=>{d(),s()})}),o.on("error",l=>{console.error("[Peer] Temp peer error:",l),d(),s()})}catch(v){console.error("[Peer] Request bootstrap device list error:",v),d(),s()}})}function Ze(e){const n=M;n&&(n.setNetworkAccelerationEnabled(e),e?I.networkAcceleration.enabled():I.networkAcceleration.disabled())}function et(){return M?.getNetworkAccelerationEnabled()||!1}async function tt(){const e=M;if(!e)return;const r=U().allDevices;e.getNetworkAccelerationEnabled();const s=r.map(o=>o.isOnline?e.sendNetworkAccelerationStatus(o.peerId).catch(()=>{}):Promise.resolve());await Promise.allSettled(s)}function st(){L();const e=H(),n=U();function r(){return ue(e)}function s(){fe();const o=M;o&&(o.destroy(),ce(null),h.message=null,h.deliveryAck=null,h.discoveryResponse=null,h.discoveryNotification=null,h.onlineCheckQuery=null,h.onlineCheckResponse=null,x.value=!1);const t=he;t&&(t.destroy(),Q(null),console.log("[Peer] Bootstrap connection destroyed"))}return{isConnected:x,isBootstrap:G,init:r,destroy:s,sendChatMessage:ve,sendMessageWithRetry:ze,generateMessageId:Ce,queryDiscoveredDevices:qe,getDiscoveredDevices:$e,getStoredDevices:xe,addDiscoveredDevice:He,sendDiscoveryNotification:Le,queryUsername:Ve,checkOnline:Je,requestUserInfo:z,tryBecomeBootstrap:Xe,requestBootstrapDeviceList:Ee,setNetworkAccelerationEnabled:Ze,getNetworkAccelerationEnabled:et,broadcastNetworkAccelerationStatus:tt,requestDeviceList:W,requestAllDeviceLists:Fe,broadcastUserInfoUpdate:je,deviceStore:n}}export{st as a,L as b,U as c,H as u};
