import{H as ve,r as U,s as Q,J as ye}from"./index-Dh8JxQg4.js";import{c as y,P as Ne,g as be,$ as Oe}from"./PeerHttpUtil-D_AN6ldI.js";import{n as Ue}from"./networkLogDB-BlD6FS5Z.js";class Ae{db=null;DB_NAME="p2p-chat";DB_VERSION=1;async init(){if(!this.db)return new Promise((n,r)=>{const a=indexedDB.open(this.DB_NAME,this.DB_VERSION);a.onerror=()=>{console.error("[IndexedDB] Failed to open database:",a.error),r(a.error)},a.onsuccess=()=>{this.db=a.result,console.log("[IndexedDB] Database opened successfully"),n()},a.onupgradeneeded=o=>{const t=o.target.result;if(t.objectStoreNames.contains("avatars")||t.createObjectStore("avatars",{keyPath:"id"}).createIndex("peerId","peerId",{unique:!1}),!t.objectStoreNames.contains("messages")){const s=t.createObjectStore("messages",{keyPath:"id"});s.createIndex("toPeerId","toPeerId",{unique:!1}),s.createIndex("timestamp","timestamp",{unique:!1})}t.objectStoreNames.contains("devices")||t.createObjectStore("devices",{keyPath:"peerId"}).createIndex("username","username",{unique:!1}),console.log("[IndexedDB] Object stores created")}})}async ensureInitialized(){this.db||await this.init()}async set(n,r){return await this.ensureInitialized(),new Promise((a,o)=>{const i=this.db.transaction([n],"readwrite").objectStore(n).put(r);i.onsuccess=()=>{console.log(`[IndexedDB] Data saved to ${n}:`,r.id||r.peerId||r.toPeerId),a()},i.onerror=()=>{console.error(`[IndexedDB] Failed to save to ${n}:`,i.error),o(i.error)}})}async get(n,r){return await this.ensureInitialized(),new Promise((a,o)=>{const i=this.db.transaction([n],"readonly").objectStore(n).get(r);i.onsuccess=()=>{a(i.result)},i.onerror=()=>{console.error(`[IndexedDB] Failed to get from ${n}:`,i.error),o(i.error)}})}async getAll(n){return await this.ensureInitialized(),new Promise((r,a)=>{const s=this.db.transaction([n],"readonly").objectStore(n).getAll();s.onsuccess=()=>{r(s.result)},s.onerror=()=>{console.error(`[IndexedDB] Failed to get all from ${n}:`,s.error),a(s.error)}})}async delete(n,r){return await this.ensureInitialized(),new Promise((a,o)=>{const i=this.db.transaction([n],"readwrite").objectStore(n).delete(r);i.onsuccess=()=>{console.log(`[IndexedDB] Data deleted from ${n}:`,r),a()},i.onerror=()=>{console.error(`[IndexedDB] Failed to delete from ${n}:`,i.error),o(i.error)}})}async clearStore(n){return await this.ensureInitialized(),new Promise((r,a)=>{const s=this.db.transaction([n],"readwrite").objectStore(n).clear();s.onsuccess=()=>{console.log(`[IndexedDB] Store ${n} cleared`),r()},s.onerror=()=>{console.error(`[IndexedDB] Failed to clear ${n}:`,s.error),a(s.error)}})}close(){this.db&&(this.db.close(),this.db=null,console.log("[IndexedDB] Database closed"))}}const k=new Ae,V="p2p_user_info",J="p2p_user_info_meta",Se="p2p_network_acceleration",De="p2p_network_logging",he="p2p_device_check_interval",we="p2p_device_check_timeout",oe="user_avatar_migrated_to_indexeddb",$="my-avatar",L=ve("user",()=>{const e=U({username:"",avatar:null,peerId:null,version:0}),n=U(!1),r=U(!1),a=U(!1),o=U(20),t=U(5),s=Q(()=>e.value.peerId);async function i(){await f();let c=localStorage.getItem(J);const u=localStorage.getItem("user_info"),I=localStorage.getItem(V)||localStorage.getItem(J);if(!c&&u)c=u,console.log('[UserStore] Loading from old key "user_info"');else if(!u&&I&&localStorage.getItem("__E2E_DISABLE_AUTO_SETUP__")==="true")return localStorage.removeItem(V),localStorage.removeItem(J),console.log("[UserStore] Old key removed, clearing new keys for E2E test"),n.value=!1,!1;if(c)try{const R=JSON.parse(c);e.value={username:R.username||"",avatar:null,peerId:R.peerId||null,version:R.version||0},n.value=!!R.username;const _=await k.get("avatars",$);if(_&&_.avatar)e.value.avatar=_.avatar;else{const C=localStorage.getItem(V);if(C)try{const N=JSON.parse(C);N.avatar&&(e.value.avatar=N.avatar,console.log("[UserStore] Loaded avatar from fallback (old localStorage key)"),await k.set("avatars",{id:$,peerId:$,avatar:N.avatar}),console.log("[UserStore] Migrated avatar to IndexedDB"))}catch(N){console.error("[UserStore] Failed to load avatar from fallback:",N)}}}catch(R){console.error("[UserStore] Failed to load user info:",R)}return n.value}async function f(){if(!localStorage.getItem(oe))try{const u=localStorage.getItem(V);if(!u){localStorage.setItem(oe,"true");return}const I=JSON.parse(u);console.log("[UserStore] 开始迁移用户数据到混合存储...");const{avatar:R,..._}=I;localStorage.setItem(J,JSON.stringify(_)),R&&(await k.set("avatars",{id:$,peerId:$,avatar:R}),console.log("[UserStore] 用户头像已移至 IndexedDB")),localStorage.removeItem(V),localStorage.setItem(oe,"true"),console.log("[UserStore] 用户数据迁移完成！")}catch(u){console.error("[UserStore] 迁移失败:",u)}}async function g(c){const u=c.username!==void 0&&c.username!==e.value.username,I=c.avatar!==void 0&&c.avatar!==e.value.avatar&&!((c.avatar===null||c.avatar===void 0)&&e.value.avatar===null),R=u||I,{avatar:_,peerId:C,...N}=c;e.value={...e.value,...N,...C!=null?{peerId:C}:{}},R&&(e.value.version+=1),_!==void 0&&(e.value.avatar=_,_?await k.set("avatars",{id:$,peerId:$,avatar:_}):await k.delete("avatars",$));const{avatar:pe,...Z}=e.value;localStorage.setItem(J,JSON.stringify(Z)),localStorage.setItem(V,JSON.stringify(e.value)),c.username&&(n.value=!0)}async function S(c){e.value.peerId=c;const{avatar:u,...I}=e.value;localStorage.setItem(J,JSON.stringify(I)),localStorage.setItem(V,JSON.stringify(e.value))}async function b(){e.value={username:"",avatar:null,peerId:null,version:0},n.value=!1,localStorage.removeItem(J),await k.delete("avatars",$)}function M(){const c=localStorage.getItem(Se);return c!==null&&(r.value=c==="true"),r.value}function D(c){r.value=c,localStorage.setItem(Se,String(c))}function P(){const c=localStorage.getItem(De);return c!==null&&(a.value=c==="true"),a.value}function h(c){a.value=c,localStorage.setItem(De,String(c))}function T(){const c=localStorage.getItem(he);if(c!==null){const u=Number.parseInt(c,10);!Number.isNaN(u)&&u>=5&&u<=600&&(o.value=u)}return o.value}function O(c){const u=Math.max(5,Math.min(600,c));o.value=u,localStorage.setItem(he,String(u))}function q(){const c=localStorage.getItem(we);if(c!==null){const u=Number.parseInt(c,10);!Number.isNaN(u)&&u>=3&&u<=30&&(t.value=u)}return t.value}function v(c){const u=Math.max(3,Math.min(30,c));t.value=u,localStorage.setItem(we,String(u))}return{userInfo:e,isSetup:n,myPeerId:s,loadUserInfo:i,saveUserInfo:g,setPeerId:S,clearUserInfo:b,networkAccelerationEnabled:r,loadNetworkAcceleration:M,setNetworkAcceleration:D,networkLoggingEnabled:a,loadNetworkLogging:P,setNetworkLogging:h,deviceCheckInterval:o,loadDeviceCheckInterval:T,setDeviceCheckInterval:O,deviceCheckTimeout:t,loadDeviceCheckTimeout:q,setDeviceCheckTimeout:v}}),K="p2p_messages_",ne="p2p_contacts",Pe="p2p_pending_messages",re="message_content_migrated_to_indexeddb",F=ve("chat",()=>{const e=U(new Map),n=U(new Map),r=U(new Map),a=U(null);async function o(l,d,m){const p=`msg-content-${l}`;await k.set("messages",{id:p,messageId:l,type:d,content:m})}async function t(l){const d=`msg-content-${l}`;return(await k.get("messages",d))?.content||null}async function s(){if(!localStorage.getItem(re))try{console.log("[ChatStore] 开始检查消息数据迁移...");const d=localStorage.getItem(ne);if(!d){localStorage.setItem(re,"true");return}const m=JSON.parse(d),p=Object.keys(m);let E=0;for(const j of p){const me=localStorage.getItem(K+j);if(!me)continue;const Ie=JSON.parse(me);let ee=0;for(const x of Ie)if(x.type==="image"||x.type==="file"||x.type==="video"){const te=x.content;te&&te.length>1e3&&(await o(x.id,x.type,te),x.content=`msg-content-${x.id}`,ee++)}ee>0&&(localStorage.setItem(K+j,JSON.stringify(Ie)),E+=ee)}localStorage.setItem(re,"true"),console.log(`[ChatStore] 消息数据迁移完成！迁移了 ${E} 条大型消息内容`)}catch(d){console.error("[ChatStore] 消息数据迁移失败:",d)}}const i=Q(()=>a.value?e.value.get(a.value)||[]:[]),f=Q(()=>Array.from(n.value.values()).sort((l,d)=>l.online!==d.online?l.online?-1:1:d.lastSeen-l.lastSeen));async function g(){await s();const l=localStorage.getItem("p2p_current_chat");if(l)try{a.value=l}catch(p){console.error("[ChatStore] Failed to load current chat:",p)}const d=localStorage.getItem(ne);if(d)try{const p=JSON.parse(d);n.value=new Map(Object.entries(p));for(const[E]of n.value)await D(E)}catch(p){console.error("[ChatStore] Failed to load contacts:",p)}const m=localStorage.getItem(Pe);if(m)try{const p=JSON.parse(m);r.value=new Map(Object.entries(p))}catch(p){console.error("[ChatStore] Failed to load pending messages:",p)}}function S(){const l=Object.fromEntries(n.value);localStorage.setItem(ne,JSON.stringify(l))}function b(){const l=Object.fromEntries(r.value);localStorage.setItem(Pe,JSON.stringify(l))}async function M(l){const d=e.value.get(l)||[],m=[];for(const p of d)if(p.type==="image"||p.type==="file"||p.type==="video"){const E=p.content;E.startsWith("msg-content-")?m.push(p):E&&E.length>1e3?(await o(p.id,p.type,E),m.push({...p,content:`msg-content-${p.id}`})):m.push(p)}else m.push(p);localStorage.setItem(K+l,JSON.stringify(m))}async function D(l){const d=localStorage.getItem(K+l);if(d)try{const m=JSON.parse(d),p=[];for(const E of m)if((E.type==="image"||E.type==="file"||E.type==="video")&&typeof E.content=="string"&&E.content.startsWith("msg-content-")){const j=await t(E.id);p.push({...E,content:j||E.content})}else p.push(E);return e.value.set(l,p),p}catch(m){console.error("[ChatStore] Failed to load messages:",m)}return[]}function P(l){const d=n.value.get(l.peerId);d?n.value.set(l.peerId,{...d,...l}):n.value.set(l.peerId,l),S()}function h(l){return n.value.get(l)}function T(l,d){const m=n.value.get(l);m&&(m.online=d,m.lastSeen=Date.now(),S())}async function O(l,d){e.value.has(l)||e.value.set(l,[]),e.value.get(l).push(d),await M(l);const m=n.value.get(l);if(m&&d.from===l){const p=e.value.get(l);p&&p.length>0&&(m.lastSeen=d.timestamp),S()}}async function q(l,d,m){const p=e.value.get(l);if(p){const E=p.find(j=>j.id===d);E&&(E.status=m,m==="delivered"&&(E.deliveredAt=Date.now()),await M(l))}}function v(l){for(const d of e.value.values()){const m=d.find(p=>p.id===l);if(m)return m}return null}function c(l){r.value.set(l.id,l),b()}function u(l){r.value.delete(l),b()}function I(l){const d=r.value.get(l);return d?(d.retryCount++,b(),!(d.maxRetries!==void 0&&d.retryCount>d.maxRetries)):!1}function R(l){return Array.from(r.value.values()).filter(d=>d.to===l)}function _(l){const d=Array.from(r.value.entries()).filter(([,m])=>m.to===l);return d.forEach(([m])=>r.value.delete(m)),b(),d.map(([,m])=>m)}async function C(l,d=l){n.value.has(l)||P({peerId:l,username:d,avatar:null,online:!1,lastSeen:Date.now(),unreadCount:0,chatVersion:0}),await D(l);const m=e.value.get(l);if(!m||m.length===0){const p={id:`system-${l}-${Date.now()}`,from:l,to:"system",content:"",timestamp:Date.now(),status:"delivered",type:"system"};await O(l,p)}}async function N(l){n.value.delete(l),e.value.delete(l);const d=localStorage.getItem(K+l);if(d)try{const m=JSON.parse(d);for(const p of m)(p.type==="image"||p.type==="file"||p.type==="video")&&await k.delete("messages",`msg-content-${p.id}`)}catch(m){console.error("[ChatStore] Failed to clean up IndexedDB messages:",m)}localStorage.removeItem(K+l),S(),_(l),a.value===l&&(a.value=null)}function pe(l){if(a.value=l,l){localStorage.setItem("p2p_current_chat",l);const d=n.value.get(l);d&&(d.unreadCount=0,S())}else localStorage.removeItem("p2p_current_chat")}function Z(l){const d=n.value.get(l);d&&a.value!==l&&(d.unreadCount++,S())}function Te(){return Array.from(n.value.values()).reduce((l,d)=>l+d.unreadCount,0)}return{messages:e,contacts:n,pendingMessages:r,currentChatPeerId:a,currentMessages:i,sortedContacts:f,loadFromStorage:g,loadMessages:D,addOrUpdateContact:P,getContact:h,setContactOnline:T,addMessage:O,updateMessageStatus:q,getMessageById:v,addPendingMessage:c,removePendingMessage:u,incrementRetryCount:I,getPendingMessagesForPeer:R,clearPendingMessagesForPeer:_,createChat:C,deleteChat:N,setCurrentChat:pe,incrementUnread:Z,getTotalUnread:Te}}),_e="discovered_devices",se="discovered_devices_meta",ae="avatar_migrated_to_indexeddb",Y=600*1e3,qe=3,$e=qe*24*60*60*1e3,A=ve("device",()=>{const e=U(new Map);let n=null;async function r(){try{await a();const v=localStorage.getItem(se);if(v){const c=JSON.parse(v),u=Object.values(c),I=await k.getAll("avatars"),R=new Map(I.map(C=>[C.peerId,C.avatar])),_=Date.now();e.value=new Map(u.map(C=>[C.peerId,{...C,avatar:R.get(C.peerId)||null,isOnline:_-C.lastHeartbeat<Y}])),e.value.forEach((C,N)=>{console.log("[DeviceStore] Loaded device: "+N+" isBootstrap="+C.isBootstrap+" realPeerId="+C.realPeerId)}),console.log(`[DeviceStore] Loaded ${e.value.size} devices from storage (${R.size} avatars from IndexedDB)`),await h()}}catch(v){console.error("[DeviceStore] Failed to load devices:",v)}}async function a(){if(!localStorage.getItem(ae))try{const c=localStorage.getItem(_e);if(!c){localStorage.setItem(ae,"true");return}const u=Object.values(JSON.parse(c));console.log(`[DeviceStore] 开始迁移 ${u.length} 个设备到混合存储...`);const I={},R=[];for(const _ of u){const{avatar:C,...N}=_;I[_.peerId]=N,C&&(await k.set("avatars",{id:_.peerId,peerId:_.peerId,avatar:C}),R.push({peerId:_.peerId,avatar:C}))}localStorage.setItem(se,JSON.stringify(I)),localStorage.removeItem(_e),localStorage.setItem(ae,"true"),console.log(`[DeviceStore] 迁移完成！${R.length} 个头像已移至 IndexedDB`)}catch(c){console.error("[DeviceStore] 迁移失败:",c)}}async function o(){try{const v={};for(const[c,u]of e.value){const{avatar:I,isBootstrap:R,..._}=u;v[c]=_,I?await k.set("avatars",{id:c,peerId:c,avatar:I}):await k.delete("avatars",c)}localStorage.setItem(se,JSON.stringify(v))}catch(v){console.error("[DeviceStore] Failed to save devices:",v)}}const t=Q(()=>Array.from(e.value.values())),s=Q(()=>{const v=Date.now();return t.value.filter(c=>v-c.lastHeartbeat<Y)}),i=Q(()=>{const v=Date.now();return t.value.filter(c=>v-c.lastHeartbeat>=Y)});async function f(v){const c=e.value.get(v.peerId),u=Date.now();c?(c.username=v.username,c.avatar=v.avatar,c.lastHeartbeat=v.lastHeartbeat,c.isOnline=u-v.lastHeartbeat<Y,c.isOnline?("isBootstrap"in v&&(c.isBootstrap=v.isBootstrap),"realPeerId"in v&&(c.realPeerId=v.realPeerId)):(c.isBootstrap=!1,c.realPeerId=void 0)):e.value.set(v.peerId,{...v,firstDiscovered:v.firstDiscovered||u,isOnline:!0}),await o()}function g(v){return e.value.get(v)}async function S(v){const c=e.value.get(v);c&&(c.lastHeartbeat=Date.now(),c.isOnline=!0,await o())}async function b(v,c){const u=e.value.get(v);if(u){const I=u.isBootstrap;u.isOnline=c,c?u.lastHeartbeat=Date.now():(u.isBootstrap&&console.log("[DeviceStore] 设备离线，清除启动者标签: "+v+" (wasBootstrap: "+I+")"),u.isBootstrap=!1,u.realPeerId=void 0),await o(),ye(e),console.log("[DeviceStore] updateDeviceOnlineStatus: "+v+" isOnline="+c+" (wasBootstrap: "+I+", isBootstrap: "+u.isBootstrap+")")}else console.warn("[DeviceStore] updateDeviceOnlineStatus: device not found: "+v)}async function M(v){const c=Date.now();v.forEach(u=>{const I=e.value.get(u.peerId);I?(I.lastHeartbeat=Math.max(I.lastHeartbeat,u.lastHeartbeat),I.isOnline=c-I.lastHeartbeat<Y,u.username&&(I.username=u.username),u.avatar!==void 0&&(I.avatar=u.avatar),"isBootstrap"in u&&(I.isBootstrap=u.isBootstrap),"realPeerId"in u&&(I.realPeerId=u.realPeerId)):e.value.set(u.peerId,{...u,firstDiscovered:c,isOnline:!0})}),await o()}async function D(v){return e.value.delete(v)?(await k.delete("avatars",v),await o(),!0):!1}async function P(){const v=Date.now(),c=[];e.value.forEach((u,I)=>{v-u.lastHeartbeat>$e&&c.push(I)});for(const u of c)e.value.delete(u),await k.delete("avatars",u),console.log(`[DeviceStore] Removed expired device: ${u}`);return c.length>0&&await o(),c.length}async function h(){const v=Date.now();e.value.forEach(c=>{c.isOnline=v-c.lastHeartbeat<Y}),await o(),ye(e)}function T(v,c=20){n===null&&(P().catch(u=>console.error("[DeviceStore] Initial cleanup failed:",u)),n=window.setInterval(async()=>{console.log("[DeviceStore] Running heartbeat check...");const u=[];e.value.forEach(I=>{u.push(I)});for(const I of u)try{if(await v(I))await S(I.peerId);else{const _=e.value.get(I.peerId);_&&(_.isOnline=!1)}}catch{const _=e.value.get(I.peerId);_&&(_.isOnline=!1)}await h(),await P()},c*1e3),console.log("[DeviceStore] Heartbeat timer started (interval: "+c+"s)"))}function O(){n!==null&&(clearInterval(n),n=null,console.log("[DeviceStore] Heartbeat timer stopped"))}async function q(){e.value.clear(),await k.clearStore("avatars"),await o()}return{devices:e,allDevices:t,onlineDevices:s,offlineDevices:i,loadDevices:r,addOrUpdateDevice:f,getDevice:g,updateHeartbeat:S,updateDeviceOnlineStatus:b,addDevices:M,removeDevice:D,cleanupExpiredDevices:P,updateOnlineStatus:h,startHeartbeatTimer:T,stopHeartbeatTimer:O,clearAll:q}});let B=null;function ie(e){B=e}let Ce=null;function G(e){Ce=e}const w={message:null,deliveryAck:null,discoveryResponse:null,discoveryNotification:null,usernameQuery:null,usernameResponse:null,onlineCheckQuery:null,onlineCheckResponse:null,userInfoQuery:null,userInfoResponse:null,userInfoUpdate:null,networkAccelerationStatus:null,deviceListRequest:null,deviceListResponse:null},ce=new Set;let le=null,Ee=!1;function Re(e){le=e}function Me(e){Ee=e}const H=U(!1),z=U(!1);async function W(e){const n=B,r=A(),a=F();if(!n)return null;y.sync.requestInfo({to:e});try{const o=await n.queryUserInfo(e);if(o){console.log("[Peer] Got user info for "+e+": "+JSON.stringify({username:o.username,version:o.version}));const t=r.getDevice(e);r.addOrUpdateDevice({peerId:e,username:o.username,avatar:o.avatar,lastHeartbeat:Date.now(),firstDiscovered:t?.firstDiscovered||Date.now(),userInfoVersion:o.version});const s=a.getContact(e);return s&&a.addOrUpdateContact({...s,username:o.username,avatar:o.avatar,lastSeen:Date.now()}),o}}catch(o){console.error("[Peer] Request user info error:",o)}return null}async function xe(e){const n=B,r=A();if(!n)return[];try{y.discovery.add({peerId:e});const a=await n.queryDiscoveredDevices(e);return a.length>0&&r.addDevices(a),a}catch(a){return console.error("[Peer] Query discovered devices error:",a),[]}}function He(){const e=B;return e?e.getDiscoveredDevices():[]}function Le(){return A().allDevices}function Ve(e){const n=B,r=A();n&&(n.addDiscoveredDevice(e),r.addOrUpdateDevice(e))}async function Je(e){const n=B,r=L();if(!n){console.warn("[Peer] sendDiscoveryNotification: peerInstance is null");return}try{console.log("[Peer] Sending discovery notification to:",e,"username:",r.userInfo.username),y.discovery.notify({to:e,username:r.userInfo.username}),await n.sendDiscoveryNotification(e,r.userInfo.username||"",r.userInfo.avatar,r.userInfo.version||0),console.log("[Peer] Discovery notification sent successfully to:",e)}catch(a){console.error("[Peer] Send discovery notification error:",a)}}async function Fe(e){const n=B;if(!n)return console.warn("[Peer] queryUsername: peerInstance is null"),null;try{console.log("[Peer] Querying username for:",e),y.discovery.query({from:e});const r=await n.queryUsername(e);return console.log("[Peer] Query username result:",r),r}catch(r){return console.error("[Peer] Query username error: "+String(r)),null}}async function je(e,n=5e3){const r=B,a=L();if(!r)return!1;try{y.heartbeat.check({to:e,version:a.userInfo.version});const o=await r.checkOnline(e,a.userInfo.username||"",a.userInfo.avatar,a.userInfo.version,n);return o!==null&&o.isOnline?(y.heartbeat.online({from:e}),!0):(o!==null&&!o.isOnline&&y.heartbeat.offline({peerId:e}),o!==null&&o.isOnline)}catch(o){return console.error("[Peer] Check online error: "+String(o)),y.heartbeat.offline({peerId:e}),!1}}async function X(e){const n=B,r=A();if(!n)return[];y.deviceDiscovery.requestSent({to:e});try{const a=await n.requestDeviceList(e);return a.length>0&&r.addDevices(a),a}catch(a){return console.error("[Peer] Request device list error:",a),[]}}async function Ke(){const e=B,n=A();if(!e)return;const r=n.allDevices;console.log("[Peer] Requesting device lists from "+r.length+" devices");const a=r.map(o=>X(o.peerId));await Promise.allSettled(a)}async function Ye(){const e=B,n=L(),r=A();if(!e)return;const a=r.allDevices,{username:o,avatar:t,version:s}=n.userInfo;console.log("[Peer] Broadcasting user info update to",a.length,"devices:",{username:o,version:s});const i=a.map(f=>f.isOnline?e.sendUserInfoUpdate(f.peerId,o,t,s).catch(g=>{console.warn("[Peer] Failed to send user info update to",f.peerId,g)}):Promise.resolve());await Promise.allSettled(i),console.log("[Peer] User info update broadcast completed")}function Qe(e){const n=F(),r=A(),a=L();return w.deliveryAck=(o,t)=>{if(o.type==="delivery_ack"){const{messageId:s}=o;y.message.delivered({from:t,messageId:s});const i=n.getMessageById(s);i&&(n.updateMessageStatus(i.to,s,"delivered"),n.removePendingMessage(s))}},e.onProtocol("delivery_ack",w.deliveryAck),w.discoveryResponse=(o,t)=>{if(o.type==="discovery_response"){if(o.devices){const{devices:s}=o;y.discovery.found({peerId:t}),s?.forEach(i=>{e?.addDiscoveredDevice(i)})}else if(o.username){const{username:s,avatar:i}=o;console.log("[Peer] Received discovery response from:",t,"username:",s);const f=r.getDevice(t),g={peerId:t,username:s,avatar:i,lastHeartbeat:Date.now(),firstDiscovered:f?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(g),r.addOrUpdateDevice(g),window.dispatchEvent(new CustomEvent("discovery-devices-updated"))}}},e.onProtocol("discovery_response",w.discoveryResponse),w.discoveryNotification=(o,t)=>{if(console.log("[Peer] discoveryNotificationHandler called:",{type:o.type,from:t}),o.type==="discovery_notification"){const{fromUsername:s,fromAvatar:i,profileVersion:f}=o;y.discovery.notified({from:t,username:s}),console.log("[Peer] Received discovery notification from:",t,"username:",s,"profileVersion:",f);const g=r.getDevice(t),S=!g||g.userInfoVersion===void 0||g.userInfoVersion<f,b={peerId:t,username:s,avatar:i,lastHeartbeat:Date.now(),firstDiscovered:g?.firstDiscovered||Date.now(),isOnline:!0,userInfoVersion:f};console.log("[Peer] Adding device to store:",b),e?.addDiscoveredDevice(b),r.addOrUpdateDevice(b),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),n.getContact(t)||(n.createChat(t,s),n.addOrUpdateContact({peerId:t,username:s,avatar:i,online:!0,lastSeen:Date.now(),unreadCount:0,chatVersion:0}));const M=a.userInfo.username||"",D=a.userInfo.avatar;console.log("[Peer] Sending discovery response to:",t,"username:",M,"avatar:",D),e?.sendDiscoveryResponse(t,M,D),S&&g!==void 0&&(console.log("[Peer] Profile version mismatch, requesting latest user info from:",t),W(t)),X(t).then(P=>{P.length>0&&console.log("[Peer] Discovered "+P.length+" devices from "+t)}).catch(P=>{console.error("[Peer] Request device list error after discovery notification:",P)})}},e.onProtocol("discovery_notification",w.discoveryNotification),w.usernameQuery=(o,t)=>{o.type==="username_query"&&(y.discovery.query({from:t}),e?.respondUsernameQuery(t,a.userInfo.username||"",a.userInfo.avatar))},e.onProtocol("username_query",w.usernameQuery),w.usernameResponse=(o,t)=>{if(o.type==="username_response"){const{username:s,avatar:i}=o;y.discovery.response({to:t,username:s});const f=n.getContact(t);f&&n.addOrUpdateContact({...f,username:s,avatar:i});const g=r.getDevice(t),S={peerId:t,username:s,avatar:i,lastHeartbeat:Date.now(),firstDiscovered:g?.firstDiscovered||Date.now(),isOnline:!0};e?.addDiscoveredDevice(S),r.addOrUpdateDevice(S)}},e.onProtocol("username_response",w.usernameResponse),w.onlineCheckQuery=(o,t)=>{if(o.type==="online_check_query"){const{userInfoVersion:s}=o,f=r.getDevice(t)?.userInfoVersion||0;y.heartbeat.response({to:t,version:a.userInfo.version}),e?.respondOnlineCheck(t,a.userInfo.username||"",a.userInfo.avatar,a.userInfo.version),s!==void 0&&s!==f&&(y.sync.versionMismatch({peerId:t,stored:f,theirs:s}),y.sync.requestInfo({to:t}),W(t))}},e.onProtocol("online_check_query",w.onlineCheckQuery),w.onlineCheckResponse=(o,t)=>{if(o.type==="online_check_response"){const{isOnline:s,username:i,avatar:f,userInfoVersion:g}=o,S=r.getDevice(t),b=S?.userInfoVersion||0;r.addOrUpdateDevice({peerId:t,username:i,avatar:f,lastHeartbeat:Date.now(),firstDiscovered:S?.firstDiscovered||Date.now(),userInfoVersion:g});const M=n.getContact(t);M&&n.addOrUpdateContact({...M,username:i,avatar:f,online:s,lastSeen:Date.now()}),g!==void 0&&g!==b&&(y.sync.versionMismatch({peerId:t,stored:b,theirs:g}),W(t))}},e.onProtocol("online_check_response",w.onlineCheckResponse),w.userInfoQuery=(o,t)=>{o.type==="user_info_query"&&(y.sync.respondInfo({to:t,version:a.userInfo.version}),e?.respondUserInfo(t,a.userInfo.username||"",a.userInfo.avatar,a.userInfo.version))},w.userInfoResponse=(o,t)=>{if(o.type==="user_info_response"){const{username:s,avatar:i,version:f}=o;y.sync.updateInfo({peerId:t,username:s,version:f});const g=r.getDevice(t);r.addOrUpdateDevice({peerId:t,username:s,avatar:i,lastHeartbeat:Date.now(),firstDiscovered:g?.firstDiscovered||Date.now(),userInfoVersion:f});const S=n.getContact(t);S&&n.addOrUpdateContact({...S,username:s,avatar:i,lastSeen:Date.now()})}},e.onProtocol("user_info_query",w.userInfoQuery),e.onProtocol("user_info_response",w.userInfoResponse),w.userInfoUpdate=(o,t)=>{if(o.type==="user_info_update"){const{username:s,avatar:i,version:f}=o;console.log("[Peer] Received user info update from:",t,"username:",s,"version:",f);const g=r.getDevice(t);if(g&&(!g.userInfoVersion||f>g.userInfoVersion)){r.addOrUpdateDevice({...g,username:s,avatar:i,userInfoVersion:f,lastHeartbeat:Date.now()});const S=n.getContact(t);S&&n.addOrUpdateContact({peerId:t,username:s,avatar:i,online:!0,lastSeen:Date.now(),unreadCount:S.unreadCount||0,chatVersion:S.chatVersion||0}),window.dispatchEvent(new CustomEvent("discovery-devices-updated")),console.log("[Peer] User info updated for device:",t)}}},e.onProtocol("user_info_update",w.userInfoUpdate),w.networkAccelerationStatus=(o,t)=>{if(o.type==="network_acceleration_status"){const{enabled:s}=o;console.log("[Peer] Network acceleration status from "+t+": "+s),y.networkAcceleration.statusSync({from:t,enabled:s});const i=r.getDevice(t);i&&r.addOrUpdateDevice({...i,networkAccelerationEnabled:s})}},e.onProtocol("network_acceleration_status",w.networkAccelerationStatus),w.deviceListResponse=o=>{if(o.type==="device_list_response"){const{devices:t}=o;if(y.deviceDiscovery.responseReceived({deviceCount:t?.length||0}),t&&t.length>0){const s=[];t.forEach(i=>{!r.getDevice(i.peerId)&&!ce.has(i.peerId)&&s.push(i),e?.addDiscoveredDevice(i)}),r.addDevices(t),s.forEach(i=>{ce.add(i.peerId),y.deviceDiscovery.newDevice({peerId:i.peerId,username:i.username}),X(i.peerId).then(f=>{f.length>0&&console.log("[Peer] Discovered "+f.length+" more devices from "+i.peerId)}).catch(f=>{console.error("[Peer] Recursive device list request error:",f)}).finally(()=>{ce.delete(i.peerId)})})}}},e.onProtocol("device_list_response",w.deviceListResponse),w.deviceListRequest=(o,t)=>{if(o.type==="device_list_request"){y.deviceDiscovery.requestReceived({from:t});const s=r.allDevices;e?.sendDeviceListResponse(t,s)}},e.onProtocol("device_list_request",w.deviceListRequest),e}function Ge(e){const{from:n,data:r}=e;if(r&&typeof r=="object"&&"id"in r&&"type"in r){ze(n,r);return}}async function ze(e,n){const r=F(),a=A(),{id:o,type:t}=n;y.message.received({from:e,msgType:t,messageId:o});const s=JSON.stringify({id:o,from:e,to:n.to,type:t,timestamp:n.timestamp});console.log("[Peer] Handling chat message:",s.substring(0,200));const i=r.getContact(e);r.setContactOnline(e,!0),await a.updateDeviceOnlineStatus(e,!0),console.log("[Peer] Contact online: "+e),i?(r.incrementUnread(e),console.log("[Peer] Incremented unread for "+e)):r.addOrUpdateContact({peerId:e,username:e,avatar:null,online:!0,lastSeen:Date.now(),unreadCount:1,chatVersion:0}),r.addMessage(e,n),console.log("[Peer] Message saved to store: "+n.id),await We(e)}async function We(e){const n=F(),r=n.getPendingMessagesForPeer(e);if(r.length!==0){console.log("[Peer] Retrying "+r.length+" pending messages for "+e);for(const a of r)await fe(e,a.id,a.content,a.type)?n.removePendingMessage(a.id):n.incrementRetryCount(a.id)||(n.removePendingMessage(a.id),n.updateMessageStatus(e,a.id,"failed"))}}async function fe(e,n,r,a="text"){const o=B;if(!o)return console.error("[Peer] Peer instance not initialized"),!1;console.log("[Peer] Sending chat message: peerId="+e+", msgId="+n+", type="+a);try{const t=await o.send(e,n,r,a);return console.log("[Peer] Send result: msgId="+t.messageId+", sent="+t.sent+", stage="+t.stage),t.sent&&F().updateMessageStatus(e,n,"sending"),t.sent}catch(t){return console.error("[Peer] Send error: "+String(t)),!1}}function Be(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}async function Xe(e,n,r="text"){const a=L(),o=F();if(!H.value||!B)throw console.error("[Peer] Peer not connected, cannot send message"),new Error("Peer not connected");const t=Be();y.message.send({to:e,msgType:r,messageId:t});const s={id:t,from:a.myPeerId||"",to:e,content:n,timestamp:Date.now(),status:"sending",type:r};o.addMessage(e,s),console.log("[Peer] Message added to local store: "+s.id);const i=await fe(e,t,n,r);return console.log("[Peer] Send result: messageId="+t+", success="+i),i?o.updateMessageStatus(e,t,"sending"):(o.addPendingMessage({id:t,to:e,content:n,timestamp:Date.now(),retryCount:0,type:r}),o.updateMessageStatus(e,t,"failed")),t}function Ze(){return e=>{Ge(e)}}function ge(){le!==null&&(clearTimeout(le),Re(null),console.log("[Peer] Auto-reconnect stopped")),Me(!1)}function ue(e){Ee||(Me(!0),console.log("[Peer] Starting auto-reconnect in 10 seconds..."),Re(window.setTimeout(async()=>{console.log("[Peer] Attempting to reconnect...");try{await e(),console.log("[Peer] Reconnected successfully"),ge()}catch(n){console.error("[Peer] Reconnect failed:",n),ue(e)}},1e4)))}function de(e){return new Promise((n,r)=>{const a=performance.now();console.log("[Peer-Performance] ===== Peer 初始化开始 ====="),console.log("[Peer-Performance] Timestamp:",Date.now());const o=(D,P)=>{const h=performance.now(),T=Math.round(h-a);console.log(`[Peer-Performance] [${D}] +${T}ms ${P}`)};o("start","开始初始化 Peer");const t=B;t&&(o("destroy-old","销毁旧的 peerInstance"),t.destroy(),ie(null));let s=e.userInfo.peerId;if(s)o("reuse-peerid",`复用已存储的 PeerId: ${s}`);else{o("generate-peerid","生成新的 PeerId");const D=Date.now().toString(36),P=Math.random().toString(36).substring(2,11);s=`peer_${D}_${P}`}console.log("[Peer] Initializing with PeerId:",s,"at",new Date().toISOString());const i={debug:2};o("before-peer-http-util","准备创建 PeerHttpUtil");const f=performance.now(),g=new Ne(s,i);ie(g),o("after-peer-http-util",`PeerHttpUtil 创建完成 (耗时 ${Math.round(performance.now()-f)}ms)`),e.loadNetworkLogging()&&(o("network-logging","启用网络日志"),g.setNetworkLogger(!0,async D=>{try{await Ue.addLog(D)}catch(P){console.error("[Peer] Failed to save network log:",P)}}),console.log("[Peer] Network logging enabled"));let b=!1;const M=setTimeout(()=>{b||(b=!0,console.error("[Peer] Connection timeout"),o("timeout","连接超时 (30秒)"),H.value=!1,r(new Error("Peer connection timeout")))},3e4);o("before-register-protocols","准备注册协议处理器"),Qe(g),o("after-register-protocols","协议处理器注册完成"),o("before-register-message","准备注册消息处理器"),g.on("message",Ze()),o("after-register-message","消息处理器注册完成"),g.on("open",D=>{if(!b){const P=performance.now();b=!0,clearTimeout(M),H.value=!0,e.setPeerId(D);const h=Math.round(P-a);console.log("[Peer] Connected with ID:",D),o("connected",`Peer 连接成功! 总耗时: ${h}ms`),console.log("[Peer-Performance] ===== Peer 初始化完成 ====="),ge(),n(g)}}),g.on("disconnected",()=>{console.warn("[Peer] Disconnected from Peer Server"),H.value=!1,ue(de.bind(null,e))}),g.on("close",()=>{console.warn("[Peer] Peer connection closed"),H.value=!1,ue(de.bind(null,e))}),g.on("error",D=>{console.error("[Peer] PeerJS error:",D),!b&&(D?.type==="peer-unavailable"||D?.type==="network"||D?.type==="server-error"||D?.type==="socket-error"||D?.type==="socket-closed")&&(b=!0,clearTimeout(M),H.value=!1,r(new Error(`Peer connection failed: ${D?.type||"unknown error"}`))),D?.type==="peer-unavailable"&&console.log("[Peer] Target peer unavailable:",D)})})}async function et(){const e="UNIVERSE-BOOTSTRAP-PEER-ID-001",n=A(),r=L();console.log("[Peer] Trying to become universe bootstrap with ID:",e),y.universeBootstrap.connecting();const a=performance.now();console.log("[Bootstrap-Performance] ===== 尝试成为宇宙启动者 =====");const o=(t,s)=>{const i=performance.now(),f=Math.round(i-a);console.log(`[Bootstrap-Performance] [${t}] +${f}ms ${s}`)};return o("start","开始尝试成为宇宙启动者"),new Promise(t=>{let s=globalThis.__bootstrapPeerInstance;if(s){console.log("[Peer] Already is bootstrap"),o("already-bootstrap","已经是启动者"),t(!0);return}const i=setTimeout(()=>{y.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! Keeping connection..."),o("success","成为宇宙启动者成功 (3秒超时未被触发)"),z.value=!0,t(!0)},3e3);try{o("before-create-peer","准备创建 Bootstrap Peer");const f=performance.now(),g=be(),S=g.host||"PeerJS Cloud (default)",b=g.port,M=g.path,D=b?`${S}:${b}${M}`:`${S}${M}`;console.log("[Peer-Bootstrap] Connecting to Peer Server:",D),s=new Oe(e,g),globalThis.__bootstrapPeerInstance=s,G(s),o("after-create-peer",`Bootstrap Peer 创建完成 (耗时 ${Math.round(performance.now()-f)}ms)`),s.on("open",P=>{const h=performance.now();clearTimeout(i),y.universeBootstrap.success({peerId:e}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Became the universe bootstrap! ID:",P),o("connected",`成为宇宙启动者成功! 连接耗时: ${Math.round(h-a)}ms`),z.value=!0,s.on("connection",T=>{T.on("data",O=>{if(O&&O.type==="device_list_request"){if(console.log("[Peer-Bootstrap] Received device list request from:",O.from,"realPeerId:",O.realPeerId,"username:",O.username),y.deviceDiscovery.requestReceived({from:O.from}),O.realPeerId&&O.realPeerId!==r.myPeerId){const c={peerId:O.realPeerId,username:O.username||O.realPeerId,avatar:O.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0};n.addOrUpdateDevice(c),console.log("[Peer-Bootstrap] Added requester to device list:",O.realPeerId,"username:",O.username)}const q=n.allDevices,v={type:"device_list_response",from:e,to:O.from,timestamp:Date.now(),devices:q,isBootstrap:!0,realPeerId:r.myPeerId,username:r.userInfo.username,avatar:r.userInfo.avatar};T.send(v),y.deviceDiscovery.responseSent({to:O.from,deviceCount:q.length}),console.log("[Peer-Bootstrap] Sent device list with",q.length,"devices")}})}),console.log("[Peer-Bootstrap] Listening for device list requests..."),t(!0)}),s.on("error",P=>{if(!s)return;const h=performance.now();clearTimeout(i),y.universeBootstrap.failed({error:P?.type}),console.log("[Peer] UNIVERSE-BOOTSTRAP-PEER-ID-001: Bootstrap already exists, requesting device list..."),o("error",`Bootstrap 已存在，连接失败 (耗时 ${Math.round(h-a)}ms)`),z.value=!1,s&&(s.destroy(),s=null,globalThis.__bootstrapPeerInstance=null,G(null)),ke(e).then(()=>{t(!1)}).catch(()=>{t(!1)})}),s.on("disconnected",()=>{console.warn("[Peer-Bootstrap] Disconnected from server")}),s.on("close",()=>{console.log("[Peer-Bootstrap] Connection closed"),s=null,globalThis.__bootstrapPeerInstance=null,G(null),z.value=!1})}catch(f){clearTimeout(i),console.error("[Peer] Bootstrap error:",f),s=null,globalThis.__bootstrapPeerInstance=null,G(null),t(!1)}})}async function ke(e){const n=A(),r=L();return y.universeBootstrap.requestList({to:e}),new Promise(a=>{let o=null,t=null,s=null,i=null;const f=()=>{t&&(t.close(),t=null),o&&(o.destroy(),o=null),s!==null&&(clearTimeout(s),s=null),i!==null&&(clearInterval(i),i=null)};s=window.setTimeout(()=>{console.warn("[Peer] Request bootstrap device list timeout"),f(),a()},1e4);try{const g=be(),S=g.host||"PeerJS Cloud (default)",b=g.port,M=g.path,D=b?`${S}:${b}${M}`:`${S}${M}`;console.log("[Peer-Bootstrap-Request] Connecting to Peer Server:",D),o=new Oe(g),o.on("open",P=>{console.log("[Peer] Temp peer connected with ID:",P),t=o.connect(e),t.on("open",()=>{console.log("[Peer] Connected to bootstrap, waiting for myPeerId...");const h=5e3,T=Date.now();i=window.setInterval(()=>{if(r.myPeerId){clearInterval(i),i=null,console.log("[Peer] myPeerId is ready:",r.myPeerId);const O={type:"device_list_request",from:P,to:e,timestamp:Date.now(),realPeerId:r.myPeerId,username:r.userInfo.username,avatar:r.userInfo.avatar};console.log("[Peer] Sending device list request with realPeerId:",r.myPeerId),t.send(O)}else if(Date.now()-T>h){clearInterval(i),i=null,console.warn("[Peer] Timeout waiting for myPeerId, sending request without it...");const O={type:"device_list_request",from:P,to:e,timestamp:Date.now(),realPeerId:null,username:null,avatar:null};t.send(O)}},100)}),t.on("data",h=>{if(h&&h.type==="device_list_response"){if(console.log("[Peer] Received device list from bootstrap:",h.devices?.length||0,"devices"),y.universeBootstrap.responseList({deviceCount:h.devices?.length||0}),h.devices&&h.devices.length>0&&n.addDevices(h.devices),h.isBootstrap&&h.realPeerId){console.log("[Peer] Bootstrap device has real PeerID:",h.realPeerId);const T={peerId:h.realPeerId,username:h.username||"宇宙启动者",avatar:h.avatar||null,lastHeartbeat:Date.now(),firstDiscovered:Date.now(),isOnline:!0,isBootstrap:!0,realPeerId:e};n.addOrUpdateDevice(T)}f(),a()}}),t.on("error",h=>{console.error("[Peer] Bootstrap connection error:",h),f(),a()}),t.on("close",()=>{f(),a()})}),o.on("error",P=>{console.error("[Peer] Temp peer error:",P),f(),a()})}catch(g){console.error("[Peer] Request bootstrap device list error:",g),f(),a()}})}function tt(e){const n=B;n&&(n.setNetworkAccelerationEnabled(e),e?y.networkAcceleration.enabled():y.networkAcceleration.disabled())}function ot(){return B?.getNetworkAccelerationEnabled()||!1}async function nt(){const e=B;if(!e)return;const r=A().allDevices;e.getNetworkAccelerationEnabled();const a=r.map(o=>o.isOnline?e.sendNetworkAccelerationStatus(o.peerId).catch(()=>{}):Promise.resolve());await Promise.allSettled(a)}function ct(){F();const e=L(),n=A();function r(){return de(e)}function a(){ge();const o=B;o&&(o.destroy(),ie(null),w.message=null,w.deliveryAck=null,w.discoveryResponse=null,w.discoveryNotification=null,w.onlineCheckQuery=null,w.onlineCheckResponse=null,H.value=!1);const t=Ce;t&&(t.destroy(),G(null),console.log("[Peer] Bootstrap connection destroyed"))}return{isConnected:H,isBootstrap:z,init:r,destroy:a,sendChatMessage:fe,sendMessageWithRetry:Xe,generateMessageId:Be,queryDiscoveredDevices:xe,getDiscoveredDevices:He,getStoredDevices:Le,addDiscoveredDevice:Ve,sendDiscoveryNotification:Je,queryUsername:Fe,checkOnline:je,requestUserInfo:W,tryBecomeBootstrap:et,requestBootstrapDeviceList:ke,setNetworkAccelerationEnabled:tt,getNetworkAccelerationEnabled:ot,broadcastNetworkAccelerationStatus:nt,requestDeviceList:X,requestAllDeviceLists:Ke,broadcastUserInfoUpdate:Ye,deviceStore:n}}export{ct as a,F as b,A as c,L as u};
