import{u as Oe,a as we}from"./PeerHttpUtil-DaMKYsqf.js";import{a as Ie,u as Pe}from"./index-91sOS4VC.js";import{f as ze,M as te}from"./fileHelper-CnRNhtN_.js";import{c as s,I as N,d as xe,o as ke,a as Se,y as ne,k as h,w as d,g as c,i as u,t as y,j as P,q as A,m as ae,n as S,b as M,r as b,s as se,e as g,f,h as L,P as re,L as Me,D as Le,z as ie,A as oe,p as De,C as je,E as Ue,B as $e,G as p}from"./index-CsO3AHyv.js";import{V as Be}from"./VideoCameraOutlined-Cnt8doUB.js";import{_ as We}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./logger-CUkP4sI-.js";import"./networkLogDB-BlD6FS5Z.js";import"./cryptoManager-B5C1ax7v.js";var Ee={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M456 231a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0z"}}]},name:"more",theme:"outlined"};function le(o){for(var a=1;a<arguments.length;a++){var t=arguments[a]!=null?Object(arguments[a]):{},m=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(m=m.concat(Object.getOwnPropertySymbols(t).filter(function(v){return Object.getOwnPropertyDescriptor(t,v).enumerable}))),m.forEach(function(v){Fe(o,v,t[v])})}return o}function Fe(o,a,t){return a in o?Object.defineProperty(o,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[a]=t,o}var H=function(a,t){var m=le({},a,t.attrs);return s(N,le({},m,{icon:Ee}),null)};H.displayName="MoreOutlined";H.inheritAttrs=!1;var Te={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 632H136v-39.9l138.5-164.3 150.1 178L658.1 489 888 761.6V792zm0-129.8L664.2 396.8c-3.2-3.8-9-3.8-12.2 0L424.6 666.4l-144-170.7c-3.2-3.8-9-3.8-12.2 0L136 652.7V232h752v430.2zM304 456a88 88 0 100-176 88 88 0 000 176zm0-116c15.5 0 28 12.5 28 28s-12.5 28-28 28-28-12.5-28-28 12.5-28 28-28z"}}]},name:"picture",theme:"outlined"};function ce(o){for(var a=1;a<arguments.length;a++){var t=arguments[a]!=null?Object(arguments[a]):{},m=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(m=m.concat(Object.getOwnPropertySymbols(t).filter(function(v){return Object.getOwnPropertyDescriptor(t,v).enumerable}))),m.forEach(function(v){Re(o,v,t[v])})}return o}function Re(o,a,t){return a in o?Object.defineProperty(o,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[a]=t,o}var q=function(a,t){var m=ce({},a,t.attrs);return s(N,ce({},m,{icon:Te}),null)};q.displayName="PictureOutlined";q.inheritAttrs=!1;var Ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M931.4 498.9L94.9 79.5c-3.4-1.7-7.3-2.1-11-1.2a15.99 15.99 0 00-11.7 19.3l86.2 352.2c1.3 5.3 5.2 9.6 10.4 11.3l147.7 50.7-147.6 50.7c-5.2 1.8-9.1 6-10.3 11.3L72.2 926.5c-.9 3.7-.5 7.6 1.2 10.9 3.9 7.9 13.5 11.1 21.5 7.2l836.5-417c3.1-1.5 5.6-4.1 7.2-7.1 3.9-8 .7-17.6-7.2-21.6zM170.8 826.3l50.3-205.6 295.2-101.3c2.3-.8 4.2-2.6 5-5 1.4-4.2-.8-8.7-5-10.2L221.1 403 171 198.2l628 314.9-628.2 313.2z"}}]},name:"send",theme:"outlined"};function ue(o){for(var a=1;a<arguments.length;a++){var t=arguments[a]!=null?Object(arguments[a]):{},m=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(m=m.concat(Object.getOwnPropertySymbols(t).filter(function(v){return Object.getOwnPropertyDescriptor(t,v).enumerable}))),m.forEach(function(v){Ae(o,v,t[v])})}return o}function Ae(o,a,t){return a in o?Object.defineProperty(o,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[a]=t,o}var G=function(a,t){var m=ue({},a,t.attrs);return s(N,ue({},m,{icon:Ve}),null)};G.displayName="SendOutlined";G.inheritAttrs=!1;const Ne={class:"wechat-container"},He={class:"wechat-layout"},qe={key:0,class:"contacts-panel"},Ge={class:"contacts-header"},Je={class:"user-info"},Qe={class:"username"},Xe={class:"header-actions"},Ye={class:"contacts-list"},Ze={key:0,class:"empty-contacts"},Ke=["onClick"],et={class:"contact-info"},tt={class:"contact-top"},nt={class:"contact-name"},at={class:"contact-time"},st={class:"contact-bottom"},rt={class:"contact-peer-id"},it={class:"chat-header"},ot={class:"chat-header-left"},lt={class:"chat-title"},ct={class:"chat-name"},ut={class:"chat-status"},dt={key:0,class:"empty-messages"},mt={key:1,class:"messages-list"},ft={class:"message-content"},pt={class:"message-meta"},vt={class:"message-time"},ht={class:"input-area"},gt={class:"input-toolbar"},_t={class:"input-row"},yt={key:1,class:"no-chat-selected"},Ct=xe({__name:"WeChatView",setup(o){const a=Oe(),t=Ie(),m=we(),v=Pe(),{sendMessageWithRetry:J}=v,D=b(!1),x=b(""),j=b(""),U=b(null),k=b(!1),$=b(null),B=b(""),Q=b("info"),O=se(()=>{if(!t.currentChatPeerId)return null;const n=t.getContact(t.currentChatPeerId);if(!n)return null;const e=m.getDevice(t.currentChatPeerId);return{...n,online:e?e.isOnline:n.online,lastSeen:e?e.lastHeartbeat:n.lastSeen}}),X=se(()=>t.sortedContacts.map(e=>{const r=m.getDevice(e.peerId);return r?{...e,online:r.isOnline??!1,lastSeen:r.lastHeartbeat,username:r.username,avatar:r.avatar}:e}).sort((e,r)=>e.online!==r.online?e.online?-1:1:r.lastSeen-e.lastSeen));ke(()=>{t.loadFromStorage(),m.loadDevices(),E(),window.addEventListener("resize",E)}),Se(()=>{window.removeEventListener("resize",E)});function E(){k.value=window.innerWidth<768}ne(()=>t.currentChatPeerId,n=>{n&&(t.loadMessages(n),Y())}),ne(()=>t.currentMessages.length,()=>{oe(()=>Y())});function Y(){U.value&&(U.value.scrollTop=U.value.scrollHeight)}function de(n){t.setCurrentChat(n)}function me(){t.setCurrentChat(null)}function w(n,e="info"){B.value=n,Q.value=e}function Z(){B.value=""}async function fe(){const n=j.value.trim();if(Z(),!n){w("请输入对方 Peer ID","warning");return}if(n===a.myPeerId){w("不能与自己聊天","warning");return}const e=n;console.log("[WeChat] Creating chat with peerId:",n,"username:",e),await t.createChat(n,e),t.setCurrentChat(n),D.value=!1,j.value="",w("已创建聊天","success"),console.log("[WeChat] Chat created successfully")}function pe(){if(!t.currentChatPeerId)return;const e=O.value?.username||t.currentChatPeerId;t.deleteChat(t.currentChatPeerId),w(`已删除与 ${e} 的聊天`,"success")}async function K(){const n=x.value.trim();if(!n||!t.currentChatPeerId)return;console.log("[WeChat] Sending text message:",{to:t.currentChatPeerId,content:n});const e=await J(t.currentChatPeerId,n,"text");console.log("[WeChat] Message sent with ID:",e),x.value="",await oe(),console.log("[WeChat] Current messages count:",t.currentMessages.length)}function W(n){$.value&&n&&$.value.setAttribute("accept",n),$.value?.click()}async function ve(n){const e=n.target,r=e.files?.[0];if(!(!r||!t.currentChatPeerId)){if(Z(),r.size>50*1024*1024){w("文件大小不能超过 50MB","warning");return}try{const l=await ze(r);let _,I;if(r.type.startsWith("image/"))try{const z=await he(r);_={name:r.name,size:r.size,width:z.width,height:z.height,data:l},I="image"}catch(z){console.warn("[Chat] Failed to load image dimensions, treating as file:",z),_={name:r.name,size:r.size,type:r.type,data:l},I="file"}else r.type.startsWith("video/")?(_={name:r.name,size:r.size,data:l},I="video"):(_={name:r.name,size:r.size,type:r.type,data:l},I="file");await J(t.currentChatPeerId,_,I),w("文件发送成功","success")}catch(l){console.error("[Chat] File send error:",l),w("文件发送失败","error")}e&&(e.value="")}}function he(n){return new Promise((e,r)=>{const l=new Image,_=URL.createObjectURL(n);l.onload=()=>{URL.revokeObjectURL(_),e({width:l.width,height:l.height})},l.onerror=()=>{URL.revokeObjectURL(_),r(new Error("Failed to load image"))},l.src=_})}function ge(n){const e=n.content;if(typeof e=="string")return;const r=document.createElement("a");r.href=e.data,r.download=e.name,r.click()}function F(n){return n<1024?n+" B":n<1024*1024?(n/1024).toFixed(1)+" KB":(n/(1024*1024)).toFixed(1)+" MB"}function ee(n){const e=new Date(n),r=new Date;return e.toDateString()===r.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function _e(n){const{content:e,type:r}=n;if(typeof e=="string")return p("div",{class:"message-text"},e);switch(r){case"image":{const l=e;return p("div",{class:"message-image"},[p("img",{src:l.data,alt:l.name,style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"8px"}}),p("div",{class:"file-info"},[p("span",{class:"file-name"},l.name),p("span",{class:"file-size"},F(l.size))])])}case"video":{const l=e;return p("div",{class:"message-video"},[p("video",{src:l.data,controls:!0,style:{maxWidth:"100%",maxHeight:"300px",borderRadius:"8px"}}),p("div",{class:"file-info"},[p("span",{class:"file-name"},l.name),p("span",{class:"file-size"},F(l.size))])])}case"file":{const l=e;return p("div",{class:"message-file"},[p(ie,{style:{fontSize:"48px",color:"#1890ff"}}),p("div",{class:"file-details"},[p("div",{class:"file-name"},l.name),p("div",{class:"file-size"},F(l.size))]),p("a",{class:"download-link",onClick:()=>ge(n)},"下载")])}default:return p("div",{class:"message-text"},"[不支持的消息类型]")}}return(n,e)=>{const r=g("a-input"),l=g("a-form-item"),_=g("a-typography-text"),I=g("a-form"),z=g("a-modal"),T=g("a-avatar"),C=g("a-button"),R=g("a-empty"),V=g("a-badge"),ye=g("a-menu-item"),Ce=g("a-menu"),be=g("a-dropdown");return f(),h("div",Ne,[s(z,{open:D.value,"onUpdate:open":e[1]||(e[1]=i=>D.value=i),title:"新增聊天","ok-text":"创建",onOk:fe},{default:d(()=>[s(I,{layout:"vertical"},{default:d(()=>[s(l,{label:"对方 Peer ID"},{default:d(()=>[s(r,{value:j.value,"onUpdate:value":e[0]||(e[0]=i=>j.value=i),placeholder:"请输入对方的 Peer ID"},null,8,["value"])]),_:1}),s(_,{type:"secondary"},{default:d(()=>[...e[8]||(e[8]=[L(" 提示：在发现中心可以查看和复制其他设备的 Peer ID ",-1)])]),_:1}),B.value?(f(),h("div",{key:0,class:S(["inline-message",`inline-message-${Q.value}`])},y(B.value),3)):P("",!0)]),_:1})]),_:1},8,["open"]),c("div",He,[!k.value||!u(t).currentChatPeerId?(f(),h("div",qe,[c("div",Ge,[c("div",Je,[s(T,{src:u(a).userInfo.avatar||void 0,size:40},{default:d(()=>[L(y(u(a).userInfo.username?.charAt(0).toUpperCase()||"U"),1)]),_:1},8,["src"]),c("span",Qe,y(u(a).userInfo.username),1)]),c("div",Xe,[s(C,{type:"text",size:"small","aria-label":"plus",onClick:e[2]||(e[2]=i=>D.value=!0)},{icon:d(()=>[s(u(re))]),_:1})])]),c("div",Ye,[X.value.length===0?(f(),h("div",Ze,[s(R,{description:"暂无聊天"},{description:d(()=>[...e[9]||(e[9]=[c("span",{style:{color:"#999"}},"点击 + 号添加聊天，或在发现中心查看可用设备",-1)])]),_:1})])):P("",!0),(f(!0),h(A,null,ae(X.value,i=>(f(),h("div",{key:i.peerId,class:S(["contact-item",{active:u(t).currentChatPeerId===i.peerId}]),onClick:bt=>de(i.peerId)},[s(V,{count:i.unreadCount,offset:[-4,4]},{default:d(()=>[s(T,{src:i.avatar||void 0,size:48},{default:d(()=>[L(y(i.username.charAt(0).toUpperCase()),1)]),_:2},1032,["src"])]),_:2},1032,["count"]),c("div",et,[c("div",tt,[c("span",nt,y(i.username),1),c("span",at,y(ee(i.lastSeen)),1)]),c("div",st,[c("span",rt,y(i.peerId.slice(0,8))+"..."+y(i.peerId.slice(-4)),1),s(V,{status:i.online?"processing":"default",text:i.online?"在线":"离线"},null,8,["status","text"])])])],10,Ke))),128))])])):P("",!0),!k.value||u(t).currentChatPeerId?(f(),h("div",{key:1,class:S(["chat-panel",{"mobile-show":k.value&&u(t).currentChatPeerId}])},[O.value?(f(),h(A,{key:0},[c("div",it,[c("div",ot,[k.value?(f(),M(C,{key:0,type:"text",onClick:me,class:"back-button"},{icon:d(()=>[s(u(Me))]),_:1})):P("",!0),s(T,{src:O.value.avatar||void 0,size:36},{default:d(()=>[L(y(O.value.username.charAt(0).toUpperCase()),1)]),_:1},8,["src"]),c("div",lt,[c("div",ct,y(O.value.username),1),c("div",ut,[s(V,{status:O.value.online?"processing":"default",text:O.value.online?"在线":"离线"},null,8,["status","text"])])])]),s(be,null,{overlay:d(()=>[s(Ce,null,{default:d(()=>[s(ye,{onClick:pe,style:{color:"#ff4d4f"}},{default:d(()=>[s(u(Le)),e[10]||(e[10]=L(" 删除聊天 ",-1))]),_:1})]),_:1})]),default:d(()=>[s(C,{type:"text",size:"small","aria-label":"more"},{icon:d(()=>[s(u(H))]),_:1})]),_:1})]),c("div",{ref_key:"messagesContainer",ref:U,class:"messages-area"},[u(t).currentMessages.length===0?(f(),h("div",dt,[s(R,{description:"开始聊天吧"},{default:d(()=>[s(u(te),{style:{"font-size":"48px",color:"#ddd"}})]),_:1})])):(f(),h("div",mt,[(f(!0),h(A,null,ae(u(t).currentMessages,i=>(f(),h("div",{key:i.id,class:S(["message-item",{"is-self":i.from===u(a).myPeerId}])},[c("div",ft,[(f(),M(De(_e(i))))]),c("div",pt,[i.from===u(a).myPeerId?(f(),h("span",{key:0,class:S(["message-status",`message-status-${i.status}`])},[i.status==="delivered"?(f(),M(u(je),{key:0})):i.status==="failed"?(f(),M(u(Ue),{key:1})):i.status==="sending"?(f(),M(u($e),{key:2})):P("",!0)],2)):P("",!0),c("span",vt,y(ee(i.timestamp)),1)])],2))),128))]))],512),c("div",ht,[c("div",gt,[s(C,{type:"text",size:"small","aria-label":"upload-file",onClick:e[3]||(e[3]=i=>W())},{icon:d(()=>[s(u(re))]),_:1}),s(C,{type:"text",size:"small","aria-label":"upload-image",onClick:e[4]||(e[4]=i=>W("image/*"))},{icon:d(()=>[s(u(q))]),_:1}),s(C,{type:"text",size:"small","aria-label":"upload-file",onClick:e[5]||(e[5]=i=>W())},{icon:d(()=>[s(u(ie))]),_:1}),s(C,{type:"text",size:"small","aria-label":"upload-video",onClick:e[6]||(e[6]=i=>W("video/*"))},{icon:d(()=>[s(u(Be))]),_:1}),c("input",{ref_key:"fileInputRef",ref:$,type:"file","data-testid":"file-input",style:{display:"none"},onChange:ve},null,544)]),c("div",_t,[s(r,{value:x.value,"onUpdate:value":e[7]||(e[7]=i=>x.value=i),placeholder:"输入消息...",size:"large",onPressEnter:K},{suffix:d(()=>[s(C,{type:"primary",disabled:!x.value.trim(),onClick:K,"aria-label":"send"},{icon:d(()=>[s(u(G))]),_:1},8,["disabled"])]),_:1},8,["value"])])])],64)):(f(),h("div",yt,[s(R,{description:"选择一个联系人开始聊天"},{image:d(()=>[s(u(te),{style:{"font-size":"64px",color:"#ccc"}})]),_:1})]))],2)):P("",!0)])])}}}),Lt=We(Ct,[["__scopeId","data-v-55ba447c"]]);export{Lt as default};
