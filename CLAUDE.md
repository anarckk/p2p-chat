# 用户的要求和喜好

## 编码风格
- **JavaScript 表达式末尾必须加分号**
- 代码规范检查使用 ESLint

## 项目组织偏好
- 工具类放入 `util/` 目录
- 改造成 Vue 组件
- 删除无用业务代码

## 测试要求
- 编写 E2E 测试验证功能
- 使用 Playwright
- 多浏览器 session 测试
- 仅需 Chrome 测试，无需 webkit
- 删除不重要的测试用例
- 测试文件要有明确的测试断言
- 先写 E2E 测试确保能测试出问题，再修正代码解决问题，最后用 E2E 测试确保问题已解决
- 可访问性测试：测试 aria-label 属性、键盘导航、颜色对比度、图片替代文本、表单可访问性、链接可访问性、模态框可访问性、状态变化通知

## UI/UX 要求
- 使用 ant-design-vue 组件
- 美观现代风格
- 支持移动端
- 所有按钮添加 aria-label 属性以便测试定位和可访问性
- 遵循可访问性最佳实践：提供足够的颜色对比度、支持键盘导航、提供适当的 aria 属性

## 功能架构偏好
- 去中心化架构
- 持久化到 LocalStorage
- 自动刷新
- 定时任务/心跳检查

## 构建测试
- 调用 `npm run build` 测试
- 禁止运行 npm run build-only，必须运行 npm run build 并解决遇到的问题

## 命令行使用
- 执行命令时路径不要 cd 到当前目录，直接执行命令
- E2E 测试要单独运行，同一时间仅运行一个测试，不能一次性启动所有测试

---

# 记忆

sx-peerjs-http-util/
    ├── index.html - HTML 入口
    ├── package.json - 项目配置（已安装 ant-design-vue@^4.2.6、vue-router@^4.6.4、pinia@^3.0.4）
    ├── vite.config.ts - Vite 构建配置（端口 36626）
    ├── .prettierrc.json - 代码格式配置（semi: true, singleQuote: true）
    └── src/
        ├── main.ts - Vue 入口（已全局注册 ant-design-vue、vue-router、pinia）
        ├── App.vue - 根组件
        ├── router/
        │   ├── index.ts - 路由配置（/test、/center、/wechat、/settings）
        │   └── RouterView.vue - 路由视图组件
        ├── layouts/
        │   ├── MainLayout.vue - 主布局（顶部导航菜单：/test 为隐藏路由，不在菜单中显示）
        │   └── ResponsiveLayout.vue - 响应式布局（PC端左侧菜单、移动端底部菜单、公钥变更弹窗）
        ├── views/
        │   ├── TestView.vue - 测试页面（原 App.vue 内容迁移）
        │   ├── CenterView.vue - 去中心化发现中心（查询/添加设备、展示在线设备、被动发现自动刷新监听、设备持久化、在线/离线状态显示、添加设备后查询用户名更新显示、左侧"我的信息"卡片实时显示与 Peer Server 的连接状态、设备互相发现、"宇宙启动者"机制、公钥/私钥展示、密钥状态管理）
        │   ├── WeChatView.vue - 聊天应用（新增聊天、消息状态展示、多种消息类型、移动端支持、按钮 aria-label 可访问性、消息时间独立显示优化：时间与消息气泡分离、我方消息时间深灰色、透明背景）
        │   └── SettingsView.vue - 设置页面（用户名、头像维护、网络加速开关）
        ├── stores/
        │   ├── userStore.ts - 用户信息 store（用户名、头像、peerId 持久化、myPeerId 计算属性、个人信息版本号）
        │   ├── chatStore.ts - 聊天 store（消息状态管理、版本号机制、重试机制、localStorage 持久化）
        │   ├── deviceStore.ts - 设备持久化 store（设备列表 localStorage + IndexedDB 混合存储策略、3天未在线自动删除、10分钟定时心跳检查、isBootstrap 字段不持久化且离线时清除、realPeerId 字段同步）
        │   └── keyExchangeStore.ts - 公钥变更弹窗状态管理（弹窗显示、队列处理、用户决策）
        ├── composables/
        │   ├── usePeerManager.ts - Peer 管理逻辑入口
        │   └── usePeerManager/
        │       ├── state.ts - 状态管理
        │       ├── init.ts - 初始化和连接
        │       ├── handlers.ts - 协议处理器
        │       ├── messaging.ts - 消息处理
        │       ├── bootstrap.ts - 宇宙启动者
        │       ├── discovery.ts - 发现中心（公钥交换、变更检测、弹窗触发）
        │       ├── network.ts - 网络加速
        │       └── index.ts - 主入口
        ├── types/
        │   └── index.ts - TypeScript 类型定义（消息类型、协议类型、基于版本号的三段式通信协议、在线检查协议、OnlineDevice 扩展 isOnline/firstDiscovered）
        └── util/
            ├── PeerHttpUtil.ts - PeerJS 工具类（基于版本号的三段式通信协议、去中心化发现中心、在线检查协议 checkOnline/respondOnlineCheck、disconnected/close 事件监听、网络加速中转协议）
            ├── logger.ts - 通讯日志工具（支持连接事件日志：connected/disconnected/closed）
            ├── indexedDBStorage.ts - IndexedDB 存储工具类（avatars/messages/devices/security_keys 存储）
            └── cryptoManager.ts - 数字签名管理器（SHA-256 RSA 密钥对生成、签名验证、密钥持久化）
    └── src/config/
        └── peer.ts - PeerJS 服务器配置（本地开发环境 path 为 /peerjs，生产环境官方地址无 path）
    ├── e2e/
        ├── test-helpers.ts - E2E 测试共享辅助函数（类型定义、SELECTORS/WAIT_TIMES 常量、数据工厂函数、页面操作、等待策略、设备管理、断言辅助、时间辅助函数）
        └── ui/
            └── a11y.spec.ts - 可访问性（A11y）E2E 测试（27个测试用例全部通过，涵盖 aria-label 属性检查、键盘导航、颜色对比度、图片替代文本、表单可访问性、链接可访问性、模态框可访问性、状态变化通知、移动端响应式可访问性）
        ├── center.spec.ts - 发现中心 E2E 测试（多浏览器 session 测试、被动发现测试）
        ├── device-persistence.spec.ts - 设备持久化 E2E 测试（localStorage 持久化、页面切换保持、3天过期删除、在线/离线状态、定时器跨页运行）
        ├── recursive-device-discovery.spec.ts - 设备互相发现递归机制 E2E 测试（被动发现触发递归、主动添加触发递归、设备列表响应递归发现、多级设备发现、避免无限递归、完整网络发现、控制台日志验证）
        ├── key-verification.spec.ts - 身份校验机制 E2E 测试（公钥变更弹窗、用户信任决策、被攻击状态标记）
        ├── wechat.spec.ts - 聊天功能 E2E 测试
        ├── navigation.spec.ts - 导航测试
        ├── vue.spec.ts - Vue 基础测试
        ├── user-setup.spec.ts - 用户信息设置 E2E 测试（首次进入弹窗、用户名必填、持久化、PeerId 稳定性）
        ├── chat-messaging.spec.ts - 聊天消息发送与接收 E2E 测试（多浏览器 session 测试、新增聊天、聊天列表、被动添加）
        ├── message-status.spec.ts - 消息状态展示与送达确认 E2E 测试（发送中/已送达/发送失败、版本号对比、重试、离线消息）
        ├── three-stage-protocol.spec.ts - 三段式通信协议 E2E 测试（版本号机制、拉取机制、多消息类型支持）
        ├── online-check-protocol.spec.ts - 在线检查协议 E2E 测试（checkOnline/respondOnlineCheck、定时心跳、超时判定）
        ├── chat-badge.spec.ts - 聊天中标识 E2E 测试（"已加入聊天"标识、设备可见性、在线状态同时显示）
        ├── connection-status.spec.ts - 发现中心连接状态 E2E 测试
        ├── device-discovery.spec.ts - 设备互相发现 E2E 测试
        ├── universe-bootstrap.spec.ts - "宇宙启动者"机制 E2E 测试（验证固定 ID UNIVERSE-BOOTSTRAP-PEER-ID-001 的使用、控制台日志验证、多设备启动者选举、提前监听日志机制）
        └── settings.spec.ts - 设置页面 E2E 测试（用户名、头像、网络加速开关）

---

# 编译测试要求

你禁止运行 npm run build-only ，必须运行 npm run build 并解决遇到的问题。

---

# 关于P2P聊天工具的用户提示词总结

本章节总结了用户在历史提示词中描述的 P2P 聊天工具的设计思路、功能需求和技术实现细节。

## 核心架构设计

### 去中心化 P2P 架构
- **无中心服务器**: 每个节点都承担发现中心的职责，相互询问发现其他设备
- **通信基础**: 基于 `PeerHttpUtil.ts` 实现类 HTTP 的 P2P 通信
- **连接方式**: 每次发送消息时建立 conn，对端接收后关闭连接，不复用连接
- **类 UDP 通信**: 单向发送，不复用连接，发起端发送消息时创建 conn，对端接收消息后关闭连接
- **回复机制**: from 变量用于标识消息来源，对端通过 from 变量向发起端回复消息

### 路由结构
- 使用哈希路由（Hash Router）以支持 GitHub Pages 部署
  - 项目部署到 GitHub Pages: https://anarckk.github.io/p2p-chat/
  - public\.nojekyll 是 vue3 发布 gitpage 重要的空文件
- `#/test` - 隐藏路由（不显示在菜单中），只有主动输入路由才能进入
- `#/center` - 去中心化发现中心
- `#/wechat` - 聊天应用
- `#/settings` - 设置页面（用户名、头像、网络加速开关）

### 通信协议设计

**重要说明**: 根据 2026-02-01 最新需求，系统将全面采用 request-response 协议。详见下方"p2p-chat 改造设计"章节。

## 功能需求

### 1. 用户管理

#### 首次进入设置
- 必须提示用户输入用户名（必填），发现中心和聊天页签都要检查
- 用户可上传头像文件，否则使用 ant-design-vue 默认头像

#### 用户信息持久化
- 用户名、头像、PeerId 存储到 LocalStorage（头像以 Base64 格式存储）
- PeerId 生成规则：使用 UUID 生成，避免出现中文字符导致连接问题

#### PeerId 稳定性
- 用户在页面间切换时，PeerId 保持不变

#### 设置页面功能
- 可维护用户名、头像
- 可开关配置"网络加速"功能

### 2. 去中心化发现中心 (`/center`)

#### 核心功能
- **主动发现**: 用户可手动输入对端设备的 PeerId 进行添加
- **被动发现**: 自动接收并处理其他设备的发现通知，并自动刷新
- **设备互相发现**: 定期向其他设备询问在线设备列表，拉取并更新本地发现中心
- **设备信息展示**: 显示对端设备的用户名、头像、PeerId（小字）
- **在线状态**: 实时显示设备在线/离线状态

#### "宇宙启动者"机制

**核心设计**:
- **双重角色**: 设备除启动自己的 PeerID（如 peer-abcdefg）外，额外启动一个固定 Peer `UNIVERSE-BOOTSTRAP-PEER-ID-001` 尝试成为宇宙启动者
- **固定 PeerId**: 宇宙启动者的 peerID 固定为 `UNIVERSE-BOOTSTRAP-PEER-ID-001`
- **竞争上岗**: 谁最先启动 Peer `UNIVERSE-BOOTSTRAP-PEER-ID-001`，谁就是宇宙启动者

**成为启动者后的职责**:
- 保持固定 ID 的 Peer 连接，持续监听其他设备的设备列表请求
- 记录在线用户列表
- 向整个宇宙的在线用户广播用户的上线、下线
- 承担一个"种子"的角色

**未能成为启动者的行为**:
- 创建临时 Peer 连接，向"宇宙启动者"请求在线设备列表并更新自身
- 自身真正的 Peer（如 peer-abcdefg）像普通用户一样连接到宇宙启动者

**设备列表请求协议**:
- 作为"宇宙启动者"收到 `device_list_request` 时，返回 `device_list_response` 包含已知的所有设备列表
- 所有用户都可以向宇宙启动者发起询问当前的在线用户列表

**启动者下线处理**:
- 一旦某个设备和宇宙启动者断开，则认为宇宙启动者下线
- 宇宙中不能没有宇宙启动者，必须再启动 Peer `UNIVERSE-BOOTSTRAP-PEER-ID-001` 竞争宇宙启动者
- 避免整个宇宙陷入没有"宇宙启动者"，人人互相隔绝的境地

**发现中心标记**:
- 发现中心里，宇宙启动者要加标记（只在这个设备真的是宇宙启动者时才给予）
- 宇宙启动者要向全宇宙告知自己的个人 PeerID
- 如果本设备是宇宙启动者，在发现中心里也要有宇宙启动者标记
- 宇宙启动者标签应实时更新，当设备不再是启动者时应移除标签

#### 设备状态标识
- **在线**: 设备可通信
- **离线**: 设备不可通信
- **聊天中**: 已在聊天列表的设备增加标识"(聊天中)"（但仍显示在发现中心）

#### 持久化与清理
- **数据持久化**: 发现的设备存储到 LocalStorage
- **跨页面保持**: 切换到聊天页面时，发现中心逻辑继续运行（定时器触发对端设备在线询问请求）
- **自动清理**: 设备超过 3 天未在线时自动删除
- **定时心跳**: 每 10 分钟向所有已知设备发起在线检查

#### 在线检查协议
- **主动询问**: 定时向对端发送 `checkOnline` 协议
- **响应确认**: 对端返回 `respondOnlineCheck` 确认在线
- **超时判定**: 无响应则标记为离线
- **检测间隔与超时**: 默认每隔 20 秒进行所有设备状态检测，5 秒超时即认为设备离线。这两个时间要能通过设置里的设置项进行更改
- **个人信息版本同步**:
  - 每个用户的个人信息（用户名、头像）都有一个版本号
  - 定时心跳检查时，发送方将自己的个人信息版本号发送给对端
  - 对端存储该用户的个人信息版本号
  - 如果版本号不一致，则主动请求该用户的个人信息（用户名和头像）
  - 获取到更新后的个人信息后，在页面上进行展示更新
  - 作为被动发现的一方，主动询问时也要检查对方个人信息版本号，如有更新则拉取

#### Peer Server 连接管理
- **连接状态展示**: 发现中心左侧实时显示与 Peer Server 的连接状态（已连接/未连接）
- **自动重连机制**: 如果意外断网，自动定时 10 秒钟重新连接 Peer Server
- **Peer Server 配置**:
  - 本地开发环境：使用本地搭建的 Peer Server（localhost:9000，path 为 /peerjs）
  - 生产环境：使用官方 Peer Server（无 path）
- 启动时打印当前 peer server 地址到 console

#### 发现通知机制
1. 设备 A 在发现中心添加设备 B
2. 设备 A 向设备 B 发送"我发现你"通知
3. 设备 B 收到通知后，主动与设备 A 建立连接
4. 双方互相询问并交换用户名信息
5. 双方都将对方添加到各自的发现中心
6. 即使对端已在聊天列表中，也要出现在发现中心，并增加特殊标识"(聊天中)"

#### 设备互相发现机制（递归式发现）

**设计背景**: 有时宇宙启动者也不一定能稳定地和宇宙中所有成员建立连接，一些边缘设备处于额外网络环境中，既竞争不中宇宙启动者，又连接不上宇宙启动者，需要这个机制确保设备间互相发现。

**触发场景**:
1. **被动发现触发递归**: 当设备 A 被动发现设备 B（收到 discovery_notification）时，自动向设备 B 请求其设备列表
2. **主动添加触发递归**: 当设备 A 主动添加设备 B 时，自动向设备 B 请求其设备列表
3. **设备列表响应触发递归**: 当设备 A 收到设备 B 的设备列表响应后，对未知设备（C、D、E...）递归发起设备列表请求

**避免无限递归**: 使用 `processingDeviceListRequests` Set 跟踪正在处理的设备，避免重复请求

**最终效果**: 设备 A 通过设备 B 可以发现 B 已知的所有设备，形成网状发现拓扑

##### 点击刷新功能
- 点击刷新时，向其他设备请求他的在线设备列表并更新自身的发现中心设备列表
- 刷新后要刷新发现中心各个设备的当前状态，在线/离线状态要刷新
- **Loading 状态**: 点击刷新时显示 loading，刷新结束时再结束 loading
- **并发检测**: 向所有设备并发发起在线状态请求（不是依次发起）
- **超时判定**: 检测用户是否在线有超时时间，超时未收到返回消息才认定对方下线
- **离线设备检测**: 离线设备也要进行检测（不能直接跳过），否则离线设备上线后无法被检测到
- **刷新状态展示**: 每个设备上增加一个圈圈旋转状态表示是否刷新中，刷新成功则用绿色文字显示刷新耗时（毫秒），方便判断和设备的网络状态

### 3. 聊天应用 (`/wechat`)

#### 界面布局
- **双栏设计**: 左侧聊天列表，右侧聊天窗口
- **移动端支持**: 响应式布局适配移动设备
- **美观风格**: 使用 ant-design-vue 组件，现代化设计

#### UI 样式细节
- **消息时间显示**: 时间与消息气泡分离显示，我方消息时间使用深灰色、透明背景
- **PeerId 显示**: 左侧人员列表中，PeerId 使用中间省略号（展示头尾，因为 UUID 头尾更容易用肉眼识别唯一性）

#### 聊天列表
- **自动发现**: 从发现中心获取所有在线设备
- **手动添加**: 可直接输入 PeerId 新建聊天
- **被动添加**: 对端主动发起通信时自动加入列表
- **刚添加的用户限制**: 刚添加的用户，还未加入聊天，不应出现在聊天列表中
- **设备信息**: 显示头像、用户名、PeerId（小字）

#### 消息功能
- **消息类型**: 文本、图片、文件、视频
- **消息ID机制**: 每条消息有唯一消息ID
- **发送方式**: 发送消息ID通知，不直接发送消息本体
- **发送状态**: 展示发送中/已送达/发送失败状态
- **送达确认**: 对端接收消息后反馈送达状态
- **通信协议**: 通过 request-response 协议确保消息可靠传输（详见"p2p-chat 改造设计"章节）
- **自动重试**: 未送达消息持续重试

#### 消息可靠性
- **自动重试**: 未送达消息自动重试
- **拉取机制**: 对端对比消息ID发现更新时，主动拉取最新消息
- **离线消息**: 对端下线时不删除聊天，上线后通过消息ID对比自动拉取
- **网络应对**: 通过 request-response 协议应对复杂网络波动，避免通信丢失且无报错

#### 在线状态同步
- 设备下线，发现中心要显示离线，聊天里的列表设备也要显示离线

### 4. 网络加速功能
- **消息中转**: 其他设备帮助本设备传递消息给第三方（实现间接通信）
- **可配置开关**: 可在设置页面开启/关闭网络加速
- **关闭效果**: 关闭后不帮助任何人进行网络中转，别人也不会帮本设备与第三方通信
- **直连模式**: 关闭网络加速时，与任何设备都是直连

## 技术实现要求

### 前端技术栈
- **框架**: Vue 3 + TypeScript
- **UI 组件**: ant-design-vue
- **路由**: vue-router
- **状态管理**: pinia
- **构建工具**: Vite（端口 36626）
- **通信基础**: PeerJS（参考官方文档了解 API 用法）

### 代码规范
- **JavaScript 表达式末尾必须加分号**
- 使用 ESLint 进行代码规范检查
- 工具类放入 `util/` 目录

### 测试要求

#### E2E 测试基本原则
- 使用 Playwright 进行功能验证
- 先写 E2E 测试确保能测试出问题，再修正代码解决问题，最后用 E2E 测试确保问题已解决
- 每一个 e2e 测试都要有明确的测试断言
- E2E 测试要单独运行，同一时间仅运行一个测试，不能一次性启动所有测试（因为会互相干扰互相影响导致测试出错）

#### 测试环境
- **多浏览器 Session**: 测试被动发现需要两个浏览器 session
- **浏览器范围**: 仅需 Chrome 测试，无需 webkit
- **Peer Server**: 使用本机 peer server（端口 9000，path 为 /peerjs），理论非常稳定

#### 测试覆盖范围
- 主动发现和被动发现
- 设备互相发现（递归机制）
- "宇宙启动者"机制（宇宙启动者标记、设备通过启动者互相发现、两台设备启动时通过启动者机制互相发现）
- 设备持久化和自动清理
- 消息发送和送达确认
- request-response 通信协议（消息ID机制、拉取机制、送达确认、自动重试）
- 用户信息设置（用户名必填）
- 设置页面（用户名、头像、网络加速开关）
- 头像上传和显示（在两个设备间同步头像显示、上传头像后立即显示、切换到发现中心后显示自己的头像）
- 定时心跳检查
- 发现中心连接状态
- 网络加速中转功能
- 发现中心点击刷新（刷新后由离线变在线、控制台不报错、loading 功能、离线设备检测、刷新状态展示）
- 聊天列表（刚添加的用户不应出现在聊天列表中）
- 设备在线状态同步（设备下线时，聊天列表也要显示离线）
- 首屏加载时间测试
- 聊天中发送图片测试
- 发现中心 loading 功能测试

#### 测试技术要求
- **按钮可访问性**: 所有按钮添加 aria-label 属性以便测试定位
- **测试选择器**: 使用 `.ant-modal .ant-btn-primary` 等精确选择器替代文本匹配
- **等待时间优化**:
  - 弹窗相关测试等待 3000ms 确保完全加载
  - 使用本地 Peer Server 时连接速度较快，可根据实际情况缩短等待时间
  - 大批量测试场景下连接时间难以预估，需根据实际情况调整
  - 超时时间最长定为 30 秒
  - PeerJS 的连接建立很快，一般不超过 5 秒（以实际测试为准）
- **时间限制**: 所有 e2e 测试时间都不能超过 30 秒，超过 30 秒则测试失败（特殊场景需有足够理由才能突破限制）

### 持久化策略
- **LocalStorage**: 用户信息、设备列表、聊天记录、消息状态
- **IndexDB**: 大数据量存储（如网络数据日志），避免 LocalStorage 配额限制
- **自动刷新**: 页面刷新后保持数据
- **跨页面同步**: 使用 Pinia store 共享状态

### 日志要求
- **通讯日志**: 和其他用户的通讯要有字符串日志
- **变量日志**: 一般变量转成字符串，长度不超过 200 个字
- **对象日志**: 对象打印到控制台时转成字符串，每个对象字段长度限制 200 个字，超长则截断
- **关键节点日志**: 发现用户、收到消息、同步个人信息等关键通讯节点要有控制台日志

### UI 提示要求
- **禁止使用全局提示**: 不使用 ant-design-vue 的 message 组件（全局提示）
  - 全局提示提示完就消失，无法追溯，用户要是没注意到，无法再回头看
  - 应该使用内联提示：在触发操作的附近显示提示文案，持久化直到下次操作

### 通信协议业务分类

根据历史提示词，系统中的消息通信业务主要分为以下几类：

**聊天消息传递**:
- request-response 协议：发送 request、对端处理并返回 response、确认送达
- 目的：在复杂不稳定的网络中构建可靠可预测的系统，同时减少网络传输量

**发现中心相关**:
- 设备发现通知和响应
- 在线状态检查（定时心跳）
- 用户信息同步（用户名、头像、个人信息版本号）
- 设备列表请求和响应（用于设备互相发现）

**网络加速**:
- 消息中转：通过第三方设备间接传递消息
- 可配置开关：用户可选择开启或关闭

### 网络数据日志功能

#### 设置页面新增配置
- 增加一个配置：是否启动网络数据日志记录

#### 网络通信数据日志表
- 增加一个"网络数据日志"页签，放到设置旁边
- "网络数据日志"页签是"网络通信数据日志表"的分页表格，每页20条
- 表格风格为小表格
- 和所有设备的 PeerJS 请求和响应数据都用日志记录下来，方便 DEBUG
- 日志存储到 IndexDB

---

## p2p-chat 改造设计（2026-02-01 最新需求）

**注意**: 以下是 2026-02-01 提出的最新改造计划，是对现有系统的重大架构变更。

### 1. 通信协议改造

**新的 request-response 通信模式**:
- 之前的通信方式：发送者和接收者创建 conn 连接，发送者通过 conn 发送消息给接收者，接收者收到消息之后断开 conn
- **改造后**: 发送者和接收者创建 conn 连接，发送者通过 conn 发送 request 给接收者，接收者收到之后进行处理，并通过 conn 反馈 response 给发送者，发送者收到 response 之后关闭 conn
- 这构成一个通信闭环，有发送必有响应。即使是没有数据要反馈也要发送一个空 response 给发送者，让发送者关闭 conn
- 如果发送者发送之后，超过 5 秒没有任何响应，则关闭 conn 并标记对方状态为离线

**五段式通信协议全面废弃**:
- 全面使用 request-response 协议进行数据消息传递
- 所有通信前检查对方状态，如果对方离线，则结束通信，不发送数据

**聊天界面改造**:
- 聊天界面对离线设备增加刷新按钮，可以手动刷新设备状态

### 2. 数字签名身份安全识别

每台设备使用 SHA256 自动生成公私钥，用于数字签名。自己的公钥和私钥可以在设置里面看。

**首次互相发现**:
- 在发现中心可以有一个查看按钮，查看对方的公钥
- 设备之间，在首次互相发现的时候，在所有的业务通信前，有一个系统底层通信，双方交换对方公钥，进行首次公钥互信
- 这个状态称为："交换公钥中"，交换完公钥之后，设备状态才变为在线

**身份校验机制**:
- 在首次互相发现对方之后，今后再次上线的时候，检测设备的公钥是否改变，通过 SHA256 校验数字签名
- 如果对方数字签名校验失败，或者公钥发生改变，则弹窗提示用户，对方的公钥已改变，是否信任
  - 如果不信任，则标记这个用户为"被中间人攻击"状态，并不与这个用户进行通信
  - 如果信任，则记录这个公钥为这个用户的最新公钥
- 在这个过程中，设备状态称之为："身份校验中"
- **实现细节**：
  - `src/stores/keyExchangeStore.ts` - Pinia store 管理公钥变更弹窗状态（支持队列处理多个变更）
  - `src/layouts/ResponsiveLayout.vue` - 全局公钥变更弹窗组件（包含安全警告、公钥对比、信任/不信任操作）
  - `src/composables/usePeerManager/discovery.ts` - `savePeerPublicKey()` 函数检测公钥变更并触发弹窗
  - 弹窗队列机制：多个设备的公钥变更会排队处理，一次只显示一个弹窗
  - 用户决策持久化：`keyExchangeStatus` 字段保存到 localStorage（compromised/verified/exchanged/pending/none）
  - 发现中心 UI 显示：`CenterView.vue` 中根据 `keyExchangeStatus` 显示对应状态标签和操作按钮
  - 密钥交换状态：
    - `none` - 未交换
    - `pending` - 交换公钥中
    - `exchanged` - 已交换
    - `verified` - 已验证（用户信任）
    - `compromised` - 被攻击（用户不信任或检测到公钥变更）
- **实现细节**：
  - `src/stores/keyExchangeStore.ts` - Pinia store 管理公钥变更弹窗状态（支持队列处理多个变更）
  - `src/layouts/ResponsiveLayout.vue` - 全局公钥变更弹窗组件（包含安全警告、公钥对比、信任/不信任操作）
  - `src/composables/usePeerManager/discovery.ts` - `savePeerPublicKey()` 函数检测公钥变更并触发弹窗
  - 弹窗队列机制：多个设备的公钥变更会排队处理，一次只显示一个弹窗
  - 用户决策持久化：`keyExchangeStatus` 字段保存到 localStorage（compromised/verified/exchanged/pending/none）
  - 发现中心 UI 显示：`CenterView.vue` 中根据 `keyExchangeStatus` 显示对应状态标签和操作按钮

### 3. UI 改造

**PC 浏览器端**:
- 顶部菜单栏改为左侧菜单栏

**手机端**:
- 改为底部菜单栏

### 4. PWA 支持

增加 PWA（渐进式 Web 应用）支持

### 5. 文件传输

聊天增加对文件的传输功能

### 6. 语音通话

聊天增加语音通话支持

### 7. 发现中心功能增强

发现中心可以对单个设备进行单独的刷新

---

## 用户交互流程

### 首次使用
1. 打开应用，弹出用户名输入框（必填）
2. 可选上传头像
3. 生成 PeerId 并存储到 LocalStorage
4. 进入发现中心或聊天页面

### 发起聊天
1. 在发现中心选择在线设备
2. 或在聊天页面手动输入 PeerId
3. 立即可发送消息
4. 消息通过 request-response 协议发送
5. 展示送达状态（发送中→已送达）

### 被动发现
1. 其他设备添加本设备
2. 本设备收到"我发现你"通知
3. 自动将对方加入发现中心
4. 可选择发起聊天

### 设备互相发现场景
1. 当整个宇宙一开始只有 2 台设备时
2. 一台设备 A 速度快，注册了宇宙启动者，它在发现中心里把自己标记为宇宙启动者
3. 另一台设备 B 速度慢，注册失败，那么他应该去连接宇宙启动者
4. 通过宇宙启动者，知道宇宙启动者的个人 PeerID 是什么
5. 在发现中心里把 A 标记成宇宙启动者

---

# 注意事项

e2e测试要单独运行，同一时间仅运行一个测试，不能一次性启动所有测试，因为会互相干扰互相影响导致测试出错。

---

# 禁止使用这个命令

禁止命令：`cd /d c:\bee\projects\sx-peerjs-http-util && npm run build`
主要是禁止 `cd /d c:\bee\projects\sx-peerjs-http-util` 到当前项目目录
因为执行效果：
```
Exit code 1
/usr/bin/bash: line 1: cd: too many arguments
```

---

# 提醒

不要后台运行测试！

---

# peerjs-server启动命令

在`peerjs-server/`目录执行命令：`node server.js`。

## 检查 peerjs-server 是否启动

检查端口 9000 是否启动。
