# 用户的要求和喜好

## 编码风格
- **JavaScript 表达式末尾必须加分号**
- 代码规范检查使用 ESLint

## 项目组织偏好
- 工具类放入 `util/` 目录
- 改造成 Vue 组件
- 删除无用业务代码

## 测试要求
- 编写 E2E 测试验证功能
- 使用 Playwright
- 多浏览器 session 测试
- 仅需 Chrome 测试，无需 webkit
- 删除不重要的测试用例
- 测试文件要有明确的测试断言
- 先写 E2E 测试确保能测试出问题，再修正代码解决问题，最后用 E2E 测试确保问题已解决

## UI/UX 要求
- 使用 ant-design-vue 组件
- 美观现代风格
- 支持移动端
- 所有按钮添加 aria-label 属性以便测试定位

## 功能架构偏好
- 去中心化架构
- 持久化到 LocalStorage
- 自动刷新
- 定时任务/心跳检查

## 构建测试
- 调用 `npm run build` 测试
- 禁止运行 npm run build-only，必须运行 npm run build 并解决遇到的问题

## 命令行使用
- 执行命令时路径不要 cd 到当前目录，直接执行命令
- E2E 测试要单独运行，同一时间仅运行一个测试，不能一次性启动所有测试

---

# 记忆

sx-peerjs-http-util/
    ├── index.html - HTML 入口
    ├── package.json - 项目配置（已安装 ant-design-vue@^4.2.6、vue-router@^4.6.4、pinia@^3.0.4）
    ├── vite.config.ts - Vite 构建配置（端口 36626）
    ├── .prettierrc.json - 代码格式配置（semi: true, singleQuote: true）
    └── src/
        ├── main.ts - Vue 入口（已全局注册 ant-design-vue、vue-router、pinia）
        ├── App.vue - 根组件
        ├── router/
        │   ├── index.ts - 路由配置（/test、/center、/wechat、/settings）
        │   └── RouterView.vue - 路由视图组件
        ├── layouts/
        │   └── MainLayout.vue - 主布局（顶部导航菜单：/test 为隐藏路由，不在菜单中显示）
        ├── views/
        │   ├── TestView.vue - 测试页面（原 App.vue 内容迁移）
        │   ├── CenterView.vue - 去中心化发现中心（查询/添加设备、展示在线设备、被动发现自动刷新监听、设备持久化、在线/离线状态显示、添加设备后查询用户名更新显示、左侧"我的信息"卡片实时显示与 Peer Server 的连接状态、设备互相发现、"宇宙启动者"机制）
        │   ├── WeChatView.vue - 聊天应用（新增聊天、消息状态展示、多种消息类型、移动端支持、按钮 aria-label 可访问性、消息时间独立显示优化：时间与消息气泡分离、我方消息时间深灰色、透明背景）
        │   └── SettingsView.vue - 设置页面（用户名、头像维护、网络加速开关）
        ├── stores/
        │   ├── userStore.ts - 用户信息 store（用户名、头像、peerId 持久化、myPeerId 计算属性、个人信息版本号）
        │   ├── chatStore.ts - 聊天 store（消息状态管理、版本号机制、重试机制、localStorage 持久化）
        │   └── deviceStore.ts - 设备持久化 store（设备列表 localStorage 持久化、3天未在线自动删除、10分钟定时心跳检查）
        ├── composables/
        │   └── usePeerManager.ts - Peer 管理逻辑（基于版本号的三段式通信、送达确认、发现中心、消息重试、被动发现自动刷新、在线检查协议处理、deviceStore 集成、连接状态实时监听、10秒自动重连机制、设备互相发现、"宇宙启动者"机制、网络加速）
        │       ├── 11-12 - 新增 bootstrapPeerInstance 模块变量，保持固定 ID 的启动者连接
        │       ├── 834-937 - tryBecomeBootstrap() 函数，成为启动者后保持 UNIVERSE-BOOTSTRAP-PEER-ID-001 连接，监听并响应设备列表请求
        │       ├── 939-1041 - requestBootstrapDeviceList() 函数，创建临时 Peer 连接向启动者请求设备列表
        │       └── 1033-1038 - destroy() 函数，清理启动者连接
        ├── types/
        │   └── index.ts - TypeScript 类型定义（消息类型、协议类型、基于版本号的三段式通信协议、在线检查协议、OnlineDevice 扩展 isOnline/firstDiscovered）
        └── util/
            ├── PeerHttpUtil.ts - PeerJS 工具类（基于版本号的三段式通信协议、去中心化发现中心、在线检查协议 checkOnline/respondOnlineCheck、disconnected/close 事件监听、网络加速中转协议）
            └── logger.ts - 通讯日志工具（支持连接事件日志：connected/disconnected/closed）
    ├── e2e/
        ├── test-helpers.ts - E2E 测试共享辅助函数（类型定义、SELECTORS/WAIT_TIMES 常量、数据工厂函数、页面操作、等待策略、设备管理、断言辅助、时间辅助函数）
        ├── center.spec.ts - 发现中心 E2E 测试（多浏览器 session 测试、被动发现测试）
        ├── device-persistence.spec.ts - 设备持久化 E2E 测试（localStorage 持久化、页面切换保持、3天过期删除、在线/离线状态、定时器跨页运行）
        ├── recursive-device-discovery.spec.ts - 设备互相发现递归机制 E2E 测试（被动发现触发递归、主动添加触发递归、设备列表响应递归发现、多级设备发现、避免无限递归、完整网络发现、控制台日志验证）
        ├── wechat.spec.ts - 聊天功能 E2E 测试
        ├── navigation.spec.ts - 导航测试
        ├── vue.spec.ts - Vue 基础测试
        ├── user-setup.spec.ts - 用户信息设置 E2E 测试（首次进入弹窗、用户名必填、持久化、PeerId 稳定性）
        ├── chat-messaging.spec.ts - 聊天消息发送与接收 E2E 测试（多浏览器 session 测试、新增聊天、聊天列表、被动添加）
        ├── message-status.spec.ts - 消息状态展示与送达确认 E2E 测试（发送中/已送达/发送失败、版本号对比、重试、离线消息）
        ├── three-stage-protocol.spec.ts - 三段式通信协议 E2E 测试（版本号机制、拉取机制、多消息类型支持）
        ├── online-check-protocol.spec.ts - 在线检查协议 E2E 测试（checkOnline/respondOnlineCheck、定时心跳、超时判定）
        ├── chat-badge.spec.ts - 聊天中标识 E2E 测试（"已加入聊天"标识、设备可见性、在线状态同时显示）
        ├── connection-status.spec.ts - 发现中心连接状态 E2E 测试
        ├── device-discovery.spec.ts - 设备互相发现 E2E 测试
        ├── universe-bootstrap.spec.ts - "宇宙启动者"机制 E2E 测试（验证固定 ID UNIVERSE-BOOTSTRAP-PEER-ID-001 的使用、控制台日志验证、多设备启动者选举、提前监听日志机制）
        └── settings.spec.ts - 设置页面 E2E 测试（用户名、头像、网络加速开关）

---

# 编译测试要求

你禁止运行 npm run build-only ，必须运行 npm run build 并解决遇到的问题。

---

# 关于P2P聊天工具的用户提示词总结

本章节总结了用户在历史提示词中描述的 P2P 聊天工具的设计思路、功能需求和技术实现细节。

## 核心架构设计

### 去中心化 P2P 架构
- **无中心服务器**: 每个节点都承担发现中心的职责，相互询问发现其他设备
- **通信基础**: 基于 `PeerHttpUtil.ts` 实现类 HTTP 的 P2P 通信
- **连接方式**: 每次发送消息时建立 conn，对端接收后关闭连接，不复用连接

### 路由结构
- `/test` - 隐藏路由（不显示在菜单中），只有主动输入路由才能进入
- `/center` - 去中心化发现中心
- `/wechat` - 聊天应用
- `/settings` - 设置页面（用户名、头像、网络加速开关）

### 三段式通信协议（基于聊天版本号）
**设计背景**: 原先使用消息 ID 去重，但持续记录会导致字段值超大，且何时删除难以决定。因此重构为版本号机制。

**协议流程**:
1. **第一段**: 发送方发送版本号变更通知（不发送消息本体）
2. **第二段**: 对端对比自身存储的消息版本号，发现有更新时，主动向发送方请求最新消息
3. **第三段**: 发送方返回真实的消息体内容

**优势**:
- 发送方永远只发送版本号通知，消息内容可能超大但由对端反向请求
- 确保双方都在线时才传输实际内容
- 可以由此知道对方已读
- 避免对方离线时大数据量持续发送占用带宽
- 去掉基于消息 ID 的去重逻辑，改用版本号机制

## 功能需求

### 1. 用户管理

#### 首次进入设置
- 必须提示用户输入用户名（必填），发现中心和聊天页签都要检查
- 用户可上传头像文件，否则使用 ant-design-vue 默认头像

#### 用户信息持久化
- 用户名、头像、PeerId 存储到 LocalStorage（头像以 Base64 格式存储）
- PeerId 生成规则：使用 UUID 生成，避免出现中文字符导致连接问题

#### PeerId 稳定性
- 用户在页面间切换时，PeerId 保持不变

#### 设置页面功能
- 可维护用户名、头像
- 可开关配置"网络加速"功能

### 2. 去中心化发现中心 (`/center`)

#### 核心功能
- **主动发现**: 用户可手动输入对端设备的 PeerId 进行添加
- **被动发现**: 自动接收并处理其他设备的发现通知，并自动刷新
- **设备互相发现**: 定期向其他设备询问在线设备列表，拉取并更新本地发现中心
- **设备信息展示**: 显示对端设备的用户名、头像、PeerId（小字）
- **在线状态**: 实时显示设备在线/离线状态

#### "宇宙启动者"机制

**核心设计**:
- **双重角色**: 设备除启动自己的 PeerID（如 peer-abcdefg）外，额外启动一个固定 Peer `UNIVERSE-BOOTSTRAP-PEER-ID-001` 尝试成为宇宙启动者
- **固定 PeerId**: 宇宙启动者的 peerID 固定为 `UNIVERSE-BOOTSTRAP-PEER-ID-001`
- **竞争上岗**: 谁最先启动 Peer `UNIVERSE-BOOTSTRAP-PEER-ID-001`，谁就是宇宙启动者

**成为启动者后的职责**:
- 保持固定 ID 的 Peer 连接，持续监听其他设备的设备列表请求
- 记录在线用户列表
- 向整个宇宙的在线用户广播用户的上线、下线
- 承担一个"种子"的角色

**未能成为启动者的行为**:
- 创建临时 Peer 连接，向"宇宙启动者"请求在线设备列表并更新自身
- 自身真正的 Peer（如 peer-abcdefg）像普通用户一样连接到宇宙启动者

**设备列表请求协议**:
- 作为"宇宙启动者"收到 `device_list_request` 时，返回 `device_list_response` 包含已知的所有设备列表
- 所有用户都可以向宇宙启动者发起询问当前的在线用户列表

**启动者下线处理**:
- 一旦某个设备和宇宙启动者断开，则认为宇宙启动者下线
- 宇宙中不能没有宇宙启动者，必须再启动 Peer `UNIVERSE-BOOTSTRAP-PEER-ID-001` 竞争宇宙启动者
- 避免整个宇宙陷入没有"宇宙启动者"，人人互相隔绝的境地

**发现中心标记**:
- 发现中心里，宇宙启动者要加标记
- 宇宙启动者要向全宇宙告知自己的个人 PeerID
- 如果本设备是宇宙启动者，在发现中心里也要有宇宙启动者标记

#### 设备状态标识
- **在线**: 设备可通信
- **离线**: 设备不可通信
- **聊天中**: 已在聊天列表的设备增加标识"(聊天中)"（但仍显示在发现中心）

#### 持久化与清理
- **数据持久化**: 发现的设备存储到 LocalStorage
- **跨页面保持**: 切换到聊天页面时，发现中心逻辑继续运行（定时器触发对端设备在线询问请求）
- **自动清理**: 设备超过 3 天未在线时自动删除
- **定时心跳**: 每 10 分钟向所有已知设备发起在线检查

#### 在线检查协议
- **主动询问**: 定时向对端发送 `checkOnline` 协议
- **响应确认**: 对端返回 `respondOnlineCheck` 确认在线
- **超时判定**: 无响应则标记为离线
- **个人信息版本同步**:
  - 每个用户的个人信息（用户名、头像）都有一个版本号
  - 定时心跳检查时，发送方将自己的个人信息版本号发送给对端
  - 对端存储该用户的个人信息版本号
  - 如果版本号不一致，则主动请求该用户的个人信息（用户名和头像）
  - 获取到更新后的个人信息后，在页面上进行展示更新
  - 作为被动发现的一方，主动询问时也要检查对方个人信息版本号，如有更新则拉取

#### Peer Server 连接管理
- **连接状态展示**: 发现中心左侧实时显示与 Peer Server 的连接状态（已连接/未连接）
- **自动重连机制**: 如果意外断网，自动定时 10 秒钟重新连接 Peer Server
- **Peer Server**: 本地搭建的 Peer Server（端口 9000），不使用公共 server

#### 发现通知机制
1. 设备 A 在发现中心添加设备 B
2. 设备 A 向设备 B 发送"我发现你"通知
3. 设备 B 收到通知后，主动与设备 A 建立连接
4. 双方互相询问并交换用户名信息
5. 双方都将对方添加到各自的发现中心
6. 即使对端已在聊天列表中，也要出现在发现中心，并增加特殊标识"(聊天中)"

#### 设备互相发现机制（递归式发现）

**设计背景**: 有时宇宙启动者也不一定能稳定地和宇宙中所有成员建立连接，一些边缘设备处于额外网络环境中，既竞争不中宇宙启动者，又连接不上宇宙启动者，需要这个机制确保设备间互相发现。

**触发场景**:
1. **被动发现触发递归**: 当设备 A 被动发现设备 B（收到 discovery_notification）时，自动向设备 B 请求其设备列表
2. **主动添加触发递归**: 当设备 A 主动添加设备 B 时，自动向设备 B 请求其设备列表
3. **设备列表响应触发递归**: 当设备 A 收到设备 B 的设备列表响应后，对未知设备（C、D、E...）递归发起设备列表请求

**避免无限递归**: 使用 `processingDeviceListRequests` Set 跟踪正在处理的设备，避免重复请求

**最终效果**: 设备 A 通过设备 B 可以发现 B 已知的所有设备，形成网状发现拓扑

#### 点击刷新功能
- 点击刷新时，向其他设备请求他的在线设备列表并更新自身的发现中心设备列表
- 刷新后要刷新发现中心各个设备的当前状态，在线/离线状态要刷新

### 3. 聊天应用 (`/wechat`)

#### 界面布局
- **双栏设计**: 左侧聊天列表，右侧聊天窗口
- **移动端支持**: 响应式布局适配移动设备
- **美观风格**: 使用 ant-design-vue 组件，现代化设计

#### UI 样式细节
- **消息时间显示**: 时间与消息气泡分离显示，我方消息时间使用深灰色、透明背景
- **PeerId 显示**: 左侧人员列表中，PeerId 使用中间省略号（展示头尾，因为 UUID 头尾更容易用肉眼识别唯一性）

#### 聊天列表
- **自动发现**: 从发现中心获取所有在线设备
- **手动添加**: 可直接输入 PeerId 新建聊天
- **被动添加**: 对端主动发起通信时自动加入列表
- **刚添加的用户限制**: 刚添加的用户，还未加入聊天，不应出现在聊天列表中
- **设备信息**: 显示头像、用户名、PeerId（小字）

#### 消息功能
- **消息类型**: 文本、图片、文件、视频
- **版本号机制**: 聊天记录设计版本号，不断递增
- **发送方式**: 发送版本号变更通知，不直接发送消息本体
- **发送状态**: 展示发送中/已送达/发送失败状态
- **送达确认**: 对端接收消息后反馈送达状态

#### 消息可靠性
- **自动重试**: 未送达消息无限次自动重试（仅重发版本号通知）
- **拉取机制**: 对端对比版本号发现更新时，主动拉取最新消息
- **离线消息**: 对端下线时不删除聊天，上线后通过版本号对比自动拉取

#### 在线状态同步
- 设备下线，发现中心要显示离线，聊天里的列表设备也要显示离线

### 4. 网络加速功能
- **消息中转**: 其他设备帮助本设备传递消息给第三方（实现间接通信）
- **可配置开关**: 可在设置页面开启/关闭网络加速
- **关闭效果**: 关闭后不帮助任何人进行网络中转，别人也不会帮本设备与第三方通信
- **直连模式**: 关闭网络加速时，与任何设备都是直连

## 技术实现要求

### 前端技术栈
- **框架**: Vue 3 + TypeScript
- **UI 组件**: ant-design-vue
- **路由**: vue-router
- **状态管理**: pinia
- **构建工具**: Vite（端口 36626）
- **通信基础**: PeerJS（参考官方文档了解 API 用法）

### 代码规范
- **JavaScript 表达式末尾必须加分号**
- 使用 ESLint 进行代码规范检查
- 工具类放入 `util/` 目录

### 测试要求

#### E2E 测试基本原则
- 使用 Playwright 进行功能验证
- 先写 E2E 测试确保能测试出问题，再修正代码解决问题，最后用 E2E 测试确保问题已解决
- 每一个 e2e 测试都要有明确的测试断言
- E2E 测试要单独运行，同一时间仅运行一个测试，不能一次性启动所有测试（因为会互相干扰互相影响导致测试出错）

#### 测试环境
- **多浏览器 Session**: 测试被动发现需要两个浏览器 session
- **浏览器范围**: 仅需 Chrome 测试，无需 webkit
- **Peer Server**: 使用本机 peer server，理论非常稳定

#### 测试覆盖范围
- 主动发现和被动发现
- 设备互相发现（递归机制）
- "宇宙启动者"机制（宇宙启动者标记、设备通过启动者互相发现、两台设备启动时通过启动者机制互相发现）
- 设备持久化和自动清理
- 消息发送和送达确认
- 版本号机制和拉取机制
- 用户信息设置（用户名必填）
- 设置页面（用户名、头像、网络加速开关）
- 头像上传和显示（在两个设备间同步头像显示、上传头像后立即显示、切换到发现中心后显示自己的头像）
- 定时心跳检查
- 发现中心连接状态
- 网络加速中转功能
- 发现中心点击刷新（刷新后由离线变在线、控制台不报错）
- 聊天列表（刚添加的用户不应出现在聊天列表中）
- 设备在线状态同步（设备下线时，聊天列表也要显示离线）

#### 测试技术要求
- **按钮可访问性**: 所有按钮添加 aria-label 属性以便测试定位
- **测试选择器**: 使用 `.ant-modal .ant-btn-primary` 等精确选择器替代文本匹配
- **等待时间优化**:
  - 弹窗相关测试等待 3000ms 确保完全加载
  - 使用本地 Peer Server 时连接速度较快，可根据实际情况缩短等待时间
  - 大批量测试场景下连接时间难以预估，需根据实际情况调整
  - 超时时间最长定为 30 秒
  - PeerJS 的连接建立很快，一般不超过 5 秒（以实际测试为准）

### 持久化策略
- **LocalStorage**: 用户信息、设备列表、聊天记录、消息状态
- **自动刷新**: 页面刷新后保持数据
- **跨页面同步**: 使用 Pinia store 共享状态

### 日志要求
- **通讯日志**: 和其他用户的通讯要有字符串日志
- **变量日志**: 一般变量转成字符串，长度不超过 200 个字
- **对象日志**: 对象打印到控制台时转成字符串，每个对象字段长度限制 200 个字，超长则截断
- **关键节点日志**: 发现用户、收到消息、同步个人信息等关键通讯节点要有控制台日志

### 命令行使用原则
- 执行命令时路径不要 cd 到当前目录，直接执行命令
- 调用 `npm run build` 测试，禁止运行 `npm run build-only`

## 用户交互流程

### 首次使用
1. 打开应用，弹出用户名输入框（必填）
2. 可选上传头像
3. 生成 PeerId 并存储到 LocalStorage
4. 进入发现中心或聊天页面

### 发起聊天
1. 在发现中心选择在线设备
2. 或在聊天页面手动输入 PeerId
3. 立即可发送消息
4. 消息通过基于版本号的三段式协议发送
5. 展示送达状态

### 被动发现
1. 其他设备添加本设备
2. 本设备收到"我发现你"通知
3. 自动将对方加入发现中心
4. 可选择发起聊天

### 设备互相发现场景
1. 当整个宇宙一开始只有 2 台设备时
2. 一台设备 A 速度快，注册了宇宙启动者，它在发现中心里把自己标记为宇宙启动者
3. 另一台设备 B 速度慢，注册失败，那么他应该去连接宇宙启动者
4. 通过宇宙启动者，知道宇宙启动者的个人 PeerID 是什么
5. 在发现中心里把 A 标记成宇宙启动者

---

# 运行所有 E2E 测试
npm run test:e2e

# 运行特定测试文件
npx playwright test e2e/center.spec.ts

# 运行特定测试文件中的其中一个测试
npx playwright test e2e/user-setup.spec.ts -g "中文用户名场景"

# 服务器已经启动了。

npm run dev 已经启动了。

# 执行命令时可以优化的点

执行命令的时候路径不要cd到当前目录。直接执行命令就行了。

---

# 注意事项

e2e测试要单独运行，同一时间仅运行一个测试，不能一次性启动所有测试，因为会互相干扰互相影响导致测试出错。

---

# 关于项目中设备互相发现机制的设计

## 一、宇宙启动者机制

”宇宙启动者“是指整个世界首个启动本应用的设备。那么后续再有设备运行本应用网页，应该要能发现宇宙启动者（既发现宇宙启动者，同时也发现他自身真正的PeerID），并将其加入到发现中心。

这个机制有一个细节我需要明确说明。
设备除了启动自己的PeerID，比如自己的PeerId是"peer-abcdefg"以外，是额外再启动一个Peer "UNIVERSE-BOOTSTRAP-PEER-ID-001"来尝试作为宇宙启动者，
也就是本设备同时承接了2个角色，一个是真正的自己，另一个是“宇宙启动者”。

而且宇宙启动者的peerID就是固定的“UNIVERSE-BOOTSTRAP-PEER-ID-001”。

本设备成功启动了Peer "UNIVERSE-BOOTSTRAP-PEER-ID-001"，那么就要以这个Peer的角色，监听其他角色对我的连接，并记录一个在线用户列表，并将这个在线用户列表提供给新加入的成员。
以及向整个宇宙的在线用户，广播用户的上线，广播用户的下线。宇宙启动者承担着一个“种子”的角色。
自身Peer"peer-abcdefg"也一样像一个普通用户一样，连接到宇宙启动者，并进入宇宙启动者维护的一个在线用户列表。
所有其他用户都可以向宇宙启动者发起询问当前的在线用户列表，宇宙启动者都会告诉他当前的在线用户列表。

有了“宇宙发现者”机制，理论上，就有一个中心，只是这个中心是竞争上岗，谁最先启动Peer "UNIVERSE-BOOTSTRAP-PEER-ID-001"，谁就是宇宙启动者。

这个机制还有一点，一旦某个设备和宇宙启动者断开，那么就认为宇宙启动者下线了，宇宙中不能没有宇宙启动者，我就必须再启动Peer "UNIVERSE-BOOTSTRAP-PEER-ID-001"，竞争宇宙启动者，避免整个宇宙陷入没有“宇宙启动者”，人人互相隔绝的境地。

## 二、设备互相发现机制

有时，宇宙启动者也不一定能稳定的和宇宙中所有的成员建立连接，一些边缘设备处于额外网络环境中，既竞争不中宇宙启动者，又连接不上宇宙启动者，那就只能采用这个机制来确保设备间互相发现了。

我每次发现一台新设备，就向这台新设备发送请求，询问他的在线设备列表，得到这些在线设备列表之后，如果有我未知的设备，我就和尝试这些在线设备列表建立联系。将其加入发现中心。

---

# 这个问题出现好多次了

```
cd /d c:\bee\projects\sx-peerjs-http-util && npx playwright test e2e/chat-list-should-not-include-discovered-devices.spec.ts -g "在发现中心添加设备后"
```

一直执行失败，你就不要再执行类似的命令了！错误的原因，可能是因为你 cd 的原因。

---

# 警惕这个命令

命令：`cd /d c:\bee\projects\sx-peerjs-http-util && npm run build`
执行效果：
```
Exit code 1
/usr/bin/bash: line 1: cd: too many arguments
```

