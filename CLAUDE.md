# 用户的要求和喜好

## 编码风格
- **JavaScript 表达式末尾必须加分号**
- 代码规范检查使用 ESLint

## 项目组织偏好
- 工具类放入 `util/` 目录
- 改造成 Vue 组件
- 删除无用业务代码

## 测试要求
- 编写 E2E 测试验证功能
- 使用 Playwright
- 多浏览器 session 测试
- 仅需 Chrome 测试，无需 webkit
- 删除不重要的测试用例

## UI/UX 要求
- 使用 ant-design-vue 组件
- 美观现代风格
- 支持移动端

## 功能架构偏好
- 去中心化架构
- 持久化到 LocalStorage
- 自动刷新
- 定时任务/心跳检查

## 构建测试
- 调用 `npm run build` 测试

---

# 记忆

sx-peerjs-http-util/
└── vue-peerjs-util/
    ├── index.html - HTML 入口
    ├── package.json - 项目配置（已安装 ant-design-vue@^4.2.6、vue-router@^4.6.4、pinia@^3.0.4）
    ├── vite.config.ts - Vite 构建配置（端口 36626）
    ├── .prettierrc.json - 代码格式配置（semi: true, singleQuote: true）
    └── src/
        ├── main.ts - Vue 入口（已全局注册 ant-design-vue、vue-router、pinia）
        ├── App.vue - 根组件
        ├── router/
        │   ├── index.ts - 路由配置（/test、/center、/wechat）
        │   └── RouterView.vue - 路由视图组件
        ├── layouts/
        │   └── MainLayout.vue - 主布局（顶部导航菜单：/test 为隐藏路由，不在菜单中显示）
        ├── views/
        │   ├── TestView.vue - 测试页面（原 App.vue 内容迁移）
        │   ├── CenterView.vue - 去中心化发现中心（查询/添加设备、展示在线设备、被动发现自动刷新监听、设备持久化、在线/离线状态显示、添加设备后查询用户名更新显示、左侧"我的信息"卡片实时显示与 Peer Server 的连接状态）
        │   └── WeChatView.vue - 聊天应用（新增聊天、消息状态展示、多种消息类型、移动端支持、按钮 aria-label 可访问性）
        ├── stores/
        │   ├── userStore.ts - 用户信息 store（用户名、头像、peerId 持久化、myPeerId 计算属性）
        │   ├── chatStore.ts - 聊天 store（消息状态管理、版本号机制、重试机制、localStorage 持久化）
        │   └── deviceStore.ts - 设备持久化 store（设备列表 localStorage 持久化、3天未在线自动删除、10分钟定时心跳检查）
        ├── composables/
        │   └── usePeerManager.ts - Peer 管理逻辑（基于版本号的三段式通信、送达确认、发现中心、消息重试、被动发现自动刷新、在线检查协议处理、deviceStore 集成、连接状态实时监听、10秒自动重连机制）
        ├── types/
        │   └── index.ts - TypeScript 类型定义（消息类型、协议类型、基于版本号的三段式通信协议、在线检查协议、OnlineDevice 扩展 isOnline/firstDiscovered）
        └── util/
            ├── PeerHttpUtil.ts - PeerJS 工具类（基于版本号的三段式通信协议、去中心化发现中心、在线检查协议 checkOnline/respondOnlineCheck、disconnected/close 事件监听）
            └── logger.ts - 通讯日志工具（支持连接事件日志：connected/disconnected/closed）
    ├── e2e/
        ├── test-helpers.ts - E2E 测试共享辅助函数（类型定义、SELECTORS/WAIT_TIMES 常量、数据工厂函数、页面操作、等待策略、设备管理、断言辅助、时间辅助函数）
        ├── center.spec.ts - 发现中心 E2E 测试（多浏览器 session 测试、被动发现测试）
        ├── device-persistence.spec.ts - 设备持久化 E2E 测试（localStorage 持久化、页面切换保持、3天过期删除、在线/离线状态、定时器跨页运行）
        ├── wechat.spec.ts - 聊天功能 E2E 测试
        ├── navigation.spec.ts - 导航测试
        ├── vue.spec.ts - Vue 基础测试
        ├── user-setup.spec.ts - 用户信息设置 E2E 测试（首次进入弹窗、用户名必填、持久化、PeerId 稳定性）
        ├── chat-messaging.spec.ts - 聊天消息发送与接收 E2E 测试（多浏览器 session 测试、新增聊天、聊天列表、被动添加）
        ├── message-status.spec.ts - 消息状态展示与送达确认 E2E 测试（发送中/已送达/发送失败、版本号对比、重试、离线消息）
        ├── three-stage-protocol.spec.ts - 三段式通信协议 E2E 测试（版本号机制、拉取机制、多消息类型支持）
        ├── online-check-protocol.spec.ts - 在线检查协议 E2E 测试（checkOnline/respondOnlineCheck、定时心跳、超时判定）
        └── chat-badge.spec.ts - 聊天中标识 E2E 测试（"已加入聊天"标识、设备可见性、在线状态同时显示）

---

# 编译测试要求

你禁止运行 npm run build-only ，必须运行 npm run build 并解决遇到的问题。

---

# 关于P2P聊天工具的用户提示词总结

## 核心架构设计

### 去中心化 P2P 架构
- **无中心服务器**: 每个节点都承担发现中心的职责,相互询问发现其他设备
- **通信基础**: 基于 [PeerHttpUtil.ts](vue-peerjs-util/src/util/PeerHttpUtil.ts) 实现类 HTTP 的 P2P 通信
- **连接方式**: 每次发送消息时建立 conn,对端接收后关闭连接,不复用连接
- **路由结构**:
  - `/test` - 隐藏路由(不显示在菜单中)
  - `/center` - 去中心化发现中心
  - `/wechat` - 聊天应用

### 三段式通信协议（基于聊天版本号）
1. **第一段**: 发送方发送版本号变更通知（不发送消息本体）
2. **第二段**: 对端对比自身存储的消息版本号，发现有更新时，主动向发送方请求最新消息
3. **第三段**: 发送方返回真实的消息体内容

**优势**:
- 发送方永远只发送版本号通知，消息内容可能超大但由对端反向请求
- 确保双方都在线时才传输实际内容
- 可以由此知道对方已读
- 避免对方不离线时大数据量持续发送占用带宽

**去重机制**: 删除基于消息ID的去重逻辑，改用版本号机制

## 功能需求

### 1. 用户管理
- **首次进入**: 必须提示用户输入用户名(必填)
- **头像支持**: 用户可上传头像文件,否则使用 ant-design-vue 默认头像
- **用户信息持久化**: 用户名、头像、PeerId 存储到 LocalStorage（头像以 Base64 格式存储）
- **PeerId 稳定性**: 用户在页面间切换时,PeerId 保持不变

### 2. 去中心化发现中心 (`/center`)

#### 核心功能
- **主动发现**: 用户可手动输入对端设备的 PeerId 进行添加
- **被动发现**: 自动接收并处理其他设备的发现通知
- **设备信息展示**: 显示对端设备的用户名、头像、PeerId(小字)
- **在线状态**: 实时显示设备在线/离线状态

#### 设备状态标识
- **在线**: 设备可通信
- **离线**: 设备不可通信
- **聊天中**: 已在聊天列表的设备增加标识(但仍显示在发现中心)

#### 持久化与清理
- **数据持久化**: 发现的设备存储到 LocalStorage
- **跨页面保持**: 切换到聊天页面时,发现中心逻辑继续运行
- **自动清理**: 设备超过 3 天未在线时自动删除
- **定时心跳**: 每 10 分钟向所有已知设备发起在线检查

#### 在线检查协议
- **主动询问**: 定时向对端发送 `checkOnline` 协议
- **响应确认**: 对端返回 `respondOnlineCheck` 确认在线
- **超时判定**: 无响应则标记为离线
- **个人信息版本同步**:
  - 每个用户的个人信息（用户名、头像）都有一个版本号
  - 定时心跳检查时，发送方将自己的个人信息版本号发送给对端
  - 对端存储该用户的个人信息版本号
  - 如果版本号不一致，则主动请求该用户的个人信息（用户名和头像）
  - 获取到更新后的个人信息后，在页面上进行展示更新

### 3. 聊天应用 (`/wechat`)

#### 界面布局
- **双栏设计**: 左侧聊天列表,右侧聊天窗口
- **移动端支持**: 响应式布局适配移动设备
- **美观风格**: 使用 ant-design-vue 组件,现代化设计

#### 聊天列表
- **自动发现**: 从发现中心获取所有在线设备
- **手动添加**: 可直接输入 PeerId 新建聊天
- **被动添加**: 对端主动发起通信时自动加入列表
- **设备信息**: 显示头像、用户名、PeerId(小字)

#### 消息功能
- **消息类型**: 文本、图片、文件、视频
- **版本号机制**: 聊天记录设计版本号，不断递增
- **发送方式**: 发送版本号变更通知，不直接发送消息本体
- **发送状态**: 展示发送中/已送达/发送失败状态
- **送达确认**: 对端接收消息后反馈送达状态

#### 消息可靠性
- **自动重试**: 未送达消息无限次自动重试（仅重发版本号通知）
- **拉取机制**: 对端对比版本号发现更新时，主动拉取最新消息
- **离线消息**: 对端下线时不删除聊天，上线后通过版本号对比自动拉取

### 4. 发现通知机制

#### 设备发现流程
1. 设备 A 在发现中心添加设备 B
2. 设备 A 向设备 B 发送"我发现你"通知
3. 设备 B 收到通知后,主动与设备 A 建立连接
4. 双方互相询问并交换用户名信息
5. 双方都将对方添加到各自的发现中心

#### 已在聊天中的处理
- 即使设备已在聊天列表中,也要出现在发现中心
- 增加特殊标识"(聊天中)"

## 技术实现要求

### 前端技术栈
- **框架**: Vue 3 + TypeScript
- **UI 组件**: ant-design-vue@^4.2.6
- **路由**: vue-router@^4.6.4
- **状态管理**: pinia@^3.0.4
- **构建工具**: Vite(端口 36626)

### 代码规范
- **JavaScript 表达式末尾必须加分号**
- 使用 ESLint 进行代码规范检查
- 工具类放入 `util/` 目录

### 测试要求
- **E2E 测试**: 使用 Playwright 进行功能验证
- **多浏览器 Session**: 测试被动发现需要两个浏览器 session
- **浏览器范围**: 仅需 Chrome 测试,无需 webkit
- **测试覆盖**:
  - 主动发现和被动发现
  - 设备持久化和自动清理
  - 消息发送和送达确认
  - 版本号机制和拉取机制
  - 用户信息设置
  - 定时心跳检查
- **按钮可访问性**: 所有按钮添加 aria-label 属性以便测试定位
- **测试选择器**: 使用 `.ant-modal .ant-btn-primary` 等精确选择器替代文本匹配
- **等待时间**: 弹窗相关测试等待 3000ms 确保完全加载

### 持久化策略
- **LocalStorage**: 用户信息、设备列表、聊天记录、消息状态
- **自动刷新**: 页面刷新后保持数据
- **跨页面同步**: 使用 Pinia store 共享状态

### 日志要求
- **通讯日志**: 和其他用户的通讯要有字符串日志
- **变量日志**: 一般变量转成字符串，长度不超过200个字
- **对象日志**: 对象打印到控制台时转成字符串，每个对象字段长度限制200个字，超长则截断
- **关键节点日志**: 发现用户、收到消息、同步个人信息等关键通讯节点要有控制台日志

## 用户交互流程

### 首次使用
1. 打开应用,弹出用户名输入框(必填)
2. 可选上传头像
3. 生成 PeerId 并存储到 LocalStorage
4. 进入发现中心或聊天页面

### 发起聊天
1. 在发现中心选择在线设备
2. 或在聊天页面手动输入 PeerId
3. 立即可发送消息
4. 消息通过基于版本号的三段式协议发送
5. 展示送达状态

### 被动发现
1. 其他设备添加本设备
2. 本设备收到"我发现你"通知
3. 自动将对方加入发现中心
4. 可选择发起聊天

---

# 运行所有 E2E 测试
npm run test:e2e

# 运行特定测试文件
npx playwright test e2e/center.spec.ts

# 运行特定测试文件中的其中一个测试
npx playwright test e2e/user-setup.spec.ts -g "中文用户名场景"
