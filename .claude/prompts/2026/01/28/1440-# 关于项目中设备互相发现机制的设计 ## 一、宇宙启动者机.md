session_id:969d507c-3de2-4c91-87f7-a8b05279606f

# 关于项目中设备互相发现机制的设计

## 一、宇宙启动者机制

”宇宙启动者“是指整个世界首个启动本应用的设备。那么后续再有设备运行本应用网页，应该要能发现宇宙启动者（既发现宇宙启动者，同时也发现他自身真正的PeerID），并将其加入到发现中心。

这个机制有一个细节我需要明确说明。
设备除了启动自己的PeerID，比如自己的PeerId是"peer-abcdefg"以外，是额外再启动一个Peer "UNIVERSE-BOOTSTRAP-PEER-ID-001"来尝试作为宇宙启动者，
也就是本设备同时承接了2个角色，一个是真正的自己，另一个是“宇宙启动者”。

而且宇宙启动者的peerID就是固定的“UNIVERSE-BOOTSTRAP-PEER-ID-001”。

本设备成功启动了Peer "UNIVERSE-BOOTSTRAP-PEER-ID-001"，那么就要以这个Peer的角色，监听其他角色对我的连接，并记录一个在线用户列表，并将这个在线用户列表提供给新加入的成员。
以及向整个宇宙的在线用户，广播用户的上线，广播用户的下线。宇宙启动者承担着一个“种子”的角色。
自身Peer"peer-abcdefg"也一样像一个普通用户一样，连接到宇宙启动者，并进入宇宙启动者维护的一个在线用户列表。
所有其他用户都可以向宇宙启动者发起询问当前的在线用户列表，宇宙启动者都会告诉他当前的在线用户列表。

有了“宇宙发现者”机制，理论上，就有一个中心，只是这个中心是竞争上岗，谁最先启动Peer "UNIVERSE-BOOTSTRAP-PEER-ID-001"，谁就是宇宙启动者。

这个机制还有一点，一旦某个设备和宇宙启动者断开，那么就认为宇宙启动者下线了，宇宙中不能没有宇宙启动者，我就必须再启动Peer "UNIVERSE-BOOTSTRAP-PEER-ID-001"，竞争宇宙启动者，避免整个宇宙陷入没有“宇宙启动者”，人人互相隔绝的境地。

## 二、设备互相发现机制

有时，宇宙启动者也不一定能稳定的和宇宙中所有的成员建立连接，一些边缘设备处于额外网络环境中，既竞争不中宇宙启动者，又连接不上宇宙启动者，那就只能采用这个机制来确保设备间互相发现了。

我每次发现一台新设备，就向这台新设备发送请求，询问他的在线设备列表，得到这些在线设备列表之后，如果有我未知的设备，我就和尝试这些在线设备列表建立联系。将其加入发现中心。