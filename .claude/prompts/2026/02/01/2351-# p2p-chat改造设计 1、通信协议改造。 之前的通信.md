session_id:4cbb58b6-c23a-441b-b590-3ea9b4cc905c

# p2p-chat改造设计

1、通信协议改造。

之前的通信方式是，发送者和接受者创建conn连接，发送者通过conn发送消息给接收者，接收者收到消息之后断开conn。
接下来要改造为：发送者和接收者创建conn连接，发送者通过conn发送request给接收者，接收者收到之后进行处理，并通过conn反馈response给发送者，发送者收到 response 之后关闭conn。
这构成一个通信闭环，有发送必有响应。即使是没有数据要反馈也要发送一个空response给发送者，让发送者关闭 conn。
如果发送者发送之后，超过5秒没有任何响应，则关闭conn并标记对方状态为离线。

五段式通信全面废弃，全面使用 request-response 协议进行数据消息传递。

所有通信前检查-检查对方状态，如果对方离线，则结束通信，不发送数据。

聊天界面对离线设备增加刷新按钮，可以手动刷新设备状态。

2、数字签名身份安全识别。

每台设备使用SHA256自动生成公私钥，用于数字签名。自己的公钥和私钥可以在设置里面看。
在发现中心可以有一个查看按钮，查看对方的公钥。

设备之间，在首次互相发现的时候，在所有的业务通信前，有一个系统底层通信，双方交换对方公钥，进行首次公钥互信。这个状态称为：“交换公钥中”，交换完公钥之后，设备状态才变为在线。

还要再加上一个安全机制，在首次互相发现对方之后，今后再次上线的时候，检测设备的公钥是否改变，通过SHA256校验数字签名，如果对方数字签名校验失败，或者公钥发生改变，
则弹窗提示用户，对方的公钥已改变，是否信任，如果不信任，则标记这个用户为“被中间人攻击”状态，并不与这个用户进行通信。如果信任，则记录这个公钥为这个用户的最新公钥。
在这个过程中，设备状态称之为：“身份校验中”。

3、UI改造，在PC浏览器端，顶部菜单栏改为左侧菜单栏。
   在手机端改为底部菜单栏。

4、增加PWA支持。

5、聊天增加对文件的传输。

6、聊天增加语音通话支持。

7、发现中心可以对单个设备进行单独的刷新。

# 任务

1、实现p2p-chat改造计划。
2、编写e2e测试，覆盖UI测试和业务逻辑测试。
3、运行e2e测试，并修复e2e测试发现的问题，实现e2e100%覆盖所有用户使用场景，实现e2e100%通过率。
请分析需求，制定计划，分解任务并使用Task工具将分解后的任务交给子代理执行。

注意：e2e测试绝对不可以并发执行！并发执行会测试数据互相影响！